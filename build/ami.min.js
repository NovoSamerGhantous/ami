/* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
			/* vim: set shiftwidth=2 tabstop=2 autoindent cindent expandtab: */
			/* Copyright 2012 Mozilla Foundation
			 *
			 * Licensed under the Apache License, Version 2.0 (the "License");
			 * you may not use this file except in compliance with the License.
			 * You may obtain a copy of the License at
			 *
			 *     http://www.apache.org/licenses/LICENSE-2.0
			 *
			 * Unless required by applicable law or agreed to in writing, software
			 * distributed under the License is distributed on an "AS IS" BASIS,
			 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
			 * See the License for the specific language governing permissions and
			 * limitations under the License.
			 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("three"),require("events")):"function"==typeof define&&define.amd?define(["exports","three","events"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).AMI={},t.three,t.EventEmitter)}(this,(function(t,e,i){"use strict";function s(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var a=s(i);class o{static matrix4(t){return!(null==t||!t.hasOwnProperty("elements")||16!==t.elements.length||"function"!=typeof t.identity||"function"!=typeof t.copy||"function"!=typeof t.determinant)}static vector3(t){return!(!(null!=t&&t.hasOwnProperty("x")&&t.hasOwnProperty("y")&&t.hasOwnProperty("z"))||t.hasOwnProperty("w"))}static box(t){return!!(null!=t&&t.hasOwnProperty("center")&&this.vector3(t.center)&&t.hasOwnProperty("halfDimensions")&&this.vector3(t.halfDimensions)&&t.halfDimensions.x>=0&&t.halfDimensions.y>=0&&t.halfDimensions.z>=0)}static ray(t){return!!(null!=t&&t.hasOwnProperty("position")&&this.vector3(t.position)&&t.hasOwnProperty("direction")&&this.vector3(t.direction))}}class n{static bbox(t,e){if(!o.vector3(t)||!o.vector3(e))return console.log("Invalid center or plane halfDimensions."),!1;if(!(e.x>=0&&e.y>=0&&e.z>=0))return console.log("halfDimensions must be >= 0."),console.log(e),!1;return{min:t.clone().sub(e),max:t.clone().add(e)}}static minMax(t=[]){let e=[65535,-32768],i=t.length;for(let s=0;s<i;s++){let i=t[s];e[0]=Math.min(e[0],i),e[1]=Math.max(e[1],i)}return e}static isElement(t){try{return t instanceof HTMLElement}catch(e){return"object"==typeof t&&1===t.nodeType&&"object"==typeof t.style&&"object"==typeof t.ownerDocument}}static isString(t){return"string"==typeof t||t instanceof String}static parseUrl(t){const e=new URL(t,"http://fix.me"),i={filename:e.searchParams.get("filename"),extension:"",pathname:e.pathname,query:e.search};i.filename||(i.filename=i.pathname.split("/").pop());const s=i.filename.split(".");i.extension=s.length>1?s.pop():"dicom";return(!isNaN(i.extension)||-1!==["asp","aspx","go","gs","hs","jsp","js","php","pl","py","rb","htm","html"].indexOf(i.extension)||i.query&&i.query.includes("contentType=application%2Fdicom"))&&(i.extension="dicom"),i}static ijk2LPS(t,i,s,a,o,n=new e.Matrix4){const l=new e.Matrix4;return l.set(t.x*a.y,i.x*a.x,s.x*a.z,o.x,t.y*a.y,i.y*a.x,s.y*a.z,o.y,t.z*a.y,i.z*a.x,s.z*a.z,o.z,0,0,0,1),l.premultiply(n),l}static aabb2LPS(t,i,s,a){const o=new e.Matrix4;return o.set(t.x,i.x,s.x,a.x,t.y,i.y,s.y,a.y,t.z,i.z,s.z,a.z,0,0,0,1),o}static worldToData(t,i){let s=(new e.Vector3).copy(i).applyMatrix4(t);return s.addScalar(.5).floor(),s}static value(t,e){console.warn("value is deprecated, please use getPixelData instead"),this.getPixelData(t,e)}static getPixelData(t,e){return e.z>=0&&e.z<t._frame.length?t._frame[e.z].getPixelData(e.x,e.y):null}static setPixelData(t,e,i){if(!(e.z>=0&&e.z<t._frame.length))return null;t._frame[e.z].setPixelData(e.x,e.y,i)}static rescaleSlopeIntercept(t,e,i){return t*e+i}static centerOfMass(t){let i=new e.Vector3(0,0,0);for(let e=0;e<t.length;e++)i.x+=t[e].x,i.y+=t[e].y,i.z+=t[e].z;return i.divideScalar(t.length),i}static orderIntersections(t,i){let s=this.centerOfMass(t),a=new e.Vector3(t[0].x-s.x,t[0].y-s.y,t[0].z-s.z).normalize(),o=new e.Vector3(0,0,0).crossVectors(a,i).normalize(),n=[];for(let i=0;i<t.length;i++){let l=new e.Vector3(t[i].x,t[i].y,t[i].z);l.direction=new e.Vector3(t[i].x-s.x,t[i].y-s.y,t[i].z-s.z).normalize();let r=a.dot(l.direction),h=o.dot(l.direction);l.xy={x:r,y:h};let c=Math.atan2(h,r)*(180/Math.PI);l.angle=c,n.push(l)}n.sort((function(t,e){return t.angle-e.angle}));let l=[n[0]];for(let t=1;t<n.length;t++)Math.abs(n[t-1].angle-n[t].angle)>1e-4&&l.push(n[t]);return l}static getRoI(t,i,s){t.geometry.computeBoundingBox();const a=(new e.Box3).setFromObject(t),o=a.min.clone().project(i),l=a.max.clone().project(i),r=i.controls.domElement.offsetWidth,h=i.controls.domElement.offsetHeight,c=new e.Raycaster,_=[];o.x=Math.round((o.x+1)*r/2),o.y=Math.round((1-o.y)*h/2),l.x=Math.round((l.x+1)*r/2),l.y=Math.round((1-l.y)*h/2),[o.x,l.x]=[Math.min(o.x,l.x),Math.max(o.x,l.x)],[o.y,l.y]=[Math.min(o.y,l.y),Math.max(o.y,l.y)];let d=[],p=null;for(let e=o.x;e<=l.x;e++)for(let a=o.y;a<=l.y;a++)c.setFromCamera({x:e/r*2-1,y:-a/h*2+1},i),d=c.intersectObject(t),0!==d.length&&(p=n.getPixelData(s,n.worldToData(s.lps2IJK,d[0].point)),null!==p&&1===s.numberOfChannels&&_.push(n.rescaleSlopeIntercept(p,s.rescaleSlope,s.rescaleIntercept)));if(0===_.length)return null;const u=_.reduce(((t,e)=>t+e))/_.length;return{min:_.reduce(((t,e)=>t<e?t:e)),max:_.reduce(((t,e)=>t>e?t:e)),mean:u,sd:Math.sqrt(_.reduce(((t,e)=>t+Math.pow(e-u,2)),0)/_.length)}}static getGeometryArea(t){if(t.faces.length<1)return 0;let i=0,s=[],a=bodyPart.geometry.getAttribute("position");for(let t=0;a.count;t++)s=[...s,(new e.Vector3).fromBufferAttribute(a,t)];return t.faces.forEach((function(t){i+=new e.Triangle(s[t.a],s[t.b],s[t.c]).getArea()})),i}static stringToNumber(t){let e=Number(t);if(e!=e){const i=(t.match(/\./g)||[]).length;if(1===(t.match(/\,/g)||[]).length&&i<2){const s=0===i?".":"",a=t.replace(/,/g,s);e=Number(a)}e!=e&&(console.error(`String could not be converted to number (${t}). Setting value to "1.0".`),e=1)}return e}}class l{static aabbPlane(t,i){let s=[];if(!this.validateAabb(t)||!this.validatePlane(i))return console.log("Invalid aabb or plane provided."),!1;let a=new e.Matrix4;a.getInverse(t.toAABB);let o=i.direction.clone().applyMatrix4(t.toAABB),l=new e.Vector3(0,0,0).applyMatrix4(t.toAABB),r=this.posdir(i.position.clone().applyMatrix4(t.toAABB),new e.Vector3(o.x-l.x,o.y-l.y,o.z-l.z).normalize()),h=n.bbox(t.center,t.halfDimensions),c=new e.Vector3(new e.Vector3(1,0,0),new e.Vector3(0,1,0),new e.Vector3(0,0,1)),_=this.posdir(new e.Vector3(t.center.x-t.halfDimensions.x,t.center.y-t.halfDimensions.y,t.center.z-t.halfDimensions.z),c.x);this.rayPlaneInBBox(_,r,h,s),_.direction=c.y,this.rayPlaneInBBox(_,r,h,s),_.direction=c.z,this.rayPlaneInBBox(_,r,h,s);let d=this.posdir(new e.Vector3(t.center.x+t.halfDimensions.x,t.center.y+t.halfDimensions.y,t.center.z+t.halfDimensions.z),c.x);this.rayPlaneInBBox(d,r,h,s),d.direction=c.y,this.rayPlaneInBBox(d,r,h,s),d.direction=c.z,this.rayPlaneInBBox(d,r,h,s);let p=this.posdir(new e.Vector3(t.center.x+t.halfDimensions.x,t.center.y-t.halfDimensions.y,t.center.z-t.halfDimensions.z),c.y);this.rayPlaneInBBox(p,r,h,s),p.direction=c.z,this.rayPlaneInBBox(p,r,h,s);let u=this.posdir(new e.Vector3(t.center.x-t.halfDimensions.x,t.center.y+t.halfDimensions.y,t.center.z-t.halfDimensions.z),c.x);this.rayPlaneInBBox(u,r,h,s),u.direction=c.z,this.rayPlaneInBBox(u,r,h,s);let m=this.posdir(new e.Vector3(t.center.x-t.halfDimensions.x,t.center.y-t.halfDimensions.y,t.center.z+t.halfDimensions.z),c.x);return this.rayPlaneInBBox(m,r,h,s),m.direction=c.y,this.rayPlaneInBBox(m,r,h,s),s.map((function(t){return t.applyMatrix4(a)})),s}static rayPlane(t,i){if(0!==t.direction.dot(i.direction)){let s=(i.direction.x*(i.position.x-t.position.x)+i.direction.y*(i.position.y-t.position.y)+i.direction.z*(i.position.z-t.position.z))/(i.direction.x*t.direction.x+i.direction.y*t.direction.y+i.direction.z*t.direction.z);return new e.Vector3(t.position.x+s*t.direction.x,t.position.y+s*t.direction.y,t.position.z+s*t.direction.z)}return null}static rayBox(t,i){let s=[],a=n.bbox(i.center,i.halfDimensions),o=this.posdir(new e.Vector3(a.min.x,i.center.y,i.center.z),new e.Vector3(-1,0,0));return this.rayPlaneInBBox(t,o,a,s),o=this.posdir(new e.Vector3(a.max.x,i.center.y,i.center.z),new e.Vector3(1,0,0)),this.rayPlaneInBBox(t,o,a,s),o=this.posdir(new e.Vector3(i.center.x,a.min.y,i.center.z),new e.Vector3(0,-1,0)),this.rayPlaneInBBox(t,o,a,s),o=this.posdir(new e.Vector3(i.center.x,a.max.y,i.center.z),new e.Vector3(0,1,0)),this.rayPlaneInBBox(t,o,a,s),o=this.posdir(new e.Vector3(i.center.x,i.center.y,a.min.z),new e.Vector3(0,0,-1)),this.rayPlaneInBBox(t,o,a,s),o=this.posdir(new e.Vector3(i.center.x,i.center.y,a.max.z),new e.Vector3(0,0,1)),this.rayPlaneInBBox(t,o,a,s),s}static rayPlaneInBBox(t,e,i,s){let a=this.rayPlane(t,e);a&&this.inBBox(a,i)&&(s.find(this.findIntersection(a))||s.push(a))}static findIntersection(t){return function(e,i,s){return t.x===e.x&&t.y===e.y&&t.z===e.z}}static inBBox(t,e){let i=1e-4;return!!(t&&t.x>=e.min.x-i&&t.y>=e.min.y-i&&t.z>=e.min.z-i&&t.x<=e.max.x+i&&t.y<=e.max.y+i&&t.z<=e.max.z+i)}static posdir(t,e){return{position:t,direction:e}}static validatePlane(t){return null===t?(console.log("Invalid plane."),console.log(t),!1):o.vector3(t.position)?!!o.vector3(t.direction)||(console.log("Invalid plane.direction."),console.log(t.direction),!1):(console.log("Invalid plane.position."),console.log(t.position),!1)}static validateAabb(t){return null===t?(console.log("Invalid aabb."),console.log(t),!1):o.matrix4(t.toAABB)?o.vector3(t.center)?!!(o.vector3(t.halfDimensions)&&t.halfDimensions.x>=0&&t.halfDimensions.y>=0&&t.halfDimensions.z>=0)||(console.log("Invalid aabb.halfDimensions."),console.log(t.halfDimensions),!1):(console.log("Invalid aabb.center."),console.log(t.center),!1):(console.log("Invalid aabb.toAABB: "),console.log(t.toAABB),!1)}}class r extends e.OrthographicCamera{constructor(t,i,s,a,o,n){super(t,i,s,a,o,n),this._front=null,this._back=null,this._directions=[new e.Vector3(1,0,0),new e.Vector3(0,1,0),new e.Vector3(0,0,1)],this._directionsLabel=["A","P","L","R","I","S"],this._orientation="default",this._convention="radio",this._stackOrientation=0,this._right=null,this._up=null,this._direction=null,this._controls=null,this._box=null,this._canvas={width:null,height:null},this._fromFront=!0,this._angle=0}init(t,i,s,a,n,r){if(console.warn("cameras.orthographic.init(...) is deprecated.\n\t\t\t\tUse .cosines, .controls, .box and .canvas instead."),!(o.vector3(t)&&o.vector3(i)&&o.vector3(s)&&o.box(n)&&a))return console.log("Invalid input provided."),!1;this._right=t,this._up=this._adjustTopDirection(t,i),this._direction=(new e.Vector3).crossVectors(this._right,this._up),this._controls=a,this._box=n,this._canvas=r;let h={position:this._box.center,direction:this._direction},c=this._orderIntersections(l.rayBox(h,this._box),this._direction);this._front=c[0],this._back=c[1],this.up.set(this._up.x,this._up.y,this._up.z),this._updateCanvas(),this._updatePositionAndTarget(this._front,this._back),this._updateMatrices(),this._updateDirections()}update(){if("default"===this._orientation)switch(this._getMaxIndex(this._directions[2])){case 0:this._orientation="sagittal";break;case 1:this._orientation="coronal";break;case 2:this._orientation="axial";break;default:this._orientation="free"}if("free"===this._orientation)this._right=this._directions[0],this._up=this._directions[1],this._direction=this._directions[2];else{let t=this.leftDirection(),e=this._directions[t],i=this.posteriorDirection(),s=this._directions[i],a=this.superiorDirection(),o=this._directions[a];if("radio"===this._convention)switch(this._orientation){case"axial":s.y>0&&s.negate(),o.z<0&&o.negate(),this._right=e,this._up=s,this._direction=o;break;case"coronal":o.z<0&&o.negate(),s.y<0&&s.negate(),this._right=e,this._up=o,this._direction=s;break;case"sagittal":o.z<0&&o.negate(),e.x>0&&e.negate(),this._right=s,this._up=o,this._direction=e;break;default:console.warn(`"${this._orientation}" orientation is not valid.\n\t\t\t\t\t\t\t\t\t(choices: axial, coronal, sagittal)`)}else if("neuro"===this._convention)switch(this._orientation){case"axial":s.y>0&&s.negate(),o.z>0&&o.negate(),this._right=e,this._up=s,this._direction=o;break;case"coronal":o.z<0&&o.negate(),s.y>0&&s.negate(),this._right=e,this._up=o,this._direction=s;break;case"sagittal":o.z<0&&o.negate(),e.x>0&&e.negate(),this._right=s,this._up=o,this._direction=e;break;default:console.warn(`"${this._orientation}" orientation is not valid.\n\t\t\t\t\t\t\t\t\t(choices: axial, coronal, sagittal)`)}else console.warn(`${this._convention} is not valid (choices: radio, neuro)`)}let t={position:this._box.center,direction:this._direction},e=this._orderIntersections(l.rayBox(t,this._box),this._direction);this._front=e[0],this._back=e[1],this.up.set(this._up.x,this._up.y,this._up.z),this._updateCanvas(),this._updatePositionAndTarget(this._front,this._back),this._updateMatrices(),this._updateDirections()}leftDirection(){return this._findMaxIndex(this._directions,0)}posteriorDirection(){return this._findMaxIndex(this._directions,1)}superiorDirection(){return this._findMaxIndex(this._directions,2)}invertRows(){this.up.multiplyScalar(-1),this.invertColumns(),this._updateDirections()}invertColumns(){this.center();let t=this._oppositePosition(this.position);this._updatePositionAndTarget(t,this.position.clone()),this._updateMatrices(),this._fromFront=!this._fromFront,this._angle%=360,this._angle=360-this._angle,this._updateDirections()}center(){this._fromFront?this._updatePositionAndTarget(this._front,this._back):this._updatePositionAndTarget(this._back,this._front),this._updateMatrices(),this._updateDirections()}rotate(t=null){this.center();let i=90;null===t?(i*=-1,this._angle+=90):(i=360-(t-this._angle),this._angle=t),this._angle%=360;let s=(new e.Matrix4).makeRotationAxis(this._direction,i*Math.PI/180);this.up.applyMatrix4(s),this._updateMatrices(),this._updateDirections()}fitBox(t=0,e=1.5){let i=1;switch(t){case 0:i=e*this._computeZoom(this._canvas.width,this._right);break;case 1:i=e*this._computeZoom(this._canvas.height,this._up);break;case 2:i=e*Math.min(this._computeZoom(this._canvas.width,this._right),this._computeZoom(this._canvas.height,this._up))}if(!i)return!1;this.zoom=i,this.center()}_adjustTopDirection(t,e){const i=this._getMaxIndex(e);return(2===i&&e.getComponent(i)<0||1===i&&e.getComponent(i)>0||0===i&&e.getComponent(i)>0)&&e.negate(),e}_getMaxIndex(t){let e=Math.abs(t.x),i=0;return Math.abs(t.y)>e&&(e=Math.abs(t.y),i=1),Math.abs(t.z)>e&&(i=2),i}_findMaxIndex(t,e){let i=this._getMaxIndices(t);for(let t=0;t<i.length;t++)if(i[t]===e)return t}_getMaxIndices(t){let e=[];return e.push(this._getMaxIndex(t[0])),e.push(this._getMaxIndex(t[1])),e.push(this._getMaxIndex(t[2])),e}_orderIntersections(t,e){return t[0].dot(e)<t[1].dot(e)?t:[t[1],t[0]]}_updateCanvas(){this.left=-this._canvas.width/2,this.right=this._canvas.width/2,this.top=this._canvas.height/2,this.bottom=-this._canvas.height/2,this._updateMatrices(),this.controls.handleResize()}_oppositePosition(t){let i=t.clone();i.sub(this._box.center);let s=(new e.Matrix4).makeRotationAxis(this.up,Math.PI);return i.applyMatrix4(s),i.add(this._box.center),i}_computeZoom(t,e){if(!(t&&t>0))return console.log("Invalid dimension provided."),console.log(t),!1;let i={position:this._box.center.clone(),direction:e},s=l.rayBox(i,this._box);return s.length<2?(console.log("Can not adjust the camera ( < 2 intersections)."),console.log(i),console.log(this._box),!1):t/s[0].distanceTo(s[1])}_updatePositionAndTarget(t,e){this.position.set(t.x,t.y,t.z),this.lookAt(e.x,e.y,e.z),this._controls.target.set(e.x,e.y,e.z)}_updateMatrices(){this._controls.update(),this.updateProjectionMatrix(),this.updateMatrixWorld()}_updateLabels(){this._directionsLabel=[this._vector2Label(this._up),this._vector2Label(this._up.clone().negate()),this._vector2Label(this._right),this._vector2Label(this._right.clone().negate()),this._vector2Label(this._direction),this._vector2Label(this._direction.clone().negate())]}_vector2Label(t){const e=this._getMaxIndex(t),i=t.clone().divideScalar(Math.abs(t.getComponent(e))),s=.2;let a="";for(let t=0;t<3;t++)0===t&&(i.getComponent(t)+s>=1?a+="L":i.getComponent(t)-s<=-1&&(a+="R")),1===t&&(i.getComponent(t)+s>=1?a+="P":i.getComponent(t)-s<=-1&&(a+="A")),2===t&&(i.getComponent(t)+s>=1?a+="S":i.getComponent(t)-s<=-1&&(a+="I"));return a}_updateDirections(){this._up=this.up.clone();let t=new e.Vector3(0,0,-1).applyMatrix4(this.matrixWorld);this._direction=t.sub(this.position).normalize(),this._right=(new e.Vector3).crossVectors(this._direction,this.up),this._updateLabels()}set controls(t){this._controls=t}get controls(){return this._controls}set box(t){this._box=t}get box(){return this._box}set canvas(t){this._canvas=t,this._updateCanvas()}get canvas(){return this._canvas}set angle(t){this.rotate(t)}get angle(){return this._angle}set directions(t){this._directions=t}get directions(){return this._directions}set convention(t){this._convention=t}get convention(){return this._convention}set orientation(t){this._orientation=t}get orientation(){return this._orientation}set directionsLabel(t){this._directionsLabel=t}get directionsLabel(){return this._directionsLabel}set stackOrientation(t){if(this._stackOrientation=t,0===this._stackOrientation)this._orientation="default";else{const t=this._getMaxIndex(this._directions[(this._stackOrientation+2)%3]);0===t?this._orientation="sagittal":1===t?this._orientation="coronal":2===t&&(this._orientation="axial")}}get stackOrientation(){if("default"===this._orientation)this._stackOrientation=0;else{let t=this._getMaxIndex(this._direction);t===this._getMaxIndex(this._directions[2])?this._stackOrientation=0:t===this._getMaxIndex(this._directions[0])?this._stackOrientation=1:t===this._getMaxIndex(this._directions[1])&&(this._stackOrientation=2)}return this._stackOrientation}}class h extends e.EventDispatcher{constructor(t,i){super();let s=this,a=-1,o=0,n=1,l=2,r=3,h=4,c=5,_=99;this.object=t,this.domElement=void 0!==i?i:document,this.enabled=!0,this.screen={left:0,top:0,width:0,height:0},this.rotateSpeed=1,this.zoomSpeed=1.2,this.panSpeed=.3,this.noRotate=!1,this.noZoom=!1,this.noPan=!1,this.noCustom=!1,this.forceState=-1,this.staticMoving=!1,this.dynamicDampingFactor=.2,this.minDistance=0,this.maxDistance=1/0,this.keys=[65,83,68],this.target=new e.Vector3;let d=new e.Vector3,p=a,u=a,m=new e.Vector3,y=new e.Vector2,b=new e.Vector2,g=new e.Vector3,f=0,v=new e.Vector2,x=new e.Vector2,w=0,S=0,M=new e.Vector2,P=new e.Vector2,C=new e.Vector2,L=new e.Vector2;this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.up0=this.object.up.clone();let I={type:"change"},D={type:"start"},E={type:"end"};this.handleResize=function(){if(this.domElement===document)this.screen.left=0,this.screen.top=0,this.screen.width=innerWidth,this.screen.height=innerHeight;else{let t=this.domElement.getBoundingClientRect(),e=this.domElement.ownerDocument.documentElement;this.screen.left=t.left+scrollX-e.clientLeft,this.screen.top=t.top+scrollY-e.clientTop,this.screen.width=t.width,this.screen.height=t.height}},this.handleEvent=function(t){"function"==typeof this[t.type]&&this[t.type](t)};let T=function(){let t=new e.Vector2;return function(e,i){return t.set((e-s.screen.left)/s.screen.width,(i-s.screen.top)/s.screen.height),t}}(),A=function(){let t=new e.Vector2;return function(e,i){return t.set((e-.5*s.screen.width-s.screen.left)/(.5*s.screen.width),(s.screen.height+2*(s.screen.top-i))/s.screen.width),t}}();function O(t){!1!==s.enabled&&(removeEventListener("keydown",O),u=p,p===a&&(t.keyCode!==s.keys[o]||s.noRotate?t.keyCode!==s.keys[n]||s.noZoom?t.keyCode!==s.keys[l]||s.noPan||(p=l):p=n:p=o))}function k(t){!1!==s.enabled&&(p=u,addEventListener("keydown",O,!1))}function H(t){!1!==s.enabled&&(t.preventDefault(),t.stopPropagation(),p===a&&(p=t.button),p!==o||s.noRotate?p!==n||s.noZoom?p!==l||s.noPan?p!==_||s.noCustom||(C.copy(T(t.pageX,t.pageY)),L.copy(M)):(M.copy(T(t.pageX,t.pageY)),P.copy(M)):(v.copy(T(t.pageX,t.pageY)),x.copy(v)):(b.copy(A(t.pageX,t.pageY)),y.copy(b)),document.addEventListener("mousemove",G,!1),document.addEventListener("mouseup",F,!1),s.dispatchEvent(D))}function G(t){!1!==s.enabled&&(t.preventDefault(),t.stopPropagation(),p!==o||s.noRotate?p!==n||s.noZoom?p!==l||s.noPan?p!==_||s.noCustom||L.copy(T(t.pageX,t.pageY)):P.copy(T(t.pageX,t.pageY)):x.copy(T(t.pageX,t.pageY)):(y.copy(b),b.copy(A(t.pageX,t.pageY))))}function F(t){!1!==s.enabled&&(t.preventDefault(),t.stopPropagation(),-1===s.forceState&&(p=a),document.removeEventListener("mousemove",G),document.removeEventListener("mouseup",F),s.dispatchEvent(E))}function V(t){if(!1!==s.enabled&&!0!==s.noZoom){switch(t.preventDefault(),t.stopPropagation(),t.deltaMode){case 2:v.y-=.025*t.deltaY;break;case 1:v.y-=.01*t.deltaY;break;default:v.y-=25e-5*t.deltaY}s.dispatchEvent(D),s.dispatchEvent(E)}}function R(t){if(!1!==s.enabled){if(-1===s.forceState)switch(t.touches.length){case 1:p=r,b.copy(A(t.touches[0].pageX,t.touches[0].pageY)),y.copy(b);break;case 2:p=h;var e=t.touches[0].pageX-t.touches[1].pageX,i=t.touches[0].pageY-t.touches[1].pageY;S=w=Math.sqrt(e*e+i*i);var o=(t.touches[0].pageX+t.touches[1].pageX)/2,d=(t.touches[0].pageY+t.touches[1].pageY)/2;M.copy(T(o,d)),P.copy(M);break;default:p=a}else switch(p){case 0:p=r,b.copy(A(t.touches[0].pageX,t.touches[0].pageY)),y.copy(b);break;case 1:case 4:if(t.touches.length>=2){p=h;e=t.touches[0].pageX-t.touches[1].pageX,i=t.touches[0].pageY-t.touches[1].pageY;S=w=Math.sqrt(e*e+i*i)}else p=n,v.copy(T(t.touches[0].pageX,t.touches[0].pageY)),x.copy(v);break;case 2:case 5:if(t.touches.length>=2){p=c;o=(t.touches[0].pageX+t.touches[1].pageX)/2,d=(t.touches[0].pageY+t.touches[1].pageY)/2;M.copy(T(o,d)),P.copy(M)}else p=l,M.copy(T(t.touches[0].pageX,t.touches[0].pageY)),P.copy(M);break;case 99:p=_;o=(t.touches[0].pageX+t.touches[1].pageX)/2,d=(t.touches[0].pageY+t.touches[1].pageY)/2;C.copy(T(o,d)),L.copy(C);break;default:p=a}s.dispatchEvent(D)}}function B(t){if(!1!==s.enabled)if(t.preventDefault(),t.stopPropagation(),-1===s.forceState)switch(t.touches.length){case 1:y.copy(b),b.copy(A(t.touches[0].pageX,t.touches[0].pageY));break;case 2:var e=t.touches[0].pageX-t.touches[1].pageX,i=t.touches[0].pageY-t.touches[1].pageY;S=Math.sqrt(e*e+i*i);var o=(t.touches[0].pageX+t.touches[1].pageX)/2,n=(t.touches[0].pageY+t.touches[1].pageY)/2;P.copy(T(o,n));break;default:p=a}else switch(p){case 0:y.copy(b),b.copy(A(t.touches[0].pageX,t.touches[0].pageY));break;case 1:x.copy(T(t.touches[0].pageX,t.touches[0].pageY));break;case 2:P.copy(T(t.touches[0].pageX,t.touches[0].pageY));break;case 4:e=t.touches[0].pageX-t.touches[1].pageX,i=t.touches[0].pageY-t.touches[1].pageY;S=Math.sqrt(e*e+i*i);break;case 5:o=(t.touches[0].pageX+t.touches[1].pageX)/2,n=(t.touches[0].pageY+t.touches[1].pageY)/2;P.copy(T(o,n));break;case 99:o=(t.touches[0].pageX+t.touches[1].pageX)/2,n=(t.touches[0].pageY+t.touches[1].pageY)/2;L.copy(T(o,n));break;default:p=a}}function z(t){if(!1!==s.enabled){if(-1===s.forceState){switch(t.touches.length){case 1:y.copy(b),b.copy(A(t.touches[0].pageX,t.touches[0].pageY));break;case 2:w=S=0;var e=(t.touches[0].pageX+t.touches[1].pageX)/2,i=(t.touches[0].pageY+t.touches[1].pageY)/2;P.copy(T(e,i)),M.copy(P)}p=a}else switch(p){case 0:y.copy(b),b.copy(A(t.touches[0].pageX,t.touches[0].pageY));break;case 1:case 2:break;case 4:w=S=0,p=n;break;case 5:if(t.touches.length>=2){e=(t.touches[0].pageX+t.touches[1].pageX)/2,i=(t.touches[0].pageY+t.touches[1].pageY)/2;P.copy(T(e,i)),M.copy(P)}p=l;break;case 99:e=(t.touches[0].pageX+t.touches[1].pageX)/2,i=(t.touches[0].pageY+t.touches[1].pageY)/2;L.copy(T(e,i)),C.copy(L);break;default:p=a}s.dispatchEvent(E)}}function N(t){t.preventDefault()}this.rotateCamera=function(){let t,i=new e.Vector3,a=new e.Quaternion,o=new e.Vector3,n=new e.Vector3,l=new e.Vector3,r=new e.Vector3;return function(){r.set(b.x-y.x,b.y-y.y,0),t=r.length(),t?(m.copy(s.object.position).sub(s.target),o.copy(m).normalize(),n.copy(s.object.up).normalize(),l.crossVectors(n,o).normalize(),n.setLength(b.y-y.y),l.setLength(b.x-y.x),r.copy(n.add(l)),i.crossVectors(r,m).normalize(),t*=s.rotateSpeed,a.setFromAxisAngle(i,t),m.applyQuaternion(a),s.object.up.applyQuaternion(a),g.copy(i),f=t):!s.staticMoving&&f&&(f*=Math.sqrt(1-s.dynamicDampingFactor),m.copy(s.object.position).sub(s.target),a.setFromAxisAngle(g,f),m.applyQuaternion(a),s.object.up.applyQuaternion(a)),y.copy(b)}}(),this.zoomCamera=function(){let t;p===h?(t=w/S,w=S,m.multiplyScalar(t)):(t=1+(x.y-v.y)*s.zoomSpeed,1!==t&&t>0&&(m.multiplyScalar(t),s.staticMoving?v.copy(x):v.y+=(x.y-v.y)*this.dynamicDampingFactor))},this.panCamera=function(){let t=new e.Vector2,i=new e.Vector3,a=new e.Vector3;return function(){t.copy(P).sub(M),t.lengthSq()&&(t.multiplyScalar(m.length()*s.panSpeed),a.copy(m).cross(s.object.up).setLength(t.x),a.add(i.copy(s.object.up).setLength(t.y)),s.object.position.add(a),s.target.add(a),s.staticMoving?M.copy(P):M.add(t.subVectors(P,M).multiplyScalar(s.dynamicDampingFactor)))}}(),this.checkDistances=function(){s.noZoom&&s.noPan||(m.lengthSq()>s.maxDistance*s.maxDistance&&s.object.position.addVectors(s.target,m.setLength(s.maxDistance)),m.lengthSq()<s.minDistance*s.minDistance&&s.object.position.addVectors(s.target,m.setLength(s.minDistance)))},this.update=function(){m.subVectors(s.object.position,s.target),s.noRotate||s.rotateCamera(),s.noZoom||s.zoomCamera(),s.noPan||s.panCamera(),s.noCustom||s.custom(C,L),s.object.position.addVectors(s.target,m),s.checkDistances(),s.object.lookAt(s.target),d.distanceToSquared(s.object.position)>1e-6&&(s.dispatchEvent(I),d.copy(s.object.position))},this.reset=function(){p=a,u=a,s.target.copy(s.target0),s.object.position.copy(s.position0),s.object.up.copy(s.up0),m.subVectors(s.object.position,s.target),s.object.lookAt(s.target),s.dispatchEvent(I),d.copy(s.object.position)},this.setState=function(t){s.forceState=t,u=t,p=t},this.custom=function(t,e){},this.dispose=function(){this.domElement.removeEventListener("contextmenu",N,!1),this.domElement.removeEventListener("mousedown",H,!1),this.domElement.removeEventListener("wheel",V,!1),this.domElement.removeEventListener("touchstart",R,!1),this.domElement.removeEventListener("touchend",z,!1),this.domElement.removeEventListener("touchmove",B,!1),removeEventListener("keydown",O,!1),removeEventListener("keyup",k,!1)},this.domElement.addEventListener("contextmenu",N,!1),this.domElement.addEventListener("mousedown",H,!1),this.domElement.addEventListener("wheel",V,!1),this.domElement.addEventListener("touchstart",R,!1),this.domElement.addEventListener("touchend",z,!1),this.domElement.addEventListener("touchmove",B,!1),addEventListener("keydown",O,!1),addEventListener("keyup",k,!1),this.handleResize(),this.update()}}class c extends e.EventDispatcher{constructor(t,i,s={NONE:-1,ROTATE:1,ZOOM:2,PAN:0,SCROLL:4,TOUCH_ROTATE:4,TOUCH_ZOOM_PAN:5}){super();let a=this,o=s;this.object=t,this.domElement=void 0!==i?i:document,this.enabled=!0,this.screen={left:0,top:0,width:0,height:0},this.radius=0,this.zoomSpeed=1.2,this.noZoom=!1,this.noPan=!1,this.staticMoving=!1,this.dynamicDampingFactor=.2,this.keys=[65,83,68],this.target=new e.Vector3;let n=!0,l=o.NONE,r=o.NONE,h=new e.Vector3,c=new e.Vector2,_=new e.Vector2,d=0,p=0,u=new e.Vector2,m=new e.Vector2;this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.up0=this.object.up.clone(),this.left0=this.object.left,this.right0=this.object.right,this.top0=this.object.top,this.bottom0=this.object.bottom;let y={type:"change"},b={type:"start"},g={type:"end"};this.handleResize=function(){if(this.domElement===document)this.screen.left=0,this.screen.top=0,this.screen.width=innerWidth,this.screen.height=innerHeight;else{let t=this.domElement.getBoundingClientRect(),e=this.domElement.ownerDocument.documentElement;this.screen.left=t.left+pageXOffset-e.clientLeft,this.screen.top=t.top+pageYOffset-e.clientTop,this.screen.width=t.width,this.screen.height=t.height}this.radius=.5*Math.min(this.screen.width,this.screen.height),this.left0=this.object.left,this.right0=this.object.right,this.top0=this.object.top,this.bottom0=this.object.bottom},this.handleEvent=function(t){"function"==typeof this[t.type]&&this[t.type](t)};let f=function(){let t=new e.Vector2;return function(e,i){return t.set((e-a.screen.left)/a.screen.width,(i-a.screen.top)/a.screen.height),t}}();function v(t){!1!==a.enabled&&(removeEventListener("keydown",v),r=l,l===o.NONE&&(t.keyCode!==a.keys[o.ROTATE]||a.noRotate?t.keyCode!==a.keys[o.ZOOM]||a.noZoom?t.keyCode!==a.keys[o.PAN]||a.noPan||(l=o.PAN):l=o.ZOOM:l=o.ROTATE))}function x(t){!1!==a.enabled&&(l=r,addEventListener("keydown",v,!1))}function w(t){!1!==a.enabled&&(t.preventDefault(),t.stopPropagation(),l===o.NONE&&(l=t.button),(l!==o.ROTATE||a.noRotate)&&(l!==o.ZOOM||a.noZoom?l!==o.PAN||a.noPan||(u.copy(f(t.pageX,t.pageY)),m.copy(u)):(c.copy(f(t.pageX,t.pageY)),_.copy(c))),document.addEventListener("mousemove",S,!1),document.addEventListener("mouseup",M,!1),a.dispatchEvent(b))}function S(t){!1!==a.enabled&&(t.preventDefault(),t.stopPropagation(),(l!==o.ROTATE||a.noRotate)&&(l!==o.ZOOM||a.noZoom?l!==o.PAN||a.noPan||m.copy(f(t.pageX,t.pageY)):_.copy(f(t.pageX,t.pageY))))}function M(t){!1!==a.enabled&&(t.preventDefault(),t.stopPropagation(),l=o.NONE,document.removeEventListener("mousemove",S),document.removeEventListener("mouseup",M),a.dispatchEvent(g))}function P(t){!1!==a.enabled&&(t.preventDefault(),t.stopPropagation(),a.dispatchEvent({type:"OnScroll",delta:.01*t.deltaX+.01*t.deltaY}),a.dispatchEvent(b),a.dispatchEvent(g))}function C(t){if(!1!==a.enabled){switch(t.touches.length){case 1:l=o.TOUCH_ROTATE;break;case 2:l=o.TOUCH_ZOOM_PAN;var e=t.touches[0].pageX-t.touches[1].pageX,i=t.touches[0].pageY-t.touches[1].pageY;p=d=Math.sqrt(e*e+i*i);var s=(t.touches[0].pageX+t.touches[1].pageX)/2,n=(t.touches[0].pageY+t.touches[1].pageY)/2;u.copy(f(s,n)),m.copy(u);break;default:l=o.NONE}a.dispatchEvent(b)}}function L(t){if(!1!==a.enabled)switch(t.preventDefault(),t.stopPropagation(),t.touches.length){case 1:break;case 2:var e=t.touches[0].pageX-t.touches[1].pageX,i=t.touches[0].pageY-t.touches[1].pageY;p=Math.sqrt(e*e+i*i);var s=(t.touches[0].pageX+t.touches[1].pageX)/2,n=(t.touches[0].pageY+t.touches[1].pageY)/2;m.copy(f(s,n));break;default:l=o.NONE}}function I(t){if(!1!==a.enabled){switch(t.touches.length){case 1:break;case 2:d=p=0;var e=(t.touches[0].pageX+t.touches[1].pageX)/2,i=(t.touches[0].pageY+t.touches[1].pageY)/2;m.copy(f(e,i)),u.copy(m)}l=o.NONE,a.dispatchEvent(g)}}function D(t){t.preventDefault()}this.zoomCamera=function(){if(l===o.TOUCH_ZOOM_PAN){var t=p/d;d=p,a.object.zoom*=t,n=!0}else{t=1+(_.y-c.y)*a.zoomSpeed;Math.abs(t-1)>1e-6&&t>0&&(a.object.zoom/=t,a.staticMoving?c.copy(_):c.y+=(_.y-c.y)*this.dynamicDampingFactor,n=!0)}},this.panCamera=function(){let t=new e.Vector2,i=new e.Vector3,s=new e.Vector3;return function(){if(t.copy(m).sub(u),t.lengthSq()){let e=(a.object.right-a.object.left)/a.object.zoom,o=(a.object.top-a.object.bottom)/a.object.zoom;t.x*=e,t.y*=o,s.copy(h).cross(a.object.up).setLength(t.x),s.add(i.copy(a.object.up).setLength(t.y)),a.object.position.add(s),a.target.add(s),a.staticMoving?u.copy(m):u.add(t.subVectors(m,u).multiplyScalar(a.dynamicDampingFactor)),n=!0}}}(),this.update=function(){h.subVectors(a.object.position,a.target),a.noZoom||(a.zoomCamera(),n&&a.object.updateProjectionMatrix()),a.noPan||a.panCamera(),a.object.position.addVectors(a.target,h),a.object.lookAt(a.target),n&&(a.dispatchEvent(y),n=!1)},this.reset=function(){l=o.NONE,r=o.NONE,a.target.copy(a.target0),a.object.position.copy(a.position0),a.object.up.copy(a.up0),h.subVectors(a.object.position,a.target),a.object.left=a.left0,a.object.right=a.right0,a.object.top=a.top0,a.object.bottom=a.bottom0,a.object.lookAt(a.target),a.dispatchEvent(y),n=!1},this.dispose=function(){this.domElement.removeEventListener("contextmenu",D,!1),this.domElement.removeEventListener("mousedown",w,!1),this.domElement.removeEventListener("wheel",P,!1),this.domElement.removeEventListener("touchstart",C,!1),this.domElement.removeEventListener("touchend",I,!1),this.domElement.removeEventListener("touchmove",L,!1),removeEventListener("keydown",v,!1),removeEventListener("keyup",x,!1)},this.domElement.addEventListener("contextmenu",D,!1),this.domElement.addEventListener("mousedown",w,!1),this.domElement.addEventListener("wheel",P,!1),this.domElement.addEventListener("touchstart",C,!1),this.domElement.addEventListener("touchend",I,!1),this.domElement.addEventListener("touchmove",L,!1),addEventListener("keydown",v,!1),addEventListener("keyup",x,!1),this.handleResize(),this.update()}}class _ extends e.EventDispatcher{get center(){return console.warn("OrbitControls: .center has been renamed to .target"),this.target}get noZoom(){return console.warn("OrbitControls: .noZoom has been deprecated. Use .enableZoom instead."),!this.enableZoom}set noZoom(t){console.warn("OrbitControls: .noZoom has been deprecated. Use .enableZoom instead."),this.enableZoom=!t}get noRotate(){return console.warn("OrbitControls: .noRotate has been deprecated. Use .enableRotate instead."),!this.enableRotate}set noRotate(t){console.warn("OrbitControls: .noRotate has been deprecated. Use .enableRotate instead."),this.enableRotate=!t}get noPan(){return console.warn("OrbitControls: .noPan has been deprecated. Use .enablePan instead."),!this.enablePan}set noPan(t){console.warn("OrbitControls: .noPan has been deprecated. Use .enablePan instead."),this.enablePan=!t}get noKeys(){return console.warn("OrbitControls: .noKeys has been deprecated. Use .enableKeys instead."),!this.enableKeys}set noKeys(t){console.warn("OrbitControls: .noKeys has been deprecated. Use .enableKeys instead."),this.enableKeys=!t}get staticMoving(){return console.warn("OrbitControls: .staticMoving has been deprecated. Use .enableDamping instead."),!this.enableDamping}set staticMoving(t){console.warn("OrbitControls: .staticMoving has been deprecated. Use .enableDamping instead."),this.enableDamping=!t}get dynamicDampingFactor(){return console.warn("OrbitControls: .dynamicDampingFactor has been renamed. Use .dampingFactor instead."),this.dampingFactor}set dynamicDampingFactor(t){console.warn("OrbitControls: .dynamicDampingFactor has been renamed. Use .dampingFactor instead."),this.dampingFactor=t}constructor(t,i){var s,a,o,n,l;this.object=t,this.domElement=void 0!==i?i:document,this.enabled=!0,this.preventDefault=!0,this.target=new e.Vector3,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.enableDamping=!1,this.dampingFactor=.25,this.enableZoom=!0,this.zoomSpeed=1,this.enableRotate=!0,this.rotateSpeed=1,this.enablePan=!0,this.panSpeed=1,this.screenSpacePanning=!1,this.keyPanSpeed=7,this.autoRotate=!1,this.autoRotateSpeed=2,this.enableKeys=!0,this.keys={LEFT:37,UP:38,RIGHT:39,BOTTOM:40},this.mouseButtons={LEFT:e.MOUSE.LEFT,MIDDLE:e.MOUSE.MIDDLE,RIGHT:e.MOUSE.RIGHT},this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this.getPolarAngle=function(){return m.phi},this.getAzimuthalAngle=function(){return m.theta},this.saveState=function(){r.target0.copy(r.target),r.position0.copy(r.object.position),r.zoom0=r.object.zoom},this.reset=function(){r.target.copy(r.target0),r.object.position.copy(r.position0),r.object.zoom=r.zoom0,r.object.updateProjectionMatrix(),r.dispatchEvent(h),r.update(),p=d.NONE},this.handleResize=function(){},this.update=(s=new e.Vector3,a=(new e.Quaternion).setFromUnitVectors(t.up,new e.Vector3(0,1,0)),o=a.clone().inverse(),n=new e.Vector3,l=new e.Quaternion,function(){var t=r.object.position;return s.copy(t).sub(r.target),s.applyQuaternion(a),m.setFromVector3(s),r.autoRotate&&p===d.NONE&&E(2*Math.PI/60/60*r.autoRotateSpeed),m.theta+=y.theta,m.phi+=y.phi,m.theta=Math.max(r.minAzimuthAngle,Math.min(r.maxAzimuthAngle,m.theta)),m.phi=Math.max(r.minPolarAngle,Math.min(r.maxPolarAngle,m.phi)),m.makeSafe(),m.radius*=b,m.radius=Math.max(r.minDistance,Math.min(r.maxDistance,m.radius)),r.target.add(g),s.setFromSpherical(m),s.applyQuaternion(o),t.copy(r.target).add(s),r.object.lookAt(r.target),!0===r.enableDamping?(y.theta*=1-r.dampingFactor,y.phi*=1-r.dampingFactor,g.multiplyScalar(1-r.dampingFactor)):(y.set(0,0,0),g.set(0,0,0)),b=1,!!(f||n.distanceToSquared(r.object.position)>u||8*(1-l.dot(r.object.quaternion))>u)&&(r.dispatchEvent(h),n.copy(r.object.position),l.copy(r.object.quaternion),f=!1,!0)}),this.dispose=function(){r.domElement.removeEventListener("contextmenu",Y,!1),r.domElement.removeEventListener("mousedown",R,!1),r.domElement.removeEventListener("wheel",N,!1),r.domElement.removeEventListener("touchstart",j,!1),r.domElement.removeEventListener("touchend",$,!1),r.domElement.removeEventListener("touchmove",W,!1),document.removeEventListener("mousemove",B,!1),document.removeEventListener("mouseup",z,!1),removeEventListener("keydown",U,!1)};var r=this,h={type:"change"},c={type:"start"},_={type:"end"},d={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_DOLLY_PAN:4},p=d.NONE,u=1e-6,m=new e.Spherical,y=new e.Spherical,b=1,g=new e.Vector3,f=!1,v=new e.Vector2,x=new e.Vector2,w=new e.Vector2,S=new e.Vector2,M=new e.Vector2,P=new e.Vector2,C=new e.Vector2,L=new e.Vector2,I=new e.Vector2;function D(){return Math.pow(.95,r.zoomSpeed)}function E(t){y.theta-=t}function T(t){y.phi-=t}var A,O=(A=new e.Vector3,function(t,e){A.setFromMatrixColumn(e,0),A.multiplyScalar(-t),g.add(A)}),k=function(){var t=new e.Vector3;return function(e,i){!0===r.screenSpacePanning?t.setFromMatrixColumn(i,1):(t.setFromMatrixColumn(i,0),t.crossVectors(r.object.up,t)),t.multiplyScalar(e),g.add(t)}}(),H=function(){var t=new e.Vector3;return function(e,i){var s=r.domElement===document?r.domElement.body:r.domElement;if(r.object.isPerspectiveCamera){var a=r.object.position;t.copy(a).sub(r.target);var o=t.length();o*=Math.tan(r.object.fov/2*Math.PI/180),O(2*e*o/s.clientHeight,r.object.matrix),k(2*i*o/s.clientHeight,r.object.matrix)}else r.object.isOrthographicCamera?(O(e*(r.object.right-r.object.left)/r.object.zoom/s.clientWidth,r.object.matrix),k(i*(r.object.top-r.object.bottom)/r.object.zoom/s.clientHeight,r.object.matrix)):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled."),r.enablePan=!1)}}();function G(t){r.object.isPerspectiveCamera?b/=t:r.object.isOrthographicCamera?(r.object.zoom=Math.max(r.minZoom,Math.min(r.maxZoom,r.object.zoom*t)),r.object.updateProjectionMatrix(),f=!0):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),r.enableZoom=!1)}function F(t){r.object.isPerspectiveCamera?b*=t:r.object.isOrthographicCamera?(r.object.zoom=Math.max(r.minZoom,Math.min(r.maxZoom,r.object.zoom/t)),r.object.updateProjectionMatrix(),f=!0):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),r.enableZoom=!1)}function V(t){S.set(t.clientX,t.clientY)}function R(t){if(!1!==r.enabled){switch(!0===r.preventDefault&&t.preventDefault(),t.button){case r.mouseButtons.LEFT:if(t.ctrlKey||t.metaKey||t.shiftKey){if(!1===r.enablePan)return;V(t),p=d.PAN}else{if(!1===r.enableRotate)return;!function(t){v.set(t.clientX,t.clientY)}(t),p=d.ROTATE}break;case r.mouseButtons.MIDDLE:if(!1===r.enableZoom)return;!function(t){C.set(t.clientX,t.clientY)}(t),p=d.DOLLY;break;case r.mouseButtons.RIGHT:if(!1===r.enablePan)return;V(t),p=d.PAN}p!==d.NONE&&(document.addEventListener("mousemove",B,!1),document.addEventListener("mouseup",z,!1),r.dispatchEvent(c))}}function B(t){if(!1!==r.enabled)switch(!0===r.preventDefault&&t.preventDefault(),p){case d.ROTATE:if(!1===r.enableRotate)return;!function(t){x.set(t.clientX,t.clientY),w.subVectors(x,v).multiplyScalar(r.rotateSpeed);var e=r.domElement===document?r.domElement.body:r.domElement;E(2*Math.PI*w.x/e.clientHeight),T(2*Math.PI*w.y/e.clientHeight),v.copy(x),r.update()}(t);break;case d.DOLLY:if(!1===r.enableZoom)return;!function(t){L.set(t.clientX,t.clientY),I.subVectors(L,C),I.y>0?G(D()):I.y<0&&F(D()),C.copy(L),r.update()}(t);break;case d.PAN:if(!1===r.enablePan)return;!function(t){M.set(t.clientX,t.clientY),P.subVectors(M,S).multiplyScalar(r.panSpeed),H(P.x,P.y),S.copy(M),r.update()}(t)}}function z(t){!1!==r.enabled&&(document.removeEventListener("mousemove",B,!1),document.removeEventListener("mouseup",z,!1),r.dispatchEvent(_),p=d.NONE)}function N(t){!1===r.enabled||!1===r.enableZoom||p!==d.NONE&&p!==d.ROTATE||(!0===r.preventDefault&&(t.preventDefault(),t.stopPropagation()),r.dispatchEvent(c),function(t){t.deltaY<0?F(D()):t.deltaY>0&&G(D()),r.update()}(t),r.dispatchEvent(_))}function U(t){!1!==r.enabled&&!1!==r.enableKeys&&!1!==r.enablePan&&function(t){switch(t.keyCode){case r.keys.UP:H(0,r.keyPanSpeed),r.update();break;case r.keys.BOTTOM:H(0,-r.keyPanSpeed),r.update();break;case r.keys.LEFT:H(r.keyPanSpeed,0),r.update();break;case r.keys.RIGHT:H(-r.keyPanSpeed,0),r.update()}}(t)}function j(t){if(!1!==r.enabled){switch(!0===r.preventDefault&&t.preventDefault(),t.touches.length){case 1:if(!1===r.enableRotate)return;!function(t){v.set(t.touches[0].pageX,t.touches[0].pageY)}(t),p=d.TOUCH_ROTATE;break;case 2:if(!1===r.enableZoom&&!1===r.enablePan)return;!function(t){if(r.enableZoom){var e=t.touches[0].pageX-t.touches[1].pageX,i=t.touches[0].pageY-t.touches[1].pageY,s=Math.sqrt(e*e+i*i);C.set(0,s)}if(r.enablePan){var a=.5*(t.touches[0].pageX+t.touches[1].pageX),o=.5*(t.touches[0].pageY+t.touches[1].pageY);S.set(a,o)}}(t),p=d.TOUCH_DOLLY_PAN;break;default:p=d.NONE}p!==d.NONE&&r.dispatchEvent(c)}}function W(t){if(!1!==r.enabled)switch(!0===r.preventDefault&&(t.preventDefault(),t.stopPropagation()),t.touches.length){case 1:if(!1===r.enableRotate)return;if(p!==d.TOUCH_ROTATE)return;!function(t){x.set(t.touches[0].pageX,t.touches[0].pageY),w.subVectors(x,v).multiplyScalar(r.rotateSpeed);var e=r.domElement===document?r.domElement.body:r.domElement;E(2*Math.PI*w.x/e.clientHeight),T(2*Math.PI*w.y/e.clientHeight),v.copy(x),r.update()}(t);break;case 2:if(!1===r.enableZoom&&!1===r.enablePan)return;if(p!==d.TOUCH_DOLLY_PAN)return;!function(t){if(r.enableZoom){var e=t.touches[0].pageX-t.touches[1].pageX,i=t.touches[0].pageY-t.touches[1].pageY,s=Math.sqrt(e*e+i*i);L.set(0,s),I.set(0,Math.pow(L.y/C.y,r.zoomSpeed)),G(I.y),C.copy(L)}if(r.enablePan){var a=.5*(t.touches[0].pageX+t.touches[1].pageX),o=.5*(t.touches[0].pageY+t.touches[1].pageY);M.set(a,o),P.subVectors(M,S).multiplyScalar(r.panSpeed),H(P.x,P.y),S.copy(M)}r.update()}(t);break;default:p=d.NONE}}function $(t){!1!==r.enabled&&(r.dispatchEvent(_),p=d.NONE)}function Y(t){!1!==r.enabled&&!0===r.preventDefault&&t.preventDefault()}r.domElement.addEventListener("contextmenu",Y,!1),r.domElement.addEventListener("mousedown",R,!1),r.domElement.addEventListener("wheel",N,!1),r.domElement.addEventListener("touchstart",j,!1),r.domElement.addEventListener("touchend",$,!1),r.domElement.addEventListener("touchmove",W,!1),addEventListener("keydown",U,!1),this.update()}}const d="#00B0FF",p="#FFEB3B",u="#F50057",m="#76FF03",y="#FFF",b="#F77";class g{static cielab2XYZ(t,e,i){let s=(t+16)/116,a=e/500+s,o=s-i/200;return s=Math.pow(s,3)>.008856?Math.pow(s,3):(s-16/116)/7.787,a=Math.pow(a,3)>.008856?Math.pow(a,3):(a-16/116)/7.787,o=Math.pow(o,3)>.008856?Math.pow(o,3):(o-16/116)/7.787,[95.047*a,100*s,108.883*o]}static xyz2RGB(t,e,i){let s=3.2406*(t/=100)+-1.5372*(e/=100)+-.4986*(i/=100),a=-.9689*t+1.8758*e+.0415*i,o=.0557*t+-.204*e+1.057*i;return s>.0031308?s=1.055*Math.pow(s,1/2.4)-.055:s*=12.92,a>.0031308?a=1.055*Math.pow(a,1/2.4)-.055:a*=12.92,o>.0031308?o=1.055*Math.pow(o,1/2.4)-.055:o*=12.92,s*=255,a*=255,o*=255,[s,a,o]}static cielab2RGB(t=50,e=0,i=0){if(!(t>=0&&t<=100))return null;const[s,a,o]=this.cielab2XYZ(t,e,i);return this.xyz2RGB(s,a,o)}}class f extends e.ShapeBufferGeometry{constructor(t,i,s,a,o=new e.Matrix4){let r={halfDimensions:t,center:i,toAABB:o},h={position:s,direction:a},c=l.aabbPlane(r,h);if(c.length<3){console.log("WARNING: Less than 3 intersections between AABB and Plane."),console.log("AABB"),console.log(r),console.log("Plane"),console.log(h),console.log("exiting...");throw new Error("geometries.slice has less than 3 intersections, can not create a valid geometry.")}let _=n.orderIntersections(c,a),d=new e.Shape;d.moveTo(_[0].xy.x,_[0].xy.y);const p=new Float32Array(3*_.length);p.set(_[0].toArray(),0);for(let t=1;t<_.length;t++)p.set(_[t].toArray(),3*t),d.lineTo(_[t].xy.x,_[t].xy.y);d.lineTo(_[0].xy.x,_[0].xy.y),super(d),this.type="SliceBufferGeometry",this.setAttribute("position",new e.Float32BufferAttribute(p,3)),this.vertices=_}}class v extends e.BoxGeometry{constructor(t){super(1,1,1),this._location=t,this.applyMatrix((new e.Matrix4).makeTranslation(this._location.x,this._location.y,this._location.z)),this.verticesNeedUpdate=!0}resetVertices(){this.vertices[0].set(.5,.5,.5),this.vertices[1].set(.5,.5,-.5),this.vertices[2].set(.5,-.5,.5),this.vertices[3].set(.5,-.5,-.5),this.vertices[4].set(-.5,.5,-.5),this.vertices[5].set(-.5,.5,.5),this.vertices[6].set(-.5,-.5,-.5),this.vertices[7].set(-.5,-.5,.5)}set location(t){this._location=t,this.vertices[0].set(.5,.5,.5),this.vertices[1].set(.5,.5,-.5),this.vertices[2].set(.5,-.5,.5),this.vertices[3].set(.5,-.5,-.5),this.vertices[4].set(-.5,.5,-.5),this.vertices[5].set(-.5,.5,.5),this.vertices[6].set(-.5,-.5,-.5),this.vertices[7].set(-.5,-.5,.5),this.applyMatrix((new e.Matrix4).makeTranslation(this._location.x,this._location.y,this._location.z)),this.verticesNeedUpdate=!0}get location(){return this._location}}class x extends e.Object3D{constructor(t){super(),this._helpersSlice=t,this._visible=!0,this._color=16711680,this._material=null,this._geometry=null,this._mesh=null,this._create()}set helpersSlice(t){this._helpersSlice=t,this._update()}get helpersSlice(){return this._helpersSlice}set visible(t){this._visible=t,this._mesh&&(this._mesh.visible=this._visible)}get visible(){return this._visible}set color(t){this._color=t,this._material&&this._material.color.set(this._color)}get color(){return this._color}_create(){if(this._material||(this._material=new e.LineBasicMaterial({color:this._color,linewidth:1})),!this._helpersSlice.geometry.vertices)return;this._geometry=new e.BufferGeometry;const t=this._helpersSlice.geometry.vertices.length,i=new Float32Array(3*(t+1));i.set(this._helpersSlice.geometry.attributes.position.array,0),i.set(this._helpersSlice.geometry.vertices[0].toArray(),3*t),this._geometry.setAttribute("position",new e.Float32BufferAttribute(i,3)),this._mesh=new e.Line(this._geometry,this._material),"IJK"===this._helpersSlice.aabbSpace&&this._mesh.applyMatrix4(this._helpersSlice.stack.ijk2LPS),this._mesh.visible=this._visible,this.add(this._mesh)}_update(){this._mesh&&(this.remove(this._mesh),this._mesh.geometry.dispose(),this._mesh=null),this._create()}dispose(){this._mesh.material.dispose(),this._mesh.material=null,this._geometry.dispose(),this._geometry=null,this._material.dispose(),this._material=null}}class w extends e.Object3D{constructor(t){super(),this._stack=t,this._visible=!0,this._color=16777215,this._material=null,this._geometry=null,this._mesh=null,this._meshStack=null,this._create()}set visible(t){this._visible=t,this._mesh&&(this._mesh.visible=this._visible)}get visible(){return this._visible}set color(t){this._color=t,this._material&&this._material.color.set(this._color)}get color(){return this._color}_create(){const t=this._stack.dimensionsIJK,i=this._stack.halfDimensionsIJK,s=new e.Vector3(-.5,-.5,-.5),a=new e.BoxGeometry(t.x,t.y,t.z);a.applyMatrix4((new e.Matrix4).makeTranslation(i.x+s.x,i.y+s.y,i.z+s.z)),this._geometry=a,this._material=new e.MeshBasicMaterial({wireframe:!0});const o=new e.Mesh(this._geometry,null);o.applyMatrix4(this._stack.ijk2LPS),o.visible=this._visible,this._meshStack=o,this._mesh=new e.BoxHelper(this._meshStack,this._color),this._material=this._mesh.material,this.add(this._mesh)}_update(){this._mesh&&(this.remove(this._mesh),this._mesh.geometry.dispose(),this._mesh.geometry=null,this._mesh.material.dispose(),this._mesh.material=null,this._mesh=null),this._create()}dispose(){this._mesh.material.dispose(),this._mesh.material=null,this._geometry.dispose(),this._geometry=null,this._material.dispose(),this._material=null}}class S{static uniforms(){return{uCanvasWidth:{type:"f",value:0,typeGLSL:"float"},uCanvasHeight:{type:"f",value:0,typeGLSL:"float"},uWidth:{type:"f",value:1,typeGLSL:"float"},uOpacity:{type:"f",value:1,typeGLSL:"float"},uTextureFilled:{type:"t",value:[],typeGLSL:"sampler2D"}}}}class M{compute(){return"\nvarying vec4 vProjectedCoords;\n\n//\n// main\n//\nvoid main() {\n\n\tvec4 vPos = modelMatrix * vec4(position, 1.0 );\n\tmat4 vProjectionViewMatrix = projectionMatrix * viewMatrix;\n\tvProjectedCoords =\tprojectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0 );\n\n}\n\t\t\t\t"}}class P{constructor(t){this._uniforms=t,this._functions={},this._main=""}functions(){""===this._main&&this.main();let t="";for(let e in this._functions)t+=this._functions[e]+"\n";return t}uniforms(){let t="";for(let e in this._uniforms){let i=this._uniforms[e];t+=`uniform ${i.typeGLSL} ${e}`,i&&i.length&&(t+=`[${i.length}]`),t+=";\n"}return t}main(){this._main="\n\nfloat luma (vec3 rgb) {\n\treturn (rgb.r + rgb.g + rgb.b)/3.0;\n}\n\nconst float T = 0.04;\nconst float M = 1.0;\nconst float L = 0.002;\n\nvoid main(void) {\n\n\tvec2 texCoord = vec2(((vProjectedCoords.x / vProjectedCoords.w) + 1.0 ) / 2.0,\n\t\t\t\t\t\t\t\t((vProjectedCoords.y / vProjectedCoords.w) + 1.0 ) / 2.0 );\n\n\tfloat borderWidth = uWidth; // in px\n\tfloat step_u = borderWidth * 1.0 / uCanvasWidth;\n\tfloat step_v = borderWidth * 1.0 / uCanvasHeight;\n\tvec4 centerPixel = texture2D(uTextureFilled, texCoord);\n\n\tvec4 rightPixel\t= texture2D(uTextureFilled, texCoord + vec2(step_u, 0.0));\n\tvec4 bottomPixel = texture2D(uTextureFilled, texCoord + vec2(0.0, step_v));\n\n\t// now manually compute the derivatives\n\tfloat _dFdX = length(rightPixel - centerPixel) / step_u;\n\tfloat _dFdY = length(bottomPixel - centerPixel) / step_v;\n\n\t// gl_FragColor.r = _dFdX;\n\t// gl_FragColor.g = _dFdY;\n\tgl_FragColor.r = max(max(centerPixel.r, rightPixel.r), bottomPixel.r);\n\tgl_FragColor.g = max(max(centerPixel.g, rightPixel.g), bottomPixel.g);\n\tgl_FragColor.b = max(max(centerPixel.b, rightPixel.b), bottomPixel.b);\n\tfloat maxDerivative = max(_dFdX, _dFdY);\n\tfloat clampedDerivative = clamp(maxDerivative, 0., 1.);\n\tgl_FragColor.a = uOpacity * clampedDerivative;\n\n\treturn;\n\t// float h = 1./uCanvasHeight;\n\t// float w = 1./uCanvasWidth;\n\t// vec4 n[9];\n\t// n[0] = texture2D(uTextureFilled, vProjectedTextCoords + vec2( -w, -h));\n\t// n[1] = texture2D(uTextureFilled, vProjectedTextCoords + vec2(0.0, -h));\n\t// n[2] = texture2D(uTextureFilled, vProjectedTextCoords + vec2(\tw, -h));\n\t// n[3] = texture2D(uTextureFilled, vProjectedTextCoords + vec2( -w, 0.0));\n\t// n[4] = texture2D(uTextureFilled, vProjectedTextCoords);\n\t// n[5] = texture2D(uTextureFilled, texCoord + vec2(\tw, 0.0));\n\t// n[6] = texture2D(uTextureFilled, texCoord + vec2( -w, h));\n\t// n[7] = texture2D(uTextureFilled, texCoord + vec2(0.0, h));\n\t// n[8] = texture2D(uTextureFilled, texCoord + vec2(\tw, h));\n\t// vec4 sobel_horizEdge = n[2] + (2.0*n[5]) + n[8] - (n[0] + (2.0*n[3]) + n[6]);\n\t// vec4 sobel_vertEdge\t= n[0] + (2.0*n[1]) + n[2] - (n[6] + (2.0*n[7]) + n[8]);\n\t// vec3 sobel = sqrt((sobel_horizEdge.rgb * sobel_horizEdge.rgb) + (sobel_vertEdge.rgb * sobel_vertEdge.rgb));\n\t// gl_FragColor = vec4( sobel, max(max(sobel.r, sobel.g), sobel.b) );\n\n\t// return;\n}\n\t "}compute(){return`\n// uniforms\n${this.uniforms()}\n\n// varying (should fetch it from vertex directly)\nvarying vec4\t\t\tvProjectedCoords;\n\n// tailored functions\n${this.functions()}\n\n// main loop\n${this._main}\n\t\t\t`}}class C extends e.Object3D{constructor(t,e,i){super(),this._stack=t,this._textureToFilter=i,this._contourWidth=1,this._contourOpacity=1,this._canvasWidth=0,this._canvasHeight=0,this._shadersFragment=P,this._shadersVertex=M,this._uniforms=S.uniforms(),this._material=null,this._geometry=e,this._create()}_create(){this._prepareMaterial(),this._mesh=new e.Mesh(this._geometry,this._material),this._mesh.applyMatrix4(this._stack._ijk2LPS),this.add(this._mesh)}_prepareMaterial(){if(!this._material){this._uniforms.uWidth.value=this._contourWidth,this._uniforms.uOpacity.value=this._contourOpacity,this._uniforms.uCanvasWidth.value=this._canvasWidth,this._uniforms.uCanvasHeight.value=this._canvasHeight;let t=new P(this._uniforms),i=new M;this._material=new e.ShaderMaterial({side:e.DoubleSide,uniforms:this._uniforms,vertexShader:i.compute(),fragmentShader:t.compute(),transparent:!0})}}update(){this._mesh&&(this.remove(this._mesh),this._mesh.geometry.dispose(),this._mesh.geometry=null,this._mesh=null),this._create()}dispose(){null!==this._textureToFilter&&(this._textureToFilter.dispose(),this._textureToFilter=null),this._shadersFragment=null,this._shadersVertex=null,this._uniforms=null,this.remove(this._mesh),this._mesh.geometry.dispose(),this._mesh.geometry=null,this._mesh.material.dispose(),this._mesh.material=null,this._mesh=null,this._geometry.dispose(),this._geometry=null,this._material.vertexShader=null,this._material.fragmentShader=null,this._material.uniforms=null,this._material.dispose(),this._material=null,this._stack=null}get geometry(){return this._geometry}set geometry(t){this._mesh&&(this.remove(this._mesh),this._mesh.geometry.dispose(),this._mesh.geometry=null,this._mesh=null,this._geometry.dispose(),this._geometry=null),this._geometry=t,this._create()}get textureToFilter(){return this._textureToFilter}set textureToFilter(t){this._textureToFilter=t,this._uniforms.uTextureFilled.value=t,this._material.needsUpdate=!0}get contourOpacity(){return this._contourOpacity}set contourOpacity(t){this._contourOpacity=t,this._uniforms.uOpacity.value=this._contourOpacity}get contourWidth(){return this._contourWidth}set contourWidth(t){this._contourWidth=t,this._uniforms.uWidth.value=this._contourWidth}get canvasWidth(){return this._canvasWidth}set canvasWidth(t){this._canvasWidth=t,this._uniforms.uCanvasWidth.value=this._canvasWidth}get canvasHeight(){return this._canvasHeight}set canvasHeight(t){this._canvasHeight=t,this._uniforms.uCanvasHeight.value=this._canvasHeight}}class L{static uniforms(){return{uCanvasWidth:{type:"f",value:0,typeGLSL:"float"},uCanvasHeight:{type:"f",value:0,typeGLSL:"float"},uSlice:{type:"v4",value:[0,0,0,0],typeGLSL:"vec4"},uPlane1:{type:"v4",value:[0,0,0,0],typeGLSL:"vec4"},uPlaneColor1:{type:"v3",value:[1,1,0],typeGLSL:"vec3"},uPlane2:{type:"v4",value:[0,0,0,0],typeGLSL:"vec4"},uPlaneColor2:{type:"v3",value:[1,1,0],typeGLSL:"vec3"},uPlane3:{type:"v4",value:[0,0,0,0],typeGLSL:"vec4"},uPlaneColor3:{type:"v3",value:[1,1,0],typeGLSL:"vec3"}}}}class I{compute(){return"\nvarying vec4 vPos;\nvarying mat4 vProjectionViewMatrix;\n\n//\n// main\n//\nvoid main() {\n\n\tvPos = modelMatrix * vec4(position, 1.0 );\n\tvProjectionViewMatrix = projectionMatrix * viewMatrix;\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0 );\n\n}\n\t\t\t\t"}}class D{constructor(t){this._uniforms=t,this._functions={},this._main=""}functions(){""===this._main&&this.main();let t="";for(let e in this._functions)t+=this._functions[e]+"\n";return t}uniforms(){let t="";for(let e in this._uniforms){let i=this._uniforms[e];t+=`uniform ${i.typeGLSL} ${e}`,i&&i.length&&(t+=`[${i.length}]`),t+=";\n"}return t}main(){this._main="\nvoid intersectionProjection(\n\tin vec4 plane,\n\tin vec4 slice,\n\tout vec3 intersectionProjection){\n\n\t\t\tvec3 intersectionDirection = normalize(cross(plane.xyz, slice.xyz));\n\t\t\tvec3 intersectionPoint = \n\t\t\t\tcross(intersectionDirection,slice.xyz) * plane.w +\n\t\t\t\tcross(plane.xyz, intersectionDirection) * slice.w;\n\n\t\t\tintersectionProjection =\n\t\t\t\tintersectionPoint.xyz +\n\t\t\t\t(dot(vPos.xyz - intersectionPoint, intersectionDirection)\n\t\t\t\t\t* intersectionDirection);\n\n}\n\nvoid main(void) {\n\t\t\tvec4 c1 = vec4(0., 0., 0., 0.);\n\t\t\tvec4 c2 = vec4(0., 0., 0., 0.);\n\t\t\tvec4 c3 = vec4(0., 0., 0., 0.);\n\n\t\t\t// localizer #1\n\t\t\t// must be normalized!\n\t\t\tif(length(uPlane1.xyz) > 0.5) {\n\t\t\t\tvec3 projection1 = vec3(1.);\n\t\t\t\tintersectionProjection(\n\t\t\t\t\tuPlane1,\n\t\t\t\t\tuSlice,\n\t\t\t\t\tprojection1\n\t\t\t\t);\n\n\t\t\t\tvec4 projInter1 = (vProjectionViewMatrix * vec4(projection1, 1.));\n\t\t\t\tvec3 ndc1 = projInter1.xyz / projInter1.w;\n\t\t\t\tvec2 screenSpace1 = (ndc1.xy * .5 + .5) * vec2(uCanvasWidth, uCanvasHeight);\n\n\t\t\t\tfloat d1 = distance(gl_FragCoord.xy, screenSpace1.xy);\n\t\t\t\tc1 = vec4(uPlaneColor1, 1. - smoothstep(.5, .7, d1));\n\t\t\t}\n\n\t\t\t// localizer #2\n\t\t\tif(length(uPlane2.xyz) > 0.5) {\n\t\t\t\tvec3 projection2 = vec3(1.);\n\t\t\t\tintersectionProjection(\n\t\t\t\t\tuPlane2,\n\t\t\t\t\tuSlice,\n\t\t\t\t\tprojection2\n\t\t\t\t);\n\n\t\t\t\tvec4 projInter2 = (vProjectionViewMatrix * vec4(projection2, 1.));\n\t\t\t\tvec3 ndc2 = projInter2.xyz / projInter2.w;\n\t\t\t\tvec2 screenSpace2 = (ndc2.xy * .5 + .5) * vec2(uCanvasWidth, uCanvasHeight);\n\n\t\t\t\tfloat d2 = distance(gl_FragCoord.xy, screenSpace2.xy);\n\t\t\t\tc2 = vec4(uPlaneColor2, 1. - smoothstep(.5, .7, d2));\n\t\t\t}\n\n\t\t\t// localizer #3\n\t\t\tif(length(uPlane3.xyz) > 0.5) {\n\t\t\t\tvec3 projection3 = vec3(1.);\n\t\t\t\tintersectionProjection(\n\t\t\t\t\tuPlane3,\n\t\t\t\t\tuSlice,\n\t\t\t\t\tprojection3\n\t\t\t\t);\n\n\t\t\t\tvec4 projInter3 = (vProjectionViewMatrix * vec4(projection3, 1.));\n\t\t\t\tvec3 ndc3 = projInter3.xyz / projInter3.w;\n\t\t\t\tvec2 screenSpace3 = (ndc3.xy * .5 + .5) * vec2(uCanvasWidth, uCanvasHeight);\n\n\t\t\t\tfloat d3 = distance(gl_FragCoord.xy, screenSpace3.xy);\n\t\t\t\tc3 = vec4(uPlaneColor3, 1. - smoothstep(.5, .7, d3));\n\t\t\t}\n\n\t\t\t// float uBorderDashLength = 10.0;\n\t\t\t// float uBorderWidth = 2.0;\n\t\t\t// float valueX = mod(gl_FragCoord.x, 2. * uBorderDashLength);\n\t\t\t// float valueY = mod(gl_FragCoord.y, 2. * uBorderDashLength);\n\t\t\t// if( valueX < uBorderDashLength || valueY < uBorderDashLength ){\n\t\t\t\tvec3 colorMix = c1.xyz*c1.w + c2.xyz*c2.w + c3.xyz*c3.w;\n\t\t\t\tgl_FragColor = vec4(colorMix, max(max(c1.w, c2.w),c3.w)*0.5);\n\t\t\t\treturn;\n\t\t\t// }\n\t\t\t\n\t\t\t// gl_FragColor = vec4(0., 0., 0., 0.);\n\t\t\t// return;\n}\n\t "}compute(){return`\n// uniforms\n${this.uniforms()}\n\n// varying (should fetch it from vertex directly)\nvarying vec4 vPos;\nvarying mat4 vProjectionViewMatrix;\n\n// tailored functions\n${this.functions()}\n\n// main loop\n${this._main}\n\t\t\t`}}class E extends e.Object3D{constructor(t,e,i){super(),this._stack=t,this._referencePlane=i,this._plane1=null,this._color1=null,this._plane2=null,this._color2=null,this._plane3=null,this._color3=null,this._canvasWidth=0,this._canvasHeight=0,this._shadersFragment=D,this._shadersVertex=I,this._uniforms=L.uniforms(),this._material=null,this._geometry=e,this._create()}_create(){this._prepareMaterial(),this._mesh=new e.Mesh(this._geometry,this._material),this._mesh.applyMatrix(this._stack._ijk2LPS),this.add(this._mesh)}_prepareMaterial(){if(!this._material){this._uniforms.uSlice.value=this._referencePlane,this._plane1&&(this._uniforms.uPlane1.value=this._plane1,this._uniforms.uPlaneColor1.value=this._color1),this._plane2&&(this._uniforms.uPlane2.value=this._plane2,this._uniforms.uPlaneColor2.value=this._color2),this._plane3&&(this._uniforms.uPlane3.value=this._plane3,this._uniforms.uPlaneColor3.value=this._color3),this._uniforms.uCanvasWidth.value=this._canvasWidth,this._uniforms.uCanvasHeight.value=this._canvasHeight;let t=new D(this._uniforms),i=new I;this._material=new e.ShaderMaterial({side:e.DoubleSide,uniforms:this._uniforms,vertexShader:i.compute(),fragmentShader:t.compute()}),this._material.transparent=!0}}update(){this._mesh&&(this.remove(this._mesh),this._mesh.geometry.dispose(),this._mesh.geometry=null,this._mesh=null),this._create()}dispose(){this._referencePlane=null,this._plane1=null,this._color1=null,this._plane2=null,this._color2=null,this._plane3=null,this._color3=null,this._shadersFragment=null,this._shadersVertex=null,this._uniforms=null,this.remove(this._mesh),this._mesh.geometry.dispose(),this._mesh.geometry=null,this._mesh.material.dispose(),this._mesh.material=null,this._mesh=null,this._geometry.dispose(),this._geometry=null,this._material.vertexShader=null,this._material.fragmentShader=null,this._material.uniforms=null,this._material.dispose(),this._material=null,this._stack=null}get geometry(){return this._geometry}set geometry(t){this._mesh&&(this.remove(this._mesh),this._mesh.geometry.dispose(),this._mesh.geometry=null,this._mesh=null,this._geometry.dispose(),this._geometry=null),this._geometry=t,this._create()}get referencePlane(){return this._referencePlane}set referencePlane(t){this._referencePlane=t,this._uniforms.uSlice.value=this._referencePlane}get plane1(){return this._plane1}set plane1(t){this._plane1=t,this._uniforms.uPlane1.value=this._plane1}get color1(){return this._color1}set color1(t){this._color1=t,this._uniforms.uPlaneColor1.value=this._color1}get plane2(){return this._plane2}set plane2(t){this._plane2=t,this._uniforms.uPlane2.value=this._plane2}get color2(){return this._color2}set color2(t){this._color2=t,this._uniforms.uPlaneColor2.value=this._color2}get plane3(){return this._plane3}set plane3(t){this._plane3=t,this._uniforms.uPlane3.value=this._plane3}get color3(){return this._color3}set color3(t){this._color3=t,this._uniforms.uPlaneColor3.value=this._color3}get canvasWidth(){return this._canvasWidth}set canvasWidth(t){this._canvasWidth=t,this._uniforms.uCanvasWidth.value=this._canvasWidth}get canvasHeight(){return this._canvasHeight}set canvasHeight(t){this._canvasHeight=t,this._uniforms.uCanvasHeight.value=this._canvasHeight}}class T extends e.Object3D{constructor(t,e="default",i="linear",s=[[0,0,0,0],[1,1,1,1]],a=[[0,0],[1,1]],o=!1){super(),n.isString(t)?this._dom=document.getElementById(t):this._dom=t,this._discrete=o,this._color=s,this._lut=e,this._luts={[e]:s},this._opacity=a,this._lutO=i,this._lutsO={[i]:a},this.initCanvas(),this.paintCanvas()}initCanvas(){this._canvasContainer=this.initCanvasContainer(this._dom),this._canvasBg=this.createCanvas(),this._canvasContainer.appendChild(this._canvasBg),this._canvas=this.createCanvas(),this._canvasContainer.appendChild(this._canvas)}initCanvasContainer(t){let e=t;return e.style.border="1px solid #F9F9F9",e}createCanvas(){let t=document.createElement("canvas");return t.height=1,t.width=256,t.style.width="256px",t.style.height="16px",t}paintCanvas(){let t=this._canvas.getContext("2d");if(t.clearRect(0,0,this._canvas.width,this._canvas.height),t.globalCompositeOperation="source-over",this._discrete){t.lineWidth=2*this._canvas.height;for(let e=0;e<this._color.length;e++){let i=this._color[e][0],s=1;e<this._color.length-1&&(s=this._color[e+1][0]);let a=0;e>0&&(a=this._color[e-1][0]);let o=a+(i-a)/2,n=i+(s-i)/2,l=this._color[e],r=this._opacity[e]?this._opacity[e][1]:1;t.beginPath(),t.strokeStyle=`rgba( ${Math.round(255*l[1])}, ${Math.round(255*l[2])}, ${Math.round(255*l[3])}, ${r})`,t.moveTo(o*this._canvas.width,0),t.lineTo(n*this._canvas.width,0),t.stroke(),t.closePath()}}else{let e=t.createLinearGradient(0,0,this._canvas.width,0);for(let t=0;t<this._color.length;t++)e.addColorStop(this._color[t][0],`rgba( ${Math.round(255*this._color[t][1])}, ${Math.round(255*this._color[t][2])}, ${Math.round(255*this._color[t][3])}, 1)`);t.fillStyle=e,t.fillRect(0,0,this._canvas.width,this._canvas.height),t.globalCompositeOperation="destination-in";let i=t.createLinearGradient(0,0,this._canvas.width,0);for(let t=0;t<this._opacity.length;t++)i.addColorStop(this._opacity[t][0],"rgba(255, 255, 255, "+this._opacity[t][1]+")");t.fillStyle=i,t.fillRect(0,0,this._canvas.width,this._canvas.height)}}get texture(){let t=new e.Texture(this._canvas);return t.mapping=e.UVMapping,t.wrapS=t.wrapT=e.ClampToEdgeWrapping,t.magFilter=t.minFilter=e.NearestFilter,t.premultiplyAlpha=!0,t.needsUpdate=!0,t}set lut(t){this._color=this._luts[t],this._lut=t,this.paintCanvas()}get lut(){return this._lut}set luts(t){this._luts=t}get luts(){return this._luts}set lutO(t){this._opacity=this._lutsO[t],this._lutO=t,this.paintCanvas()}get lutO(){return this._lutO}set lutsO(t){this._lutsO=t}get lutsO(){return this._lutsO}set discrete(t){this._discrete=t,this.paintCanvas()}get discrete(){return this._discrete}lutsAvailable(t="color"){let e=[],i=this._luts;"color"!==t&&(i=this._lutsO);for(let t in i)e.push(t);return e}static presetLuts(){return{default:[[0,0,0,0],[1,1,1,1]],spectrum:[[0,0,0,0],[.1,0,0,1],[.33,0,1,1],[.5,0,1,0],[.66,1,1,0],[.9,1,0,0],[1,1,1,1]],hot_and_cold:[[0,0,0,1],[.15,0,1,1],[.3,0,1,0],[.45,0,0,0],[.5,0,0,0],[.55,0,0,0],[.7,1,1,0],[.85,1,0,0],[1,1,1,1]],gold:[[0,0,0,0],[.13,.19,.03,0],[.25,.39,.12,0],[.38,.59,.26,0],[.5,.8,.46,.08],[.63,.99,.71,.21],[.75,.99,.88,.34],[.88,.99,.99,.48],[1,.9,.95,.61]],red:[[0,.75,0,0],[.5,1,.5,0],[.95,1,1,0],[1,1,1,1]],green:[[0,0,.75,0],[.5,.5,1,0],[.95,1,1,0],[1,1,1,1]],blue:[[0,0,0,1],[.5,0,.5,1],[.95,0,1,1],[1,1,1,1]],walking_dead:[[0,.1,1,1],[1,1,1,1]],random:[[0,0,0,0],[.27,.18,.18,.18],[.41,1,1,1],[.7,1,0,0],[1,1,1,1]],muscle_bone:[[0,0,0,0],[.00392156862745098,.00784313725490196,0,0],[.00784313725490196,.0196078431372549,0,0],[.011764705882352941,.03137254901960784,0,0],[.01568627450980392,.0392156862745098,0,.00392156862745098],[.0196078431372549,.050980392156862744,.00392156862745098,.00392156862745098],[.023529411764705882,.06274509803921569,.00392156862745098,.00392156862745098],[.027450980392156862,.07058823529411765,.00392156862745098,.00784313725490196],[.03137254901960784,.08235294117647059,.00392156862745098,.00784313725490196],[.03529411764705882,.09411764705882353,.00784313725490196,.00784313725490196],[.0392156862745098,.10196078431372549,.00784313725490196,.00784313725490196],[.043137254901960784,.11372549019607843,.00784313725490196,.011764705882352941],[.047058823529411764,.12549019607843137,.00784313725490196,.011764705882352941],[.050980392156862744,.13333333333333333,.011764705882352941,.011764705882352941],[.054901960784313725,.1450980392156863,.011764705882352941,.01568627450980392],[.058823529411764705,.1568627450980392,.011764705882352941,.01568627450980392],[.06274509803921569,.16470588235294117,.011764705882352941,.01568627450980392],[.06666666666666667,.17647058823529413,.011764705882352941,.0196078431372549],[.07058823529411765,.18823529411764706,.01568627450980392,.0196078431372549],[.07450980392156863,.2,.01568627450980392,.0196078431372549],[.0784313725490196,.20784313725490197,.01568627450980392,.0196078431372549],[.08235294117647059,.2196078431372549,.01568627450980392,.023529411764705882],[.08627450980392157,.23137254901960785,.0196078431372549,.023529411764705882],[.09019607843137255,.23921568627450981,.0196078431372549,.023529411764705882],[.09411764705882353,.25098039215686274,.0196078431372549,.027450980392156862],[.09803921568627451,.2627450980392157,.0196078431372549,.027450980392156862],[.10196078431372549,.27058823529411763,.023529411764705882,.027450980392156862],[.10588235294117647,.2823529411764706,.023529411764705882,.027450980392156862],[.10980392156862745,.29411764705882354,.023529411764705882,.03137254901960784],[.11372549019607843,.30196078431372547,.023529411764705882,.03137254901960784],[.11764705882352941,.3137254901960784,.023529411764705882,.03137254901960784],[.12156862745098039,.3254901960784314,.027450980392156862,.03529411764705882],[.12549019607843137,.3333333333333333,.027450980392156862,.03529411764705882],[.12941176470588237,.34509803921568627,.027450980392156862,.03529411764705882],[.13333333333333333,.3568627450980392,.027450980392156862,.0392156862745098],[.13725490196078433,.36470588235294116,.03137254901960784,.0392156862745098],[.1411764705882353,.3764705882352941,.03137254901960784,.0392156862745098],[.1450980392156863,.38823529411764707,.03137254901960784,.0392156862745098],[.14901960784313725,.4,.03137254901960784,.043137254901960784],[.15294117647058825,.40784313725490196,.03529411764705882,.043137254901960784],[.1568627450980392,.4196078431372549,.03529411764705882,.043137254901960784],[.1607843137254902,.43137254901960786,.03529411764705882,.047058823529411764],[.16470588235294117,.4392156862745098,.03529411764705882,.047058823529411764],[.16862745098039217,.45098039215686275,.03529411764705882,.047058823529411764],[.17254901960784313,.4627450980392157,.0392156862745098,.047058823529411764],[.17647058823529413,.47058823529411764,.0392156862745098,.050980392156862744],[.1803921568627451,.4823529411764706,.0392156862745098,.050980392156862744],[.1843137254901961,.49411764705882355,.0392156862745098,.050980392156862744],[.18823529411764706,.5019607843137255,.043137254901960784,.054901960784313725],[.19215686274509805,.5137254901960784,.043137254901960784,.054901960784313725],[.19607843137254902,.5254901960784314,.043137254901960784,.054901960784313725],[.2,.5333333333333333,.043137254901960784,.058823529411764705],[.20392156862745098,.5450980392156862,.047058823529411764,.058823529411764705],[.20784313725490197,.5568627450980392,.047058823529411764,.058823529411764705],[.21176470588235294,.5647058823529412,.047058823529411764,.058823529411764705],[.21568627450980393,.5764705882352941,.047058823529411764,.06274509803921569],[.2196078431372549,.5882352941176471,.047058823529411764,.06274509803921569],[.2235294117647059,.6,.050980392156862744,.06274509803921569],[.22745098039215686,.6078431372549019,.050980392156862744,.06666666666666667],[.23137254901960785,.6196078431372549,.050980392156862744,.06666666666666667],[.23529411764705882,.6313725490196078,.050980392156862744,.06666666666666667],[.23921568627450981,.6392156862745098,.054901960784313725,.06666666666666667],[.24313725490196078,.6509803921568628,.054901960784313725,.07058823529411765],[.24705882352941178,.6627450980392157,.054901960784313725,.07058823529411765],[.25098039215686274,.6705882352941176,.054901960784313725,.07058823529411765],[.2549019607843137,.6823529411764706,.058823529411764705,.07450980392156863],[.25882352941176473,.6941176470588235,.058823529411764705,.07450980392156863],[.2627450980392157,.7019607843137254,.058823529411764705,.07450980392156863],[.26666666666666666,.7137254901960784,.058823529411764705,.0784313725490196],[.27058823529411763,.7254901960784313,.058823529411764705,.0784313725490196],[.27450980392156865,.7333333333333333,.06274509803921569,.0784313725490196],[.2784313725490196,.7450980392156863,.06274509803921569,.0784313725490196],[.2823529411764706,.7568627450980392,.06274509803921569,.08235294117647059],[.28627450980392155,.7647058823529411,.06274509803921569,.08235294117647059],[.2901960784313726,.7764705882352941,.06666666666666667,.08235294117647059],[.29411764705882354,.788235294117647,.06666666666666667,.08627450980392157],[.2980392156862745,.8,.06666666666666667,.08627450980392157],[.30196078431372547,.807843137254902,.06666666666666667,.08627450980392157],[.3058823529411765,.8196078431372549,.07058823529411765,.08627450980392157],[.30980392156862746,.8313725490196079,.07058823529411765,.09019607843137255],[.3137254901960784,.8392156862745098,.07058823529411765,.09019607843137255],[.3176470588235294,.8509803921568627,.07058823529411765,.09019607843137255],[.3215686274509804,.8627450980392157,.07058823529411765,.09411764705882353],[.3254901960784314,.8705882352941177,.07450980392156863,.09411764705882353],[.32941176470588235,.8823529411764706,.07450980392156863,.09411764705882353],[.3333333333333333,.8941176470588236,.07450980392156863,.09803921568627451],[.33725490196078434,.9019607843137255,.07450980392156863,.09803921568627451],[.3411764705882353,.9137254901960784,.0784313725490196,.09803921568627451],[.34509803921568627,.9254901960784314,.0784313725490196,.09803921568627451],[.34901960784313724,.9333333333333333,.0784313725490196,.10196078431372549],[.35294117647058826,.9450980392156862,.0784313725490196,.10196078431372549],[.3568627450980392,.9568627450980393,.08235294117647059,.10196078431372549],[.3607843137254902,.9647058823529412,.08235294117647059,.10588235294117647],[.36470588235294116,.9764705882352941,.08235294117647059,.10588235294117647],[.3686274509803922,.9882352941176471,.08235294117647059,.10588235294117647],[.37254901960784315,1,.08235294117647059,.10588235294117647],[.3764705882352941,1,.09411764705882353,.10588235294117647],[.3803921568627451,1,.10588235294117647,.10588235294117647],[.3843137254901961,1,.11764705882352941,.10196078431372549],[.38823529411764707,1,.12941176470588237,.10196078431372549],[.39215686274509803,1,.1411764705882353,.10196078431372549],[.396078431372549,1,.15294117647058825,.09803921568627451],[.4,1,.16470588235294117,.09803921568627451],[.403921568627451,1,.17647058823529413,.09803921568627451],[.40784313725490196,1,.18823529411764706,.09411764705882353],[.4117647058823529,1,.2,.09411764705882353],[.41568627450980394,1,.21176470588235294,.09411764705882353],[.4196078431372549,1,.2235294117647059,.09019607843137255],[.4235294117647059,1,.23529411764705882,.09019607843137255],[.42745098039215684,1,.24705882352941178,.08627450980392157],[.43137254901960786,1,.25882352941176473,.08627450980392157],[.43529411764705883,1,.27058823529411763,.08627450980392157],[.4392156862745098,1,.2823529411764706,.08235294117647059],[.44313725490196076,1,.29411764705882354,.08235294117647059],[.4470588235294118,1,.3058823529411765,.08235294117647059],[.45098039215686275,1,.3176470588235294,.0784313725490196],[.4549019607843137,1,.32941176470588235,.0784313725490196],[.4588235294117647,1,.3411764705882353,.0784313725490196],[.4627450980392157,1,.35294117647058826,.07450980392156863],[.4666666666666667,1,.36470588235294116,.07450980392156863],[.47058823529411764,1,.3764705882352941,.07450980392156863],[.4745098039215686,1,.38823529411764707,.07058823529411765],[.47843137254901963,1,.4,.07058823529411765],[.4823529411764706,1,.4117647058823529,.07058823529411765],[.48627450980392156,1,.4235294117647059,.06666666666666667],[.49019607843137253,1,.43529411764705883,.06666666666666667],[.49411764705882355,1,.4470588235294118,.06274509803921569],[.4980392156862745,1,.4588235294117647,.06274509803921569],[.5019607843137255,1,.47058823529411764,.06274509803921569],[.5058823529411764,1,.4823529411764706,.058823529411764705],[.5098039215686274,1,.49411764705882355,.058823529411764705],[.5137254901960784,1,.5058823529411764,.058823529411764705],[.5176470588235295,1,.5137254901960784,.054901960784313725],[.5215686274509804,1,.5254901960784314,.054901960784313725],[.5254901960784314,1,.5372549019607843,.054901960784313725],[.5294117647058824,1,.5490196078431373,.050980392156862744],[.5333333333333333,1,.5607843137254902,.050980392156862744],[.5372549019607843,1,.5725490196078431,.050980392156862744],[.5411764705882353,1,.5843137254901961,.047058823529411764],[.5450980392156862,1,.596078431372549,.047058823529411764],[.5490196078431373,1,.6078431372549019,.043137254901960784],[.5529411764705883,1,.6196078431372549,.043137254901960784],[.5568627450980392,1,.6313725490196078,.043137254901960784],[.5607843137254902,1,.6431372549019608,.0392156862745098],[.5647058823529412,1,.6549019607843137,.0392156862745098],[.5686274509803921,1,.6666666666666666,.0392156862745098],[.5725490196078431,1,.6784313725490196,.03529411764705882],[.5764705882352941,1,.6901960784313725,.03529411764705882],[.5803921568627451,1,.6941176470588235,.0392156862745098],[.5843137254901961,1,.7019607843137254,.0392156862745098],[.5882352941176471,1,.7058823529411765,.043137254901960784],[.592156862745098,1,.7098039215686275,.043137254901960784],[.596078431372549,1,.7137254901960784,.047058823529411764],[.6,1,.7176470588235294,.047058823529411764],[.6039215686274509,1,.7254901960784313,.050980392156862744],[.6078431372549019,1,.7294117647058823,.050980392156862744],[.611764705882353,1,.7333333333333333,.054901960784313725],[.615686274509804,1,.7372549019607844,.058823529411764705],[.6196078431372549,1,.7411764705882353,.058823529411764705],[.6235294117647059,1,.7490196078431373,.06274509803921569],[.6274509803921569,1,.7529411764705882,.06274509803921569],[.6313725490196078,1,.7568627450980392,.06666666666666667],[.6352941176470588,1,.7607843137254902,.06666666666666667],[.6392156862745098,1,.7647058823529411,.07058823529411765],[.6431372549019608,1,.7725490196078432,.07058823529411765],[.6470588235294118,1,.7764705882352941,.07450980392156863],[.6509803921568628,1,.7803921568627451,.07450980392156863],[.6549019607843137,1,.7843137254901961,.0784313725490196],[.6588235294117647,1,.788235294117647,.08235294117647059],[.6627450980392157,1,.796078431372549,.08235294117647059],[.6666666666666666,1,.8,.08627450980392157],[.6705882352941176,1,.803921568627451,.08627450980392157],[.6745098039215687,1,.807843137254902,.09019607843137255],[.6784313725490196,1,.8117647058823529,.09019607843137255],[.6823529411764706,1,.8196078431372549,.09411764705882353],[.6862745098039216,1,.8235294117647058,.09411764705882353],[.6901960784313725,1,.8274509803921568,.09803921568627451],[.6941176470588235,1,.8313725490196079,.10196078431372549],[.6980392156862745,1,.8352941176470589,.10196078431372549],[.7019607843137254,1,.8431372549019608,.10588235294117647],[.7058823529411765,1,.8470588235294118,.10588235294117647],[.7098039215686275,1,.8509803921568627,.10980392156862745],[.7137254901960784,1,.8549019607843137,.10980392156862745],[.7176470588235294,1,.8627450980392157,.11372549019607843],[.7215686274509804,1,.8666666666666667,.11372549019607843],[.7254901960784313,1,.8705882352941177,.11764705882352941],[.7294117647058823,1,.8745098039215686,.12156862745098039],[.7333333333333333,1,.8784313725490196,.12156862745098039],[.7372549019607844,1,.8862745098039215,.12549019607843137],[.7411764705882353,1,.8901960784313725,.12549019607843137],[.7450980392156863,1,.8941176470588236,.12941176470588237],[.7490196078431373,1,.8980392156862745,.12941176470588237],[.7529411764705882,1,.9019607843137255,.13333333333333333],[.7568627450980392,1,.9098039215686274,.13333333333333333],[.7607843137254902,1,.9137254901960784,.13725490196078433],[.7647058823529411,1,.9176470588235294,.1411764705882353],[.7686274509803922,1,.9215686274509803,.1411764705882353],[.7725490196078432,1,.9254901960784314,.1450980392156863],[.7764705882352941,1,.9333333333333333,.1450980392156863],[.7803921568627451,1,.9372549019607843,.14901960784313725],[.7843137254901961,1,.9411764705882353,.14901960784313725],[.788235294117647,1,.9450980392156862,.15294117647058825],[.792156862745098,1,.9450980392156862,.16862745098039217],[.796078431372549,1,.9490196078431372,.1843137254901961],[.8,1,.9490196078431372,.2],[.803921568627451,1,.9490196078431372,.21568627450980393],[.807843137254902,1,.9490196078431372,.22745098039215686],[.8117647058823529,1,.9529411764705882,.24313725490196078],[.8156862745098039,1,.9529411764705882,.25882352941176473],[.8196078431372549,1,.9529411764705882,.27450980392156865],[.8235294117647058,1,.9529411764705882,.2901960784313726],[.8274509803921568,1,.9568627450980393,.3058823529411765],[.8313725490196079,1,.9568627450980393,.3215686274509804],[.8352941176470589,1,.9568627450980393,.33725490196078434],[.8392156862745098,1,.9568627450980393,.35294117647058826],[.8431372549019608,1,.9607843137254902,.3686274509803922],[.8470588235294118,1,.9607843137254902,.3843137254901961],[.8509803921568627,1,.9607843137254902,.4],[.8549019607843137,1,.9607843137254902,.4117647058823529],[.8588235294117647,1,.9647058823529412,.42745098039215684],[.8627450980392157,1,.9647058823529412,.44313725490196076],[.8666666666666667,1,.9647058823529412,.4588235294117647],[.8705882352941177,1,.9647058823529412,.4745098039215686],[.8745098039215686,1,.9686274509803922,.49019607843137253],[.8784313725490196,1,.9686274509803922,.5058823529411764],[.8823529411764706,1,.9686274509803922,.5215686274509804],[.8862745098039215,1,.9686274509803922,.5372549019607843],[.8901960784313725,1,.9725490196078431,.5529411764705883],[.8941176470588236,1,.9725490196078431,.5686274509803921],[.8980392156862745,1,.9725490196078431,.5843137254901961],[.9019607843137255,1,.9725490196078431,.6],[.9058823529411765,1,.9725490196078431,.611764705882353],[.9098039215686274,1,.9764705882352941,.6274509803921569],[.9137254901960784,1,.9764705882352941,.6431372549019608],[.9176470588235294,1,.9764705882352941,.6588235294117647],[.9215686274509803,1,.9764705882352941,.6745098039215687],[.9254901960784314,1,.9803921568627451,.6901960784313725],[.9294117647058824,1,.9803921568627451,.7058823529411765],[.9333333333333333,1,.9803921568627451,.7215686274509804],[.9372549019607843,1,.9803921568627451,.7372549019607844],[.9411764705882353,1,.984313725490196,.7529411764705882],[.9450980392156862,1,.984313725490196,.7686274509803922],[.9490196078431372,1,.984313725490196,.7843137254901961],[.9529411764705882,1,.984313725490196,.8],[.9568627450980393,1,.9882352941176471,.8117647058823529],[.9607843137254902,1,.9882352941176471,.8274509803921568],[.9647058823529412,1,.9882352941176471,.8431372549019608],[.9686274509803922,1,.9882352941176471,.8588235294117647],[.9725490196078431,1,.9921568627450981,.8745098039215686],[.9764705882352941,1,.9921568627450981,.8901960784313725],[.9803921568627451,1,.9921568627450981,.9058823529411765],[.984313725490196,1,.9921568627450981,.9215686274509803],[.9882352941176471,1,.996078431372549,.9372549019607843],[.9921568627450981,1,.996078431372549,.9529411764705882],[.996078431372549,1,.996078431372549,.9686274509803922],[1,1,.996078431372549,.984313725490196]]}}static presetLutsO(){return{linear:[[0,0],[1,1]],lowpass:[[0,.8],[.2,.6],[.3,.1],[1,0]],bandpass:[[0,0],[.4,.8],[.6,.8],[1,0]],highpass:[[0,0],[.7,.1],[.8,.6],[1,.8]],flat:[[0,.7],[1,1]],random:[[0,0],[.38,0],[.55,1],[.72,1],[1,.05]],linear_full:[[0,0],[.00392156862745098,.00392156862745098],[.00784313725490196,.00784313725490196],[.011764705882352941,.011764705882352941],[.01568627450980392,.01568627450980392],[.0196078431372549,.0196078431372549],[.023529411764705882,.023529411764705882],[.027450980392156862,.027450980392156862],[.03137254901960784,.03137254901960784],[.03529411764705882,.03529411764705882],[.0392156862745098,.0392156862745098],[.043137254901960784,.043137254901960784],[.047058823529411764,.047058823529411764],[.050980392156862744,.050980392156862744],[.054901960784313725,.054901960784313725],[.058823529411764705,.058823529411764705],[.06274509803921569,.06274509803921569],[.06666666666666667,.06666666666666667],[.07058823529411765,.07058823529411765],[.07450980392156863,.07450980392156863],[.0784313725490196,.0784313725490196],[.08235294117647059,.08235294117647059],[.08627450980392157,.08627450980392157],[.09019607843137255,.09019607843137255],[.09411764705882353,.09411764705882353],[.09803921568627451,.09803921568627451],[.10196078431372549,.10196078431372549],[.10588235294117647,.10588235294117647],[.10980392156862745,.10980392156862745],[.11372549019607843,.11372549019607843],[.11764705882352941,.11764705882352941],[.12156862745098039,.12156862745098039],[.12549019607843137,.12549019607843137],[.12941176470588237,.12941176470588237],[.13333333333333333,.13333333333333333],[.13725490196078433,.13725490196078433],[.1411764705882353,.1411764705882353],[.1450980392156863,.1450980392156863],[.14901960784313725,.14901960784313725],[.15294117647058825,.15294117647058825],[.1568627450980392,.1568627450980392],[.1607843137254902,.1607843137254902],[.16470588235294117,.16470588235294117],[.16862745098039217,.16862745098039217],[.17254901960784313,.17254901960784313],[.17647058823529413,.17647058823529413],[.1803921568627451,.1803921568627451],[.1843137254901961,.1843137254901961],[.18823529411764706,.18823529411764706],[.19215686274509805,.19215686274509805],[.19607843137254902,.19607843137254902],[.2,.2],[.20392156862745098,.20392156862745098],[.20784313725490197,.20784313725490197],[.21176470588235294,.21176470588235294],[.21568627450980393,.21568627450980393],[.2196078431372549,.2196078431372549],[.2235294117647059,.2235294117647059],[.22745098039215686,.22745098039215686],[.23137254901960785,.23137254901960785],[.23529411764705882,.23529411764705882],[.23921568627450981,.23921568627450981],[.24313725490196078,.24313725490196078],[.24705882352941178,.24705882352941178],[.25098039215686274,.25098039215686274],[.2549019607843137,.2549019607843137],[.25882352941176473,.25882352941176473],[.2627450980392157,.2627450980392157],[.26666666666666666,.26666666666666666],[.27058823529411763,.27058823529411763],[.27450980392156865,.27450980392156865],[.2784313725490196,.2784313725490196],[.2823529411764706,.2823529411764706],[.28627450980392155,.28627450980392155],[.2901960784313726,.2901960784313726],[.29411764705882354,.29411764705882354],[.2980392156862745,.2980392156862745],[.30196078431372547,.30196078431372547],[.3058823529411765,.3058823529411765],[.30980392156862746,.30980392156862746],[.3137254901960784,.3137254901960784],[.3176470588235294,.3176470588235294],[.3215686274509804,.3215686274509804],[.3254901960784314,.3254901960784314],[.32941176470588235,.32941176470588235],[.3333333333333333,.3333333333333333],[.33725490196078434,.33725490196078434],[.3411764705882353,.3411764705882353],[.34509803921568627,.34509803921568627],[.34901960784313724,.34901960784313724],[.35294117647058826,.35294117647058826],[.3568627450980392,.3568627450980392],[.3607843137254902,.3607843137254902],[.36470588235294116,.36470588235294116],[.3686274509803922,.3686274509803922],[.37254901960784315,.37254901960784315],[.3764705882352941,.3764705882352941],[.3803921568627451,.3803921568627451],[.3843137254901961,.3843137254901961],[.38823529411764707,.38823529411764707],[.39215686274509803,.39215686274509803],[.396078431372549,.396078431372549],[.4,.4],[.403921568627451,.403921568627451],[.40784313725490196,.40784313725490196],[.4117647058823529,.4117647058823529],[.41568627450980394,.41568627450980394],[.4196078431372549,.4196078431372549],[.4235294117647059,.4235294117647059],[.42745098039215684,.42745098039215684],[.43137254901960786,.43137254901960786],[.43529411764705883,.43529411764705883],[.4392156862745098,.4392156862745098],[.44313725490196076,.44313725490196076],[.4470588235294118,.4470588235294118],[.45098039215686275,.45098039215686275],[.4549019607843137,.4549019607843137],[.4588235294117647,.4588235294117647],[.4627450980392157,.4627450980392157],[.4666666666666667,.4666666666666667],[.47058823529411764,.47058823529411764],[.4745098039215686,.4745098039215686],[.47843137254901963,.47843137254901963],[.4823529411764706,.4823529411764706],[.48627450980392156,.48627450980392156],[.49019607843137253,.49019607843137253],[.49411764705882355,.49411764705882355],[.4980392156862745,.4980392156862745],[.5019607843137255,.5019607843137255],[.5058823529411764,.5058823529411764],[.5098039215686274,.5098039215686274],[.5137254901960784,.5137254901960784],[.5176470588235295,.5176470588235295],[.5215686274509804,.5215686274509804],[.5254901960784314,.5254901960784314],[.5294117647058824,.5294117647058824],[.5333333333333333,.5333333333333333],[.5372549019607843,.5372549019607843],[.5411764705882353,.5411764705882353],[.5450980392156862,.5450980392156862],[.5490196078431373,.5490196078431373],[.5529411764705883,.5529411764705883],[.5568627450980392,.5568627450980392],[.5607843137254902,.5607843137254902],[.5647058823529412,.5647058823529412],[.5686274509803921,.5686274509803921],[.5725490196078431,.5725490196078431],[.5764705882352941,.5764705882352941],[.5803921568627451,.5803921568627451],[.5843137254901961,.5843137254901961],[.5882352941176471,.5882352941176471],[.592156862745098,.592156862745098],[.596078431372549,.596078431372549],[.6,.6],[.6039215686274509,.6039215686274509],[.6078431372549019,.6078431372549019],[.611764705882353,.611764705882353],[.615686274509804,.615686274509804],[.6196078431372549,.6196078431372549],[.6235294117647059,.6235294117647059],[.6274509803921569,.6274509803921569],[.6313725490196078,.6313725490196078],[.6352941176470588,.6352941176470588],[.6392156862745098,.6392156862745098],[.6431372549019608,.6431372549019608],[.6470588235294118,.6470588235294118],[.6509803921568628,.6509803921568628],[.6549019607843137,.6549019607843137],[.6588235294117647,.6588235294117647],[.6627450980392157,.6627450980392157],[.6666666666666666,.6666666666666666],[.6705882352941176,.6705882352941176],[.6745098039215687,.6745098039215687],[.6784313725490196,.6784313725490196],[.6823529411764706,.6823529411764706],[.6862745098039216,.6862745098039216],[.6901960784313725,.6901960784313725],[.6941176470588235,.6941176470588235],[.6980392156862745,.6980392156862745],[.7019607843137254,.7019607843137254],[.7058823529411765,.7058823529411765],[.7098039215686275,.7098039215686275],[.7137254901960784,.7137254901960784],[.7176470588235294,.7176470588235294],[.7215686274509804,.7215686274509804],[.7254901960784313,.7254901960784313],[.7294117647058823,.7294117647058823],[.7333333333333333,.7333333333333333],[.7372549019607844,.7372549019607844],[.7411764705882353,.7411764705882353],[.7450980392156863,.7450980392156863],[.7490196078431373,.7490196078431373],[.7529411764705882,.7529411764705882],[.7568627450980392,.7568627450980392],[.7607843137254902,.7607843137254902],[.7647058823529411,.7647058823529411],[.7686274509803922,.7686274509803922],[.7725490196078432,.7725490196078432],[.7764705882352941,.7764705882352941],[.7803921568627451,.7803921568627451],[.7843137254901961,.7843137254901961],[.788235294117647,.788235294117647],[.792156862745098,.792156862745098],[.796078431372549,.796078431372549],[.8,.8],[.803921568627451,.803921568627451],[.807843137254902,.807843137254902],[.8117647058823529,.8117647058823529],[.8156862745098039,.8156862745098039],[.8196078431372549,.8196078431372549],[.8235294117647058,.8235294117647058],[.8274509803921568,.8274509803921568],[.8313725490196079,.8313725490196079],[.8352941176470589,.8352941176470589],[.8392156862745098,.8392156862745098],[.8431372549019608,.8431372549019608],[.8470588235294118,.8470588235294118],[.8509803921568627,.8509803921568627],[.8549019607843137,.8549019607843137],[.8588235294117647,.8588235294117647],[.8627450980392157,.8627450980392157],[.8666666666666667,.8666666666666667],[.8705882352941177,.8705882352941177],[.8745098039215686,.8745098039215686],[.8784313725490196,.8784313725490196],[.8823529411764706,.8823529411764706],[.8862745098039215,.8862745098039215],[.8901960784313725,.8901960784313725],[.8941176470588236,.8941176470588236],[.8980392156862745,.8980392156862745],[.9019607843137255,.9019607843137255],[.9058823529411765,.9058823529411765],[.9098039215686274,.9098039215686274],[.9137254901960784,.9137254901960784],[.9176470588235294,.9176470588235294],[.9215686274509803,.9215686274509803],[.9254901960784314,.9254901960784314],[.9294117647058824,.9294117647058824],[.9333333333333333,.9333333333333333],[.9372549019607843,.9372549019607843],[.9411764705882353,.9411764705882353],[.9450980392156862,.9450980392156862],[.9490196078431372,.9490196078431372],[.9529411764705882,.9529411764705882],[.9568627450980393,.9568627450980393],[.9607843137254902,.9607843137254902],[.9647058823529412,.9647058823529412],[.9686274509803922,.9686274509803922],[.9725490196078431,.9725490196078431],[.9764705882352941,.9764705882352941],[.9803921568627451,.9803921568627451],[.984313725490196,.984313725490196],[.9882352941176471,.9882352941176471],[.9921568627450981,.9921568627450981],[.996078431372549,.996078431372549],[1,1]]}}}let A={0:{color:[0,0,0],opacity:0,label:"background"},1:{color:[255,0,0],opacity:1,label:"white matter"}};class O{constructor(t){this._container=t,this._modes={load:{name:"load",color:"#FFF56F"},parse:{name:"parse",color:"#2196F3"}},this.requestAnimationFrameID=null,this._mode=null,this._value=null,this._total=null,this._totalFiles=null,this.init()}free(){let t=this._container.getElementsByClassName("progress container");t.length>0&&t[0].parentNode.removeChild(t[0]),t=null,cancelAnimationFrame(this.requestAnimationFrameID)}init(){let t=this._domContainer();for(let e in this._modes)if(this._modes.hasOwnProperty(e)){let i=this._domBar(this._modes[e]);t.appendChild(i),i=null}this._container.appendChild(t),t=null,this.updateUI()}update(t,e,i,s=""){this._mode=i,this._value=t,0===e?(this._total=t,this._value=Math.random()*t):this._total=e}updateUI(){if(this.requestAnimationFrameID=requestAnimationFrame((()=>{this.updateUI()})),!(this._modes.hasOwnProperty(this._mode)&&this._modes[this._mode].hasOwnProperty("name")&&this._modes[this._mode].hasOwnProperty("color")))return!1;const t=Math.round(this._value/this._total*100),e=this._modes[this._mode].color;let i=this._container.getElementsByClassName("progress "+this._modes[this._mode].name);i.length>0&&(i[0].style.borderColor=e,i[0].style.width=t+"%"),i=null}_domContainer(){let t=document.createElement("div");return t.classList.add("progress"),t.classList.add("container"),t.style.width="100%",t.style.height="8px",t.style.position="absolute",t.style.backgroundColor="rgba(158, 158, 158, 0.5)",t.style.top="0",t.style.zIndex="1",t}_domBar(t){if(!t.hasOwnProperty("name")||!t.hasOwnProperty("color"))return console.log("Invalid mode provided."),console.log(t),!1;let e=document.createElement("div");return e.classList.add(t.name),e.classList.add("progress"),e.style.border="2px solid "+t.color,e.style.width="0%",e}set totalFiles(t){this._totalFiles=t}get totalFiles(){return this._totalFiles}}class k{static uniforms(){return{uTextureSize:{type:"i",value:0,typeGLSL:"int"},uTextureContainer:{type:"tv",value:[],typeGLSL:"sampler2D",length:7},uDataDimensions:{type:"iv",value:[0,0,0],typeGLSL:"ivec3"},uWorldToData:{type:"m4",value:new e.Matrix4,typeGLSL:"mat4"},uWindowCenterWidth:{type:"fv1",value:[0,0],typeGLSL:"float",length:2},uLowerUpperThreshold:{type:"fv1",value:[0,0],typeGLSL:"float",length:2},uRescaleSlopeIntercept:{type:"fv1",value:[0,0],typeGLSL:"float",length:2},uNumberOfChannels:{type:"i",value:1,typeGLSL:"int"},uBitsAllocated:{type:"i",value:8,typeGLSL:"int"},uInvert:{type:"i",value:0,typeGLSL:"int"},uLut:{type:"i",value:0,typeGLSL:"int"},uTextureLUT:{type:"t",value:[],typeGLSL:"sampler2D"},uLutSegmentation:{type:"i",value:0,typeGLSL:"int"},uTextureLUTSegmentation:{type:"t",value:[],typeGLSL:"sampler2D"},uPixelType:{type:"i",value:0,typeGLSL:"int"},uPackedPerPixel:{type:"i",value:1,typeGLSL:"int"},uInterpolation:{type:"i",value:1,typeGLSL:"int"},uCanvasWidth:{type:"f",value:0,typeGLSL:"float"},uCanvasHeight:{type:"f",value:0,typeGLSL:"float"},uBorderColor:{type:"v3",value:[1,0,.5],typeGLSL:"vec3"},uBorderWidth:{type:"f",value:2,typeGLSL:"float"},uBorderMargin:{type:"f",value:2,typeGLSL:"float"},uBorderDashLength:{type:"f",value:10,typeGLSL:"float"},uOpacity:{type:"f",value:1,typeGLSL:"float"},uSpacing:{type:"f",value:0,typeGLSL:"float"},uThickness:{type:"f",value:0,typeGLSL:"float"},uThicknessMethod:{type:"i",value:0,typeGLSL:"int"}}}}class H{compute(){return"\nvarying vec3 vPos;\nvarying vec3 vNormal;\n\nvoid main() {\n\tvNormal = normal;\n\tvPos = (modelMatrix * vec4(position, 1.0 )).xyz;\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0 );\n\n}\n\t\t\t\t"}}class G{constructor(){this._name="shadersBase",this._base={_functions:{},_uniforms:{}},this._definition=""}get name(){return this._name}set name(t){this._name=t}}var F=new class extends G{constructor(){super(),this.name="unpack",this._packedData="packedData",this._offset="offset",this._unpackedData="unpackedData",this._base._uniforms={uNumberOfChannels:{value:1},uBitsAllocated:{value:16},uPixelType:{value:0}}}api(t=this._base,e=this._packedData,i=this._offset,s=this._unpackedData){return this._base=t,this.compute(e,i,s)}compute(t,e,i){return this.computeDefinition(),this._base._functions[this._name]=this._definition,`${this._name}(${t}, ${e}, ${i});`}computeDefinition(){let t="";if(1===this._base._uniforms.uNumberOfChannels.value)switch(this._base._uniforms.uBitsAllocated.value){case 1:case 8:t=this.upack8();break;case 16:t=this.upack16();break;case 32:t=this.upack32();break;default:t=this.upackIdentity()}else t=this.upackIdentity();this._definition=`\nvoid ${this._name}(in vec4 packedData, in int offset, out vec4 unpackedData){\n\n${t}\n\n}\t\n\t\t`}upack8(){return this._base._functions.uInt8=this.uInt8(),"\nfloat floatedOffset = float(offset);\nfloat floatedOffsetSquared = floatedOffset * floatedOffset;\nuInt8(\n\tstep( floatedOffsetSquared , 0.0 ) * packedData.r +\n\tstep( floatedOffsetSquared - 2. * floatedOffset + 1., 0.0 ) * packedData.g +\n\tstep( floatedOffsetSquared - 2. * 2. *\tfloatedOffset + 4., 0.0 ) * packedData.b +\n\tstep( floatedOffsetSquared - 2. * 3. *\tfloatedOffset + 9., 0.0 ) * packedData.a\n\t,\n\tunpackedData.x);\n\t\t"}upack16(){return this._base._functions.uInt16=this.uInt16(),"\nfloat floatedOffset = float(offset);\nuInt16(\n\tpackedData.r * (1. - floatedOffset) + packedData.b * floatedOffset,\n\tpackedData.g * (1. - floatedOffset) + packedData.a * floatedOffset,\n\tunpackedData.x);\n\t\t"}upack32(){return 0===this._base._uniforms.uPixelType.value?(this._base._functions.uInt32=this.uInt32(),"\nuInt32(\n\tpackedData.r,\n\tpackedData.g,\n\tpackedData.b,\n\tpackedData.a,\n\tunpackedData.x);\n\t\t\t"):(this._base._functions.uFloat32=this.uFloat32(),"\nuFloat32(\n\tpackedData.r,\n\tpackedData.g,\n\tpackedData.b,\n\tpackedData.a,\n\tunpackedData.x);\n\t\t\t")}upackIdentity(){return"\nunpackedData = packedData;\n\t\t\t"}uInt8(){return"\nvoid uInt8(in float r, out float value){\n\tvalue = r * 255.;\n}\n\t\t"}uInt16(){return"\nvoid uInt16(in float r, in float a, out float value){\n\tvalue = r * 255. + a * 255. * 256.;\n}\n\t\t"}uInt32(){return"\nvoid uInt32(in float r, in float g, in float b, in float a, out float value){\n\tvalue = r * 255. + g * 255. * 256. + b * 255. * 256. * 256. + a * 255. * 256. * 256. * 256.;\n\t// value = r * 255. + g * 65025. + b * 16581375. + a * 4228250625.;\n}\n\t\t"}uFloat32(){return"\nvoid uFloat32(in float r, in float g, in float b, in float a, out float value){\n\n\t// create arrays containing bits for rgba values\n\t// value between 0 and 255\n\tvalue = r * 255.;\n\tint bytemeR[8];\n\tbytemeR[0] = int(floor(value / 128.));\n\tvalue -= float(bytemeR[0] * 128);\n\tbytemeR[1] = int(floor(value / 64.));\n\tvalue -= float(bytemeR[1] * 64);\n\tbytemeR[2] = int(floor(value / 32.));\n\tvalue -= float(bytemeR[2] * 32);\n\tbytemeR[3] = int(floor(value / 16.));\n\tvalue -= float(bytemeR[3] * 16);\n\tbytemeR[4] = int(floor(value / 8.));\n\tvalue -= float(bytemeR[4] * 8);\n\tbytemeR[5] = int(floor(value / 4.));\n\tvalue -= float(bytemeR[5] * 4);\n\tbytemeR[6] = int(floor(value / 2.));\n\tvalue -= float(bytemeR[6] * 2);\n\tbytemeR[7] = int(floor(value));\n\n\tvalue = g * 255.;\n\tint bytemeG[8];\n\tbytemeG[0] = int(floor(value / 128.));\n\tvalue -= float(bytemeG[0] * 128);\n\tbytemeG[1] = int(floor(value / 64.));\n\tvalue -= float(bytemeG[1] * 64);\n\tbytemeG[2] = int(floor(value / 32.));\n\tvalue -= float(bytemeG[2] * 32);\n\tbytemeG[3] = int(floor(value / 16.));\n\tvalue -= float(bytemeG[3] * 16);\n\tbytemeG[4] = int(floor(value / 8.));\n\tvalue -= float(bytemeG[4] * 8);\n\tbytemeG[5] = int(floor(value / 4.));\n\tvalue -= float(bytemeG[5] * 4);\n\tbytemeG[6] = int(floor(value / 2.));\n\tvalue -= float(bytemeG[6] * 2);\n\tbytemeG[7] = int(floor(value));\n\n\tvalue = b * 255.;\n\tint bytemeB[8];\n\tbytemeB[0] = int(floor(value / 128.));\n\tvalue -= float(bytemeB[0] * 128);\n\tbytemeB[1] = int(floor(value / 64.));\n\tvalue -= float(bytemeB[1] * 64);\n\tbytemeB[2] = int(floor(value / 32.));\n\tvalue -= float(bytemeB[2] * 32);\n\tbytemeB[3] = int(floor(value / 16.));\n\tvalue -= float(bytemeB[3] * 16);\n\tbytemeB[4] = int(floor(value / 8.));\n\tvalue -= float(bytemeB[4] * 8);\n\tbytemeB[5] = int(floor(value / 4.));\n\tvalue -= float(bytemeB[5] * 4);\n\tbytemeB[6] = int(floor(value / 2.));\n\tvalue -= float(bytemeB[6] * 2);\n\tbytemeB[7] = int(floor(value));\n\n\tvalue = a * 255.;\n\tint bytemeA[8];\n\tbytemeA[0] = int(floor(value / 128.));\n\tvalue -= float(bytemeA[0] * 128);\n\tbytemeA[1] = int(floor(value / 64.));\n\tvalue -= float(bytemeA[1] * 64);\n\tbytemeA[2] = int(floor(value / 32.));\n\tvalue -= float(bytemeA[2] * 32);\n\tbytemeA[3] = int(floor(value / 16.));\n\tvalue -= float(bytemeA[3] * 16);\n\tbytemeA[4] = int(floor(value / 8.));\n\tvalue -= float(bytemeA[4] * 8);\n\tbytemeA[5] = int(floor(value / 4.));\n\tvalue -= float(bytemeA[5] * 4);\n\tbytemeA[6] = int(floor(value / 2.));\n\tvalue -= float(bytemeA[6] * 2);\n\tbytemeA[7] = int(floor(value));\n\n\t// compute float32 value from bit arrays\n\n\t// sign\n\tint issigned = 1 - 2 * bytemeR[0];\n\t//\t issigned = int(pow(-1., float(bytemeR[0])));\n\n\t// exponent\n\tint exponent = 0;\n\n\texponent += bytemeR[1] * int(pow(2., 7.));\n\texponent += bytemeR[2] * int(pow(2., 6.));\n\texponent += bytemeR[3] * int(pow(2., 5.));\n\texponent += bytemeR[4] * int(pow(2., 4.));\n\texponent += bytemeR[5] * int(pow(2., 3.));\n\texponent += bytemeR[6] * int(pow(2., 2.));\n\texponent += bytemeR[7] * int(pow(2., 1.));\n\n\texponent += bytemeG[0];\n\n\n\t// fraction\n\tfloat fraction = 0.;\n\n\tfraction = float(bytemeG[1]) * pow(2., -1.);\n\tfraction += float(bytemeG[2]) * pow(2., -2.);\n\tfraction += float(bytemeG[3]) * pow(2., -3.);\n\tfraction += float(bytemeG[4]) * pow(2., -4.);\n\tfraction += float(bytemeG[5]) * pow(2., -5.);\n\tfraction += float(bytemeG[6]) * pow(2., -6.);\n\tfraction += float(bytemeG[7]) * pow(2., -7.);\n\n\tfraction += float(bytemeB[0]) * pow(2., -8.);\n\tfraction += float(bytemeB[1]) * pow(2., -9.);\n\tfraction += float(bytemeB[2]) * pow(2., -10.);\n\tfraction += float(bytemeB[3]) * pow(2., -11.);\n\tfraction += float(bytemeB[4]) * pow(2., -12.);\n\tfraction += float(bytemeB[5]) * pow(2., -13.);\n\tfraction += float(bytemeB[6]) * pow(2., -14.);\n\tfraction += float(bytemeB[7]) * pow(2., -15.);\n\n\tfraction += float(bytemeA[0]) * pow(2., -16.);\n\tfraction += float(bytemeA[1]) * pow(2., -17.);\n\tfraction += float(bytemeA[2]) * pow(2., -18.);\n\tfraction += float(bytemeA[3]) * pow(2., -19.);\n\tfraction += float(bytemeA[4]) * pow(2., -20.);\n\tfraction += float(bytemeA[5]) * pow(2., -21.);\n\tfraction += float(bytemeA[6]) * pow(2., -22.);\n\tfraction += float(bytemeA[7]) * pow(2., -23.);\n\n\tvalue = float(issigned) * pow( 2., float(exponent - 127)) * (1. + fraction);\n}\n\t\t"}};var V=new class extends G{constructor(){super(),this.name="texture3d",this._dataCoordinates="dataCoordinates",this._dataValue="dataValue",this._offset="offset"}api(t=this._base,e=this._dataCoordinates,i=this._dataValue,s=this._offset){return this._base=t,this.compute(e,i,s)}compute(t,e,i){return this.computeDefinition(),this._base._functions[this._name]=this._definition,`${this._name}(${t}, ${e}, ${i});`}computeDefinition(){let t="\n\t\t\tstep( abs( textureIndexF - 0.0 ), 0.0 ) * texture2D(uTextureContainer[0], uv) +\n\t\t\tstep( abs( textureIndexF - 1.0 ), 0.0 ) * texture2D(uTextureContainer[1], uv) +\n\t\t\tstep( abs( textureIndexF - 2.0 ), 0.0 ) * texture2D(uTextureContainer[2], uv) +\n\t\t\tstep( abs( textureIndexF - 3.0 ), 0.0 ) * texture2D(uTextureContainer[3], uv) +\n\t\t\tstep( abs( textureIndexF - 4.0 ), 0.0 ) * texture2D(uTextureContainer[4], uv) +\n\t\t\tstep( abs( textureIndexF - 5.0 ), 0.0 ) * texture2D(uTextureContainer[5], uv) +\n\t\t\tstep( abs( textureIndexF - 6.0 ), 0.0 ) * texture2D(uTextureContainer[6], uv)";14===this._base._uniforms.uTextureContainer.length&&(t+=" +\n\t\t\tstep( abs( textureIndexF - 7.0 ), 0.0 ) * texture2D(uTextureContainer[7], uv) +\n\t\t\tstep( abs( textureIndexF - 8.0 ), 0.0 ) * texture2D(uTextureContainer[8], uv) +\n\t\t\tstep( abs( textureIndexF - 9.0 ), 0.0 ) * texture2D(uTextureContainer[9], uv) +\n\t\t\tstep( abs( textureIndexF - 10.0 ), 0.0 ) * texture2D(uTextureContainer[10], uv) +\n\t\t\tstep( abs( textureIndexF - 11.0 ), 0.0 ) * texture2D(uTextureContainer[11], uv) +\n\t\t\tstep( abs( textureIndexF - 12.0 ), 0.0 ) * texture2D(uTextureContainer[12], uv) +\n\t\t\tstep( abs( textureIndexF - 13.0 ), 0.0 ) * texture2D(uTextureContainer[13], uv)"),this._definition=`\nvoid ${this._name}(in ivec3 dataCoordinates, out vec4 dataValue, out int offset){\n\tfloat textureSizeF = float(uTextureSize);\n\tint voxelsPerTexture = uTextureSize*uTextureSize;\n\n\tint index = dataCoordinates.x\n\t\t\t\t\t\t+ dataCoordinates.y * uDataDimensions.x\n\t\t\t\t\t\t+ dataCoordinates.z * uDataDimensions.y * uDataDimensions.x;\n\t\n\t// dividing an integer by an integer will give you an integer result, rounded down\n\t// can not get float numbers to work :(\n\tint packedIndex = index/uPackedPerPixel;\n\toffset = index - uPackedPerPixel*packedIndex;\n\n\t// Map data index to right sampler2D texture\n\tint textureIndex = packedIndex/voxelsPerTexture;\n\tint inTextureIndex = packedIndex - voxelsPerTexture*textureIndex;\n\n\t// Get row and column in the texture\n\tint rowIndex = inTextureIndex/uTextureSize;\n\tfloat rowIndexF = float(rowIndex);\n\tfloat colIndex = float(inTextureIndex - uTextureSize * rowIndex);\n\n\t// Map row and column to uv\n\tvec2 uv = vec2(0,0);\n\tuv.x = (0.5 + colIndex) / textureSizeF;\n\tuv.y = 1. - (0.5 + rowIndexF) / textureSizeF;\n\n\tfloat textureIndexF = float(textureIndex);\n\tdataValue = vec4(0.) + ${t};\n}\n\t\t`}};var R=new class extends G{constructor(){super(),this.name="interpolationIdentity",this._currentVoxel="currentVoxel",this._dataValue="dataValue"}api(t=this._base,e=this._currentVoxel,i=this._dataValue){return this._base=t,this.compute(e,i)}compute(t,e){return this.computeDefinition(),this._base._functions[this._name]=this._definition,`${this._name}(${t}, ${e});`}computeDefinition(){this._definition=`\nvoid ${this._name}(in vec3 currentVoxel, out vec4 dataValue){\n\t// lower bound\n\tvec3 rcurrentVoxel = vec3(floor(currentVoxel.x + 0.5 ), floor(currentVoxel.y + 0.5 ), floor(currentVoxel.z + 0.5 ));\n\tivec3 voxel = ivec3(int(rcurrentVoxel.x), int(rcurrentVoxel.y), int(rcurrentVoxel.z));\n\n\tvec4 tmp = vec4(0., 0., 0., 0.);\n\tint offset = 0;\n\n\t${V.api(this._base,"voxel","tmp","offset")}\n\t${F.api(this._base,"tmp","offset","dataValue")}\n}\n\t\t`}};var B=new class extends G{constructor(){super(),this.name="interpolationTrilinear",this._currentVoxel="currentVoxel",this._dataValue="dataValue",this._gradient="gradient"}api(t=this._base,e=this._currentVoxel,i=this._dataValue,s=this._gradient){return this._base=t,this.compute(e,i,s)}compute(t,e,i){return this.computeDefinition(),this._base._functions[this._name]=this._definition,`${this._name}(${t}, ${e}, ${i});`}computeDefinition(){this._definition=`\nvoid trilinearInterpolation(\n\tin vec3 normalizedPosition,\n\tout vec4 interpolatedValue,\n\tin vec4 v000, in vec4 v100,\n\tin vec4 v001, in vec4 v101,\n\tin vec4 v010, in vec4 v110,\n\tin vec4 v011, in vec4 v111) {\n\t// https://en.wikipedia.org/wiki/Trilinear_interpolation\n\tvec4 c00 = v000 * ( 1.0 - normalizedPosition.x ) + v100 * normalizedPosition.x;\n\tvec4 c01 = v001 * ( 1.0 - normalizedPosition.x ) + v101 * normalizedPosition.x;\n\tvec4 c10 = v010 * ( 1.0 - normalizedPosition.x ) + v110 * normalizedPosition.x;\n\tvec4 c11 = v011 * ( 1.0 - normalizedPosition.x ) + v111 * normalizedPosition.x;\n\n\t// c0 and c1\n\tvec4 c0 = c00 * ( 1.0 - normalizedPosition.y) + c10 * normalizedPosition.y;\n\tvec4 c1 = c01 * ( 1.0 - normalizedPosition.y) + c11 * normalizedPosition.y;\n\n\t// c\n\tvec4 c = c0 * ( 1.0 - normalizedPosition.z) + c1 * normalizedPosition.z;\n\tinterpolatedValue = c;\n}\n\nvoid ${this._name}(in vec3 currentVoxel, out vec4 dataValue, out vec3 gradient){\n\n\tvec3 lower_bound = floor(currentVoxel);\n\tlower_bound = max(vec3(0.), lower_bound);\n\t\n\tvec3 higher_bound = lower_bound + vec3(1.);\n\n\tvec3 normalizedPosition = (currentVoxel - lower_bound);\n\tnormalizedPosition =\tmax(vec3(0.), normalizedPosition);\n\n\tvec4 interpolatedValue = vec4(0.);\n\n\t//\n\t// fetch values required for interpolation\n\t//\n\tvec4 v000 = vec4(0.0, 0.0, 0.0, 0.0);\n\tvec3 c000 = vec3(lower_bound.x, lower_bound.y, lower_bound.z);\n\t${R.api(this._base,"c000","v000")}\n\n\t//\n\tvec4 v100 = vec4(0.0, 0.0, 0.0, 0.0);\n\tvec3 c100 = vec3(higher_bound.x, lower_bound.y, lower_bound.z);\n\t${R.api(this._base,"c100","v100")}\n\n\t//\n\tvec4 v001 = vec4(0.0, 0.0, 0.0, 0.0);\n\tvec3 c001 = vec3(lower_bound.x, lower_bound.y, higher_bound.z);\n\t${R.api(this._base,"c001","v001")}\n\n\t//\n\tvec4 v101 = vec4(0.0, 0.0, 0.0, 0.0);\n\tvec3 c101 = vec3(higher_bound.x, lower_bound.y, higher_bound.z);\n\t${R.api(this._base,"c101","v101")}\n\t\n\t//\n\tvec4 v010 = vec4(0.0, 0.0, 0.0, 0.0);\n\tvec3 c010 = vec3(lower_bound.x, higher_bound.y, lower_bound.z);\n\t${R.api(this._base,"c010","v010")}\n\n\tvec4 v110 = vec4(0.0, 0.0, 0.0, 0.0);\n\tvec3 c110 = vec3(higher_bound.x, higher_bound.y, lower_bound.z);\n\t${R.api(this._base,"c110","v110")}\n\n\t//\n\tvec4 v011 = vec4(0.0, 0.0, 0.0, 0.0);\n\tvec3 c011 = vec3(lower_bound.x, higher_bound.y, higher_bound.z);\n\t${R.api(this._base,"c011","v011")}\n\n\tvec4 v111 = vec4(0.0, 0.0, 0.0, 0.0);\n\tvec3 c111 = vec3(higher_bound.x, higher_bound.y, higher_bound.z);\n\t${R.api(this._base,"c111","v111")}\n\n\t// compute interpolation at position\n\ttrilinearInterpolation(normalizedPosition, interpolatedValue ,v000, v100, v001, v101, v010,v110, v011,v111);\n\tdataValue = interpolatedValue;\n\n\t// That breaks shading in volume rendering\n\t// if (gradient.x == 1.) { // skip gradient calculation for slice helper\n\t//\treturn;\n\t// }\n\n\t// compute gradient\n\tfloat gradientStep = 0.005;\n\n\t// x axis\n\tvec3 g100 = vec3(1., 0., 0.);\n\tvec3 ng100 = normalizedPosition + g100 * gradientStep;\n\tng100.x = min(1., ng100.x);\n\n\tvec4 vg100 = vec4(0.);\n\ttrilinearInterpolation(ng100, vg100 ,v000, v100, v001, v101, v010,v110, v011,v111);\n\n\tvec3 go100 = -g100;\n\tvec3 ngo100 = normalizedPosition + go100 * gradientStep;\n\tngo100.x = max(0., ngo100.x);\n\n\tvec4 vgo100 = vec4(0.);\n\ttrilinearInterpolation(ngo100, vgo100 ,v000, v100, v001, v101, v010,v110, v011,v111);\n\n\tgradient.x = (g100.x * vg100.x + go100.x * vgo100.x);\n\n\t// y axis\n\tvec3 g010 = vec3(0., 1., 0.);\n\tvec3 ng010 = normalizedPosition + g010 * gradientStep;\n\tng010.y = min(1., ng010.y);\n\n\tvec4 vg010 = vec4(0.);\n\ttrilinearInterpolation(ng010, vg010 ,v000, v100, v001, v101, v010,v110, v011,v111);\n\n\tvec3 go010 = -g010;\n\tvec3 ngo010 = normalizedPosition + go010 * gradientStep;\n\tngo010.y = max(0., ngo010.y);\n\n\tvec4 vgo010 = vec4(0.);\n\ttrilinearInterpolation(ngo010, vgo010 ,v000, v100, v001, v101, v010,v110, v011,v111);\n\n\tgradient.y = (g010.y * vg010.x + go010.y * vgo010.x);\n\n\t// z axis\n\tvec3 g001 = vec3(0., 0., 1.);\n\tvec3 ng001 = normalizedPosition + g001 * gradientStep;\n\tng001.z = min(1., ng001.z);\n\n\tvec4 vg001 = vec4(0.);\n\ttrilinearInterpolation(ng001, vg001 ,v000, v100, v001, v101, v010,v110, v011,v111);\n\n\tvec3 go001 = -g001;\n\tvec3 ngo001 = normalizedPosition + go001 * gradientStep;\n\tngo001.z = max(0., ngo001.z);\n\n\tvec4 vgo001 = vec4(0.);\n\ttrilinearInterpolation(ngo001, vgo001 ,v000, v100, v001, v101, v010,v110, v011,v111);\n\n\tgradient.z = (g001.z * vg001.x + go001.z * vgo001.x);\n\n\t// normalize gradient\n\t// +0.0001\tinstead of if?\n\tfloat gradientMagnitude = length(gradient);\n\tif (gradientMagnitude > 0.0) {\n\t\tgradient = -(1. / gradientMagnitude) * gradient;\n\t}\n}\n\t\t`}};function z(t,e,i,s){switch(t._uniforms.uInterpolation.value){case 0:default:return R.api(t,e,i);case 1:return B.api(t,e,i,s)}}class N{constructor(t){this._uniforms=t,this._functions={},this._main=""}functions(){""===this._main&&this.main();let t="";for(let e in this._functions)t+=this._functions[e]+"\n";return t}uniforms(){let t="";for(let e in this._uniforms){let i=this._uniforms[e];t+=`uniform ${i.typeGLSL} ${e}`,i&&i.length&&(t+=`[${i.length}]`),t+=";\n"}return t}main(){this._main=`\nvoid main(void) {\n\n\t// draw border if slice is cropped\n\t// float uBorderDashLength = 10.;\n\n\tif( uCanvasWidth > 0. &&\n\t\t\t((gl_FragCoord.x > uBorderMargin && (gl_FragCoord.x - uBorderMargin) < uBorderWidth) ||\n\t\t\t (gl_FragCoord.x < (uCanvasWidth - uBorderMargin) && (gl_FragCoord.x + uBorderMargin) > (uCanvasWidth - uBorderWidth) ))){\n\t\tfloat valueY = mod(gl_FragCoord.y, 2. * uBorderDashLength);\n\t\tif( valueY < uBorderDashLength && gl_FragCoord.y > uBorderMargin && gl_FragCoord.y < (uCanvasHeight - uBorderMargin) ){\n\t\t\tgl_FragColor = vec4(uBorderColor, 1.);\n\t\t\treturn;\n\t\t}\n\t}\n\n\tif( uCanvasHeight > 0. &&\n\t\t\t((gl_FragCoord.y > uBorderMargin && (gl_FragCoord.y - uBorderMargin) < uBorderWidth) ||\n\t\t\t (gl_FragCoord.y < (uCanvasHeight - uBorderMargin) && (gl_FragCoord.y + uBorderMargin) > (uCanvasHeight - uBorderWidth) ))){\n\t\tfloat valueX = mod(gl_FragCoord.x, 2. * uBorderDashLength);\n\t\tif( valueX < uBorderDashLength && gl_FragCoord.x > uBorderMargin && gl_FragCoord.x < (uCanvasWidth - uBorderMargin) ){\n\t\t\tgl_FragColor = vec4(uBorderColor, 1.);\n\t\t\treturn;\n\t\t}\n\t}\n\n\t// get texture coordinates of current pixel\n\tvec4 dataValue = vec4(0.);\n\tvec3 gradient = vec3(1.); // gradient calculations will be skipped if it is equal to vec3(1.) \n\tfloat steps = floor(uThickness / uSpacing + 0.5);\n\n\tif (steps > 1.) {\n\t\tvec3 origin = vPos - uThickness * 0.5 * vNormal;\n\t\tvec4 dataValueAcc = vec4(0.);\n\t\tfor (float step = 0.; step < 128.; step++) {\n\t\t\tif (step >= steps) {\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tvec4 dataCoordinates = uWorldToData * vec4(origin + step * uSpacing * vNormal, 1.);\n\t\t\tvec3 currentVoxel = dataCoordinates.xyz;\n\t\t\t${z(this,"currentVoxel","dataValueAcc","gradient")};\n\n\t\t\tif (step == 0.) {\n\t\t\t\tdataValue.r = dataValueAcc.r;\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tif (uThicknessMethod == 0) {\n\t\t\t\tdataValue.r = max(dataValueAcc.r, dataValue.r);\n\t\t\t}\n\t\t\tif (uThicknessMethod == 1) {\n\t\t\t\tdataValue.r += dataValueAcc.r;\n\t\t\t}\n\t\t\tif (uThicknessMethod == 2) {\n\t\t\t\tdataValue.r = min(dataValueAcc.r, dataValue.r);\n\t\t\t}\n\t\t}\n\n\t\tif (uThicknessMethod == 1) {\n\t\t\tdataValue.r /= steps;\n\t\t}\n\t} else {\n\t\tvec4 dataCoordinates = uWorldToData * vec4(vPos, 1.);\n\t\tvec3 currentVoxel = dataCoordinates.xyz;\n\t\t${z(this,"currentVoxel","dataValue","gradient")}\n\t}\n\n\tif(uNumberOfChannels == 1){\n\t\t// rescale/slope\n\t\tfloat realIntensity = dataValue.r * uRescaleSlopeIntercept[0] + uRescaleSlopeIntercept[1];\n\t\n\t\t// threshold\n\t\tif (realIntensity < uLowerUpperThreshold[0] || realIntensity > uLowerUpperThreshold[1]) {\n\t\t\tdiscard;\n\t\t}\n\t\n\t\t// normalize\n\t\tfloat windowMin = uWindowCenterWidth[0] - uWindowCenterWidth[1] * 0.5;\n\t\tfloat normalizedIntensity =\n\t\t\t( realIntensity - windowMin ) / uWindowCenterWidth[1];\n\t\tdataValue.r = dataValue.g = dataValue.b = normalizedIntensity;\n\t\tdataValue.a = 1.;\n\n\t\t// apply LUT\n\t\tif(uLut == 1){\n\t\t\t// should opacity be grabbed there?\n\t\t\tdataValue = texture2D( uTextureLUT, vec2( normalizedIntensity , 1.0) );\n\t\t}\n\t\n\t\t// apply segmentation\n\t\tif(uLutSegmentation == 1){\n\t\t\t// should opacity be grabbed there?\n\t\t\t//\n\t\t\tfloat textureWidth = 256.;\n\t\t\tfloat textureHeight = 128.;\n\t\t\tfloat min = 0.;\n\t\t\t// start at 0!\n\t\t\tint adjustedIntensity = int(floor(realIntensity + 0.5));\n\t\n\t\t\t// Get row and column in the texture\n\t\t\tint colIndex = int(mod(float(adjustedIntensity), textureWidth));\n\t\t\tint rowIndex = int(floor(float(adjustedIntensity)/textureWidth));\n\t\n\t\t\tfloat texWidth = 1./textureWidth;\n\t\t\tfloat texHeight = 1./textureHeight;\n\t\t\n\t\t\t// Map row and column to uv\n\t\t\tvec2 uv = vec2(0,0);\n\t\t\tuv.x = 0.5 * texWidth + (texWidth * float(colIndex));\n\t\t\tuv.y = 1. - (0.5 * texHeight + float(rowIndex) * texHeight);\n\t\n\t\t\tdataValue = texture2D( uTextureLUTSegmentation, uv );\n\t\t}\n\t}\n\n\tif(uInvert == 1){\n\t\tdataValue.xyz = vec3(1.) - dataValue.xyz;\n\t}\n\n\tdataValue.a = dataValue.a*uOpacity;\n\n\tgl_FragColor = dataValue;\n}\n\t `}compute(){return`\n// uniforms\n${this.uniforms()}\n\n// varying (should fetch it from vertex directly)\nvarying vec3 vPos;\nvarying vec3 vNormal;\n\n// tailored functions\n${this.functions()}\n\n// main loop\n${this._main}\n\t\t\t`}}class U extends e.Object3D{_createMaterial(t){let i=new this._shadersFragment(this._uniforms),s=new this._shadersVertex,a={uniforms:this._uniforms,vertexShader:s.compute(),fragmentShader:i.compute()},o=Object.assign(t,a);this._material=new e.ShaderMaterial(o),this._material.needsUpdate=!0}_updateMaterial(){let t=new this._shadersFragment(this._uniforms),e=new this._shadersVertex;this._material.vertexShader=e.compute(),this._material.fragmentShader=t.compute(),this._material.needsUpdate=!0}_prepareTexture(){this._textures=[];for(let t=0;t<this._stack._rawData.length;t++){let i=new e.DataTexture(this._stack.rawData[t],this._stack.textureSize,this._stack.textureSize,this._stack.textureType,e.UnsignedByteType,e.UVMapping,e.ClampToEdgeWrapping,e.ClampToEdgeWrapping,e.NearestFilter,e.NearestFilter);i.needsUpdate=!0,i.flipY=!0,this._textures.push(i)}}}class j extends U{constructor(t,i=0,s=new e.Vector3(0,0,0),a=new e.Vector3(0,0,1),o="IJK"){super(),this._stack=t,this._invert=this._stack.invert,this._lut="none",this._lutTexture=null,this._intensityAuto=!0,this._interpolation=1,this._index=i,this._windowWidth=null,this._windowCenter=null,this._opacity=1,this._rescaleSlope=null,this._rescaleIntercept=null,this._spacing=1,this._thickness=0,this._thicknessMethod=0,this._lowerThreshold=null,this._upperThreshold=null,this._canvasWidth=0,this._canvasHeight=0,this._borderColor=null,this._planePosition=s,this._planeDirection=a,this._aaBBspace=o,this._material=null,this._textures=[],this._shadersFragment=N,this._shadersVertex=H,this._uniforms=k.uniforms(),this._geometry=null,this._mesh=null,this._visible=!0,this._init(),this._create()}get stack(){return this._stack}set stack(t){this._stack=t}get spacing(){return this._spacing}set spacing(t){this._spacing=t,this._uniforms.uSpacing.value=this._spacing}get thickness(){return this._thickness}set thickness(t){this._thickness=t,this._uniforms.uThickness.value=this._thickness}get thicknessMethod(){return this._thicknessMethod}set thicknessMethod(t){this._thicknessMethod=t,this._uniforms.uThicknessMethod.value=this._thicknessMethod}get windowWidth(){return this._windowWidth}set windowWidth(t){this._windowWidth=t,this.updateIntensitySettingsUniforms()}get windowCenter(){return this._windowCenter}set windowCenter(t){this._windowCenter=t,this.updateIntensitySettingsUniforms()}get opacity(){return this._opacity}set opacity(t){this._opacity=t,this.updateIntensitySettingsUniforms()}get upperThreshold(){return this._upperThreshold}set upperThreshold(t){this._upperThreshold=t,this.updateIntensitySettingsUniforms()}get lowerThreshold(){return this._lowerThreshold}set lowerThreshold(t){this._lowerThreshold=t,this.updateIntensitySettingsUniforms()}get rescaleSlope(){return this._rescaleSlope}set rescaleSlope(t){this._rescaleSlope=t,this.updateIntensitySettingsUniforms()}get rescaleIntercept(){return this._rescaleIntercept}set rescaleIntercept(t){this._rescaleIntercept=t,this.updateIntensitySettingsUniforms()}get invert(){return this._invert}set invert(t){this._invert=t,this.updateIntensitySettingsUniforms()}get lut(){return this._lut}set lut(t){this._lut=t}get lutTexture(){return this._lutTexture}set lutTexture(t){this._lutTexture=t,this.updateIntensitySettingsUniforms()}get intensityAuto(){return this._intensityAuto}set intensityAuto(t){this._intensityAuto=t,this.updateIntensitySettings(),this.updateIntensitySettingsUniforms()}get interpolation(){return this._interpolation}set interpolation(t){this._interpolation=t,this.updateIntensitySettingsUniforms(),this._updateMaterial()}get index(){return this._index}set index(t){this._index=t,this._update()}set planePosition(t){this._planePosition=t,this._update()}get planePosition(){return this._planePosition}set planeDirection(t){this._planeDirection=t,this._update()}get planeDirection(){return this._planeDirection}set halfDimensions(t){this._halfDimensions=t}get halfDimensions(){return this._halfDimensions}set center(t){this._center=t}get center(){return this._center}set aabbSpace(t){this._aaBBspace=t,this._init()}get aabbSpace(){return this._aaBBspace}set mesh(t){this._mesh=t}get mesh(){return this._mesh}set geometry(t){this._geometry=t}get geometry(){return this._geometry}set canvasWidth(t){this._canvasWidth=t,this._uniforms.uCanvasWidth.value=this._canvasWidth}get canvasWidth(){return this._canvasWidth}set canvasHeight(t){this._canvasHeight=t,this._uniforms.uCanvasHeight.value=this._canvasHeight}get canvasHeight(){return this._canvasHeight}set borderColor(t){this._borderColor=t,this._uniforms.uBorderColor.value=new e.Color(t)}get borderColor(){return this._borderColor}_init(){if(this._stack&&this._stack._prepared&&this._stack._packed)if("IJK"===this._aaBBspace)this._halfDimensions=this._stack.halfDimensionsIJK,this._center=new e.Vector3(this._stack.halfDimensionsIJK.x-.5,this._stack.halfDimensionsIJK.y-.5,this._stack.halfDimensionsIJK.z-.5),this._toAABB=new e.Matrix4;else{let t=this._stack.AABBox();this._halfDimensions=t.clone().multiplyScalar(.5),this._center=this._stack.centerAABBox(),this._toAABB=this._stack.lps2AABB}}_create(){if(this._stack&&this._stack.prepared&&this._stack.packed){try{const t=f();this._geometry=new t(this._halfDimensions,this._center,this._planePosition,this._planeDirection,this._toAABB)}catch(t){return console.log(t),void console.log("invalid slice geometry - exiting...")}this._geometry.vertices&&(this._material||(this._uniforms.uTextureSize.value=this._stack.textureSize,this._uniforms.uDataDimensions.value=[this._stack.dimensionsIJK.x,this._stack.dimensionsIJK.y,this._stack.dimensionsIJK.z],this._uniforms.uWorldToData.value=this._stack.lps2IJK,this._uniforms.uNumberOfChannels.value=this._stack.numberOfChannels,this._uniforms.uPixelType.value=this._stack.pixelType,this._uniforms.uBitsAllocated.value=this._stack.bitsAllocated,this._uniforms.uPackedPerPixel.value=this._stack.packedPerPixel,this._uniforms.uSpacing.value=this._spacing,this._uniforms.uThickness.value=this._thickness,this._uniforms.uThicknessMethod.value=this._thicknessMethod,this._prepareTexture(),this._uniforms.uTextureContainer.value=this._textures,this._stack.textureUnits>8&&(this._uniforms.uTextureContainer.length=14),this._createMaterial({side:e.DoubleSide})),this.updateIntensitySettings(),this.updateIntensitySettingsUniforms(),this._mesh=new e.Mesh(this._geometry,this._material),"IJK"===this._aaBBspace&&this._mesh.applyMatrix4(this._stack.ijk2LPS),this._mesh.visible=this._visible,this.add(this._mesh))}}updateIntensitySettings(){this._intensityAuto?(this.updateIntensitySetting("windowCenter"),this.updateIntensitySetting("windowWidth"),this.updateIntensitySetting("rescaleSlope"),this.updateIntensitySetting("rescaleIntercept")):(null===this._windowCenter&&(this._windowCenter=this._stack.windowCenter),null===this._windowWidth&&(this._windowWidth=this._stack.windowWidth),null===this._rescaleSlope&&(this._rescaleSlope=this._stack.rescaleSlope),null===this._rescaleIntercept&&(this._rescaleIntercept=this._stack.rescaleIntercept)),null===this._upperThreshold&&(this._upperThreshold=this._stack._minMax[1]),null===this._lowerThreshold&&(this._lowerThreshold=this._stack._minMax[0])}updateIntensitySettingsUniforms(){let t=0;this._stack._minMax[0]<0&&(t-=this._stack._minMax[0]),this._uniforms.uRescaleSlopeIntercept.value=[this._rescaleSlope,this._rescaleIntercept],this._uniforms.uWindowCenterWidth.value=[t+this._windowCenter,this._windowWidth],this._uniforms.uOpacity.value=this._opacity,this._uniforms.uLowerUpperThreshold.value=[t+this._lowerThreshold,t+this._upperThreshold],this._uniforms.uInvert.value=!0===this._invert?1:0,this._uniforms.uInterpolation.value=this._interpolation,"none"===this._lut?this._uniforms.uLut.value=0:(this._uniforms.uLut.value=1,this._uniforms.uTextureLUT.value=this._lutTexture)}updateIntensitySetting(t){this._stack.frame[this._index]&&this._stack.frame[this._index][t]?this["_"+t]=this._stack.frame[this._index][t]:this["_"+t]=this._stack[t]}_update(){this._mesh&&(this.remove(this._mesh),this._mesh.geometry.dispose(),this._mesh.geometry=null,this._mesh=null),this._create()}dispose(){for(let t=0;t<this._textures.length;t++)this._textures[t].dispose(),this._textures[t]=null;this._textures=null,this._shadersFragment=null,this._shadersVertex=null,this._uniforms=null,this.remove(this._mesh),this._mesh.geometry.dispose(),this._mesh.geometry=null,this._mesh.material.dispose(),this._mesh.material=null,this._mesh=null,this._geometry.dispose(),this._geometry=null,this._material.vertexShader=null,this._material.fragmentShader=null,this._material.uniforms=null,this._material.dispose(),this._material=null,this._stack=null}cartesianEquation(){if(!this._geometry||!this._geometry.vertices||this._geometry.vertices.length<3)return new e.Vector4;let t=this._geometry.vertices,i=this._stack.ijk2LPS,s=new e.Vector3(t[0].x,t[0].y,t[0].z).applyMatrix4(i),a=new e.Vector3(t[1].x,t[1].y,t[1].z).applyMatrix4(i),o=new e.Vector3(t[2].x,t[2].y,t[2].z).applyMatrix4(i),n=new e.Vector3,l=new e.Vector3,r=n.subVectors(o,a).cross(l.subVectors(s,a)).normalize();return new e.Vector4(r.x,r.y,r.z,-r.dot(s))}}class W extends e.Object3D{constructor(t){super(),this._stack=t,this._bBox=null,this._slice=null,this._border=null,this._dummy=null,this._orientation=0,this._index=0,this._uniforms=null,this._autoWindowLevel=!1,this._outOfBounds=!1,this._orientationMaxIndex=0,this._orientationSpacing=0,this._canvasWidth=0,this._canvasHeight=0,this._borderColor=null,this._create()}get stack(){return this._stack}set stack(t){this._stack=t}get bbox(){return this._bBox}get slice(){return this._slice}get border(){return this._border}get index(){return this._index}set index(t){this._index=t,this._slice.index=t;let e=this._stack.halfDimensionsIJK;this._slice.planePosition=this._prepareSlicePosition(e,this._index),this._border.helpersSlice=this._slice,this._isIndexOutOfBounds()}set orientation(t){this._orientation=t,this._computeOrientationMaxIndex(),this._computeOrientationSpacing(),this._slice.spacing=Math.abs(this._orientationSpacing),this._slice.thickness=this._slice.spacing,this._slice.planeDirection=this._prepareDirection(this._orientation),this._border.helpersSlice=this._slice}get orientation(){return this._orientation}set outOfBounds(t){this._outOfBounds=t}get outOfBounds(){return this._outOfBounds}set orientationMaxIndex(t){this._orientationMaxIndex=t}get orientationMaxIndex(){return this._orientationMaxIndex}set orientationSpacing(t){this._orientationSpacing=t}get orientationSpacing(){return this._orientationSpacing}set canvasWidth(t){this._canvasWidth=t,this._slice.canvasWidth=this._canvasWidth}get canvasWidth(){return this._canvasWidth}set canvasHeight(t){this._canvasHeight=t,this._slice.canvasHeight=this._canvasHeight}get canvasHeight(){return this._canvasHeight}set borderColor(t){this._borderColor=t,this._border.color=t,this._slice.borderColor=this._borderColor}get borderColor(){return this._borderColor}_create(){this._stack?(this._prepareStack(),this._prepareBBox(),this._prepareSlice(),this._prepareBorder()):console.log("no stack to be prepared...")}_computeOrientationSpacing(){let t=this._stack._spacing;switch(this._orientation){case 0:this._orientationSpacing=t.z;break;case 1:this._orientationSpacing=t.x;break;case 2:this._orientationSpacing=t.y;break;default:this._orientationSpacing=0}}_computeOrientationMaxIndex(){let t=this._stack.dimensionsIJK;switch(this._orientationMaxIndex=0,this._orientation){case 0:this._orientationMaxIndex=t.z-1;break;case 1:this._orientationMaxIndex=t.x-1;break;case 2:this._orientationMaxIndex=t.y-1}}_isIndexOutOfBounds(){this._computeOrientationMaxIndex(),this._index>=this._orientationMaxIndex||this._index<0?this._outOfBounds=!0:this._outOfBounds=!1}_prepareStack(){this._stack.prepared||this._stack.prepare(),this._stack.packed||this._stack.pack()}_prepareBBox(){const t=w();this._bBox=new t(this._stack),this.add(this._bBox)}_prepareBorder(){const t=x();this._border=new t(this._slice),this.add(this._border)}_prepareSlice(){let t=this._stack.halfDimensionsIJK;this._index=this._prepareSliceIndex(t);let e=this._prepareSlicePosition(t,this._index),i=this._prepareDirection(this._orientation);const s=j();this._slice=new s(this._stack,this._index,e,i),this.add(this._slice)}_prepareSliceIndex(t){let e=0;switch(this._orientation){case 0:e=Math.floor(t.z);break;case 1:e=Math.floor(t.x);break;case 2:e=Math.floor(t.y)}return e}_prepareSlicePosition(t,i){let s=new e.Vector3(0,0,0);switch(this._orientation){case 0:s=new e.Vector3(Math.floor(t.x),Math.floor(t.y),i);break;case 1:s=new e.Vector3(i,Math.floor(t.y),Math.floor(t.z));break;case 2:s=new e.Vector3(Math.floor(t.x),i,Math.floor(t.z))}return s}_prepareDirection(t){let i=new e.Vector3(0,0,1);switch(t){case 0:i=new e.Vector3(0,0,1);break;case 1:i=new e.Vector3(1,0,0);break;case 2:i=new e.Vector3(0,1,0)}return i}dispose(){this.remove(this._slice),this._slice.dispose(),this._slice=null,this._bBox.dispose(),this._bBox=null,this._border.dispose(),this._border=null}}class ${static uniforms(){return{uTextureSize:{type:"i",value:0,typeGLSL:"int"},uTextureContainer:{type:"tv",value:[],typeGLSL:"sampler2D",length:7},uDataDimensions:{type:"iv",value:[0,0,0],typeGLSL:"ivec3"},uWorldToData:{type:"m4",value:new e.Matrix4,typeGLSL:"mat4"},uWindowCenterWidth:{type:"fv1",value:[0,0],typeGLSL:"float",length:2},uRescaleSlopeIntercept:{type:"fv1",value:[0,0],typeGLSL:"float",length:2},uNumberOfChannels:{type:"i",value:1,typeGLSL:"int"},uBitsAllocated:{type:"i",value:8,typeGLSL:"int"},uInvert:{type:"i",value:0,typeGLSL:"int"},uLut:{type:"i",value:0,typeGLSL:"int"},uTextureLUT:{type:"t",value:[],typeGLSL:"sampler2D"},uPixelType:{type:"i",value:0,typeGLSL:"int"},uPackedPerPixel:{type:"i",value:1,typeGLSL:"int"},uInterpolation:{type:"i",value:1,typeGLSL:"int"},uWorldBBox:{type:"fv1",value:[0,0,0,0,0,0],typeGLSL:"float",length:6},uSteps:{type:"i",value:256,typeGLSL:"int"},uAlphaCorrection:{type:"f",value:.5,typeGLSL:"float"},uFrequence:{type:"f",value:0,typeGLSL:"float"},uAmplitude:{type:"f",value:0,typeGLSL:"float"},uShading:{type:"i",value:1,typeGLSL:"int"},uAmbient:{type:"f",value:.1,typeGLSL:"float"},uAmbientColor:{type:"v3",value:[1,1,0],typeGLSL:"vec3"},uSampleColorToAmbient:{type:"i",value:1,typeGLSL:"int"},uSpecular:{type:"f",value:1,typeGLSL:"float"},uSpecularColor:{type:"v3",value:[1,1,1],typeGLSL:"vec3"},uDiffuse:{type:"f",value:.3,typeGLSL:"float"},uDiffuseColor:{type:"v3",value:[1,1,0],typeGLSL:"vec3"},uSampleColorToDiffuse:{type:"i",value:1,typeGLSL:"int"},uShininess:{type:"f",value:5,typeGLSL:"float"},uLightPosition:{type:"v3",value:[0,0,0],typeGLSL:"vec3"},uLightPositionInCamera:{type:"i",value:1,typeGLSL:"int"},uIntensity:{type:"v3",value:[.8,.8,.8],typeGLSL:"vec3"},uAlgorithm:{type:"i",value:0,typeGLSL:"int"}}}}class Y{compute(){return"\nvarying vec4 vPos;\n\n//\n// main\n//\nvoid main() {\n\n\tvPos = modelMatrix * vec4(position, 1.0 );\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0 );\n\n}\n\t\t\t\t"}}var X=new class extends G{constructor(){super(),this.name="intersectBox",this._rayOrigin="rayOrigin",this._rayDirection="rayDirection",this._aabbMin="aabbMin",this._aabbMax="aabbMax",this._tNear="tNear",this._tFar="tFar",this._intersect="intersect"}api(t=this._base,e=this._rayOrigin,i=this._rayDirection,s=this._aabbMin,a=this._aabbMax,o=this._tNear,n=this._tFar,l=this._intersect){return this._base=t,this.compute(e,i,s,a,o,n,l)}compute(t,e,i,s,a,o,n){return this.computeDefinition(),this._base._functions[this._name]=this._definition,`${this._name}(${t}, ${e}, ${i}, ${s}, ${a}, ${o}, ${n});`}computeDefinition(){this._definition=`\nvoid ${this._name}(vec3 rayOrigin, vec3 rayDirection, vec3 boxMin, vec3 boxMax, out float tNear, out float tFar, out bool intersect){\n\t// compute intersection of ray with all six bbox planes\n\tvec3 invRay = vec3(1.) / rayDirection;\n\tvec3 tBot = invRay * (boxMin - rayOrigin);\n\tvec3 tTop = invRay * (boxMax - rayOrigin);\n\t// re-order intersections to find smallest and largest on each axis\n\tvec3 tMin = min(tTop, tBot);\n\tvec3 tMax = max(tTop, tBot);\n\t// find the largest tMin and the smallest tMax\n\tfloat largest_tMin = max(max(tMin.x, tMin.y), max(tMin.x, tMin.z));\n\tfloat smallest_tMax = min(min(tMax.x, tMax.y), min(tMax.x, tMax.z));\n\ttNear = largest_tMin;\n\ttFar = smallest_tMax;\n\tintersect = smallest_tMax > largest_tMin;\n}\n\n\t\t`}};class q{constructor(t){this._uniforms=t,this._functions={},this._main=""}functions(){""===this._main&&this.main();let t="";for(let e in this._functions)t+=this._functions[e]+"\n";return t}uniforms(){let t="";for(let e in this._uniforms){let i=this._uniforms[e];t+=`uniform ${i.typeGLSL} ${e}`,i&&i.length&&(t+=`[${i.length}]`),t+=";\n"}return t}main(){this._main=`\nvoid getIntensity(in vec3 dataCoordinates, out float intensity, out vec3 gradient){\n\n\tvec4 dataValue = vec4(0., 0., 0., 0.);\n\t${z(this,"dataCoordinates","dataValue","gradient")}\n\n\tintensity = dataValue.r;\n\n\t// rescale/slope\n\tintensity = intensity*uRescaleSlopeIntercept[0] + uRescaleSlopeIntercept[1];\n\t// window level\n\tfloat windowMin = uWindowCenterWidth[0] - uWindowCenterWidth[1] * 0.5;\n\tintensity = ( intensity - windowMin ) / uWindowCenterWidth[1];\n}\n\nmat4 inverse(mat4 m) {\n\tfloat\n\t\ta00 = m[0][0], a01 = m[0][1], a02 = m[0][2], a03 = m[0][3],\n\t\ta10 = m[1][0], a11 = m[1][1], a12 = m[1][2], a13 = m[1][3],\n\t\ta20 = m[2][0], a21 = m[2][1], a22 = m[2][2], a23 = m[2][3],\n\t\ta30 = m[3][0], a31 = m[3][1], a32 = m[3][2], a33 = m[3][3],\n\n\t\tb00 = a00 * a11 - a01 * a10,\n\t\tb01 = a00 * a12 - a02 * a10,\n\t\tb02 = a00 * a13 - a03 * a10,\n\t\tb03 = a01 * a12 - a02 * a11,\n\t\tb04 = a01 * a13 - a03 * a11,\n\t\tb05 = a02 * a13 - a03 * a12,\n\t\tb06 = a20 * a31 - a21 * a30,\n\t\tb07 = a20 * a32 - a22 * a30,\n\t\tb08 = a20 * a33 - a23 * a30,\n\t\tb09 = a21 * a32 - a22 * a31,\n\t\tb10 = a21 * a33 - a23 * a31,\n\t\tb11 = a22 * a33 - a23 * a32,\n\n\t\tdet = b00 * b11 - b01 * b10 + b02 * b09 + b03 * b08 - b04 * b07 + b05 * b06;\n\n\treturn mat4(\n\t\ta11 * b11 - a12 * b10 + a13 * b09,\n\t\ta02 * b10 - a01 * b11 - a03 * b09,\n\t\ta31 * b05 - a32 * b04 + a33 * b03,\n\t\ta22 * b04 - a21 * b05 - a23 * b03,\n\t\ta12 * b08 - a10 * b11 - a13 * b07,\n\t\ta00 * b11 - a02 * b08 + a03 * b07,\n\t\ta32 * b02 - a30 * b05 - a33 * b01,\n\t\ta20 * b05 - a22 * b02 + a23 * b01,\n\t\ta10 * b10 - a11 * b08 + a13 * b06,\n\t\ta01 * b08 - a00 * b10 - a03 * b06,\n\t\ta30 * b04 - a31 * b02 + a33 * b00,\n\t\ta21 * b02 - a20 * b04 - a23 * b00,\n\t\ta11 * b07 - a10 * b09 - a12 * b06,\n\t\ta00 * b09 - a01 * b07 + a02 * b06,\n\t\ta31 * b01 - a30 * b03 - a32 * b00,\n\t\ta20 * b03 - a21 * b01 + a22 * b00) / det;\n}\n\n/**\n * Adapted from original sources\n * \n * Original code: \n * http://jamie-wong.com/2016/07/15/ray-marching-signed-distance-functions/\n * https://www.shadertoy.com/view/lt33z7\n * \n * The vec3 returned is the RGB color of the light's contribution.\n *\n * k_a: Ambient color\n * k_d: Diffuse color\n * k_s: Specular color\n * alpha: Shininess coefficient\n * p: position of point being lit\n * eye: the position of the camera\n * lightPos: the position of the light\n * lightIntensity: color/intensity of the light\n *\n * See https://en.wikipedia.org/wiki/Phong_reflection_model#Description\n */\nvec3 phongShading(vec3 k_a, vec3 k_d, vec3 k_s, float shininess, vec3 p, vec3 eye,\n\tvec3 lightPos, vec3 lightIntensity, vec3 normal) {\n\tvec3 N = normal;\n\tvec3 L = lightPos - p;\n\tif (length(L) > 0.) {\n\t\tL = L / length(L);\n\t}\n\tvec3 V = eye - p;\n\tif (length(V) > 0.) {\n\t\tV = V / length(V);\n\t}\n\tvec3 R = reflect(-L, N);\n\tif (length(R) > 0.) {\n\t\tR = R / length(R);\n\t}\n\n\t// https://en.wikipedia.org/wiki/Blinn%E2%80%93Phong_shading_model\n\tvec3 h = L + V;\n\tvec3 H = h;\n\tif (length(h) > 0.) {\n\t\tH = H / length(h);\n\t}\n\n\tfloat dotLN = dot(L, N);\n\tfloat dotRV = dot(R, V);\n\n\tif (dotLN < 0.) {\n\t\t// Light not visible from this point on the surface\n\t\treturn k_a;\n\t} \n\n\tif (dotRV < 0.) {\n\t\t// Light reflection in opposite direction as viewer, apply only diffuse\n\t\t// component\n\t\treturn k_a + lightIntensity * (k_d * dotLN);\n\t}\n\n\tfloat specAngle = max(dot(H, normal), 0.0);\n\tfloat specular = pow(dotRV, shininess); //pow(specAngle, shininess); // \n\treturn k_a + lightIntensity * (k_d * dotLN\t+ k_s * specular);\n}\n\nfloat PI = 3.14159265358979323846264 * 00000.1; // PI\n\n// expects values in the range of [0,1]x[0,1], returns values in the [0,1] range.\n// do not collapse into a single function per: http://byteblacksmith.com/improvements-to-the-canonical-one-liner-glsl-rand-for-opengl-es-2-0/\nhighp float rand( const in vec2 uv) {\n\tconst highp float a = 12.9898;\n\tconst highp float b = 78.233;\n\tconst highp float c = 43758.5453;\n\thighp float dt = dot(uv.xy, vec2(a, b)), sn = mod(dt, PI);\n\treturn fract(sin(sn) * c);\n}\n\nvoid main(void) {\n\tconst int maxSteps = 1024;\n\n\t// the ray\n\tvec3 rayOrigin = cameraPosition;\n\tvec3 rayDirection = normalize(vPos.xyz - rayOrigin);\n\n\tvec3 lightOrigin = uLightPositionInCamera == 1 ? cameraPosition : uLightPosition;\n\n\t// the Axe-Aligned B-Box\n\tvec3 AABBMin = vec3(uWorldBBox[0], uWorldBBox[2], uWorldBBox[4]);\n\tvec3 AABBMax = vec3(uWorldBBox[1], uWorldBBox[3], uWorldBBox[5]);\n\n\t// Intersection ray/bbox\n\tfloat tNear, tFar;\n\tbool intersect = false;\n\t${X.api(this,"rayOrigin","rayDirection","AABBMin","AABBMax","tNear","tFar","intersect")}\n\tif (tNear < 0.0) tNear = 0.0;\n\n\t// x / y should be within o-1\n\t// should\n\tfloat offset = rand(gl_FragCoord.xy);\n\n\t// init the ray marching\n\tfloat tStep = (tFar - tNear) / float(uSteps);\n\tfloat tCurrent = tNear + offset * tStep;\n\tvec4 accumulatedColor = vec4(0.0);\n\tfloat accumulatedAlpha = 0.0;\n\n\t// MIP volume rendering\n\tfloat maxIntensity = 0.0;\n\n\tmat4 dataToWorld = inverse(uWorldToData);\n\n\t// rayOrigin -= rayDirection * 0.1; // gold_noise(vPos.xz, vPos.y) / 100.;\t\n\n\tfor(int rayStep = 0; rayStep < maxSteps; rayStep++){\n\t\tvec3 currentPosition = rayOrigin + rayDirection * tCurrent;\n\t\t// some non-linear FUN\n\t\t// some occlusion issue to be fixed\n\t\tvec3 transformedPosition = currentPosition; //transformPoint(currentPosition, uAmplitude, uFrequence);\n\t\t// world to data coordinates\n\t\t// rounding trick\n\t\t// first center of first voxel in data space is CENTERED on (0,0,0)\n\t\tvec4 dataCoordinatesRaw = uWorldToData * vec4(transformedPosition, 1.0);\n\t\tvec3 currentVoxel = vec3(dataCoordinatesRaw.x, dataCoordinatesRaw.y, dataCoordinatesRaw.z);\n\t\tfloat intensity = 0.0;\n\t\tvec3 gradient = vec3(0., 0., 0.);\n\t\tgetIntensity(currentVoxel, intensity, gradient);\n\t\t// map gradient to world space and normalize before using\n\t\t// we avoid to call "normalize" as it may be undefined if vector length == 0.\n\t\tgradient = (vec3(dataToWorld * vec4(gradient, 0.)));\n\t\tif (length(gradient) > 0.0) {\n\t\t\tgradient = normalize(gradient);\n\t\t}\n\n\t\tvec4 colorSample;\n\t\tfloat alphaSample;\n\t\tif(uLut == 1){\n\t\t\tvec4 colorFromLUT = texture2D( uTextureLUT, vec2( intensity, 1.0) );\n\t\t\t// 256 colors\n\t\t\tcolorSample = colorFromLUT;\n\t\t\talphaSample = colorFromLUT.a;\n\t\t}\n\t\telse{\n\t\t\talphaSample = intensity;\n\t\t\tcolorSample.r = colorSample.g = colorSample.b = intensity;\n\t\t}\n\n\t\t// ray marching algorithm\n\t\t// shading on\n\t\t// interpolation on\n\t\tif (uAlgorithm == 0 && uShading == 1 && uInterpolation != 0) {\n\t\t\t//\t&& alphaSample > .3\n\t\t\tvec3 ambientComponent = uSampleColorToAmbient == 1 ? colorSample.xyz : uAmbientColor;\n\t\t\tambientComponent *= uAmbient;\n\t\t\tvec3 diffuseComponent = uSampleColorToDiffuse == 1 ? colorSample.xyz : uDiffuseColor;\n\t\t\tdiffuseComponent *= uDiffuse;\n\t\t\tvec3 specularComponent = uSpecular * uSpecularColor;\n\t\t\tfloat shininess = uShininess;\n\t\t\tvec3 vIntensity = uIntensity;\n\n\t\t\tcolorSample.xyz += phongShading(\n\t\t\t\tambientComponent,\n\t\t\t\tdiffuseComponent,\n\t\t\t\tspecularComponent,\n\t\t\t\tshininess,\n\t\t\t\tcurrentPosition.xyz,\n\t\t\t\trayOrigin.xyz,\n\t\t\t\tlightOrigin.xyz,\n\t\t\t\tvIntensity,\n\t\t\t\tgradient);\n\t\t}\n\n\t\talphaSample = 1.0 - pow((1.0- alphaSample),tStep*uAlphaCorrection);\n\t\talphaSample *= (1.0 - accumulatedAlpha);\n\n\t\taccumulatedColor += alphaSample * colorSample;\n\t\taccumulatedAlpha += alphaSample;\n\n\t\ttCurrent += tStep;\n\n\t\tif (tCurrent > tFar || (uAlgorithm == 0 && accumulatedAlpha >= 1.0)) break;\n\n\t\tif (uAlgorithm == 1 && (intensity >= maxIntensity)) {\n\t\t\tmaxIntensity = intensity;\n\t\t\taccumulatedColor = colorSample;\n\t\t\taccumulatedAlpha = 1.;\n\t\t}\n\t}\n\n\tgl_FragColor = vec4(accumulatedColor.xyz, accumulatedAlpha);\n}\n\t `}compute(){return`\n// uniforms\n${this.uniforms()}\n\n// varying (should fetch it from vertex directly)\nvarying vec4\t\t\tvPos;\n\n// tailored functions\n${this.functions()}\n\n// main loop\n${this._main}\n\t\t\t`}}class J extends a.default{constructor(t=null,e=O){super(),this._loaded=-1,this._totalLoaded=-1,this._parsed=-1,this._totalParsed=-1,this._data=[],this._container=t,this._progressBar=null,this._container&&e&&(this._progressBar=new e(this._container))}free(){this._data=[],this._container=null,this._progressBar&&(this._progressBar.free(),this._progressBar=null)}fetch(t,e){return new Promise(((i,s)=>{const a=new XMLHttpRequest;a.open("GET",t),a.crossOrigin=!0,a.responseType="arraybuffer",a.onloadstart=e=>{this.emit("fetch-start",{file:t,time:new Date})},a.onload=e=>{if(200===a.status||0===a.status){this._loaded=e.loaded,this._totalLoaded=e.total,this._progressBar&&this._progressBar.update(this._loaded,this._totalLoaded,"load",t);let s=a.response,o={url:t,buffer:s};this.emit("fetch-success",{file:t,time:new Date,totalLoaded:e.total}),i(o)}else s(a.statusText)},a.onerror=()=>{this.emit("fetch-error",{file:t,time:new Date}),s(a.statusText)},a.onabort=e=>{this.emit("fetch-abort",{file:t,time:new Date}),s(a.statusText||"Aborted")},a.ontimeout=()=>{this.emit("fetch-timeout",{file:t,time:new Date}),s(a.statusText)},a.onprogress=e=>{this._loaded=e.loaded,this._totalLoaded=e.total,this.emit("fetch-progress",{file:t,total:e.total,loaded:e.loaded,time:new Date}),this._progressBar&&this._progressBar.update(this._loaded,this._totalLoaded,"load",t)},a.onloadend=e=>{this.emit("fetch-end",{file:t,time:new Date})},e instanceof Map&&e.set(t,a),a.send()}))}parse(t){return new Promise(((e,i)=>{e(t)}))}loadSequenceGroup(t,e){const i=[];return t.forEach((t=>{i.push(this.fetch(t,e))})),Promise.all(i).then((t=>this.parse(t))).then((t=>(this._data.push(t),t))).catch((function(t){"Aborted"!==t&&(console.log("oops... something went wrong..."),console.log(t))}))}loadSequence(t,e){return this.fetch(t,e).then((t=>this.parse(t))).then((t=>(this._data.push(t),t))).catch((function(t){"Aborted"!==t&&(console.log("oops... something went wrong..."),console.log(t))}))}load(t,e){Array.isArray(t)||(t=[t]),this._progressBar&&(this._progressBar.totalFiles=t.length,this._progressBar.requests=e),this.emit("load-start",{files:t,time:new Date});const i=[];return t.forEach((t=>{Array.isArray(t)?i.push(this.loadSequenceGroup(t,e)):i.push(this.loadSequence(t,e))})),Promise.all(i)}set data(t){this._data=t}get data(){return this._data}}class K{constructor(){this._id=-1}mergeModels(t,e){if(!this._validateModelArray(t)||!this._validateModelArray(e))return console.log("invalid inputs provided."),!1;for(let i=0,s=e.length;i<s;i++)for(let s=0,a=t.length;s<a&&!t[s].merge(e[i]);s++)s===t.length-1&&t.push(e[i]);return!0}merge(t){return!!this.validate(t)&&this._id===t._id}validate(t){return!(!t||null===t||"function"!=typeof t.merge)}_validateModelArray(t){if(null===t||Array!==t.constructor)return console.log("invalid model array provided."),!1;for(let e=0;e<t.length;e++)if(!t[e]||null===t[e]||"function"!=typeof t[e].validate||!t[e].validate(t[e]))return!1;return!0}}class Z extends K{constructor(){super(),this._concatenationUID=-1,this._seriesInstanceUID=-1,this._transferSyntaxUID="",this._seriesNumber=-1,this._seriesDescription="",this._seriesDate="",this._studyDescription="",this._studyDate="",this._accessionNumber=-1,this._modality="Modality not set",this._dimensionIndexSequence=[],this._numberOfFrames=0,this._numberOfChannels=1,this._rawHeader=null,this._patientID="",this._patientName="",this._patientAge="",this._patientBirthdate="",this._patientSex="",this._segmentationType=null,this._segmentationSegments=[],this._stack=[]}validate(t){return!!(super.validate(t)&&"function"==typeof t.mergeSeries&&t.hasOwnProperty("_seriesInstanceUID")&&t.hasOwnProperty("_numberOfFrames")&&t.hasOwnProperty("_numberOfChannels")&&t.hasOwnProperty("_stack")&&void 0!==t._stack&&Array===t._stack.constructor)}merge(t){return!!this.validate(t)&&(this._seriesInstanceUID===t.seriesInstanceUID&&(t.stack[0]&&(0===this._stack[0]._numberOfFrames&&this._stack[0].computeNumberOfFrames(),this._stack[0].computeCosines(),0===t.stack[0]._numberOfFrames&&t.stack[0].computeNumberOfFrames(),t.stack[0].computeCosines()),this.mergeModels(this._stack,t.stack)))}mergeSeries(t){let e=[this];return this.mergeModels(e,t),e}set seriesInstanceUID(t){this._seriesInstanceUID=t}get seriesInstanceUID(){return this._seriesInstanceUID}set transferSyntaxUID(t){this._transferSyntaxUID=t}get transferSyntaxUID(){return this._transferSyntaxUID}get transferSyntaxUIDLabel(){switch(this._transferSyntaxUID){case"1.2.840.10008.1.2.4.90":return"JPEG 2000 Lossless";case"1.2.840.10008.1.2.4.91":return"JPEG 2000 Lossy";case"1.2.840.10008.1.2.4.57":return"JPEG Lossless, Nonhierarchical (Processes 14)";case"1.2.840.10008.1.2.4.70":return"JPEG Lossless, Nonhierarchical (Processes 14 [Selection 1])";case"1.2.840.10008.1.2.4.50":return"JPEG Baseline lossy process 1 (8 bit)";case"1.2.840.10008.1.2.4.51":return"JPEG Baseline lossy process 2 & 4 (12 bit)";case"1.2.840.10008.1.2":return"Implicit VR Little Endian";case"1.2.840.10008.1.2.1":return"Explicit VR Little Endian";case"1.2.840.10008.1.2.2":return"Explicit VR Big Endian";default:return`Unknown transfersyntax: ${this._transferSyntaxUID}`}}set studyDate(t){this._studyDate=t}get studyDate(){return this._studyDate}set studyDescription(t){this._studyDescription=t}get studyDescription(){return this._studyDescription}set seriesDate(t){this._seriesDate=t}get seriesDate(){return this._seriesDate}set seriesDescription(t){this._seriesDescription=t}get seriesDescription(){return this._seriesDescription}set rawHeader(t){this._rawHeader=t}get rawHeader(){return this._rawHeader}set patientID(t){this._patientID=t}get patientID(){return this._patientID}set patientName(t){this._patientName=t}get patientName(){return this._patientName}set patientAge(t){this._patientAge=t}get patientAge(){return this._patientAge}set patientBirthdate(t){this._patientBirthdate=t}get patientBirthdate(){return this._patientBirthdate}set patientSex(t){this._patientSex=t}get patientSex(){return this._patientSex}set numberOfFrames(t){this._numberOfFrames=t}get numberOfFrames(){return this._numberOfFrames}set numberOfChannels(t){this._numberOfChannels=t}get numberOfChannels(){return this._numberOfChannels}set stack(t){this._stack=t}get stack(){return this._stack}set modality(t){this._modality=t}get modality(){return this._modality}set segmentationType(t){this._segmentationType=t}get segmentationType(){return this._segmentationType}set segmentationSegments(t){this._segmentationSegments=t}get segmentationSegments(){return this._segmentationSegments}}const Q=require("math-float32-to-binary-string");class tt extends K{constructor(){super(),this._uid=null,this._stackID=-1,this._frame=[],this._numberOfFrames=0,this._rows=0,this._columns=0,this._numberOfChannels=1,this._bitsAllocated=8,this._pixelType=0,this._pixelRepresentation=0,this._textureSize=4096,this._textureUnits=7,this._rawData=[],this._windowCenter=0,this._windowWidth=0,this._rescaleSlope=1,this._rescaleIntercept=0,this._minMax=[Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY],this._regMatrix=new e.Matrix4,this._ijk2LPS=null,this._lps2IJK=null,this._aabb2LPS=null,this._lps2AABB=null,this._dimensionsIJK=null,this._halfDimensionsIJK=null,this._spacing=new e.Vector3(1,1,1),this._spacingBetweenSlices=0,this._sliceThickness=0,this._origin=null,this._rightHanded=!0,this._xCosine=new e.Vector3(1,0,0),this._yCosine=new e.Vector3(0,1,0),this._zCosine=new e.Vector3(0,0,1),this._prepared=!1,this._packed=!1,this._packedPerPixel=1,this._modality="Modality not set",this._segmentationType=null,this._segmentationSegments=[],this._segmentationDefaultColor=[63,174,128],this._frameSegment=[],this._segmentationLUT=[],this._segmentationLUTO=[],this._invert=!1}prepareSegmentation(){this._frameSegment=this._frame;let t=[];this.computeCosines(),this._frame.map(this._computeDistanceArrayMap.bind(null,this._zCosine)),this._frame.sort(this._sortDistanceArraySort);let e=-1;for(let i=0;i<this._frame.length;i++){if(t[e]&&t[e]._dist==this._frame[i]._dist)for(let s=0;s<t[e]._rows*t[e]._columns;s++)t[e]._pixelData[s]+=this._frame[i].pixelData[s]*this._frame[i]._referencedSegmentNumber;else{t.push(this._frame[i]),e++;for(let s=0;s<t[e]._rows*t[e]._columns;s++)t[e]._pixelData[s]*=this._frame[i]._referencedSegmentNumber}t[e].minMax=n.minMax(t[e]._pixelData)}let i={},s=0;for(let t=0;t<this._segmentationSegments.length;t++){s=Math.max(s,parseInt(this._segmentationSegments[t].segmentNumber,10));let e=this._segmentationSegments[t].recommendedDisplayCIELab;i[this._segmentationSegments[t].segmentNumber]=null===e?this._segmentationDefaultColor:g.cielab2RGB(...e)}for(let t=0;t<=s;t++){let e=t/s,a=t?1:0,o=[0,0,0];i.hasOwnProperty(t.toString())&&(o=i[t.toString()]),o[0]/=255,o[1]/=255,o[2]/=255,this._segmentationLUT.push([e,...o]),this._segmentationLUTO.push([e,a])}this._frame=t}prepare(){"SEG"===this._modality&&this.prepareSegmentation(),this.computeNumberOfFrames(),this._rows=this._frame[0].rows,this._columns=this._frame[0].columns,this._dimensionsIJK=new e.Vector3(this._columns,this._rows,this._numberOfFrames),this._halfDimensionsIJK=new e.Vector3(this._dimensionsIJK.x/2,this._dimensionsIJK.y/2,this._dimensionsIJK.z/2),this._spacingBetweenSlices=this._frame[0].spacingBetweenSlices,this._sliceThickness=this._frame[0].sliceThickness,this.computeCosines(),this._numberOfFrames>1&&this.orderFrames(),this.computeSpacing(),this._frame[0].imagePosition||(this._frame[0].imagePosition=[0,0,0]),this._frame[0].imageOrientation||(this._frame[0].imageOrientation=[1,0,0,0,1,0]),this._origin=this._arrayToVector3(this._frame[0].imagePosition,0),this.computeIJK2LPS(),this.computeLPS2AABB();const t=Math.floor(this._frame.length/2),i=this._frame[t];this._rescaleSlope=i.rescaleSlope||1,this._rescaleIntercept=i.rescaleIntercept||0,this.computeMinMaxIntensities(),this._minMax[0]=n.rescaleSlopeIntercept(this._minMax[0],this._rescaleSlope,this._rescaleIntercept),this._minMax[1]=n.rescaleSlopeIntercept(this._minMax[1],this._rescaleSlope,this._rescaleIntercept),this._windowWidth=i.windowWidth||this._minMax[1]-this._minMax[0],this._windowCenter=i.windowCenter||this._minMax[0]+this._windowWidth/2,this._bitsAllocated=i.bitsAllocated,this._prepared=!0}packEchos(){let t=[];for(let e=0;e<this._frame.length;e+=4){let i=this._frame[e];for(let t=0;t<this._rows*this._columns;t++){for(let s=1;s<4;s++)i.pixelData[t]+=this._frame[e+s].pixelData[t];i.pixelData[t]/=4}t.push(i)}this._frame=t,this._numberOfFrames=this._frame.length,this._dimensionsIJK=new e.Vector3(this._columns,this._rows,this._numberOfFrames),this._halfDimensionsIJK=new e.Vector3(this._dimensionsIJK.x/2,this._dimensionsIJK.y/2,this._dimensionsIJK.z/2)}computeNumberOfFrames(){if(!(this._frame&&this._frame.length>0))return console.warn("_frame doesn't contain anything...."),console.warn(this._frame),!1;this._numberOfFrames=this._frame.length}computeCosines(){if(this._frame&&this._frame[0]){let t=this._frame[0].cosines();this._xCosine=t[0],this._yCosine=t[1],this._zCosine=t[2]}}orderFrames(){this._frame[0].dimensionIndexValues?this._frame.sort(this._orderFrameOnDimensionIndicesArraySort):this._frame[0].imagePosition&&this._frame[0].imageOrientation&&this._frame[1]&&this._frame[1].imagePosition&&this._frame[1].imageOrientation&&this._frame[0].imagePosition.join()!==this._frame[1].imagePosition.join()?(this._frame.map(this._computeDistanceArrayMap.bind(null,this._zCosine)),this._frame.sort(this._sortDistanceArraySort)):null!==this._frame[0].instanceNumber&&this._frame[1]&&null!==this._frame[1].instanceNumber&&this._frame[0].instanceNumber!==this._frame[1].instanceNumber?this._frame.sort(this._sortInstanceNumberArraySort):this._frame[0].sopInstanceUID&&this._frame[1]&&this._frame[1].sopInstanceUID&&this._frame[0].sopInstanceUID!==this._frame[1].sopInstanceUID?this._frame.sort(this._sortSopInstanceUIDArraySort):this._frame[0].imagePosition&&console.warn("do not know how to order the frames...")}computeSpacing(){this.xySpacing(),this.zSpacing()}zSpacing(){this._numberOfFrames>1&&(this._frame[0].pixelSpacing&&this._frame[0].pixelSpacing[2]?this._spacing.z=this._frame[0].pixelSpacing[2]:(this._frame.map(this._computeDistanceArrayMap.bind(null,this._zCosine)),this._frame[1].dist!==this._frame[0].dist?(this._frame.sort(this._sortDistanceArraySort),this._spacing.z=this._frame[1].dist-this._frame[0].dist):this._spacingBetweenSlices?this._spacing.z=this._spacingBetweenSlices:this._frame[0].sliceThickness&&(this._spacing.z=this._frame[0].sliceThickness))),0===this._spacing.z&&(this._spacing.z=1)}xySpacing(){if(this._frame&&this._frame[0]){let t=this._frame[0].spacingXY();this._spacing.x=t[0],this._spacing.y=t[1]}}computeMinMaxIntensities(){for(let t=0;t<this._frame.length;t++){let e=this._frame[t].minMax[0];Number.isNaN(e)||(this._minMax[0]=Math.min(this._minMax[0],e));let i=this._frame[t].minMax[1];Number.isNaN(i)||(this._minMax[1]=Math.max(this._minMax[1],i))}}computeIJK2LPS(){this._ijk2LPS=n.ijk2LPS(this._xCosine,this._yCosine,this._zCosine,this._spacing,this._origin,this._regMatrix),this._lps2IJK=new e.Matrix4,this._lps2IJK.getInverse(this._ijk2LPS)}computeLPS2AABB(){this._aabb2LPS=n.aabb2LPS(this._xCosine,this._yCosine,this._zCosine,this._origin),this._lps2AABB=new e.Matrix4,this._lps2AABB.getInverse(this._aabb2LPS)}merge(t){return!!(this._stackID===t.stackID&&1===this._numberOfFrames&&1===t._numberOfFrames&&this._frame[0].columns===t.frame[0].columns&&this._frame[0].rows===t.frame[0].rows&&this._xCosine.equals(t.xCosine)&&this._yCosine.equals(t.yCosine)&&this._zCosine.equals(t.zCosine))&&this.mergeModels(this._frame,t.frame)}pack(){const t=this._dimensionsIJK.x*this._dimensionsIJK.y*this._dimensionsIJK.z;(8===this._bitsAllocated&&1===this._numberOfChannels||1===this._bitsAllocated)&&(this._packedPerPixel=4),16===this._bitsAllocated&&1===this._numberOfChannels&&(this._packedPerPixel=2);const e=this._textureSize*this._textureSize;let i=Math.ceil(t/(e*this._packedPerPixel)),s=0,a=this._packedPerPixel*e;a>t&&(a=t),this._textureUnits<i&&(console.warn("Insufficient number of supported textures. Some frames will not be packed."),i=this._textureUnits);for(let o=0;o<i;o++){const i=this._packTo8Bits(this._numberOfChannels,this._frame,this._textureSize,s,a);this._textureType=i.textureType,this._rawData.push(i.data),s+=this._packedPerPixel*e,a+=this._packedPerPixel*e,a>t&&(a=t)}this._packed=!0}_packTo8Bits(t,i,s,a,o){const n={textureType:null,data:null},l=i[0].bitsAllocated,r=i[0].pixelType;let h=0;this._minMax[0]<0&&(h-=this._minMax[0]);let c=0,_=0,d=0;const p=i[0].rows*i[0].columns;if(8===l&&1===t||1===l){let t=new Uint8Array(s*s*4),l=0,r=0;for(let e=a;e<o;e++){_=~~(e/p),d=e%p;let s=i[_].pixelData[d]+h;Number.isNaN(s)||(t[4*l+r]=s),c++,l=Math.floor(c/4),r=c%4}n.textureType=e.RGBAFormat,n.data=t}else if(16===l&&1===t){let t=new Uint8Array(s*s*4),l=0,r=0;for(let e=a;e<o;e++){_=~~(e/p),d=e%p;let s=i[_].pixelData[d]+h;Number.isNaN(s)||(t[4*l+2*r]=255&s,t[4*l+2*r+1]=s>>>8&255),c++,l=Math.floor(c/2),r=c%2}n.textureType=e.RGBAFormat,n.data=t}else if(32===l&&1===t&&0===r){let t=new Uint8Array(s*s*4);for(let e=a;e<o;e++){_=~~(e/p),d=e%p;let s=i[_].pixelData[d]+h;Number.isNaN(s)||(t[4*c]=255&s,t[4*c+1]=s>>>8&255,t[4*c+2]=s>>>16&255,t[4*c+3]=s>>>24&255),c++}n.textureType=e.RGBAFormat,n.data=t}else if(32===l&&1===t&&1===r){let t=new Uint8Array(s*s*4);for(let e=a;e<o;e++){_=~~(e/p),d=e%p;let s=i[_].pixelData[d]+h;if(!Number.isNaN(s)){let e=Q(s).match(/.{1,8}/g);t[4*c]=parseInt(e[0],2),t[4*c+1]=parseInt(e[1],2),t[4*c+2]=parseInt(e[2],2),t[4*c+3]=parseInt(e[3],2)}c++}n.textureType=e.RGBAFormat,n.data=t}else if(8===l&&3===t){let t=new Uint8Array(s*s*3);for(let e=a;e<o;e++)_=~~(e/p),d=e%p,t[3*c]=i[_].pixelData[3*d],t[3*c+1]=i[_].pixelData[3*d+1],t[3*c+2]=i[_].pixelData[3*d+2],c++;n.textureType=e.RGBFormat,n.data=t}return n}worldCenter(){return this._halfDimensionsIJK.clone().addScalar(-.5).applyMatrix4(this._ijk2LPS)}worldBoundingBox(){let t=[Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY];const i=this._dimensionsIJK;for(let s=0;s<=i.x;s+=i.x)for(let a=0;a<=i.y;a+=i.y)for(let o=0;o<=i.z;o+=i.z){let i=new e.Vector3(s,a,o).applyMatrix4(this._ijk2LPS);t=[Math.min(t[0],i.x),Math.max(t[1],i.x),Math.min(t[2],i.y),Math.max(t[3],i.y),Math.min(t[4],i.z),Math.max(t[5],i.z)]}return t}AABBox(){let t=(new e.Vector3).addScalar(-.5).applyMatrix4(this._ijk2LPS).applyMatrix4(this._lps2AABB),i=this._dimensionsIJK.clone().addScalar(-.5).applyMatrix4(this._ijk2LPS).applyMatrix4(this._lps2AABB);return new e.Vector3(Math.abs(t.x-i.x),Math.abs(t.y-i.y),Math.abs(t.z-i.z))}centerAABBox(){let t=this.worldCenter();return t.applyMatrix4(this._lps2AABB),t}static indexInDimensions(t,e){return t.x>=0&&t.y>=0&&t.z>=0&&t.x<e.x&&t.y<e.y&&t.z<e.z}_arrayToVector3(t,i){return new e.Vector3(t[i],t[i+1],t[i+2])}_orderFrameOnDimensionIndicesArraySort(t,e){if("dimensionIndexValues"in t&&"[object Array]"===Object.prototype.toString.call(t.dimensionIndexValues)&&"dimensionIndexValues"in e&&"[object Array]"===Object.prototype.toString.call(e.dimensionIndexValues))for(let i=0;i<t.dimensionIndexValues.length;i++){if(parseInt(t.dimensionIndexValues[i],10)>parseInt(e.dimensionIndexValues[i],10))return 1;if(parseInt(t.dimensionIndexValues[i],10)<parseInt(e.dimensionIndexValues[i],10))return-1}else console.warn("One of the frames doesn't have a dimensionIndexValues array."),console.warn(t),console.warn(e);return 0}_computeDistanceArrayMap(t,e){return e.imagePosition&&(e.dist=e.imagePosition[0]*t.x+e.imagePosition[1]*t.y+e.imagePosition[2]*t.z),e}_sortDistanceArraySort(t,e){return t.dist-e.dist}_sortInstanceNumberArraySort(t,e){return t.instanceNumber-e.instanceNumber}_sortSopInstanceUIDArraySort(t,e){return t.sopInstanceUID-e.sopInstanceUID}set numberOfChannels(t){this._numberOfChannels=t}get numberOfChannels(){return this._numberOfChannels}set frame(t){this._frame=t}get frame(){return this._frame}set prepared(t){this._prepared=t}get prepared(){return this._prepared}set packed(t){this._packed=t}get packed(){return this._packed}set packedPerPixel(t){this._packedPerPixel=t}get packedPerPixel(){return this._packedPerPixel}set dimensionsIJK(t){this._dimensionsIJK=t}get dimensionsIJK(){return this._dimensionsIJK}set halfDimensionsIJK(t){this._halfDimensionsIJK=t}get halfDimensionsIJK(){return this._halfDimensionsIJK}set regMatrix(t){this._regMatrix=t}get regMatrix(){return this._regMatrix}set ijk2LPS(t){this._ijk2LPS=t}get ijk2LPS(){return this._ijk2LPS}set lps2IJK(t){this._lps2IJK=t}get lps2IJK(){return this._lps2IJK}set lps2AABB(t){this._lps2AABB=t}get lps2AABB(){return this._lps2AABB}set textureSize(t){this._textureSize=t}get textureSize(){return this._textureSize}set textureUnits(t){this._textureUnits=t}get textureUnits(){return this._textureUnits}set textureType(t){this._textureType=t}get textureType(){return this._textureType}set bitsAllocated(t){this._bitsAllocated=t}get bitsAllocated(){return this._bitsAllocated}set rawData(t){this._rawData=t}get rawData(){return this._rawData}get windowWidth(){return this._windowWidth}set windowWidth(t){this._windowWidth=t}get windowCenter(){return this._windowCenter}set windowCenter(t){this._windowCenter=t}get rescaleSlope(){return this._rescaleSlope}set rescaleSlope(t){this._rescaleSlope=t}get rescaleIntercept(){return this._rescaleIntercept}set rescaleIntercept(t){this._rescaleIntercept=t}get xCosine(){return this._xCosine}set xCosine(t){this._xCosine=t}get yCosine(){return this._yCosine}set yCosine(t){this._yCosine=t}get zCosine(){return this._zCosine}set zCosine(t){this._zCosine=t}get minMax(){return this._minMax}set minMax(t){this._minMax=t}get stackID(){return this._stackID}set stackID(t){this._stackID=t}get pixelType(){return this._pixelType}set pixelType(t){this._pixelType=t}get pixelRepresentation(){return this._pixelRepresentation}set pixelRepresentation(t){this._pixelRepresentation=t}set invert(t){this._invert=t}get invert(){return this._invert}set modality(t){this._modality=t}get modality(){return this._modality}get rightHanded(){return this._rightHanded}set rightHanded(t){this._rightHanded=t}get spacingBetweenSlices(){return this._spacingBetweenSlices}set spacingBetweenSlices(t){this._spacingBetweenSlices=t}set segmentationSegments(t){this._segmentationSegments=t}get segmentationSegments(){return this._segmentationSegments}set segmentationType(t){this._segmentationType=t}get segmentationType(){return this._segmentationType}set segmentationLUT(t){this._segmentationLUT=t}get segmentationLUT(){return this._segmentationLUT}set segmentationLUTO(t){this._segmentationLUTO=t}get segmentationLUTO(){return this._segmentationLUTO}static value(t,e){return console.warn("models.stack.value is deprecated.\n\t\t\t Please use core.utils.value instead."),n.value(t,e)}static valueRescaleSlopeIntercept(t,e,i){return console.warn("models.stack.valueRescaleSlopeIntercept is deprecated.\n\t\t\t Please use core.utils.rescaleSlopeIntercept instead."),n.rescaleSlopeIntercept(t,e,i)}static worldToData(t,e){return console.warn("models.stack.worldToData is deprecated.\n\t\t\t Please use core.utils.worldToData instead."),n.worldToData(t._lps2IJK,e)}}class et extends K{constructor(){super(),this._sopInstanceUID=null,this._url=null,this._stackID=-1,this._invert=!1,this._frameTime=null,this._ultrasoundRegions=[],this._rows=0,this._columns=0,this._dimensionIndexValues=[],this._imagePosition=null,this._imageOrientation=null,this._rightHanded=!0,this._sliceThickness=1,this._spacingBetweenSlices=null,this._pixelPaddingValue=null,this._pixelRepresentation=0,this._pixelType=0,this._pixelSpacing=null,this._pixelAspectRatio=null,this._pixelData=null,this._instanceNumber=null,this._windowCenter=null,this._windowWidth=null,this._rescaleSlope=null,this._rescaleIntercept=null,this._bitsAllocated=8,this._numberOfChannels=1,this._minMax=null,this._dist=null,this._index=-1,this._referencedSegmentNumber=-1}validate(t){return!!(super.validate(t)&&"function"==typeof t.cosines&&"function"==typeof t.spacingXY&&t.hasOwnProperty("_sopInstanceUID")&&t.hasOwnProperty("_dimensionIndexValues")&&t.hasOwnProperty("_imageOrientation")&&t.hasOwnProperty("_imagePosition"))}merge(t){return!!this.validate(t)&&!!(this._compareArrays(this._dimensionIndexValues,t.dimensionIndexValues)&&this._compareArrays(this._imageOrientation,t.imageOrientation)&&this._compareArrays(this._imagePosition,t.imagePosition)&&this._instanceNumber===t.instanceNumber&&this._sopInstanceUID===t.sopInstanceUID)}cosines(){let t=[new e.Vector3(1,0,0),new e.Vector3(0,1,0),new e.Vector3(0,0,1)];if(this._imageOrientation&&6===this._imageOrientation.length){let i=new e.Vector3(this._imageOrientation[0],this._imageOrientation[1],this._imageOrientation[2]),s=new e.Vector3(this._imageOrientation[3],this._imageOrientation[4],this._imageOrientation[5]);i.length()>0&&s.length()>0&&(t[0]=i,t[1]=s,t[2]=new e.Vector3(0,0,0).crossVectors(t[0],t[1]).normalize())}else console.log("No valid image orientation for frame"),console.log(this),console.log("Returning default orientation.");return this._rightHanded||t[2].negate(),t}spacingXY(){let t=[1,1];return this.pixelSpacing?(t[0]=this.pixelSpacing[0],t[1]=this.pixelSpacing[1]):this.pixelAspectRatio&&(t[0]=1,t[1]=1*this.pixelAspectRatio[1]/this.pixelAspectRatio[0]),t}getPixelData(t,e){return t>=0&&t<this._columns&&e>=0&&e<this._rows?this.pixelData[t+this._columns*e]:null}setPixelData(t,e,i){this.pixelData[t+this._columns*e]=i}getImageDataUrl(){const t=document.createElement("canvas");t.width=this._columns,t.height=this._rows;const e=t.getContext("2d"),i=e.createImageData(t.width,t.height);return i.data.set(this._frameToCanvas()),e.putImageData(i,0,0),t.toDataURL()}_frameToCanvas(){const t=this._columns*this._rows,e={invert:this._invert,min:this._minMax[0],padding:this._pixelPaddingValue};let i=new Uint8Array(4*t);if(null!==e.padding){e.min=this._minMax[1];for(let t=0,i=this._pixelData.length;t<i;t++)this._pixelData[t]!==e.padding&&(e.min=Math.min(e.min,this._pixelData[t]))}if(this._windowWidth&&null!==this._windowCenter){const t=this._rescaleIntercept||0,i=this._rescaleSlope||1;e.min=Math.max((this._windowCenter-this._windowWidth/2-t)/i,e.min),e.max=Math.min((this._windowCenter+this._windowWidth/2-t)/i,this._minMax[1])}else e.max=this._minMax[1];if(e.range=e.max-e.min||255,1===this._numberOfChannels)for(let s=0;s<t;s++){const t=this._pixelTo8Bit(this._pixelData[s],e);i[4*s]=t,i[4*s+1]=t,i[4*s+2]=t,i[4*s+3]=255}else if(3===this._numberOfChannels)for(let s=0;s<t;s++)i[4*s]=this._pixelTo8Bit(this._pixelData[3*s],e),i[4*s+1]=this._pixelTo8Bit(this._pixelData[3*s+1],e),i[4*s+2]=this._pixelTo8Bit(this._pixelData[3*s+2],e),i[4*s+3]=255;return i}_pixelTo8Bit(t,e){let i=t<=e.min||t===e.padding?0:255;return t>e.min&&t<e.max&&(i=Math.round(255*(t-e.min)/e.range)),Number.isNaN(i)?0:e.invert?255-i:i}_compareArrays(t,e){return t===e||!(!t||!e||t.join()!==e.join())}get frameTime(){return this._frameTime}set frameTime(t){this._frameTime=t}get ultrasoundRegions(){return this._ultrasoundRegions}set ultrasoundRegions(t){this._ultrasoundRegions=t}get rows(){return this._rows}set rows(t){this._rows=t}get columns(){return this._columns}set columns(t){this._columns=t}get spacingBetweenSlices(){return this._spacingBetweenSlices}set spacingBetweenSlices(t){this._spacingBetweenSlices=t}get sliceThickness(){return this._sliceThickness}set sliceThickness(t){this._sliceThickness=t}get imagePosition(){return this._imagePosition}set imagePosition(t){this._imagePosition=t}get imageOrientation(){return this._imageOrientation}set imageOrientation(t){this._imageOrientation=t}get windowWidth(){return this._windowWidth}set windowWidth(t){this._windowWidth=t}get windowCenter(){return this._windowCenter}set windowCenter(t){this._windowCenter=t}get rescaleSlope(){return this._rescaleSlope}set rescaleSlope(t){this._rescaleSlope=t}get rescaleIntercept(){return this._rescaleIntercept}set rescaleIntercept(t){this._rescaleIntercept=t}get bitsAllocated(){return this._bitsAllocated}set bitsAllocated(t){this._bitsAllocated=t}get dist(){return this._dist}set dist(t){this._dist=t}get pixelSpacing(){return this._pixelSpacing}set pixelSpacing(t){this._pixelSpacing=t}get pixelAspectRatio(){return this._pixelAspectRatio}set pixelAspectRatio(t){this._pixelAspectRatio=t}get minMax(){return this._minMax}set minMax(t){this._minMax=t}get dimensionIndexValues(){return this._dimensionIndexValues}set dimensionIndexValues(t){this._dimensionIndexValues=t}get instanceNumber(){return this._instanceNumber}set instanceNumber(t){this._instanceNumber=t}get pixelData(){return this._pixelData}set pixelData(t){this._pixelData=t}set sopInstanceUID(t){this._sopInstanceUID=t}get sopInstanceUID(){return this._sopInstanceUID}get pixelPaddingValue(){return this._pixelPaddingValue}set pixelPaddingValue(t){this._pixelPaddingValue=t}get pixelRepresentation(){return this._pixelRepresentation}set pixelRepresentation(t){this._pixelRepresentation=t}get pixelType(){return this._pixelType}set pixelType(t){this._pixelType=t}get url(){return this._url}set url(t){this._url=t}get referencedSegmentNumber(){return this._referencedSegmentNumber}set referencedSegmentNumber(t){this._referencedSegmentNumber=t}get rightHanded(){return this._rightHanded}set rightHanded(t){this._rightHanded=t}get index(){return this._index}set index(t){this._index=t}get invert(){return this._invert}set invert(t){this._invert=t}get numberOfChannels(){return this._numberOfChannels}set numberOfChannels(t){this._numberOfChannels=t}}class it{constructor(){this._rightHanded=!0}pixelRepresentation(){return 0}pixelPaddingValue(t=0){return null}modality(){return"unknown"}segmentationType(){return"unknown"}segmentationSegments(){return[]}referencedSegmentNumber(t){return-1}rightHanded(){return this._rightHanded}spacingBetweenSlices(){return null}numberOfChannels(){return 1}sliceThickness(){return null}dimensionIndexValues(t=0){return null}instanceNumber(t=0){return t}windowCenter(t=0){return null}windowWidth(t=0){return null}rescaleSlope(t=0){return 1}rescaleIntercept(t=0){return 0}ultrasoundRegions(t=0){return[]}frameTime(t=0){return null}_decompressUncompressed(){}_swap16(t){return(255&t)<<8|t>>8&255}_swap32(t){return(255&t)<<24|(65280&t)<<8|t>>8&65280|t>>24&255}invert(){return!1}transferSyntaxUID(){return"no value provided"}studyDate(){return"no value provided"}studyDescription(){return"no value provided"}seriesDate(){return"no value provided"}seriesDescription(){return"no value provided"}rawHeader(){return"no value provided"}patientID(){return"no value provided"}patientName(){return"no value provided"}patientAge(){return"no value provided"}patientBirthdate(){return"no value provided"}patientSex(){return"no value provided"}minMaxPixelData(t=[]){let e=[Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY],i=t.length;for(let s=0;s<i;s++){let i=t[s];e[0]=Math.min(e[0],i),e[1]=Math.max(e[1],i)}return e}}const st=function(t,e){if(8===t.bitsAllocated)return t.planarConfiguration?function(t,e){const i=e,s=t.rows*t.columns,a=new ArrayBuffer(s*t.samplesPerPixel),o=new DataView(i.buffer,i.byteOffset),n=new Int8Array(i.buffer,i.byteOffset),l=new Int8Array(a);let r=0;const h=o.getInt32(0,!0);for(let t=0;t<h;++t){r=t*s;let e=o.getInt32(4*(t+1),!0),a=o.getInt32(4*(t+2),!0);0===a&&(a=i.length);const c=s*h;for(;e<a;){const t=n[e++];if(t>=0&&t<=127)for(let i=0;i<t+1&&r<c;++i)l[r]=n[e++],r++;else if(t<=-1&&t>=-127){const i=n[e++];for(let e=0;e<1-t&&r<c;++e)l[r]=i,r++}}}return t.pixelData=new Uint8Array(a),t}(t,e):function(t,e){const i=e,s=t.rows*t.columns,a=new ArrayBuffer(s*t.samplesPerPixel),o=new DataView(i.buffer,i.byteOffset),n=new Int8Array(i.buffer,i.byteOffset),l=new Int8Array(a);let r=0;const h=o.getInt32(0,!0);for(let e=0;e<h;++e){r=e;let a=o.getInt32(4*(e+1),!0),c=o.getInt32(4*(e+2),!0);0===c&&(c=i.length);const _=s*h;for(;a<c;){const e=n[a++];if(e>=0&&e<=127)for(let i=0;i<e+1&&r<_;++i)l[r]=n[a++],r+=t.samplesPerPixel;else if(e<=-1&&e>=-127){const i=n[a++];for(let s=0;s<1-e&&r<_;++s)l[r]=i,r+=t.samplesPerPixel}}}return t.pixelData=new Uint8Array(a),t}(t,e);if(16===t.bitsAllocated)return function(t,e){const i=e,s=t.rows*t.columns,a=new ArrayBuffer(s*t.samplesPerPixel*2),o=new DataView(i.buffer,i.byteOffset),n=new Int8Array(i.buffer,i.byteOffset),l=new Int8Array(a),r=o.getInt32(0,!0);for(let t=0;t<r;++t){let e=0;const a=0===t?1:0;let r=o.getInt32(4*(t+1),!0),h=o.getInt32(4*(t+2),!0);for(0===h&&(h=i.length);r<h;){const t=n[r++];if(t>=0&&t<=127)for(let i=0;i<t+1&&e<s;++i)l[2*e+a]=n[r++],e++;else if(t<=-1&&t>=-127){const i=n[r++];for(let o=0;o<1-t&&e<s;++o)l[2*e+a]=i,e++}}}0===t.pixelRepresentation?t.pixelData=new Uint16Array(a):t.pixelData=new Int16Array(a);return t}(t,e);throw new Error("unsupported pixel format for RLE")};let at,ot=require("dicom-parser"),nt=require("jpeg-lossless-decoder-js"),lt=require("OpenJPEG.js/dist/openJPEG-DynamicMemory-browser.js"),rt=require("../../external/scripts/jpeg"),ht=require("../../external/scripts/jpx");class ct extends it{constructor(t,e){super(),this._id=e,this._arrayBuffer=t.buffer;let i=new Uint8Array(this._arrayBuffer);this._dataSet=null;try{this._dataSet=ot.parseDicom(i)}catch(t){console.log(t);throw new Error("parsers.dicom could not parse the file")}}seriesInstanceUID(){return this._dataSet.string("x0020000e")}studyInstanceUID(){return this._dataSet.string("x0020000d")}modality(){return this._dataSet.string("x00080060")}segmentationType(){return this._dataSet.string("x00620001")}segmentationSegments(){let t=[],e=this._dataSet.elements.x00620002;if(!e)return t;for(let i=0;i<e.items.length;i++){let s=this._recommendedDisplayCIELab(e.items[i]),a=this._segmentationCode(e.items[i]),o=e.items[i].dataSet.uint16("x00620004"),n=e.items[i].dataSet.string("x00620005"),l=e.items[i].dataSet.string("x00620008");t.push({recommendedDisplayCIELab:s,segmentationCodeDesignator:a.segmentationCodeDesignator,segmentationCodeValue:a.segmentationCodeValue,segmentationCodeMeaning:a.segmentationCodeMeaning,segmentNumber:o,segmentLabel:n,segmentAlgorithmType:l})}return t}_segmentationCode(t){let e="unknown",i="unknown",s="unknown",a=t.dataSet.elements.x00082218;return a&&a.items&&a.items.length>0&&(e=a.items[0].dataSet.string("x00080102"),i=a.items[0].dataSet.string("x00080100"),s=a.items[0].dataSet.string("x00080104")),{segmentationCodeDesignator:e,segmentationCodeValue:i,segmentationCodeMeaning:s}}_recommendedDisplayCIELab(t){if(!t.dataSet.elements.x0062000d)return null;let e=t.dataSet.elements.x0062000d.dataOffset,i=t.dataSet.elements.x0062000d.length,s=t.dataSet.byteArray.slice(e,e+i),a=new Uint16Array(i/2);for(let t=0;t<i/2;t++)a[t]=(s[2*t+1]<<8)+s[2*t];return[a[0]/65535*100,a[1]/65535*255-128,a[2]/65535*255-128]}rawHeader(){return this._dataSet}sopInstanceUID(t=0){return this._findStringEverywhere("x2005140f","x00080018",t)}transferSyntaxUID(){return this._dataSet.string("x00020010")}studyDate(){return this._dataSet.string("x00080020")}studyDescription(){return this._dataSet.string("x00081030")}seriesDate(){return this._dataSet.string("x00080021")}seriesDescription(){return this._dataSet.string("x0008103e")}patientName(){return this._dataSet.string("x00100010")}patientID(){return this._dataSet.string("x00100020")}patientBirthdate(){return this._dataSet.string("x00100030")}patientSex(){return this._dataSet.string("x00100040")}patientAge(){return this._dataSet.string("x00101010")}photometricInterpretation(){return this._dataSet.string("x00280004")}planarConfiguration(){let t=this._dataSet.uint16("x00280006");return void 0===t&&(t=null),t}samplesPerPixel(){return this._dataSet.uint16("x00280002")}numberOfFrames(){let t=this._dataSet.intString("x00280008");return void 0===t&&(t=null),t}numberOfChannels(){let t=1,e=this.photometricInterpretation();return"RGB"!==e&&"PALETTE COLOR"!==e&&"YBR_FULL"!==e&&"YBR_FULL_422"!==e&&"YBR_PARTIAL_422"!==e&&"YBR_PARTIAL_420"!==e&&"YBR_RCT"!==e||(t=3),t}invert(){return"MONOCHROME1"===this.photometricInterpretation()}imageOrientation(t=0){let e=this._findStringEverywhere("x00209116","x00200037",t);return e&&(e=e.split("\\").map(n.stringToNumber)),e}referencedSegmentNumber(t=0){let e=-1,i=this._findInGroupSequence("x52009230","x0062000a",t);return null!==i&&(e=i.uint16("x0062000b")),e}pixelAspectRatio(){let t=[this._dataSet.intString("x00280034",0),this._dataSet.intString("x00280034",1)];return void 0===t[0]&&(t=null),t}imagePosition(t=0){let e=this._findStringEverywhere("x00209113","x00200032",t);return e&&(e=e.split("\\").map(n.stringToNumber)),e}instanceNumber(t=0){let e=null,i=this._dataSet.elements.x52009230;if(void 0!==i)if(i.items[t].dataSet.elements.x2005140f){e=i.items[t].dataSet.elements.x2005140f.items[0].dataSet.intString("x00200013")}else e=this._dataSet.intString("x00200013"),void 0===e&&(e=null);else e=this._dataSet.intString("x00200013"),void 0===e&&(e=null);return e}pixelSpacing(t=0){let e=this._findStringEverywhere("x00289110","x00280030",t);if(null===e&&(e=this._dataSet.string("x00181164"),void 0===e&&(e=null)),e){const t=e.split("\\");2!==t.length?(console.error(`DICOM spacing format is not supported (could not split string on "\\"): ${e}`),e=null):e=t.map(n.stringToNumber)}return e}ultrasoundRegions(t=0){const e=this._dataSet.elements.x00186011;if(!e||!e.items)return[];const i=[];return e.items.forEach((t=>{i.push({x0:t.dataSet.uint32("x00186018"),y0:t.dataSet.uint32("x0018601a"),x1:t.dataSet.uint32("x0018601c"),y1:t.dataSet.uint32("x0018601e"),axisX:t.dataSet.int32("x00186020")||null,axisY:t.dataSet.int32("x00186022")||null,unitsX:this._getUnitsName(t.dataSet.uint16("x00186024")),unitsY:this._getUnitsName(t.dataSet.uint16("x00186026")),deltaX:t.dataSet.double("x0018602c"),deltaY:t.dataSet.double("x0018602e")})})),i}frameTime(t=0){let e,i=this._dataSet.uint16("x00280009",1),s=this._dataSet.intString("x00082144");return"number"==typeof i&&(i=i.toString(16),e=this._dataSet.floatString("x0018"+i)),void 0===e&&"number"==typeof s&&(e=1e3/s),void 0===e&&(e=null),e}rows(t=0){let e=this._dataSet.uint16("x00280010");return void 0===e&&(e=null),e}columns(t=0){let e=this._dataSet.uint16("x00280011");return void 0===e&&(e=null),e}pixelType(t=0){return 0}pixelRepresentation(t=0){return this._dataSet.uint16("x00280103")}pixelPaddingValue(t=0){let e=this._dataSet.int16("x00280120");return void 0===e&&(e=null),e}bitsAllocated(t=0){return this._dataSet.uint16("x00280100")}highBit(t=0){return this._dataSet.uint16("x00280102")}rescaleIntercept(t=0){return this._findFloatStringInFrameGroupSequence("x00289145","x00281052",t)}rescaleSlope(t=0){return this._findFloatStringInFrameGroupSequence("x00289145","x00281053",t)}windowCenter(t=0){return this._findFloatStringInFrameGroupSequence("x00289132","x00281050",t)}windowWidth(t=0){return this._findFloatStringInFrameGroupSequence("x00289132","x00281051",t)}sliceThickness(t=0){return this._findFloatStringInFrameGroupSequence("x00289110","x00180050",t)}spacingBetweenSlices(t=0){let e=this._dataSet.floatString("x00180088");return void 0===e&&(e=null),e}dimensionIndexValues(t=0){let e=null,i=this._dataSet.elements.x52009230;if(void 0!==i){let s=i.items[t].dataSet.elements.x00209111;if(null!=s){s=s.items[0].dataSet;let t=s.elements.x00209157;if(null!=t){let i=t.length/4;e=[];for(let t=0;t<i;t++)e.push(s.uint32("x00209157",t))}}}return e}inStackPositionNumber(t=0){let e=null,i=this._dataSet.elements.x52009230;if(void 0!==i){e=i.items[t].dataSet.elements.x00209111.items[0].dataSet.uint32("x00209057")}else e=null;return e}stackID(t=0){let e=null,i=this._dataSet.elements.x52009230;if(void 0!==i){e=i.items[t].dataSet.elements.x00209111.items[0].dataSet.intString("x00209056")}else e=null;return e}extractPixelData(t=0){let e=this._decodePixelData(t);return this.numberOfChannels()>1?this._convertColorSpace(e):e}_findInGroupSequence(t,e,i){let s=this._dataSet.elements[t];if(void 0!==s){let t=s.items[i].dataSet.elements[e];if(void 0!==t)return t.items[0].dataSet}return null}_findStringInGroupSequence(t,e,i,s){let a=this._findInGroupSequence(t,e,s);return null!==a?a.string(i):null}_findStringInFrameGroupSequence(t,e,i){return this._findStringInGroupSequence("x52009229",t,e,0)||this._findStringInGroupSequence("x52009230",t,e,i)}_findStringEverywhere(t,e,i){let s=this._findStringInFrameGroupSequence(t,e,i);if(null===s){const t="x00540022";s=this._findStringInSequence(t,e)}return null===s&&(s=this._dataSet.string(e)),void 0===s&&(s=null),s}_findStringInSequence(t,e,i){const s=this._dataSet.elements[t];let a;return s&&(a=s.items[0].dataSet.string(e)),void 0===a&&(a=null),a}_findFloatStringInGroupSequence(t,e,i,s){let a=this._dataSet.floatString(i);return void 0===a&&(a=this._findInGroupSequence(t,e,s),null!==a)?a.floatString(i):a}_findFloatStringInFrameGroupSequence(t,e,i){return this._findFloatStringInGroupSequence("x52009229",t,e,0)||this._findFloatStringInGroupSequence("x52009230",t,e,i)}_decodePixelData(t=0){let e=this.transferSyntaxUID();if("1.2.840.10008.1.2.4.90"===e||"1.2.840.10008.1.2.4.91"===e)return this._decodeJ2K(t);if("1.2.840.10008.1.2.5"===e)return this._decodeRLE(t);if("1.2.840.10008.1.2.4.57"===e||"1.2.840.10008.1.2.4.70"===e)return this._decodeJPEGLossless(t);if("1.2.840.10008.1.2.4.50"===e||"1.2.840.10008.1.2.4.51"===e)return this._decodeJPEGBaseline(t);if("1.2.840.10008.1.2"===e||"1.2.840.10008.1.2.1"===e)return this._decodeUncompressed(t);if("1.2.840.10008.1.2.2"===e){let e=this._decodeUncompressed(t);return this._swapFrame(e)}throw{error:`no decoder for transfer syntax ${e}`}}framesAreFragmented(){return this._dataSet.intString("x00280008")!==this._dataSet.elements.x7fe00010.fragments.length}getEncapsulatedImageFrame(t){return this._dataSet.elements.x7fe00010&&this._dataSet.elements.x7fe00010.basicOffsetTable.length?ot.readEncapsulatedImageFrame(this._dataSet,this._dataSet.elements.x7fe00010,t):this.framesAreFragmented()?ot.readEncapsulatedImageFrame(this._dataSet,this._dataSet.elements.x7fe00010,t,ot.createJPEGBasicOffsetTable(this._dataSet,this._dataSet.elements.x7fe00010)):ot.readEncapsulatedPixelDataFromFragments(this._dataSet,this._dataSet.elements.x7fe00010,t)}_decodeJpx(t=0){const e=new ht;if(e.parse(this.getEncapsulatedImageFrame(t)),1!==e.componentsCount)throw new Error("JPEG2000 decoder returned a componentCount of ${componentsCount}, when 1 is expected");if(1!==e.tiles.length)throw new Error("JPEG2000 decoder returned a tileCount of ${tileCount}, when 1 is expected");return e.tiles[0].items}_decodeOpenJPEG(t=0){const e=this.getEncapsulatedImageFrame(t),i=this.bitsAllocated(t)<=8?1:2,s=1===this.pixelRepresentation(t),a=at._malloc(e.length);at.writeArrayToMemory(e,a);const o=at._malloc(4),n=at._malloc(4),l=at._malloc(4),r=at._malloc(4),h=at._malloc(4),c=at.ccall("jp2_decode","number",["number","number","number","number","number","number","number"],[a,e.length,o,n,l,r,h]),_=at.getValue(o,"*");if(0!==c)return console.log("[opj_decode] decoding failed!"),at._free(a),at._free(_),at._free(l),at._free(r),at._free(n),void at._free(h);const d=at.getValue(l,"i32")*at.getValue(r,"i32")*at.getValue(h,"i32"),p=new Int32Array(at.HEAP32.buffer,_,d);let u;if(1===i)if(Uint8Array.from)u=Uint8Array.from(p);else{u=new Uint8Array(d);for(let t=0;t<d;t++)u[t]=p[t]}else if(s)if(Int16Array.from)u=Int16Array.from(p);else{u=new Int16Array(d);for(let t=0;t<d;t++)u[t]=p[t]}else if(Uint16Array.from)u=Uint16Array.from(p);else{u=new Uint16Array(d);for(let t=0;t<d;t++)u[t]=p[t]}return at._free(a),at._free(o),at._free(_),at._free(n),at._free(l),at._free(r),at._free(h),u}_decodeJ2K(t=0){return void 0===lt?this._decodeJpx(t):at||(at=lt(),at&&at._jp2_decode)?this._decodeOpenJPEG(t):this._decodeJpx(t)}_decodeRLE(t=0){const e=this.bitsAllocated(t),i=this.planarConfiguration(),s=this.columns(),a=this.rows(),o=this.samplesPerPixel(t),n={pixelRepresentation:this.pixelRepresentation(t),bitsAllocated:e,planarConfiguration:i,columns:s,rows:a,samplesPerPixel:o},l=ot.readEncapsulatedPixelDataFromFragments(this._dataSet,this._dataSet.elements.x7fe00010,t);return st(n,l).pixelData}_decodeJPEGLossless(t=0){let e=this.getEncapsulatedImageFrame(t),i=this.pixelRepresentation(t),s=this.bitsAllocated(t)<=8?1:2,a=(new nt.lossless.Decoder).decode(e.buffer,e.byteOffset,e.length,s);return 0===i?2===s?new Uint16Array(a.buffer):new Uint8Array(a.buffer):new Int16Array(a.buffer)}_decodeJPEGBaseline(t=0){let e=this.getEncapsulatedImageFrame(t),i=this.rows(t),s=this.columns(t),a=this.bitsAllocated(t),o=new rt;return o.parse(e),8===a?o.getData(s,i):16===a?o.getData16(s,i):void 0}_decodeUncompressed(t=0){let e=this.pixelRepresentation(t),i=this.bitsAllocated(t),s=this._dataSet.elements.x7fe00010.dataOffset,a=this.numberOfChannels(),o=this.rows(t)*this.columns(t)*a,n=0,l=this._dataSet.byteArray.buffer;if(0===e&&8===i)return n=s+t*o,new Uint8Array(l,n,o);if(0===e&&16===i)return n=s+t*o*2,new Uint16Array(l,n,o);if(1===e&&16===i)return n=s+t*o*2,new Int16Array(l,n,o);if(0===e&&32===i)return n=s+t*o*4,new Uint32Array(l,n,o);if(0===e&&1===i){let e=new ArrayBuffer(o),i=new Uint8Array(e);n=s+t*o;let a=0,r=t*o,h=t*o+o,c=Math.floor(r/8),_=r-8*c,d=Math.ceil(h/8),p=new Uint8Array(l,s);for(let t=c;t<=d;t++){for(;_<8;){switch(_){case 0:i[a]=1&p[t];break;case 1:i[a]=p[t]>>>1&1;break;case 2:i[a]=p[t]>>>2&1;break;case 3:i[a]=p[t]>>>3&1;break;case 4:i[a]=p[t]>>>4&1;break;case 5:i[a]=p[t]>>>5&1;break;case 6:i[a]=p[t]>>>6&1;break;case 7:i[a]=p[t]>>>7&1}if(_++,a++,a>=o)return i}_=0}}}_interpretAsRGB(t){return-1!==["RGB","YBR_RCT","YBR_ICT","YBR_FULL_422"].indexOf(t)}_convertColorSpace(t){let e=null,i=this.photometricInterpretation(),s=this.planarConfiguration();null===s&&(s=0,console.log("Planar Configuration was not set and was defaulted to\t0"));const a=this._interpretAsRGB(i);if(a&&0===s)e=t;else if(a&&1===s){if(t instanceof Int8Array)e=new Int8Array(t.length);else if(t instanceof Uint8Array)e=new Uint8Array(t.length);else if(t instanceof Int16Array)e=new Int16Array(t.length);else{if(!(t instanceof Uint16Array)){throw new Error(`unsuported typed array: ${t}`)}e=new Uint16Array(t.length)}let i=t.length/3,s=0,a=0,o=i,n=2*i;for(let l=0;l<i;l++)e[s++]=t[a++],e[s++]=t[o++],e[s++]=t[n++]}else{if("YBR_FULL"!==i){throw new Error(`photometric interpolation not supported: ${i}`)}{if(t instanceof Int8Array)e=new Int8Array(t.length);else if(t instanceof Uint8Array)e=new Uint8Array(t.length);else if(t instanceof Int16Array)e=new Int16Array(t.length);else{if(!(t instanceof Uint16Array)){throw new Error(`unsuported typed array: ${t}`)}e=new Uint16Array(t.length)}let i=t.length/3,s=0,a=0;for(let o=0;o<i;o++){let i=t[s++],o=t[s++],n=t[s++];e[a++]=i+1.402*(n-128),e[a++]=i-.34414*(o-128)-.71414*(n-128),e[a++]=i+1.772*(o-128)}}}return e}_swapFrame(t){let e=this.bitsAllocated();if(16===e)for(let e=0;e<t.length;e++)t[e]=this._swap16(t[e]);else if(32===e)for(let e=0;e<t.length;e++)t[e]=this._swap32(t[e]);return t}_getUnitsName(t){const e={0:"none",1:"percent",2:"dB",3:"cm",4:"seconds",5:"hertz",6:"dB/seconds",7:"cm/sec",8:"cm2",9:"cm2/sec",10:"cm3",11:"cm3/sec",12:"degrees"};return e.hasOwnProperty(t)?e[t]:"none"}}class _t extends it{constructor(t,e){super(),this._id=e,this._url=t.url,this._header={},this._buffer=null;try{(new TextDecoder).decode(t.mhdBuffer).split("\n").forEach((t=>{let e=t.split("=");2===e.length&&(this._header[e[0].trim()]=e[1].trim())})),this._header.DimSize=this._header.DimSize.split(" "),this._header.ElementSpacing=this._header.ElementSpacing.split(" "),this._header.TransformMatrix=this._header.TransformMatrix.split(" "),this._header.Offset=this._header.Offset.split(" "),this._buffer=t.rawBuffer}catch(t){console.log("ooops... :(")}}rightHanded(){let t=this._header.AnatomicalOrientation;return this._rightHanded="RAS"===t||"RPI"===t||"LPS"===t||"LAI"===t,this._rightHanded}seriesInstanceUID(){return this._url}numberOfFrames(){return parseInt(this._header.DimSize[2],10)}sopInstanceUID(t=0){return t}rows(t=0){return parseInt(this._header.DimSize[1],10)}columns(t=0){return parseInt(this._header.DimSize[0],10)}pixelType(t=0){let e=0;return"MET_UFLOAT"!==this._header.ElementType&&"MET_FLOAT"!==this._header.ElementType||(e=1),e}bitsAllocated(t=0){let e=1;return"MET_UCHAR"===this._header.ElementType||"MET_CHAR"===this._header.ElementType?e=8:"MET_USHORT"===this._header.ElementType||"MET_SHORT"===this._header.ElementType?e=16:"MET_UINT"!==this._header.ElementType&&"MET_INT"!==this._header.ElementType&&"MET_UFLOAT"!==this._header.ElementType&&"MET_FLOAT"!==this._header.ElementType||(e=32),e}pixelSpacing(t=0){return[parseFloat(this._header.ElementSpacing[1],10),parseFloat(this._header.ElementSpacing[0],10),parseFloat(this._header.ElementSpacing[2],10)]}imageOrientation(t=0){let i=this._header.AnatomicalOrientation.match(/L/)?-1:1,s=this._header.AnatomicalOrientation.match(/P/)?-1:1,a=new e.Vector3(parseFloat(this._header.TransformMatrix[0])*i,parseFloat(this._header.TransformMatrix[1])*s,parseFloat(this._header.TransformMatrix[2]));a.normalize();let o=new e.Vector3(parseFloat(this._header.TransformMatrix[3])*i,parseFloat(this._header.TransformMatrix[4])*s,parseFloat(this._header.TransformMatrix[5]));return o.normalize(),[a.x,a.y,a.z,o.x,o.y,o.z]}imagePosition(t=0){return[parseFloat(this._header.Offset[0]),parseFloat(this._header.Offset[1]),parseFloat(this._header.Offset[2])]}extractPixelData(t=0){return this._decompressUncompressed(t)}_decompressUncompressed(t=0){let e=this._buffer,i=this.numberOfChannels(),s=this.rows(t)*this.columns(t)*i;this.rightHanded()||(t=this.numberOfFrames()-1-t);let a=t*s;return"MET_CHAR"===this._header.ElementType?new Int8Array(e,a,s):"MET_UCHAR"===this._header.ElementType?new Uint8Array(e,a,s):"MET_SHORT"===this._header.ElementType?(a*=2,new Int16Array(e,a,s)):"MET_USHORT"===this._header.ElementType?(a*=2,new Uint16Array(e,a,s)):"MET_INT"===this._header.ElementType?(a*=4,new Int32Array(e,a,s)):"MET_UINT"===this._header.ElementType?(a*=4,new Uint32Array(e,a,s)):"MET_FLOAT"===this._header.ElementType?(a*=4,new Float32Array(e,a,s)):void 0}}let dt=require("nifti-reader-js/src/nifti");class pt extends it{constructor(t,e){if(super(),this._id=e,this._arrayBuffer=t.buffer,this._url=t.url,this._dataSet=null,this._niftiHeader=null,this._niftiImage=null,this._ordered=!0,this._orderedData=null,this._qfac=1,!dt.isNIFTI(this._arrayBuffer)){throw new Error("parsers.nifti could not parse the file")}this._dataSet=dt.readHeader(this._arrayBuffer),this._niftiImage=dt.readImage(this._dataSet,this._arrayBuffer)}seriesInstanceUID(){return this._url}numberOfFrames(){return this._dataSet.dims[3]}numberOfChannels(){let t=1;return this._dataSet.dims[0]>=5?(t=this._dataSet.dims[5],this._ordered=!1):128===this._dataSet.datatypeCode?t=3:2304===this._dataSet.datatypeCode&&(t=4),t}sopInstanceUID(t=0){return t}rows(t=0){return this._dataSet.dims[2]}columns(t=0){return this._dataSet.dims[1]}pixelType(t=0){let e=0;return 16!==this._dataSet.datatypeCode&&64!==this._dataSet.datatypeCode&&1536!==this._dataSet.datatypeCode||(e=1),e}bitsAllocated(t=0){return this._dataSet.numBitsPerVoxel}pixelSpacing(t=0){return[this._dataSet.pixDims[1],this._dataSet.pixDims[2],this._dataSet.pixDims[3]]}sliceThickness(){return null}imageOrientation(t=0){if(this._dataSet.qform_code>0){let t=0,e=this._dataSet.quatern_b,i=this._dataSet.quatern_c,s=this._dataSet.quatern_d;return t=1-(e*e+i*i+s*s),t<1e-7?(t=1/Math.sqrt(e*e+i*i+s*s),e*=t,i*=t,s*=t,t=0):t=Math.sqrt(t),this._dataSet.pixDims[0]<0&&(this._rightHanded=!1),[-(t*t+e*e-i*i-s*s),-2*(e*i+t*s),2*(e*s-t*i),-2*(e*i-t*s),-(t*t+i*i-e*e-s*s),2*(i*s+t*e)]}if(this._dataSet.sform_code>0){return[...[-this._dataSet.affine[0][0],-this._dataSet.affine[0][1],this._dataSet.affine[0][2]],...[-this._dataSet.affine[1][0],-this._dataSet.affine[1][1],this._dataSet.affine[0][2]]]}return this._dataSet.qform_code,[1,0,0,0,1,0]}imagePosition(t=0){return[-this._dataSet.qoffset_x,-this._dataSet.qoffset_y,this._dataSet.qoffset_z]}dimensionIndexValues(t=0){return null}instanceNumber(t=0){return t}windowCenter(t=0){return null}windowWidth(t=0){return null}rescaleSlope(t=0){return this._dataSet.scl_slope}rescaleIntercept(t=0){return this._dataSet.scl_inter}extractPixelData(t=0){return this._decompressUncompressed(t)}_decompressUncompressed(t=0){let e=this.numberOfChannels(),i=this.rows(t)*this.columns(t)*e,s=t*i,a=this._niftiImage;if(this._ordered||null!==this._orderedData||this._reorderData(),null!==this._orderedData)return this._orderedData.slice(s,s+i);if(2===this._dataSet.datatypeCode)return new Uint8Array(a,s,i);if(256===this._dataSet.datatypeCode)return new Int8Array(a,s,i);if(512===this._dataSet.datatypeCode)return s*=2,new Uint16Array(a,s,i);if(4===this._dataSet.datatypeCode)return s*=2,new Int16Array(a,s,i);if(8===this._dataSet.datatypeCode)return s*=4,new Int32Array(a,s,i);if(16===this._dataSet.datatypeCode){s*=4;const t=new Float32Array(a,s,i);for(let e=0;e<t.length;e++)t[e]!==1/0&&t[e]!==-1/0||(t[e]=0);return t}console.warn(`Unknown data type: datatypeCode : ${this._dataSet.datatypeCode}`)}_reorderData(){let t=this.numberOfChannels(),e=this.rows()*this.columns()*t,i=this._niftiImage,s=e*this.numberOfFrames(),a=null;this._orderedData=null,2===this._dataSet.datatypeCode?(a=new Uint8Array(i,0,s),this._orderedData=new Uint8Array(a.length)):256===this._dataSet.datatypeCode?(a=new Int8Array(i,0,s),this._orderedData=new Int8Array(a.length)):512===this._dataSet.datatypeCode?(a=new Uint16Array(i,0,s),this._orderedData=new Uint16Array(a.length)):4===this._dataSet.datatypeCode?(a=new Int16Array(i,0,s),this._orderedData=new Int16Array(a.length)):16===this._dataSet.datatypeCode&&(a=new Float32Array(i,0,s),this._orderedData=new Float32Array(a.length));let o=a.length/3,n=0,l=0,r=o,h=2*o;for(let t=0;t<o;t++)this._orderedData[n++]=a[l++],this._orderedData[n++]=a[r++],this._orderedData[n++]=a[h++];this._ordered=!0}}let ut=require("pako"),mt=require("nrrd-js");class yt extends it{constructor(t,e){super(),this._id=e,this._arrayBuffer=t.buffer,this._url=t.url,this._dataSet=null,this._unpackedData=null;try{this._dataSet=mt.parse(this._arrayBuffer)}catch(t){console.log("ooops... :(")}}rightHanded(){return this._dataSet.space.match(/^right-anterior-superior/)||this._dataSet.space.match(/^left-posterior-superior/)?this._rightHanded=!0:this._rightHanded=!1,this._rightHanded}seriesInstanceUID(){return this._url}numberOfFrames(){return this._dataSet.sizes[2]}numberOfChannels(){return 1}sopInstanceUID(t=0){return t}rows(t=0){return this._dataSet.sizes[1]}columns(t=0){return this._dataSet.sizes[0]}pixelType(t=0){let e=0;return"float"===this._dataSet.type&&(e=1),e}bitsAllocated(t=0){let e=1;return"int8"===this._dataSet.type||"uint8"===this._dataSet.type||"char"===this._dataSet.type?e=8:"int16"===this._dataSet.type||"uint16"===this._dataSet.type||"short"===this._dataSet.type?e=16:"int32"!==this._dataSet.type&&"uint32"!==this._dataSet.type&&"float"!==this._dataSet.type||(e=32),e}pixelSpacing(t=0){const i=new e.Vector3(this._dataSet.spaceDirections[0][0],this._dataSet.spaceDirections[0][1],this._dataSet.spaceDirections[0][2]),s=new e.Vector3(this._dataSet.spaceDirections[1][0],this._dataSet.spaceDirections[1][1],this._dataSet.spaceDirections[1][2]),a=new e.Vector3(this._dataSet.spaceDirections[2][0],this._dataSet.spaceDirections[2][1],this._dataSet.spaceDirections[2][2]);return[i.length(),s.length(),a.length()]}imageOrientation(t=0){let i=this._dataSet.space.match(/right/)?-1:1,s=this._dataSet.space.match(/anterior/)?-1:1,a=new e.Vector3(this._dataSet.spaceDirections[0][0]*i,this._dataSet.spaceDirections[0][1]*s,this._dataSet.spaceDirections[0][2]);a.normalize();let o=new e.Vector3(this._dataSet.spaceDirections[1][0]*i,this._dataSet.spaceDirections[1][1]*s,this._dataSet.spaceDirections[1][2]);return o.normalize(),[a.x,a.y,a.z,o.x,o.y,o.z]}imagePosition(t=0){return[this._dataSet.spaceOrigin[0],this._dataSet.spaceOrigin[1],this._dataSet.spaceOrigin[2]]}extractPixelData(t=0){return this._decompressUncompressed(t)}_decompressUncompressed(t=0){let e=this._dataSet.buffer;const i=this.numberOfChannels(),s=this.rows(t)*this.columns(t)*i;this.rightHanded()||(t=this.numberOfFrames()-1-t);let a=t*s;if(null===this._unpackedData&&"gzip"===this._dataSet.encoding){let t=ut.inflate(this._dataSet.buffer);this._unpackedData=t.buffer,e=this._unpackedData}else"gzip"===this._dataSet.encoding&&(e=this._unpackedData);return"int8"===this._dataSet.type||"char"===this._dataSet.type?new Int8Array(e,a,s):"uint8"===this._dataSet.type?new Uint8Array(e,a,s):"int16"===this._dataSet.type||"short"===this._dataSet.type?(a*=2,new Int16Array(e,a,s)):"uint16"===this._dataSet.type?(a*=2,new Uint16Array(e,a,s)):"int32"===this._dataSet.type?(a*=4,new Int32Array(e,a,s)):"uint32"===this._dataSet.type?(a*=4,new Uint32Array(e,a,s)):"float"===this._dataSet.type?(a*=4,new Float32Array(e,a,s)):void 0}}class bt extends it{constructor(t,i){if(super(),this._id=i,this._url=t.url,this._buffer=null,this._bufferPos=0,this._dataPos=0,this._pixelData=null,this._version=1,this._width=0,this._height=0,this._depth=0,this._nframes=0,this._type=bt.MRI_UCHAR,this._dof=0,this._goodRASFlag=0,this._spacingXYZ=[1,1,1],this._Xras=[-1,0,0],this._Yras=[0,0,-1],this._Zras=[0,1,0],this._Cras=[0,0,0],this._tr=0,this._flipAngle=0,this._te=0,this._ti=0,this._fov=0,this._tags=[],this._origin=[0,0,0],this._imageOrient=[0,0,0,0,0,0],this._buffer=t.buffer,this._version=this._readInt(),this._swapEndian=!1,1==this._version);else{if(16777216!=this._version){throw new Error("MGH/MGZ parser: Unknown Endian.\tVersion reports: "+this._version)}this._swapEndian=!0,this._version=this._swap32(this._version)}this._width=this._readInt(),this._height=this._readInt(),this._depth=this._readInt(),this._nframes=this._readInt(),this._type=this._readInt(),this._dof=this._readInt(),this._goodRASFlag=this._readShort(),this._spacingXYZ=this._readFloat(3),this._Xras=this._readFloat(3),this._Yras=this._readFloat(3),this._Zras=this._readFloat(3),this._Cras=this._readFloat(3),this._bufferPos=284;let s=this._width*this._height*this._depth*this._nframes;switch(this._width,this._height,this._depth,this._type){case bt.MRI_UCHAR:this._pixelData=this._readUChar(s);break;case bt.MRI_INT:this._pixelData=this._readInt(s);break;case bt.MRI_FLOAT:this._pixelData=this._readFloat(s);break;case bt.MRI_SHORT:this._pixelData=this._readShort(s);break;default:throw Error("MGH/MGZ parser: Unknown _type.\t_type reports: "+this._type)}this._tr=this._readFloat(1),this._flipAngle=this._readFloat(1),this._te=this._readFloat(1),this._ti=this._readFloat(1),this._fov=this._readFloat(1);let a=new TextDecoder,o=this._tagReadStart();for(;null!=o[0];){let t,e=o[0],i=o[1];switch(e){case bt.TAG_OLD_MGH_XFORM:case bt.TAG_MGH_XFORM:}t=this._readChar(i),t=a.decode(t),this._tags.push({tagType:e,tagValue:t}),o=this._tagReadStart()}const n=(new e.Vector3).fromArray(this._Xras),l=(new e.Vector3).fromArray(this._Yras),r=(new e.Vector3).crossVectors(n,l),h=(new e.Vector3).fromArray(this._Zras);r.angleTo(h)>Math.PI/2&&(this._rightHanded=!1),this._imageOrient=[-this._Xras[0],-this._Xras[1],this._Xras[2],-this._Yras[0],-this._Yras[1],this._Yras[2]];let c=this._width/2,_=this._height/2,d=this._depth/2;for(let t=0;t<3;++t)this._origin[t]=this._Cras[t]-(this._Xras[t]*this._spacingXYZ[0]*c+this._Yras[t]*this._spacingXYZ[1]*_+this._Zras[t]*this._spacingXYZ[2]*d);this._origin=[-this._origin[0],-this._origin[1],this._origin[2]]}seriesInstanceUID(){return this._url}numberOfFrames(){return this._depth}sopInstanceUID(t=0){return t}rows(t=0){return this._width}columns(t=0){return this._height}pixelType(t=0){switch(this._type){case bt.MRI_UCHAR:case bt.MRI_INT:case bt.MRI_SHORT:return 0;case bt.MRI_FLOAT:return 1;default:throw Error("MGH/MGZ parser: Unknown _type.\t_type reports: "+this._type)}}bitsAllocated(t=0){switch(this._type){case bt.MRI_UCHAR:return 8;case bt.MRI_SHORT:return 16;case bt.MRI_INT:case bt.MRI_FLOAT:return 32;default:throw Error("MGH/MGZ parser: Unknown _type.\t_type reports: "+this._type)}}pixelSpacing(t=0){return this._spacingXYZ}imageOrientation(t=0){return this._imageOrient}imagePosition(t=0){return this._origin}extractPixelData(t=0){let e=this._width*this._height;return this._pixelData.slice(t*e,(t+1)*e)}_readInt(t=1){let e,i=new DataView(this._buffer.slice(this._bufferPos,this._bufferPos+4*t));if(this._bufferPos+=4*t,1==t)e=i.getInt32(0,this._swapEndian);else{e=new Int32Array(t);for(let s=0;s<t;s++)e[s]=i.getInt32(4*s,this._swapEndian)}return e}_readShort(t=1){let e,i=new DataView(this._buffer.slice(this._bufferPos,this._bufferPos+2*t));if(this._bufferPos+=2*t,1==t)e=i.getInt16(0,this._swapEndian);else{e=new Int16Array(t);for(let s=0;s<t;s++)e[s]=i.getInt16(2*s,this._swapEndian)}return e}_readLong(t=1){let e=new DataView(this._buffer.slice(this._bufferPos,this._bufferPos+8*t));this._bufferPos+=8*t;let i=new Uint16Array(t);for(let s=0;s<t;s++){let t=0,a=0;this._swapendian?t=4:a=4;let o=e.getInt32(8*s+t,this._swapEndian),n=e.getInt32(8*s+a,this._swapEndian);0!=o&&(console.log("Unable to read Int64 with high word: "+o+"low word: "+n),n=void 0),i[s]=n}return 0==t?void 0:1==t?i[0]:i}_readChar(t=1){let e,i=new DataView(this._buffer.slice(this._bufferPos,this._bufferPos+t));if(this._bufferPos+=t,1==t)e=i.getInt8(0,this._swapEndian);else{e=new Int8Array(t);for(let s=0;s<t;s++)e[s]=i.getInt8(s,this._swapEndian)}return e}_readUChar(t=1){let e,i=new DataView(this._buffer.slice(this._bufferPos,this._bufferPos+t));if(this._bufferPos+=t,1==t)e=i.getUint8(0,this._swapEndian);else{e=new Uint8Array(t);for(let s=0;s<t;s++)e[s]=i.getUint8(s,this._swapEndian)}return e}_readFloat(t=1){let e,i=new DataView(this._buffer.slice(this._bufferPos,this._bufferPos+4*t));if(this._bufferPos+=4*t,1==t)e=i.getFloat32(0,this._swapEndian);else{e=new Float32Array(t);for(let s=0;s<t;s++)e[s]=i.getFloat32(4*s,this._swapEndian)}return e}_tagReadStart(){if(this._bufferPos>=this._buffer.byteLength)return[void 0,void 0];let t,e=this._readInt();switch(e){case bt.TAG_OLD_MGH_XFORM:t=this._readInt(),t-=1;break;case bt.TAG_OLD_SURF_GEOM:case bt.TAG_OLD_USEREALRAS:case bt.TAG_OLD_COLORTABLE:t=0;break;default:t=this._readLong()}return null==t&&(e=void 0),[e,t]}}bt.MRI_UCHAR=0,bt.MRI_INT=1,bt.MRI_LONG=2,bt.MRI_FLOAT=3,bt.MRI_SHORT=4,bt.MRI_BITMAP=5,bt.MRI_TENSOR=6,bt.MRI_FLOAT_COMPLEX=7,bt.MRI_DOUBLE_COMPLEX=8,bt.MRI_RGB=9,bt.TAG_OLD_COLORTABLE=1,bt.TAG_OLD_USEREALRAS=2,bt.TAG_CMDLINE=3,bt.TAG_USEREALRAS=4,bt.TAG_COLORTABLE=5,bt.TAG_GCAMORPH_GEOM=10,bt.TAG_GCAMORPH_TYPE=11,bt.TAG_GCAMORPH_LABELS=12,bt.TAG_OLD_SURF_GEOM=20,bt.TAG_SURF_GEOM=21,bt.TAG_OLD_MGH_XFORM=30,bt.TAG_MGH_XFORM=31,bt.TAG_GROUP_AVG_SURFACE_AREA=32,bt.TAG_AUTO_ALIGN=33,bt.TAG_SCALAR_DOUBLE=40,bt.TAG_PEDIR=41,bt.TAG_MRI_FRAME=42,bt.TAG_FIELDSTRENGTH=43;const gt=require("pako");class ft{constructor(){this._id=-1,this._worldCoordinates=null,this._dataCoordinates=null,this._screenCoordinates=null,this._value=null}set worldCoordinates(t){this._worldCoordinates=t}get worldCoordinates(){return this._worldCoordinates}set dataCoordinates(t){this._dataCoordinates=t}get dataCoordinates(){return this._dataCoordinates}set screenCoordinates(t){this._screenCoordinates=t}get screenCoordinates(){return this._screenCoordinates}set value(t){this._value=t}get value(){return this._value}set id(t){this._id=t}get id(){return this._id}}const vt={0:{color:[0,0,0],opacity:0,label:"Unknown"},1:{color:[70,130,180],opacity:1,label:"Left-Cerebral-Exterior"},2:{color:[245,245,245],opacity:1,label:"Left-Cerebral-White-Matter"},3:{color:[205,62,78],opacity:1,label:"Left-Cerebral-Cortex"},4:{color:[120,18,134],opacity:1,label:"Left-Lateral-Ventricle"},5:{color:[196,58,250],opacity:1,label:"Left-Inf-Lat-Vent"},6:{color:[0,148,0],opacity:1,label:"Left-Cerebellum-Exterior"},7:{color:[220,248,164],opacity:1,label:"Left-Cerebellum-White-Matter"},8:{color:[230,148,34],opacity:1,label:"Left-Cerebellum-Cortex"},9:{color:[0,118,14],opacity:1,label:"Left-Thalamus"},10:{color:[0,118,14],opacity:1,label:"Left-Thalamus-Proper"},11:{color:[122,186,220],opacity:1,label:"Left-Caudate"},12:{color:[236,13,176],opacity:1,label:"Left-Putamen"},13:{color:[12,48,255],opacity:1,label:"Left-Pallidum"},14:{color:[204,182,142],opacity:1,label:"3rd-Ventricle"},15:{color:[42,204,164],opacity:1,label:"4th-Ventricle"},16:{color:[119,159,176],opacity:1,label:"Brain-Stem"},17:{color:[220,216,20],opacity:1,label:"Left-Hippocampus"},18:{color:[103,255,255],opacity:1,label:"Left-Amygdala"},19:{color:[80,196,98],opacity:1,label:"Left-Insula"},20:{color:[60,58,210],opacity:1,label:"Left-Operculum"},21:{color:[60,58,210],opacity:1,label:"Line-1"},22:{color:[60,58,210],opacity:1,label:"Line-2"},23:{color:[60,58,210],opacity:1,label:"Line-3"},24:{color:[60,60,60],opacity:1,label:"CSF"},25:{color:[255,165,0],opacity:1,label:"Left-Lesion"},26:{color:[255,165,0],opacity:1,label:"Left-Accumbens-area"},27:{color:[0,255,127],opacity:1,label:"Left-Substancia-Nigra"},28:{color:[165,42,42],opacity:1,label:"Left-VentralDC"},29:{color:[135,206,235],opacity:1,label:"Left-undetermined"},30:{color:[160,32,240],opacity:1,label:"Left-vessel"},31:{color:[0,200,200],opacity:1,label:"Left-choroid-plexus"},32:{color:[100,50,100],opacity:1,label:"Left-F3orb"},33:{color:[135,50,74],opacity:1,label:"Left-lOg"},34:{color:[122,135,50],opacity:1,label:"Left-aOg"},35:{color:[51,50,135],opacity:1,label:"Left-mOg"},36:{color:[74,155,60],opacity:1,label:"Left-pOg"},37:{color:[120,62,43],opacity:1,label:"Left-Stellate"},38:{color:[74,155,60],opacity:1,label:"Left-Porg"},39:{color:[122,135,50],opacity:1,label:"Left-Aorg"},40:{color:[70,130,180],opacity:1,label:"Right-Cerebral-Exterior"},41:{color:[245,245,245],opacity:1,label:"Right-Cerebral-White-Matter"},42:{color:[205,62,78],opacity:1,label:"Right-Cerebral-Cortex"},43:{color:[120,18,134],opacity:1,label:"Right-Lateral-Ventricle"},44:{color:[196,58,250],opacity:1,label:"Right-Inf-Lat-Vent"},45:{color:[0,148,0],opacity:1,label:"Right-Cerebellum-Exterior"},46:{color:[220,248,164],opacity:1,label:"Right-Cerebellum-White-Matter"},47:{color:[230,148,34],opacity:1,label:"Right-Cerebellum-Cortex"},48:{color:[0,118,14],opacity:1,label:"Right-Thalamus"},49:{color:[0,118,14],opacity:1,label:"Right-Thalamus-Proper"},50:{color:[122,186,220],opacity:1,label:"Right-Caudate"},51:{color:[236,13,176],opacity:1,label:"Right-Putamen"},52:{color:[13,48,255],opacity:1,label:"Right-Pallidum"},53:{color:[220,216,20],opacity:1,label:"Right-Hippocampus"},54:{color:[103,255,255],opacity:1,label:"Right-Amygdala"},55:{color:[80,196,98],opacity:1,label:"Right-Insula"},56:{color:[60,58,210],opacity:1,label:"Right-Operculum"},57:{color:[255,165,0],opacity:1,label:"Right-Lesion"},58:{color:[255,165,0],opacity:1,label:"Right-Accumbens-area"},59:{color:[0,255,127],opacity:1,label:"Right-Substancia-Nigra"},60:{color:[165,42,42],opacity:1,label:"Right-VentralDC"},61:{color:[135,206,235],opacity:1,label:"Right-undetermined"},62:{color:[160,32,240],opacity:1,label:"Right-vessel"},63:{color:[0,200,221],opacity:1,label:"Right-choroid-plexus"},64:{color:[100,50,100],opacity:1,label:"Right-F3orb"},65:{color:[135,50,74],opacity:1,label:"Right-lOg"},66:{color:[122,135,50],opacity:1,label:"Right-aOg"},67:{color:[51,50,135],opacity:1,label:"Right-mOg"},68:{color:[74,155,60],opacity:1,label:"Right-pOg"},69:{color:[120,62,43],opacity:1,label:"Right-Stellate"},70:{color:[74,155,60],opacity:1,label:"Right-Porg"},71:{color:[122,135,50],opacity:1,label:"Right-Aorg"},72:{color:[120,190,150],opacity:1,label:"5th-Ventricle"},73:{color:[122,135,50],opacity:1,label:"Left-Interior"},74:{color:[122,135,50],opacity:1,label:"Right-Interior"},77:{color:[200,70,255],opacity:1,label:"WM-hypointensities"},78:{color:[255,148,10],opacity:1,label:"Left-WM-hypointensities"},79:{color:[255,148,10],opacity:1,label:"Right-WM-hypointensities"},80:{color:[164,108,226],opacity:1,label:"non-WM-hypointensities"},81:{color:[164,108,226],opacity:1,label:"Left-non-WM-hypointensities"},82:{color:[164,108,226],opacity:1,label:"Right-non-WM-hypointensities"},83:{color:[255,218,185],opacity:1,label:"Left-F1"},84:{color:[255,218,185],opacity:1,label:"Right-F1"},85:{color:[234,169,30],opacity:1,label:"Optic-Chiasm"},192:{color:[250,255,50],opacity:1,label:"Corpus_Callosum"},86:{color:[200,120,255],opacity:1,label:"Left_future_WMSA"},87:{color:[200,121,255],opacity:1,label:"Right_future_WMSA"},88:{color:[200,122,255],opacity:1,label:"future_WMSA"},96:{color:[205,10,125],opacity:1,label:"Left-Amygdala-Anterior"},97:{color:[205,10,125],opacity:1,label:"Right-Amygdala-Anterior"},98:{color:[160,32,240],opacity:1,label:"Dura"},100:{color:[124,140,178],opacity:1,label:"Left-wm-intensity-abnormality"},101:{color:[125,140,178],opacity:1,label:"Left-caudate-intensity-abnormality"},102:{color:[126,140,178],opacity:1,label:"Left-putamen-intensity-abnormality"},103:{color:[127,140,178],opacity:1,label:"Left-accumbens-intensity-abnormality"},104:{color:[124,141,178],opacity:1,label:"Left-pallidum-intensity-abnormality"},105:{color:[124,142,178],opacity:1,label:"Left-amygdala-intensity-abnormality"},106:{color:[124,143,178],opacity:1,label:"Left-hippocampus-intensity-abnormality"},107:{color:[124,144,178],opacity:1,label:"Left-thalamus-intensity-abnormality"},108:{color:[124,140,179],opacity:1,label:"Left-VDC-intensity-abnormality"},109:{color:[124,140,178],opacity:1,label:"Right-wm-intensity-abnormality"},110:{color:[125,140,178],opacity:1,label:"Right-caudate-intensity-abnormality"},111:{color:[126,140,178],opacity:1,label:"Right-putamen-intensity-abnormality"},112:{color:[127,140,178],opacity:1,label:"Right-accumbens-intensity-abnormality"},113:{color:[124,141,178],opacity:1,label:"Right-pallidum-intensity-abnormality"},114:{color:[124,142,178],opacity:1,label:"Right-amygdala-intensity-abnormality"},115:{color:[124,143,178],opacity:1,label:"Right-hippocampus-intensity-abnormality"},116:{color:[124,144,178],opacity:1,label:"Right-thalamus-intensity-abnormality"},117:{color:[124,140,179],opacity:1,label:"Right-VDC-intensity-abnormality"},118:{color:[255,20,147],opacity:1,label:"Epidermis"},119:{color:[205,179,139],opacity:1,label:"Conn-Tissue"},120:{color:[238,238,209],opacity:1,label:"SC-Fat-Muscle"},121:{color:[200,200,200],opacity:1,label:"Cranium"},122:{color:[74,255,74],opacity:1,label:"CSF-SA"},123:{color:[238,0,0],opacity:1,label:"Muscle"},124:{color:[0,0,139],opacity:1,label:"Ear"},125:{color:[173,255,47],opacity:1,label:"Adipose"},126:{color:[133,203,229],opacity:1,label:"Spinal-Cord"},127:{color:[26,237,57],opacity:1,label:"Soft-Tissue"},128:{color:[34,139,34],opacity:1,label:"Nerve"},129:{color:[30,144,255],opacity:1,label:"Bone"},130:{color:[147,19,173],opacity:1,label:"Air"},131:{color:[238,59,59],opacity:1,label:"Orbital-Fat"},132:{color:[221,39,200],opacity:1,label:"Tongue"},133:{color:[238,174,238],opacity:1,label:"Nasal-Structures"},134:{color:[255,0,0],opacity:1,label:"Globe"},135:{color:[72,61,139],opacity:1,label:"Teeth"},136:{color:[21,39,132],opacity:1,label:"Left-Caudate-Putamen"},137:{color:[21,39,132],opacity:1,label:"Right-Caudate-Putamen"},138:{color:[65,135,20],opacity:1,label:"Left-Claustrum"},139:{color:[65,135,20],opacity:1,label:"Right-Claustrum"},140:{color:[134,4,160],opacity:1,label:"Cornea"},142:{color:[221,226,68],opacity:1,label:"Diploe"},143:{color:[255,255,254],opacity:1,label:"Vitreous-Humor"},144:{color:[52,209,226],opacity:1,label:"Lens"},145:{color:[239,160,223],opacity:1,label:"Aqueous-Humor"},146:{color:[70,130,180],opacity:1,label:"Outer-Table"},147:{color:[70,130,181],opacity:1,label:"Inner-Table"},148:{color:[139,121,94],opacity:1,label:"Periosteum"},149:{color:[224,224,224],opacity:1,label:"Endosteum"},150:{color:[255,0,0],opacity:1,label:"R-C-S"},151:{color:[205,205,0],opacity:1,label:"Iris"},152:{color:[238,238,209],opacity:1,label:"SC-Adipose-Muscle"},153:{color:[139,121,94],opacity:1,label:"SC-Tissue"},154:{color:[238,59,59],opacity:1,label:"Orbital-Adipose"},155:{color:[238,59,59],opacity:1,label:"Left-IntCapsule-Ant"},156:{color:[238,59,59],opacity:1,label:"Right-IntCapsule-Ant"},157:{color:[62,10,205],opacity:1,label:"Left-IntCapsule-Pos"},158:{color:[62,10,205],opacity:1,label:"Right-IntCapsule-Pos"},159:{color:[0,118,14],opacity:1,label:"Left-Cerebral-WM-unmyelinated"},160:{color:[0,118,14],opacity:1,label:"Right-Cerebral-WM-unmyelinated"},161:{color:[220,216,21],opacity:1,label:"Left-Cerebral-WM-myelinated"},162:{color:[220,216,21],opacity:1,label:"Right-Cerebral-WM-myelinated"},163:{color:[122,186,220],opacity:1,label:"Left-Subcortical-Gray-Matter"},164:{color:[122,186,220],opacity:1,label:"Right-Subcortical-Gray-Matter"},165:{color:[120,120,120],opacity:1,label:"Skull"},166:{color:[14,48,255],opacity:1,label:"Posterior-fossa"},167:{color:[166,42,42],opacity:1,label:"Scalp"},168:{color:[121,18,134],opacity:1,label:"Hematoma"},169:{color:[236,13,127],opacity:1,label:"Left-Basal-Ganglia"},176:{color:[236,13,126],opacity:1,label:"Right-Basal-Ganglia"},170:{color:[119,159,176],opacity:1,label:"brainstem"},171:{color:[119,0,176],opacity:1,label:"DCG"},172:{color:[119,100,176],opacity:1,label:"Vermis"},173:{color:[242,104,76],opacity:1,label:"Midbrain"},174:{color:[206,195,58],opacity:1,label:"Pons"},175:{color:[119,159,176],opacity:1,label:"Medulla"},177:{color:[119,50,176],opacity:1,label:"Vermis-White-Matter"},178:{color:[142,182,0],opacity:1,label:"SCP"},179:{color:[19,100,176],opacity:1,label:"Floculus"},180:{color:[73,61,139],opacity:1,label:"Left-Cortical-Dysplasia"},181:{color:[73,62,139],opacity:1,label:"Right-Cortical-Dysplasia"},182:{color:[10,100,176],opacity:1,label:"CblumNodulus"},193:{color:[0,196,255],opacity:1,label:"Left-hippocampal_fissure"},194:{color:[255,164,164],opacity:1,label:"Left-CADG-head"},195:{color:[196,196,0],opacity:1,label:"Left-subiculum"},196:{color:[0,100,255],opacity:1,label:"Left-fimbria"},197:{color:[128,196,164],opacity:1,label:"Right-hippocampal_fissure"},198:{color:[0,126,75],opacity:1,label:"Right-CADG-head"},199:{color:[128,96,64],opacity:1,label:"Right-subiculum"},200:{color:[0,50,128],opacity:1,label:"Right-fimbria"},201:{color:[255,204,153],opacity:1,label:"alveus"},202:{color:[255,128,128],opacity:1,label:"perforant_pathway"},203:{color:[255,255,0],opacity:1,label:"parasubiculum"},204:{color:[64,0,64],opacity:1,label:"presubiculum"},205:{color:[0,0,255],opacity:1,label:"subiculum"},206:{color:[255,0,0],opacity:1,label:"CA1"},207:{color:[128,128,255],opacity:1,label:"CA2"},208:{color:[0,128,0],opacity:1,label:"CA3"},209:{color:[196,160,128],opacity:1,label:"CA4"},210:{color:[32,200,255],opacity:1,label:"GC-DG"},211:{color:[128,255,128],opacity:1,label:"HATA"},212:{color:[204,153,204],opacity:1,label:"fimbria"},213:{color:[121,17,136],opacity:1,label:"lateral_ventricle"},214:{color:[128,0,0],opacity:1,label:"molecular_layer_HP"},215:{color:[128,32,255],opacity:1,label:"hippocampal_fissure"},216:{color:[255,204,102],opacity:1,label:"entorhinal_cortex"},217:{color:[128,128,128],opacity:1,label:"molecular_layer_subiculum"},218:{color:[104,255,255],opacity:1,label:"Amygdala"},219:{color:[0,226,0],opacity:1,label:"Cerebral_White_Matter"},220:{color:[205,63,78],opacity:1,label:"Cerebral_Cortex"},221:{color:[197,58,250],opacity:1,label:"Inf_Lat_Vent"},222:{color:[33,150,250],opacity:1,label:"Perirhinal"},223:{color:[226,0,0],opacity:1,label:"Cerebral_White_Matter_Edge"},224:{color:[100,100,100],opacity:1,label:"Background"},225:{color:[197,150,250],opacity:1,label:"Ectorhinal"},226:{color:[170,170,255],opacity:1,label:"HP_tail"},250:{color:[255,0,0],opacity:1,label:"Fornix"},251:{color:[0,0,64],opacity:1,label:"CC_Posterior"},252:{color:[0,0,112],opacity:1,label:"CC_Mid_Posterior"},253:{color:[0,0,160],opacity:1,label:"CC_Central"},254:{color:[0,0,208],opacity:1,label:"CC_Mid_Anterior"},255:{color:[0,0,255],opacity:1,label:"CC_Anterior"},256:{color:[0,0,0],opacity:1,label:"Voxel-Unchanged"},257:{color:[60,60,60],opacity:1,label:"CSF-ExtraCerebral"},258:{color:[150,150,200],opacity:1,label:"Head-ExtraCerebral"},259:{color:[120,120,120],opacity:1,label:"SkullApprox"},260:{color:[119,159,176],opacity:1,label:"BoneOrAir"},261:{color:[120,18,134],opacity:1,label:"PossibleFluid"},262:{color:[119,159,176],opacity:1,label:"Sinus"},263:{color:[119,159,176],opacity:1,label:"Left-Eustachian"},264:{color:[119,159,176],opacity:1,label:"Right-Eustachian"},331:{color:[255,0,0],opacity:1,label:"Aorta"},332:{color:[255,80,0],opacity:1,label:"Left-Common-IliacA"},333:{color:[255,160,0],opacity:1,label:"Right-Common-IliacA"},334:{color:[255,255,0],opacity:1,label:"Left-External-IliacA"},335:{color:[0,255,0],opacity:1,label:"Right-External-IliacA"},336:{color:[255,0,160],opacity:1,label:"Left-Internal-IliacA"},337:{color:[255,0,255],opacity:1,label:"Right-Internal-IliacA"},338:{color:[255,50,80],opacity:1,label:"Left-Lateral-SacralA"},339:{color:[80,255,50],opacity:1,label:"Right-Lateral-SacralA"},340:{color:[160,255,50],opacity:1,label:"Left-ObturatorA"},341:{color:[160,200,255],opacity:1,label:"Right-ObturatorA"},342:{color:[0,255,160],opacity:1,label:"Left-Internal-PudendalA"},343:{color:[0,0,255],opacity:1,label:"Right-Internal-PudendalA"},344:{color:[80,50,255],opacity:1,label:"Left-UmbilicalA"},345:{color:[160,0,255],opacity:1,label:"Right-UmbilicalA"},346:{color:[255,210,0],opacity:1,label:"Left-Inf-RectalA"},347:{color:[0,160,255],opacity:1,label:"Right-Inf-RectalA"},348:{color:[255,200,80],opacity:1,label:"Left-Common-IliacV"},349:{color:[255,200,160],opacity:1,label:"Right-Common-IliacV"},350:{color:[255,80,200],opacity:1,label:"Left-External-IliacV"},351:{color:[255,160,200],opacity:1,label:"Right-External-IliacV"},352:{color:[30,255,80],opacity:1,label:"Left-Internal-IliacV"},353:{color:[80,200,255],opacity:1,label:"Right-Internal-IliacV"},354:{color:[80,255,200],opacity:1,label:"Left-ObturatorV"},355:{color:[195,255,200],opacity:1,label:"Right-ObturatorV"},356:{color:[120,200,20],opacity:1,label:"Left-Internal-PudendalV"},357:{color:[170,10,200],opacity:1,label:"Right-Internal-PudendalV"},358:{color:[20,130,180],opacity:1,label:"Pos-Lymph"},359:{color:[20,180,130],opacity:1,label:"Neg-Lymph"},400:{color:[206,62,78],opacity:1,label:"V1"},401:{color:[121,18,134],opacity:1,label:"V2"},402:{color:[199,58,250],opacity:1,label:"BA44"},403:{color:[1,148,0],opacity:1,label:"BA45"},404:{color:[221,248,164],opacity:1,label:"BA4a"},405:{color:[231,148,34],opacity:1,label:"BA4p"},406:{color:[1,118,14],opacity:1,label:"BA6"},407:{color:[120,118,14],opacity:1,label:"BA2"},408:{color:[123,186,221],opacity:1,label:"BA1_old"},409:{color:[238,13,177],opacity:1,label:"BAun2"},410:{color:[123,186,220],opacity:1,label:"BA1"},411:{color:[138,13,206],opacity:1,label:"BA2b"},412:{color:[238,130,176],opacity:1,label:"BA3a"},413:{color:[218,230,76],opacity:1,label:"BA3b"},414:{color:[38,213,176],opacity:1,label:"MT"},415:{color:[1,225,176],opacity:1,label:"AIPS_AIP_l"},416:{color:[1,225,176],opacity:1,label:"AIPS_AIP_r"},417:{color:[200,2,100],opacity:1,label:"AIPS_VIP_l"},418:{color:[200,2,100],opacity:1,label:"AIPS_VIP_r"},419:{color:[5,200,90],opacity:1,label:"IPL_PFcm_l"},420:{color:[5,200,90],opacity:1,label:"IPL_PFcm_r"},421:{color:[100,5,200],opacity:1,label:"IPL_PF_l"},422:{color:[25,255,100],opacity:1,label:"IPL_PFm_l"},423:{color:[25,255,100],opacity:1,label:"IPL_PFm_r"},424:{color:[230,7,100],opacity:1,label:"IPL_PFop_l"},425:{color:[230,7,100],opacity:1,label:"IPL_PFop_r"},426:{color:[100,5,200],opacity:1,label:"IPL_PF_r"},427:{color:[150,10,200],opacity:1,label:"IPL_PFt_l"},428:{color:[150,10,200],opacity:1,label:"IPL_PFt_r"},429:{color:[175,10,176],opacity:1,label:"IPL_PGa_l"},430:{color:[175,10,176],opacity:1,label:"IPL_PGa_r"},431:{color:[10,100,255],opacity:1,label:"IPL_PGp_l"},432:{color:[10,100,255],opacity:1,label:"IPL_PGp_r"},433:{color:[150,45,70],opacity:1,label:"Visual_V3d_l"},434:{color:[150,45,70],opacity:1,label:"Visual_V3d_r"},435:{color:[45,200,15],opacity:1,label:"Visual_V4_l"},436:{color:[45,200,15],opacity:1,label:"Visual_V4_r"},437:{color:[227,45,100],opacity:1,label:"Visual_V5_b"},438:{color:[227,45,100],opacity:1,label:"Visual_VP_l"},439:{color:[227,45,100],opacity:1,label:"Visual_VP_r"},498:{color:[143,188,143],opacity:1,label:"wmsa"},499:{color:[255,248,220],opacity:1,label:"other_wmsa"},500:{color:[17,85,136],opacity:1,label:"right_CA2_3"},501:{color:[119,187,102],opacity:1,label:"right_alveus"},502:{color:[204,68,34],opacity:1,label:"right_CA1"},503:{color:[204,0,255],opacity:1,label:"right_fimbria"},504:{color:[221,187,17],opacity:1,label:"right_presubiculum"},505:{color:[153,221,238],opacity:1,label:"right_hippocampal_fissure"},506:{color:[51,17,17],opacity:1,label:"right_CA4_DG"},507:{color:[0,119,85],opacity:1,label:"right_subiculum"},508:{color:[20,100,200],opacity:1,label:"right_fornix"},550:{color:[17,85,137],opacity:1,label:"left_CA2_3"},551:{color:[119,187,103],opacity:1,label:"left_alveus"},552:{color:[204,68,35],opacity:1,label:"left_CA1"},553:{color:[204,0,254],opacity:1,label:"left_fimbria"},554:{color:[221,187,16],opacity:1,label:"left_presubiculum"},555:{color:[153,221,239],opacity:1,label:"left_hippocampal_fissure"},556:{color:[51,17,18],opacity:1,label:"left_CA4_DG"},557:{color:[0,119,86],opacity:1,label:"left_subiculum"},558:{color:[20,100,201],opacity:1,label:"left_fornix"},600:{color:[254,254,254],opacity:1,label:"Tumor"},601:{color:[70,130,180],opacity:1,label:"Cbm_Left_I_IV"},602:{color:[245,245,245],opacity:1,label:"Cbm_Right_I_IV"},603:{color:[205,62,78],opacity:1,label:"Cbm_Left_V"},604:{color:[120,18,134],opacity:1,label:"Cbm_Right_V"},605:{color:[196,58,250],opacity:1,label:"Cbm_Left_VI"},606:{color:[0,148,0],opacity:1,label:"Cbm_Vermis_VI"},607:{color:[220,248,164],opacity:1,label:"Cbm_Right_VI"},608:{color:[230,148,34],opacity:1,label:"Cbm_Left_CrusI"},609:{color:[0,118,14],opacity:1,label:"Cbm_Vermis_CrusI"},610:{color:[0,118,14],opacity:1,label:"Cbm_Right_CrusI"},611:{color:[122,186,220],opacity:1,label:"Cbm_Left_CrusII"},612:{color:[236,13,176],opacity:1,label:"Cbm_Vermis_CrusII"},613:{color:[12,48,255],opacity:1,label:"Cbm_Right_CrusII"},614:{color:[204,182,142],opacity:1,label:"Cbm_Left_VIIb"},615:{color:[42,204,164],opacity:1,label:"Cbm_Vermis_VIIb"},616:{color:[119,159,176],opacity:1,label:"Cbm_Right_VIIb"},617:{color:[220,216,20],opacity:1,label:"Cbm_Left_VIIIa"},618:{color:[103,255,255],opacity:1,label:"Cbm_Vermis_VIIIa"},619:{color:[80,196,98],opacity:1,label:"Cbm_Right_VIIIa"},620:{color:[60,58,210],opacity:1,label:"Cbm_Left_VIIIb"},621:{color:[60,58,210],opacity:1,label:"Cbm_Vermis_VIIIb"},622:{color:[60,58,210],opacity:1,label:"Cbm_Right_VIIIb"},623:{color:[60,58,210],opacity:1,label:"Cbm_Left_IX"},624:{color:[60,60,60],opacity:1,label:"Cbm_Vermis_IX"},625:{color:[255,165,0],opacity:1,label:"Cbm_Right_IX"},626:{color:[255,165,0],opacity:1,label:"Cbm_Left_X"},627:{color:[0,255,127],opacity:1,label:"Cbm_Vermis_X"},628:{color:[165,42,42],opacity:1,label:"Cbm_Right_X"},640:{color:[204,0,0],opacity:1,label:"Cbm_Right_I_V_med"},641:{color:[255,0,0],opacity:1,label:"Cbm_Right_I_V_mid"},642:{color:[0,0,255],opacity:1,label:"Cbm_Right_VI_med"},643:{color:[30,144,255],opacity:1,label:"Cbm_Right_VI_mid"},644:{color:[100,212,237],opacity:1,label:"Cbm_Right_VI_lat"},645:{color:[218,165,32],opacity:1,label:"Cbm_Right_CrusI_med"},646:{color:[255,215,0],opacity:1,label:"Cbm_Right_CrusI_mid"},647:{color:[255,255,166],opacity:1,label:"Cbm_Right_CrusI_lat"},648:{color:[153,0,204],opacity:1,label:"Cbm_Right_CrusII_med"},649:{color:[153,141,209],opacity:1,label:"Cbm_Right_CrusII_mid"},650:{color:[204,204,255],opacity:1,label:"Cbm_Right_CrusII_lat"},651:{color:[31,212,194],opacity:1,label:"Cbm_Right_7med"},652:{color:[3,255,237],opacity:1,label:"Cbm_Right_7mid"},653:{color:[204,255,255],opacity:1,label:"Cbm_Right_7lat"},654:{color:[86,74,147],opacity:1,label:"Cbm_Right_8med"},655:{color:[114,114,190],opacity:1,label:"Cbm_Right_8mid"},656:{color:[184,178,255],opacity:1,label:"Cbm_Right_8lat"},657:{color:[126,138,37],opacity:1,label:"Cbm_Right_PUNs"},658:{color:[189,197,117],opacity:1,label:"Cbm_Right_TONs"},659:{color:[240,230,140],opacity:1,label:"Cbm_Right_FLOs"},660:{color:[204,0,0],opacity:1,label:"Cbm_Left_I_V_med"},661:{color:[255,0,0],opacity:1,label:"Cbm_Left_I_V_mid"},662:{color:[0,0,255],opacity:1,label:"Cbm_Left_VI_med"},663:{color:[30,144,255],opacity:1,label:"Cbm_Left_VI_mid"},664:{color:[100,212,237],opacity:1,label:"Cbm_Left_VI_lat"},665:{color:[218,165,32],opacity:1,label:"Cbm_Left_CrusI_med"},666:{color:[255,215,0],opacity:1,label:"Cbm_Left_CrusI_mid"},667:{color:[255,255,166],opacity:1,label:"Cbm_Left_CrusI_lat"},668:{color:[153,0,204],opacity:1,label:"Cbm_Left_CrusII_med"},669:{color:[153,141,209],opacity:1,label:"Cbm_Left_CrusII_mid"},670:{color:[204,204,255],opacity:1,label:"Cbm_Left_CrusII_lat"},671:{color:[31,212,194],opacity:1,label:"Cbm_Left_7med"},672:{color:[3,255,237],opacity:1,label:"Cbm_Left_7mid"},673:{color:[204,255,255],opacity:1,label:"Cbm_Left_7lat"},674:{color:[86,74,147],opacity:1,label:"Cbm_Left_8med"},675:{color:[114,114,190],opacity:1,label:"Cbm_Left_8mid"},676:{color:[184,178,255],opacity:1,label:"Cbm_Left_8lat"},677:{color:[126,138,37],opacity:1,label:"Cbm_Left_PUNs"},678:{color:[189,197,117],opacity:1,label:"Cbm_Left_TONs"},679:{color:[240,230,140],opacity:1,label:"Cbm_Left_FLOs"},690:{color:[122,135,50],opacity:1,label:"CbmWM_Gyri_Left"},691:{color:[122,135,50],opacity:1,label:"CbmWM_Gyri_Right"},701:{color:[120,18,134],opacity:1,label:"CSF-FSL-FAST"},702:{color:[205,62,78],opacity:1,label:"GrayMatter-FSL-FAST"},703:{color:[0,225,0],opacity:1,label:"WhiteMatter-FSL-FAST"},999:{color:[255,100,100],opacity:1,label:"SUSPICIOUS"},1e3:{color:[25,5,25],opacity:1,label:"ctx-lh-unknown"},1001:{color:[25,100,40],opacity:1,label:"ctx-lh-bankssts"},1002:{color:[125,100,160],opacity:1,label:"ctx-lh-caudalanteriorcingulate"},1003:{color:[100,25,0],opacity:1,label:"ctx-lh-caudalmiddlefrontal"},1004:{color:[120,70,50],opacity:1,label:"ctx-lh-corpuscallosum"},1005:{color:[220,20,100],opacity:1,label:"ctx-lh-cuneus"},1006:{color:[220,20,10],opacity:1,label:"ctx-lh-entorhinal"},1007:{color:[180,220,140],opacity:1,label:"ctx-lh-fusiform"},1008:{color:[220,60,220],opacity:1,label:"ctx-lh-inferiorparietal"},1009:{color:[180,40,120],opacity:1,label:"ctx-lh-inferiortemporal"},1010:{color:[140,20,140],opacity:1,label:"ctx-lh-isthmuscingulate"},1011:{color:[20,30,140],opacity:1,label:"ctx-lh-lateraloccipital"},1012:{color:[35,75,50],opacity:1,label:"ctx-lh-lateralorbitofrontal"},1013:{color:[225,140,140],opacity:1,label:"ctx-lh-lingual"},1014:{color:[200,35,75],opacity:1,label:"ctx-lh-medialorbitofrontal"},1015:{color:[160,100,50],opacity:1,label:"ctx-lh-middletemporal"},1016:{color:[20,220,60],opacity:1,label:"ctx-lh-parahippocampal"},1017:{color:[60,220,60],opacity:1,label:"ctx-lh-paracentral"},1018:{color:[220,180,140],opacity:1,label:"ctx-lh-parsopercularis"},1019:{color:[20,100,50],opacity:1,label:"ctx-lh-parsorbitalis"},1020:{color:[220,60,20],opacity:1,label:"ctx-lh-parstriangularis"},1021:{color:[120,100,60],opacity:1,label:"ctx-lh-pericalcarine"},1022:{color:[220,20,20],opacity:1,label:"ctx-lh-postcentral"},1023:{color:[220,180,220],opacity:1,label:"ctx-lh-posteriorcingulate"},1024:{color:[60,20,220],opacity:1,label:"ctx-lh-precentral"},1025:{color:[160,140,180],opacity:1,label:"ctx-lh-precuneus"},1026:{color:[80,20,140],opacity:1,label:"ctx-lh-rostralanteriorcingulate"},1027:{color:[75,50,125],opacity:1,label:"ctx-lh-rostralmiddlefrontal"},1028:{color:[20,220,160],opacity:1,label:"ctx-lh-superiorfrontal"},1029:{color:[20,180,140],opacity:1,label:"ctx-lh-superiorparietal"},1030:{color:[140,220,220],opacity:1,label:"ctx-lh-superiortemporal"},1031:{color:[80,160,20],opacity:1,label:"ctx-lh-supramarginal"},1032:{color:[100,0,100],opacity:1,label:"ctx-lh-frontalpole"},1033:{color:[70,70,70],opacity:1,label:"ctx-lh-temporalpole"},1034:{color:[150,150,200],opacity:1,label:"ctx-lh-transversetemporal"},1035:{color:[255,192,32],opacity:1,label:"ctx-lh-insula"},2e3:{color:[25,5,25],opacity:1,label:"ctx-rh-unknown"},2001:{color:[25,100,40],opacity:1,label:"ctx-rh-bankssts"},2002:{color:[125,100,160],opacity:1,label:"ctx-rh-caudalanteriorcingulate"},2003:{color:[100,25,0],opacity:1,label:"ctx-rh-caudalmiddlefrontal"},2004:{color:[120,70,50],opacity:1,label:"ctx-rh-corpuscallosum"},2005:{color:[220,20,100],opacity:1,label:"ctx-rh-cuneus"},2006:{color:[220,20,10],opacity:1,label:"ctx-rh-entorhinal"},2007:{color:[180,220,140],opacity:1,label:"ctx-rh-fusiform"},2008:{color:[220,60,220],opacity:1,label:"ctx-rh-inferiorparietal"},2009:{color:[180,40,120],opacity:1,label:"ctx-rh-inferiortemporal"},2010:{color:[140,20,140],opacity:1,label:"ctx-rh-isthmuscingulate"},2011:{color:[20,30,140],opacity:1,label:"ctx-rh-lateraloccipital"},2012:{color:[35,75,50],opacity:1,label:"ctx-rh-lateralorbitofrontal"},2013:{color:[225,140,140],opacity:1,label:"ctx-rh-lingual"},2014:{color:[200,35,75],opacity:1,label:"ctx-rh-medialorbitofrontal"},2015:{color:[160,100,50],opacity:1,label:"ctx-rh-middletemporal"},2016:{color:[20,220,60],opacity:1,label:"ctx-rh-parahippocampal"},2017:{color:[60,220,60],opacity:1,label:"ctx-rh-paracentral"},2018:{color:[220,180,140],opacity:1,label:"ctx-rh-parsopercularis"},2019:{color:[20,100,50],opacity:1,label:"ctx-rh-parsorbitalis"},2020:{color:[220,60,20],opacity:1,label:"ctx-rh-parstriangularis"},2021:{color:[120,100,60],opacity:1,label:"ctx-rh-pericalcarine"},2022:{color:[220,20,20],opacity:1,label:"ctx-rh-postcentral"},2023:{color:[220,180,220],opacity:1,label:"ctx-rh-posteriorcingulate"},2024:{color:[60,20,220],opacity:1,label:"ctx-rh-precentral"},2025:{color:[160,140,180],opacity:1,label:"ctx-rh-precuneus"},2026:{color:[80,20,140],opacity:1,label:"ctx-rh-rostralanteriorcingulate"},2027:{color:[75,50,125],opacity:1,label:"ctx-rh-rostralmiddlefrontal"},2028:{color:[20,220,160],opacity:1,label:"ctx-rh-superiorfrontal"},2029:{color:[20,180,140],opacity:1,label:"ctx-rh-superiorparietal"},2030:{color:[140,220,220],opacity:1,label:"ctx-rh-superiortemporal"},2031:{color:[80,160,20],opacity:1,label:"ctx-rh-supramarginal"},2032:{color:[100,0,100],opacity:1,label:"ctx-rh-frontalpole"},2033:{color:[70,70,70],opacity:1,label:"ctx-rh-temporalpole"},2034:{color:[150,150,200],opacity:1,label:"ctx-rh-transversetemporal"},2035:{color:[255,192,32],opacity:1,label:"ctx-rh-insula"},3e3:{color:[230,250,230],opacity:1,label:"wm-lh-unknown"},3001:{color:[230,155,215],opacity:1,label:"wm-lh-bankssts"},3002:{color:[130,155,95],opacity:1,label:"wm-lh-caudalanteriorcingulate"},3003:{color:[155,230,255],opacity:1,label:"wm-lh-caudalmiddlefrontal"},3004:{color:[135,185,205],opacity:1,label:"wm-lh-corpuscallosum"},3005:{color:[35,235,155],opacity:1,label:"wm-lh-cuneus"},3006:{color:[35,235,245],opacity:1,label:"wm-lh-entorhinal"},3007:{color:[75,35,115],opacity:1,label:"wm-lh-fusiform"},3008:{color:[35,195,35],opacity:1,label:"wm-lh-inferiorparietal"},3009:{color:[75,215,135],opacity:1,label:"wm-lh-inferiortemporal"},3010:{color:[115,235,115],opacity:1,label:"wm-lh-isthmuscingulate"},3011:{color:[235,225,115],opacity:1,label:"wm-lh-lateraloccipital"},3012:{color:[220,180,205],opacity:1,label:"wm-lh-lateralorbitofrontal"},3013:{color:[30,115,115],opacity:1,label:"wm-lh-lingual"},3014:{color:[55,220,180],opacity:1,label:"wm-lh-medialorbitofrontal"},3015:{color:[95,155,205],opacity:1,label:"wm-lh-middletemporal"},3016:{color:[235,35,195],opacity:1,label:"wm-lh-parahippocampal"},3017:{color:[195,35,195],opacity:1,label:"wm-lh-paracentral"},3018:{color:[35,75,115],opacity:1,label:"wm-lh-parsopercularis"},3019:{color:[235,155,205],opacity:1,label:"wm-lh-parsorbitalis"},3020:{color:[35,195,235],opacity:1,label:"wm-lh-parstriangularis"},3021:{color:[135,155,195],opacity:1,label:"wm-lh-pericalcarine"},3022:{color:[35,235,235],opacity:1,label:"wm-lh-postcentral"},3023:{color:[35,75,35],opacity:1,label:"wm-lh-posteriorcingulate"},3024:{color:[195,235,35],opacity:1,label:"wm-lh-precentral"},3025:{color:[95,115,75],opacity:1,label:"wm-lh-precuneus"},3026:{color:[175,235,115],opacity:1,label:"wm-lh-rostralanteriorcingulate"},3027:{color:[180,205,130],opacity:1,label:"wm-lh-rostralmiddlefrontal"},3028:{color:[235,35,95],opacity:1,label:"wm-lh-superiorfrontal"},3029:{color:[235,75,115],opacity:1,label:"wm-lh-superiorparietal"},3030:{color:[115,35,35],opacity:1,label:"wm-lh-superiortemporal"},3031:{color:[175,95,235],opacity:1,label:"wm-lh-supramarginal"},3032:{color:[155,255,155],opacity:1,label:"wm-lh-frontalpole"},3033:{color:[185,185,185],opacity:1,label:"wm-lh-temporalpole"},3034:{color:[105,105,55],opacity:1,label:"wm-lh-transversetemporal"},3035:{color:[20,220,160],opacity:1,label:"wm-lh-insula"},4e3:{color:[230,250,230],opacity:1,label:"wm-rh-unknown"},4001:{color:[230,155,215],opacity:1,label:"wm-rh-bankssts"},4002:{color:[130,155,95],opacity:1,label:"wm-rh-caudalanteriorcingulate"},4003:{color:[155,230,255],opacity:1,label:"wm-rh-caudalmiddlefrontal"},4004:{color:[135,185,205],opacity:1,label:"wm-rh-corpuscallosum"},4005:{color:[35,235,155],opacity:1,label:"wm-rh-cuneus"},4006:{color:[35,235,245],opacity:1,label:"wm-rh-entorhinal"},4007:{color:[75,35,115],opacity:1,label:"wm-rh-fusiform"},4008:{color:[35,195,35],opacity:1,label:"wm-rh-inferiorparietal"},4009:{color:[75,215,135],opacity:1,label:"wm-rh-inferiortemporal"},4010:{color:[115,235,115],opacity:1,label:"wm-rh-isthmuscingulate"},4011:{color:[235,225,115],opacity:1,label:"wm-rh-lateraloccipital"},4012:{color:[220,180,205],opacity:1,label:"wm-rh-lateralorbitofrontal"},4013:{color:[30,115,115],opacity:1,label:"wm-rh-lingual"},4014:{color:[55,220,180],opacity:1,label:"wm-rh-medialorbitofrontal"},4015:{color:[95,155,205],opacity:1,label:"wm-rh-middletemporal"},4016:{color:[235,35,195],opacity:1,label:"wm-rh-parahippocampal"},4017:{color:[195,35,195],opacity:1,label:"wm-rh-paracentral"},4018:{color:[35,75,115],opacity:1,label:"wm-rh-parsopercularis"},4019:{color:[235,155,205],opacity:1,label:"wm-rh-parsorbitalis"},4020:{color:[35,195,235],opacity:1,label:"wm-rh-parstriangularis"},4021:{color:[135,155,195],opacity:1,label:"wm-rh-pericalcarine"},4022:{color:[35,235,235],opacity:1,label:"wm-rh-postcentral"},4023:{color:[35,75,35],opacity:1,label:"wm-rh-posteriorcingulate"},4024:{color:[195,235,35],opacity:1,label:"wm-rh-precentral"},4025:{color:[95,115,75],opacity:1,label:"wm-rh-precuneus"},4026:{color:[175,235,115],opacity:1,label:"wm-rh-rostralanteriorcingulate"},4027:{color:[180,205,130],opacity:1,label:"wm-rh-rostralmiddlefrontal"},4028:{color:[235,35,95],opacity:1,label:"wm-rh-superiorfrontal"},4029:{color:[235,75,115],opacity:1,label:"wm-rh-superiorparietal"},4030:{color:[115,35,35],opacity:1,label:"wm-rh-superiortemporal"},4031:{color:[175,95,235],opacity:1,label:"wm-rh-supramarginal"},4032:{color:[155,255,155],opacity:1,label:"wm-rh-frontalpole"},4033:{color:[185,185,185],opacity:1,label:"wm-rh-temporalpole"},4034:{color:[105,105,55],opacity:1,label:"wm-rh-transversetemporal"},4035:{color:[20,220,160],opacity:1,label:"wm-rh-insula"},3201:{color:[235,35,95],opacity:1,label:"wm-lh-frontal-lobe"},3203:{color:[35,75,35],opacity:1,label:"wm-lh-cingulate-lobe"},3204:{color:[135,155,195],opacity:1,label:"wm-lh-occiptal-lobe"},3205:{color:[115,35,35],opacity:1,label:"wm-lh-temporal-lobe"},3206:{color:[35,195,35],opacity:1,label:"wm-lh-parietal-lobe"},3207:{color:[20,220,160],opacity:1,label:"wm-lh-insula-lobe"},4201:{color:[235,35,95],opacity:1,label:"wm-rh-frontal-lobe"},4203:{color:[35,75,35],opacity:1,label:"wm-rh-cingulate-lobe"},4204:{color:[135,155,195],opacity:1,label:"wm-rh-occiptal-lobe"},4205:{color:[115,35,35],opacity:1,label:"wm-rh-temporal-lobe"},4206:{color:[35,195,35],opacity:1,label:"wm-rh-parietal-lobe"},4207:{color:[20,220,160],opacity:1,label:"wm-rh-insula-lobe"},1100:{color:[0,0,0],opacity:1,label:"ctx-lh-Unknown"},1101:{color:[50,50,50],opacity:1,label:"ctx-lh-Corpus_callosum"},1102:{color:[180,20,30],opacity:1,label:"ctx-lh-G_and_S_Insula_ONLY_AVERAGE"},1103:{color:[60,25,25],opacity:1,label:"ctx-lh-G_cingulate-Isthmus"},1104:{color:[25,60,60],opacity:1,label:"ctx-lh-G_cingulate-Main_part"},1200:{color:[25,60,61],opacity:1,label:"ctx-lh-G_cingulate-caudal_ACC"},1201:{color:[25,90,60],opacity:1,label:"ctx-lh-G_cingulate-rostral_ACC"},1202:{color:[25,120,60],opacity:1,label:"ctx-lh-G_cingulate-posterior"},1205:{color:[25,150,60],opacity:1,label:"ctx-lh-S_cingulate-caudal_ACC"},1206:{color:[25,180,60],opacity:1,label:"ctx-lh-S_cingulate-rostral_ACC"},1207:{color:[25,210,60],opacity:1,label:"ctx-lh-S_cingulate-posterior"},1210:{color:[25,150,90],opacity:1,label:"ctx-lh-S_pericallosal-caudal"},1211:{color:[25,180,90],opacity:1,label:"ctx-lh-S_pericallosal-rostral"},1212:{color:[25,210,90],opacity:1,label:"ctx-lh-S_pericallosal-posterior"},1105:{color:[180,20,20],opacity:1,label:"ctx-lh-G_cuneus"},1106:{color:[220,20,100],opacity:1,label:"ctx-lh-G_frontal_inf-Opercular_part"},1107:{color:[140,60,60],opacity:1,label:"ctx-lh-G_frontal_inf-Orbital_part"},1108:{color:[180,220,140],opacity:1,label:"ctx-lh-G_frontal_inf-Triangular_part"},1109:{color:[140,100,180],opacity:1,label:"ctx-lh-G_frontal_middle"},1110:{color:[180,20,140],opacity:1,label:"ctx-lh-G_frontal_superior"},1111:{color:[140,20,140],opacity:1,label:"ctx-lh-G_frontomarginal"},1112:{color:[21,10,10],opacity:1,label:"ctx-lh-G_insular_long"},1113:{color:[225,140,140],opacity:1,label:"ctx-lh-G_insular_short"},1114:{color:[23,60,180],opacity:1,label:"ctx-lh-G_and_S_occipital_inferior"},1115:{color:[180,60,180],opacity:1,label:"ctx-lh-G_occipital_middle"},1116:{color:[20,220,60],opacity:1,label:"ctx-lh-G_occipital_superior"},1117:{color:[60,20,140],opacity:1,label:"ctx-lh-G_occipit-temp_lat-Or_fusiform"},1118:{color:[220,180,140],opacity:1,label:"ctx-lh-G_occipit-temp_med-Lingual_part"},1119:{color:[65,100,20],opacity:1,label:"ctx-lh-G_occipit-temp_med-Parahippocampal_part"},1120:{color:[220,60,20],opacity:1,label:"ctx-lh-G_orbital"},1121:{color:[60,100,60],opacity:1,label:"ctx-lh-G_paracentral"},1122:{color:[20,60,220],opacity:1,label:"ctx-lh-G_parietal_inferior-Angular_part"},1123:{color:[100,100,60],opacity:1,label:"ctx-lh-G_parietal_inferior-Supramarginal_part"},1124:{color:[220,180,220],opacity:1,label:"ctx-lh-G_parietal_superior"},1125:{color:[20,180,140],opacity:1,label:"ctx-lh-G_postcentral"},1126:{color:[60,140,180],opacity:1,label:"ctx-lh-G_precentral"},1127:{color:[25,20,140],opacity:1,label:"ctx-lh-G_precuneus"},1128:{color:[20,60,100],opacity:1,label:"ctx-lh-G_rectus"},1129:{color:[60,220,20],opacity:1,label:"ctx-lh-G_subcallosal"},1130:{color:[60,20,220],opacity:1,label:"ctx-lh-G_subcentral"},1131:{color:[220,220,100],opacity:1,label:"ctx-lh-G_temporal_inferior"},1132:{color:[180,60,60],opacity:1,label:"ctx-lh-G_temporal_middle"},1133:{color:[60,60,220],opacity:1,label:"ctx-lh-G_temp_sup-G_temp_transv_and_interm_S"},1134:{color:[220,60,220],opacity:1,label:"ctx-lh-G_temp_sup-Lateral_aspect"},1135:{color:[65,220,60],opacity:1,label:"ctx-lh-G_temp_sup-Planum_polare"},1136:{color:[25,140,20],opacity:1,label:"ctx-lh-G_temp_sup-Planum_tempolare"},1137:{color:[13,0,250],opacity:1,label:"ctx-lh-G_and_S_transverse_frontopolar"},1138:{color:[61,20,220],opacity:1,label:"ctx-lh-Lat_Fissure-ant_sgt-ramus_horizontal"},1139:{color:[61,20,60],opacity:1,label:"ctx-lh-Lat_Fissure-ant_sgt-ramus_vertical"},1140:{color:[61,60,100],opacity:1,label:"ctx-lh-Lat_Fissure-post_sgt"},1141:{color:[25,25,25],opacity:1,label:"ctx-lh-Medial_wall"},1142:{color:[140,20,60],opacity:1,label:"ctx-lh-Pole_occipital"},1143:{color:[220,180,20],opacity:1,label:"ctx-lh-Pole_temporal"},1144:{color:[63,180,180],opacity:1,label:"ctx-lh-S_calcarine"},1145:{color:[221,20,10],opacity:1,label:"ctx-lh-S_central"},1146:{color:[21,220,20],opacity:1,label:"ctx-lh-S_central_insula"},1147:{color:[183,100,20],opacity:1,label:"ctx-lh-S_cingulate-Main_part_and_Intracingulate"},1148:{color:[221,20,100],opacity:1,label:"ctx-lh-S_cingulate-Marginalis_part"},1149:{color:[221,60,140],opacity:1,label:"ctx-lh-S_circular_insula_anterior"},1150:{color:[221,20,220],opacity:1,label:"ctx-lh-S_circular_insula_inferior"},1151:{color:[61,220,220],opacity:1,label:"ctx-lh-S_circular_insula_superior"},1152:{color:[100,200,200],opacity:1,label:"ctx-lh-S_collateral_transverse_ant"},1153:{color:[10,200,200],opacity:1,label:"ctx-lh-S_collateral_transverse_post"},1154:{color:[221,220,20],opacity:1,label:"ctx-lh-S_frontal_inferior"},1155:{color:[141,20,100],opacity:1,label:"ctx-lh-S_frontal_middle"},1156:{color:[61,220,100],opacity:1,label:"ctx-lh-S_frontal_superior"},1157:{color:[21,220,60],opacity:1,label:"ctx-lh-S_frontomarginal"},1158:{color:[141,60,20],opacity:1,label:"ctx-lh-S_intermedius_primus-Jensen"},1159:{color:[143,20,220],opacity:1,label:"ctx-lh-S_intraparietal-and_Parietal_transverse"},1160:{color:[61,20,180],opacity:1,label:"ctx-lh-S_occipital_anterior"},1161:{color:[101,60,220],opacity:1,label:"ctx-lh-S_occipital_middle_and_Lunatus"},1162:{color:[21,20,140],opacity:1,label:"ctx-lh-S_occipital_superior_and_transversalis"},1163:{color:[221,140,20],opacity:1,label:"ctx-lh-S_occipito-temporal_lateral"},1164:{color:[141,100,220],opacity:1,label:"ctx-lh-S_occipito-temporal_medial_and_S_Lingual"},1165:{color:[101,20,20],opacity:1,label:"ctx-lh-S_orbital-H_shapped"},1166:{color:[221,100,20],opacity:1,label:"ctx-lh-S_orbital_lateral"},1167:{color:[181,200,20],opacity:1,label:"ctx-lh-S_orbital_medial-Or_olfactory"},1168:{color:[21,180,140],opacity:1,label:"ctx-lh-S_paracentral"},1169:{color:[101,100,180],opacity:1,label:"ctx-lh-S_parieto_occipital"},1170:{color:[181,220,20],opacity:1,label:"ctx-lh-S_pericallosal"},1171:{color:[21,140,200],opacity:1,label:"ctx-lh-S_postcentral"},1172:{color:[21,20,240],opacity:1,label:"ctx-lh-S_precentral-Inferior-part"},1173:{color:[21,20,200],opacity:1,label:"ctx-lh-S_precentral-Superior-part"},1174:{color:[61,180,60],opacity:1,label:"ctx-lh-S_subcentral_ant"},1175:{color:[61,180,250],opacity:1,label:"ctx-lh-S_subcentral_post"},1176:{color:[21,20,60],opacity:1,label:"ctx-lh-S_suborbital"},1177:{color:[101,60,60],opacity:1,label:"ctx-lh-S_subparietal"},1178:{color:[21,220,220],opacity:1,label:"ctx-lh-S_supracingulate"},1179:{color:[21,180,180],opacity:1,label:"ctx-lh-S_temporal_inferior"},1180:{color:[223,220,60],opacity:1,label:"ctx-lh-S_temporal_superior"},1181:{color:[221,60,60],opacity:1,label:"ctx-lh-S_temporal_transverse"},2100:{color:[0,0,0],opacity:1,label:"ctx-rh-Unknown"},2101:{color:[50,50,50],opacity:1,label:"ctx-rh-Corpus_callosum"},2102:{color:[180,20,30],opacity:1,label:"ctx-rh-G_and_S_Insula_ONLY_AVERAGE"},2103:{color:[60,25,25],opacity:1,label:"ctx-rh-G_cingulate-Isthmus"},2104:{color:[25,60,60],opacity:1,label:"ctx-rh-G_cingulate-Main_part"},2105:{color:[180,20,20],opacity:1,label:"ctx-rh-G_cuneus"},2106:{color:[220,20,100],opacity:1,label:"ctx-rh-G_frontal_inf-Opercular_part"},2107:{color:[140,60,60],opacity:1,label:"ctx-rh-G_frontal_inf-Orbital_part"},2108:{color:[180,220,140],opacity:1,label:"ctx-rh-G_frontal_inf-Triangular_part"},2109:{color:[140,100,180],opacity:1,label:"ctx-rh-G_frontal_middle"},2110:{color:[180,20,140],opacity:1,label:"ctx-rh-G_frontal_superior"},2111:{color:[140,20,140],opacity:1,label:"ctx-rh-G_frontomarginal"},2112:{color:[21,10,10],opacity:1,label:"ctx-rh-G_insular_long"},2113:{color:[225,140,140],opacity:1,label:"ctx-rh-G_insular_short"},2114:{color:[23,60,180],opacity:1,label:"ctx-rh-G_and_S_occipital_inferior"},2115:{color:[180,60,180],opacity:1,label:"ctx-rh-G_occipital_middle"},2116:{color:[20,220,60],opacity:1,label:"ctx-rh-G_occipital_superior"},2117:{color:[60,20,140],opacity:1,label:"ctx-rh-G_occipit-temp_lat-Or_fusiform"},2118:{color:[220,180,140],opacity:1,label:"ctx-rh-G_occipit-temp_med-Lingual_part"},2119:{color:[65,100,20],opacity:1,label:"ctx-rh-G_occipit-temp_med-Parahippocampal_part"},2120:{color:[220,60,20],opacity:1,label:"ctx-rh-G_orbital"},2121:{color:[60,100,60],opacity:1,label:"ctx-rh-G_paracentral"},2122:{color:[20,60,220],opacity:1,label:"ctx-rh-G_parietal_inferior-Angular_part"},2123:{color:[100,100,60],opacity:1,label:"ctx-rh-G_parietal_inferior-Supramarginal_part"},2124:{color:[220,180,220],opacity:1,label:"ctx-rh-G_parietal_superior"},2125:{color:[20,180,140],opacity:1,label:"ctx-rh-G_postcentral"},2126:{color:[60,140,180],opacity:1,label:"ctx-rh-G_precentral"},2127:{color:[25,20,140],opacity:1,label:"ctx-rh-G_precuneus"},2128:{color:[20,60,100],opacity:1,label:"ctx-rh-G_rectus"},2129:{color:[60,220,20],opacity:1,label:"ctx-rh-G_subcallosal"},2130:{color:[60,20,220],opacity:1,label:"ctx-rh-G_subcentral"},2131:{color:[220,220,100],opacity:1,label:"ctx-rh-G_temporal_inferior"},2132:{color:[180,60,60],opacity:1,label:"ctx-rh-G_temporal_middle"},2133:{color:[60,60,220],opacity:1,label:"ctx-rh-G_temp_sup-G_temp_transv_and_interm_S"},2134:{color:[220,60,220],opacity:1,label:"ctx-rh-G_temp_sup-Lateral_aspect"},2135:{color:[65,220,60],opacity:1,label:"ctx-rh-G_temp_sup-Planum_polare"},2136:{color:[25,140,20],opacity:1,label:"ctx-rh-G_temp_sup-Planum_tempolare"},2137:{color:[13,0,250],opacity:1,label:"ctx-rh-G_and_S_transverse_frontopolar"},2138:{color:[61,20,220],opacity:1,label:"ctx-rh-Lat_Fissure-ant_sgt-ramus_horizontal"},2139:{color:[61,20,60],opacity:1,label:"ctx-rh-Lat_Fissure-ant_sgt-ramus_vertical"},2140:{color:[61,60,100],opacity:1,label:"ctx-rh-Lat_Fissure-post_sgt"},2141:{color:[25,25,25],opacity:1,label:"ctx-rh-Medial_wall"},2142:{color:[140,20,60],opacity:1,label:"ctx-rh-Pole_occipital"},2143:{color:[220,180,20],opacity:1,label:"ctx-rh-Pole_temporal"},2144:{color:[63,180,180],opacity:1,label:"ctx-rh-S_calcarine"},2145:{color:[221,20,10],opacity:1,label:"ctx-rh-S_central"},2146:{color:[21,220,20],opacity:1,label:"ctx-rh-S_central_insula"},2147:{color:[183,100,20],opacity:1,label:"ctx-rh-S_cingulate-Main_part_and_Intracingulate"},2148:{color:[221,20,100],opacity:1,label:"ctx-rh-S_cingulate-Marginalis_part"},2149:{color:[221,60,140],opacity:1,label:"ctx-rh-S_circular_insula_anterior"},2150:{color:[221,20,220],opacity:1,label:"ctx-rh-S_circular_insula_inferior"},2151:{color:[61,220,220],opacity:1,label:"ctx-rh-S_circular_insula_superior"},2152:{color:[100,200,200],opacity:1,label:"ctx-rh-S_collateral_transverse_ant"},2153:{color:[10,200,200],opacity:1,label:"ctx-rh-S_collateral_transverse_post"},2154:{color:[221,220,20],opacity:1,label:"ctx-rh-S_frontal_inferior"},2155:{color:[141,20,100],opacity:1,label:"ctx-rh-S_frontal_middle"},2156:{color:[61,220,100],opacity:1,label:"ctx-rh-S_frontal_superior"},2157:{color:[21,220,60],opacity:1,label:"ctx-rh-S_frontomarginal"},2158:{color:[141,60,20],opacity:1,label:"ctx-rh-S_intermedius_primus-Jensen"},2159:{color:[143,20,220],opacity:1,label:"ctx-rh-S_intraparietal-and_Parietal_transverse"},2160:{color:[61,20,180],opacity:1,label:"ctx-rh-S_occipital_anterior"},2161:{color:[101,60,220],opacity:1,label:"ctx-rh-S_occipital_middle_and_Lunatus"},2162:{color:[21,20,140],opacity:1,label:"ctx-rh-S_occipital_superior_and_transversalis"},2163:{color:[221,140,20],opacity:1,label:"ctx-rh-S_occipito-temporal_lateral"},2164:{color:[141,100,220],opacity:1,label:"ctx-rh-S_occipito-temporal_medial_and_S_Lingual"},2165:{color:[101,20,20],opacity:1,label:"ctx-rh-S_orbital-H_shapped"},2166:{color:[221,100,20],opacity:1,label:"ctx-rh-S_orbital_lateral"},2167:{color:[181,200,20],opacity:1,label:"ctx-rh-S_orbital_medial-Or_olfactory"},2168:{color:[21,180,140],opacity:1,label:"ctx-rh-S_paracentral"},2169:{color:[101,100,180],opacity:1,label:"ctx-rh-S_parieto_occipital"},2170:{color:[181,220,20],opacity:1,label:"ctx-rh-S_pericallosal"},2171:{color:[21,140,200],opacity:1,label:"ctx-rh-S_postcentral"},2172:{color:[21,20,240],opacity:1,label:"ctx-rh-S_precentral-Inferior-part"},2173:{color:[21,20,200],opacity:1,label:"ctx-rh-S_precentral-Superior-part"},2174:{color:[61,180,60],opacity:1,label:"ctx-rh-S_subcentral_ant"},2175:{color:[61,180,250],opacity:1,label:"ctx-rh-S_subcentral_post"},2176:{color:[21,20,60],opacity:1,label:"ctx-rh-S_suborbital"},2177:{color:[101,60,60],opacity:1,label:"ctx-rh-S_subparietal"},2178:{color:[21,220,220],opacity:1,label:"ctx-rh-S_supracingulate"},2179:{color:[21,180,180],opacity:1,label:"ctx-rh-S_temporal_inferior"},2180:{color:[223,220,60],opacity:1,label:"ctx-rh-S_temporal_superior"},2181:{color:[221,60,60],opacity:1,label:"ctx-rh-S_temporal_transverse"},2200:{color:[25,60,61],opacity:1,label:"ctx-rh-G_cingulate-caudal_ACC"},2201:{color:[25,90,60],opacity:1,label:"ctx-rh-G_cingulate-rostral_ACC"},2202:{color:[25,120,60],opacity:1,label:"ctx-rh-G_cingulate-posterior"},2205:{color:[25,150,60],opacity:1,label:"ctx-rh-S_cingulate-caudal_ACC"},2206:{color:[25,180,60],opacity:1,label:"ctx-rh-S_cingulate-rostral_ACC"},2207:{color:[25,210,60],opacity:1,label:"ctx-rh-S_cingulate-posterior"},2210:{color:[25,150,90],opacity:1,label:"ctx-rh-S_pericallosal-caudal"},2211:{color:[25,180,90],opacity:1,label:"ctx-rh-S_pericallosal-rostral"},2212:{color:[25,210,90],opacity:1,label:"ctx-rh-S_pericallosal-posterior"},3100:{color:[0,0,0],opacity:1,label:"wm-lh-Unknown"},3101:{color:[50,50,50],opacity:1,label:"wm-lh-Corpus_callosum"},3102:{color:[180,20,30],opacity:1,label:"wm-lh-G_and_S_Insula_ONLY_AVERAGE"},3103:{color:[60,25,25],opacity:1,label:"wm-lh-G_cingulate-Isthmus"},3104:{color:[25,60,60],opacity:1,label:"wm-lh-G_cingulate-Main_part"},3105:{color:[180,20,20],opacity:1,label:"wm-lh-G_cuneus"},3106:{color:[220,20,100],opacity:1,label:"wm-lh-G_frontal_inf-Opercular_part"},3107:{color:[140,60,60],opacity:1,label:"wm-lh-G_frontal_inf-Orbital_part"},3108:{color:[180,220,140],opacity:1,label:"wm-lh-G_frontal_inf-Triangular_part"},3109:{color:[140,100,180],opacity:1,label:"wm-lh-G_frontal_middle"},3110:{color:[180,20,140],opacity:1,label:"wm-lh-G_frontal_superior"},3111:{color:[140,20,140],opacity:1,label:"wm-lh-G_frontomarginal"},3112:{color:[21,10,10],opacity:1,label:"wm-lh-G_insular_long"},3113:{color:[225,140,140],opacity:1,label:"wm-lh-G_insular_short"},3114:{color:[23,60,180],opacity:1,label:"wm-lh-G_and_S_occipital_inferior"},3115:{color:[180,60,180],opacity:1,label:"wm-lh-G_occipital_middle"},3116:{color:[20,220,60],opacity:1,label:"wm-lh-G_occipital_superior"},3117:{color:[60,20,140],opacity:1,label:"wm-lh-G_occipit-temp_lat-Or_fusiform"},3118:{color:[220,180,140],opacity:1,label:"wm-lh-G_occipit-temp_med-Lingual_part"},3119:{color:[65,100,20],opacity:1,label:"wm-lh-G_occipit-temp_med-Parahippocampal_part"},3120:{color:[220,60,20],opacity:1,label:"wm-lh-G_orbital"},3121:{color:[60,100,60],opacity:1,label:"wm-lh-G_paracentral"},3122:{color:[20,60,220],opacity:1,label:"wm-lh-G_parietal_inferior-Angular_part"},3123:{color:[100,100,60],opacity:1,label:"wm-lh-G_parietal_inferior-Supramarginal_part"},3124:{color:[220,180,220],opacity:1,label:"wm-lh-G_parietal_superior"},3125:{color:[20,180,140],opacity:1,label:"wm-lh-G_postcentral"},3126:{color:[60,140,180],opacity:1,label:"wm-lh-G_precentral"},3127:{color:[25,20,140],opacity:1,label:"wm-lh-G_precuneus"},3128:{color:[20,60,100],opacity:1,label:"wm-lh-G_rectus"},3129:{color:[60,220,20],opacity:1,label:"wm-lh-G_subcallosal"},3130:{color:[60,20,220],opacity:1,label:"wm-lh-G_subcentral"},3131:{color:[220,220,100],opacity:1,label:"wm-lh-G_temporal_inferior"},3132:{color:[180,60,60],opacity:1,label:"wm-lh-G_temporal_middle"},3133:{color:[60,60,220],opacity:1,label:"wm-lh-G_temp_sup-G_temp_transv_and_interm_S"},3134:{color:[220,60,220],opacity:1,label:"wm-lh-G_temp_sup-Lateral_aspect"},3135:{color:[65,220,60],opacity:1,label:"wm-lh-G_temp_sup-Planum_polare"},3136:{color:[25,140,20],opacity:1,label:"wm-lh-G_temp_sup-Planum_tempolare"},3137:{color:[13,0,250],opacity:1,label:"wm-lh-G_and_S_transverse_frontopolar"},3138:{color:[61,20,220],opacity:1,label:"wm-lh-Lat_Fissure-ant_sgt-ramus_horizontal"},3139:{color:[61,20,60],opacity:1,label:"wm-lh-Lat_Fissure-ant_sgt-ramus_vertical"},3140:{color:[61,60,100],opacity:1,label:"wm-lh-Lat_Fissure-post_sgt"},3141:{color:[25,25,25],opacity:1,label:"wm-lh-Medial_wall"},3142:{color:[140,20,60],opacity:1,label:"wm-lh-Pole_occipital"},3143:{color:[220,180,20],opacity:1,label:"wm-lh-Pole_temporal"},3144:{color:[63,180,180],opacity:1,label:"wm-lh-S_calcarine"},3145:{color:[221,20,10],opacity:1,label:"wm-lh-S_central"},3146:{color:[21,220,20],opacity:1,label:"wm-lh-S_central_insula"},3147:{color:[183,100,20],opacity:1,label:"wm-lh-S_cingulate-Main_part_and_Intracingulate"},3148:{color:[221,20,100],opacity:1,label:"wm-lh-S_cingulate-Marginalis_part"},3149:{color:[221,60,140],opacity:1,label:"wm-lh-S_circular_insula_anterior"},3150:{color:[221,20,220],opacity:1,label:"wm-lh-S_circular_insula_inferior"},3151:{color:[61,220,220],opacity:1,label:"wm-lh-S_circular_insula_superior"},3152:{color:[100,200,200],opacity:1,label:"wm-lh-S_collateral_transverse_ant"},3153:{color:[10,200,200],opacity:1,label:"wm-lh-S_collateral_transverse_post"},3154:{color:[221,220,20],opacity:1,label:"wm-lh-S_frontal_inferior"},3155:{color:[141,20,100],opacity:1,label:"wm-lh-S_frontal_middle"},3156:{color:[61,220,100],opacity:1,label:"wm-lh-S_frontal_superior"},3157:{color:[21,220,60],opacity:1,label:"wm-lh-S_frontomarginal"},3158:{color:[141,60,20],opacity:1,label:"wm-lh-S_intermedius_primus-Jensen"},3159:{color:[143,20,220],opacity:1,label:"wm-lh-S_intraparietal-and_Parietal_transverse"},3160:{color:[61,20,180],opacity:1,label:"wm-lh-S_occipital_anterior"},3161:{color:[101,60,220],opacity:1,label:"wm-lh-S_occipital_middle_and_Lunatus"},3162:{color:[21,20,140],opacity:1,label:"wm-lh-S_occipital_superior_and_transversalis"},3163:{color:[221,140,20],opacity:1,label:"wm-lh-S_occipito-temporal_lateral"},3164:{color:[141,100,220],opacity:1,label:"wm-lh-S_occipito-temporal_medial_and_S_Lingual"},3165:{color:[101,20,20],opacity:1,label:"wm-lh-S_orbital-H_shapped"},3166:{color:[221,100,20],opacity:1,label:"wm-lh-S_orbital_lateral"},3167:{color:[181,200,20],opacity:1,label:"wm-lh-S_orbital_medial-Or_olfactory"},3168:{color:[21,180,140],opacity:1,label:"wm-lh-S_paracentral"},3169:{color:[101,100,180],opacity:1,label:"wm-lh-S_parieto_occipital"},3170:{color:[181,220,20],opacity:1,label:"wm-lh-S_pericallosal"},3171:{color:[21,140,200],opacity:1,label:"wm-lh-S_postcentral"},3172:{color:[21,20,240],opacity:1,label:"wm-lh-S_precentral-Inferior-part"},3173:{color:[21,20,200],opacity:1,label:"wm-lh-S_precentral-Superior-part"},3174:{color:[61,180,60],opacity:1,label:"wm-lh-S_subcentral_ant"},3175:{color:[61,180,250],opacity:1,label:"wm-lh-S_subcentral_post"},3176:{color:[21,20,60],opacity:1,label:"wm-lh-S_suborbital"},3177:{color:[101,60,60],opacity:1,label:"wm-lh-S_subparietal"},3178:{color:[21,220,220],opacity:1,label:"wm-lh-S_supracingulate"},3179:{color:[21,180,180],opacity:1,label:"wm-lh-S_temporal_inferior"},3180:{color:[223,220,60],opacity:1,label:"wm-lh-S_temporal_superior"},3181:{color:[221,60,60],opacity:1,label:"wm-lh-S_temporal_transverse"},4100:{color:[0,0,0],opacity:1,label:"wm-rh-Unknown"},4101:{color:[50,50,50],opacity:1,label:"wm-rh-Corpus_callosum"},4102:{color:[180,20,30],opacity:1,label:"wm-rh-G_and_S_Insula_ONLY_AVERAGE"},4103:{color:[60,25,25],opacity:1,label:"wm-rh-G_cingulate-Isthmus"},4104:{color:[25,60,60],opacity:1,label:"wm-rh-G_cingulate-Main_part"},4105:{color:[180,20,20],opacity:1,label:"wm-rh-G_cuneus"},4106:{color:[220,20,100],opacity:1,label:"wm-rh-G_frontal_inf-Opercular_part"},4107:{color:[140,60,60],opacity:1,label:"wm-rh-G_frontal_inf-Orbital_part"},4108:{color:[180,220,140],opacity:1,label:"wm-rh-G_frontal_inf-Triangular_part"},4109:{color:[140,100,180],opacity:1,label:"wm-rh-G_frontal_middle"},4110:{color:[180,20,140],opacity:1,label:"wm-rh-G_frontal_superior"},4111:{color:[140,20,140],opacity:1,label:"wm-rh-G_frontomarginal"},4112:{color:[21,10,10],opacity:1,label:"wm-rh-G_insular_long"},4113:{color:[225,140,140],opacity:1,label:"wm-rh-G_insular_short"},4114:{color:[23,60,180],opacity:1,label:"wm-rh-G_and_S_occipital_inferior"},4115:{color:[180,60,180],opacity:1,label:"wm-rh-G_occipital_middle"},4116:{color:[20,220,60],opacity:1,label:"wm-rh-G_occipital_superior"},4117:{color:[60,20,140],opacity:1,label:"wm-rh-G_occipit-temp_lat-Or_fusiform"},4118:{color:[220,180,140],opacity:1,label:"wm-rh-G_occipit-temp_med-Lingual_part"},4119:{color:[65,100,20],opacity:1,label:"wm-rh-G_occipit-temp_med-Parahippocampal_part"},4120:{color:[220,60,20],opacity:1,label:"wm-rh-G_orbital"},4121:{color:[60,100,60],opacity:1,label:"wm-rh-G_paracentral"},4122:{color:[20,60,220],opacity:1,label:"wm-rh-G_parietal_inferior-Angular_part"},4123:{color:[100,100,60],opacity:1,label:"wm-rh-G_parietal_inferior-Supramarginal_part"},4124:{color:[220,180,220],opacity:1,label:"wm-rh-G_parietal_superior"},4125:{color:[20,180,140],opacity:1,label:"wm-rh-G_postcentral"},4126:{color:[60,140,180],opacity:1,label:"wm-rh-G_precentral"},4127:{color:[25,20,140],opacity:1,label:"wm-rh-G_precuneus"},4128:{color:[20,60,100],opacity:1,label:"wm-rh-G_rectus"},4129:{color:[60,220,20],opacity:1,label:"wm-rh-G_subcallosal"},4130:{color:[60,20,220],opacity:1,label:"wm-rh-G_subcentral"},4131:{color:[220,220,100],opacity:1,label:"wm-rh-G_temporal_inferior"},4132:{color:[180,60,60],opacity:1,label:"wm-rh-G_temporal_middle"},4133:{color:[60,60,220],opacity:1,label:"wm-rh-G_temp_sup-G_temp_transv_and_interm_S"},4134:{color:[220,60,220],opacity:1,label:"wm-rh-G_temp_sup-Lateral_aspect"},4135:{color:[65,220,60],opacity:1,label:"wm-rh-G_temp_sup-Planum_polare"},4136:{color:[25,140,20],opacity:1,label:"wm-rh-G_temp_sup-Planum_tempolare"},4137:{color:[13,0,250],opacity:1,label:"wm-rh-G_and_S_transverse_frontopolar"},4138:{color:[61,20,220],opacity:1,label:"wm-rh-Lat_Fissure-ant_sgt-ramus_horizontal"},4139:{color:[61,20,60],opacity:1,label:"wm-rh-Lat_Fissure-ant_sgt-ramus_vertical"},4140:{color:[61,60,100],opacity:1,label:"wm-rh-Lat_Fissure-post_sgt"},4141:{color:[25,25,25],opacity:1,label:"wm-rh-Medial_wall"},4142:{color:[140,20,60],opacity:1,label:"wm-rh-Pole_occipital"},4143:{color:[220,180,20],opacity:1,label:"wm-rh-Pole_temporal"},4144:{color:[63,180,180],opacity:1,label:"wm-rh-S_calcarine"},4145:{color:[221,20,10],opacity:1,label:"wm-rh-S_central"},4146:{color:[21,220,20],opacity:1,label:"wm-rh-S_central_insula"},4147:{color:[183,100,20],opacity:1,label:"wm-rh-S_cingulate-Main_part_and_Intracingulate"},4148:{color:[221,20,100],opacity:1,label:"wm-rh-S_cingulate-Marginalis_part"},4149:{color:[221,60,140],opacity:1,label:"wm-rh-S_circular_insula_anterior"},4150:{color:[221,20,220],opacity:1,label:"wm-rh-S_circular_insula_inferior"},4151:{color:[61,220,220],opacity:1,label:"wm-rh-S_circular_insula_superior"},4152:{color:[100,200,200],opacity:1,label:"wm-rh-S_collateral_transverse_ant"},4153:{color:[10,200,200],opacity:1,label:"wm-rh-S_collateral_transverse_post"},4154:{color:[221,220,20],opacity:1,label:"wm-rh-S_frontal_inferior"},4155:{color:[141,20,100],opacity:1,label:"wm-rh-S_frontal_middle"},4156:{color:[61,220,100],opacity:1,label:"wm-rh-S_frontal_superior"},4157:{color:[21,220,60],opacity:1,label:"wm-rh-S_frontomarginal"},4158:{color:[141,60,20],opacity:1,label:"wm-rh-S_intermedius_primus-Jensen"},4159:{color:[143,20,220],opacity:1,label:"wm-rh-S_intraparietal-and_Parietal_transverse"},4160:{color:[61,20,180],opacity:1,label:"wm-rh-S_occipital_anterior"},4161:{color:[101,60,220],opacity:1,label:"wm-rh-S_occipital_middle_and_Lunatus"},4162:{color:[21,20,140],opacity:1,label:"wm-rh-S_occipital_superior_and_transversalis"},4163:{color:[221,140,20],opacity:1,label:"wm-rh-S_occipito-temporal_lateral"},4164:{color:[141,100,220],opacity:1,label:"wm-rh-S_occipito-temporal_medial_and_S_Lingual"},4165:{color:[101,20,20],opacity:1,label:"wm-rh-S_orbital-H_shapped"},4166:{color:[221,100,20],opacity:1,label:"wm-rh-S_orbital_lateral"},4167:{color:[181,200,20],opacity:1,label:"wm-rh-S_orbital_medial-Or_olfactory"},4168:{color:[21,180,140],opacity:1,label:"wm-rh-S_paracentral"},4169:{color:[101,100,180],opacity:1,label:"wm-rh-S_parieto_occipital"},4170:{color:[181,220,20],opacity:1,label:"wm-rh-S_pericallosal"},4171:{color:[21,140,200],opacity:1,label:"wm-rh-S_postcentral"},4172:{color:[21,20,240],opacity:1,label:"wm-rh-S_precentral-Inferior-part"},4173:{color:[21,20,200],opacity:1,label:"wm-rh-S_precentral-Superior-part"},4174:{color:[61,180,60],opacity:1,label:"wm-rh-S_subcentral_ant"},4175:{color:[61,180,250],opacity:1,label:"wm-rh-S_subcentral_post"},4176:{color:[21,20,60],opacity:1,label:"wm-rh-S_suborbital"},4177:{color:[101,60,60],opacity:1,label:"wm-rh-S_subparietal"},4178:{color:[21,220,220],opacity:1,label:"wm-rh-S_supracingulate"},4179:{color:[21,180,180],opacity:1,label:"wm-rh-S_temporal_inferior"},4180:{color:[223,220,60],opacity:1,label:"wm-rh-S_temporal_superior"},4181:{color:[221,60,60],opacity:1,label:"wm-rh-S_temporal_transverse"},5001:{color:[20,30,40],opacity:1,label:"Left-UnsegmentedWhiteMatter"},5002:{color:[20,30,40],opacity:1,label:"Right-UnsegmentedWhiteMatter"},5100:{color:[204,102,102],opacity:1,label:"fmajor"},5101:{color:[204,102,102],opacity:1,label:"fminor"},5102:{color:[255,255,102],opacity:1,label:"lh.atr"},5103:{color:[153,204,0],opacity:1,label:"lh.cab"},5104:{color:[0,153,153],opacity:1,label:"lh.ccg"},5105:{color:[204,153,255],opacity:1,label:"lh.cst"},5106:{color:[255,153,51],opacity:1,label:"lh.ilf"},5107:{color:[204,204,204],opacity:1,label:"lh.slfp"},5108:{color:[153,255,255],opacity:1,label:"lh.slft"},5109:{color:[102,153,255],opacity:1,label:"lh.unc"},5110:{color:[255,255,102],opacity:1,label:"rh.atr"},5111:{color:[153,204,0],opacity:1,label:"rh.cab"},5112:{color:[0,153,153],opacity:1,label:"rh.ccg"},5113:{color:[204,153,255],opacity:1,label:"rh.cst"},5114:{color:[255,153,51],opacity:1,label:"rh.ilf"},5115:{color:[204,204,204],opacity:1,label:"rh.slfp"},5116:{color:[153,255,255],opacity:1,label:"rh.slft"},5117:{color:[102,153,255],opacity:1,label:"rh.unc"},5200:{color:[204,102,102],opacity:1,label:"CC-ForcepsMajor"},5201:{color:[204,102,102],opacity:1,label:"CC-ForcepsMinor"},5202:{color:[255,255,102],opacity:1,label:"LAntThalRadiation"},5203:{color:[153,204,0],opacity:1,label:"LCingulumAngBundle"},5204:{color:[0,153,153],opacity:1,label:"LCingulumCingGyrus"},5205:{color:[204,153,255],opacity:1,label:"LCorticospinalTract"},5206:{color:[255,153,51],opacity:1,label:"LInfLongFas"},5207:{color:[204,204,204],opacity:1,label:"LSupLongFasParietal"},5208:{color:[153,255,255],opacity:1,label:"LSupLongFasTemporal"},5209:{color:[102,153,255],opacity:1,label:"LUncinateFas"},5210:{color:[255,255,102],opacity:1,label:"RAntThalRadiation"},5211:{color:[153,204,0],opacity:1,label:"RCingulumAngBundle"},5212:{color:[0,153,153],opacity:1,label:"RCingulumCingGyrus"},5213:{color:[204,153,255],opacity:1,label:"RCorticospinalTract"},5214:{color:[255,153,51],opacity:1,label:"RInfLongFas"},5215:{color:[204,204,204],opacity:1,label:"RSupLongFasParietal"},5216:{color:[153,255,255],opacity:1,label:"RSupLongFasTemporal"},5217:{color:[102,153,255],opacity:1,label:"RUncinateFas"},6e3:{color:[0,255,0],opacity:1,label:"CST-orig"},6001:{color:[255,255,0],opacity:1,label:"CST-hammer"},6002:{color:[0,255,255],opacity:1,label:"CST-CVS"},6003:{color:[0,0,255],opacity:1,label:"CST-flirt"},6010:{color:[236,16,231],opacity:1,label:"Left-SLF1"},6020:{color:[237,18,232],opacity:1,label:"Right-SLF1"},6030:{color:[236,13,227],opacity:1,label:"Left-SLF3"},6040:{color:[236,17,228],opacity:1,label:"Right-SLF3"},6050:{color:[1,255,1],opacity:1,label:"Left-CST"},6060:{color:[2,255,1],opacity:1,label:"Right-CST"},6070:{color:[236,14,230],opacity:1,label:"Left-SLF2"},6080:{color:[237,14,230],opacity:1,label:"Right-SLF2"},7001:{color:[72,132,181],opacity:1,label:"Lateral-nucleus"},7002:{color:[243,243,243],opacity:1,label:"Basolateral-nucleus"},7003:{color:[207,63,79],opacity:1,label:"Basal-nucleus"},7004:{color:[121,20,135],opacity:1,label:"Centromedial-nucleus"},7005:{color:[197,60,248],opacity:1,label:"Central-nucleus"},7006:{color:[2,149,2],opacity:1,label:"Medial-nucleus"},7007:{color:[221,249,166],opacity:1,label:"Cortical-nucleus"},7008:{color:[232,146,35],opacity:1,label:"Accessory-Basal-nucleus"},7009:{color:[20,60,120],opacity:1,label:"Corticoamygdaloid-transitio"},7010:{color:[250,250,0],opacity:1,label:"Anterior-amygdaloid-area-AAA"},7011:{color:[122,187,222],opacity:1,label:"Fusion-amygdala-HP-FAH"},7012:{color:[237,12,177],opacity:1,label:"Hippocampal-amygdala-transition-HATA"},7013:{color:[10,49,255],opacity:1,label:"Endopiriform-nucleus"},7014:{color:[205,184,144],opacity:1,label:"Lateral-nucleus-olfactory-tract"},7015:{color:[45,205,165],opacity:1,label:"Paralaminar-nucleus"},7016:{color:[117,160,175],opacity:1,label:"Intercalated-nucleus"},7017:{color:[221,217,21],opacity:1,label:"Prepiriform-cortex"},7018:{color:[20,60,120],opacity:1,label:"Periamygdaloid-cortex"},7019:{color:[141,21,100],opacity:1,label:"Envelope-Amygdala"},7020:{color:[225,140,141],opacity:1,label:"Extranuclear-Amydala"},7100:{color:[42,201,168],opacity:1,label:"Brainstem-inferior-colliculus"},7101:{color:[168,104,162],opacity:1,label:"Brainstem-cochlear-nucleus"},8001:{color:[74,130,181],opacity:1,label:"Thalamus-Anterior"},8002:{color:[242,241,240],opacity:1,label:"Thalamus-Ventral-anterior"},8003:{color:[206,65,78],opacity:1,label:"Thalamus-Lateral-dorsal"},8004:{color:[120,21,133],opacity:1,label:"Thalamus-Lateral-posterior"},8005:{color:[195,61,246],opacity:1,label:"Thalamus-Ventral-lateral"},8006:{color:[3,147,6],opacity:1,label:"Thalamus-Ventral-posterior-medial"},8007:{color:[220,251,163],opacity:1,label:"Thalamus-Ventral-posterior-lateral"},8008:{color:[232,146,33],opacity:1,label:"Thalamus-intralaminar"},8009:{color:[4,114,14],opacity:1,label:"Thalamus-centromedian"},8010:{color:[121,184,220],opacity:1,label:"Thalamus-mediodorsal"},8011:{color:[235,11,175],opacity:1,label:"Thalamus-medial"},8012:{color:[12,46,250],opacity:1,label:"Thalamus-pulvinar"},8013:{color:[203,182,143],opacity:1,label:"Thalamus-lateral-geniculate"},8014:{color:[42,204,167],opacity:1,label:"Thalamus-medial-geniculate"},9e3:{color:[50,100,30],opacity:1,label:"ctx-lh-prefrontal"},9001:{color:[30,100,45],opacity:1,label:"ctx-lh-primary-motor"},9002:{color:[130,100,165],opacity:1,label:"ctx-lh-premotor"},9003:{color:[105,25,5],opacity:1,label:"ctx-lh-temporal"},9004:{color:[125,70,55],opacity:1,label:"ctx-lh-posterior-parietal"},9005:{color:[225,20,105],opacity:1,label:"ctx-lh-prim-sec-somatosensory"},9006:{color:[225,20,15],opacity:1,label:"ctx-lh-occipital"},9500:{color:[50,200,30],opacity:1,label:"ctx-rh-prefrontal"},9501:{color:[30,150,45],opacity:1,label:"ctx-rh-primary-motor"},9502:{color:[130,150,165],opacity:1,label:"ctx-rh-premotor"},9503:{color:[105,75,5],opacity:1,label:"ctx-rh-temporal"},9504:{color:[125,120,55],opacity:1,label:"ctx-rh-posterior-parietal"},9505:{color:[225,70,105],opacity:1,label:"ctx-rh-prim-sec-somatosensory"},9506:{color:[225,70,15],opacity:1,label:"ctx-rh-occipital"},11100:{color:[0,0,0],opacity:1,label:"ctx_lh_Unknown"},11101:{color:[23,220,60],opacity:1,label:"ctx_lh_G_and_S_frontomargin"},11102:{color:[23,60,180],opacity:1,label:"ctx_lh_G_and_S_occipital_inf"},11103:{color:[63,100,60],opacity:1,label:"ctx_lh_G_and_S_paracentral"},11104:{color:[63,20,220],opacity:1,label:"ctx_lh_G_and_S_subcentral"},11105:{color:[13,0,250],opacity:1,label:"ctx_lh_G_and_S_transv_frontopol"},11106:{color:[26,60,0],opacity:1,label:"ctx_lh_G_and_S_cingul-Ant"},11107:{color:[26,60,75],opacity:1,label:"ctx_lh_G_and_S_cingul-Mid-Ant"},11108:{color:[26,60,150],opacity:1,label:"ctx_lh_G_and_S_cingul-Mid-Post"},11109:{color:[25,60,250],opacity:1,label:"ctx_lh_G_cingul-Post-dorsal"},11110:{color:[60,25,25],opacity:1,label:"ctx_lh_G_cingul-Post-ventral"},11111:{color:[180,20,20],opacity:1,label:"ctx_lh_G_cuneus"},11112:{color:[220,20,100],opacity:1,label:"ctx_lh_G_front_inf-Opercular"},11113:{color:[140,60,60],opacity:1,label:"ctx_lh_G_front_inf-Orbital"},11114:{color:[180,220,140],opacity:1,label:"ctx_lh_G_front_inf-Triangul"},11115:{color:[140,100,180],opacity:1,label:"ctx_lh_G_front_middle"},11116:{color:[180,20,140],opacity:1,label:"ctx_lh_G_front_sup"},11117:{color:[23,10,10],opacity:1,label:"ctx_lh_G_Ins_lg_and_S_cent_ins"},11118:{color:[225,140,140],opacity:1,label:"ctx_lh_G_insular_short"},11119:{color:[180,60,180],opacity:1,label:"ctx_lh_G_occipital_middle"},11120:{color:[20,220,60],opacity:1,label:"ctx_lh_G_occipital_sup"},11121:{color:[60,20,140],opacity:1,label:"ctx_lh_G_oc-temp_lat-fusifor"},11122:{color:[220,180,140],opacity:1,label:"ctx_lh_G_oc-temp_med-Lingual"},11123:{color:[65,100,20],opacity:1,label:"ctx_lh_G_oc-temp_med-Parahip"},11124:{color:[220,60,20],opacity:1,label:"ctx_lh_G_orbital"},11125:{color:[20,60,220],opacity:1,label:"ctx_lh_G_pariet_inf-Angular"},11126:{color:[100,100,60],opacity:1,label:"ctx_lh_G_pariet_inf-Supramar"},11127:{color:[220,180,220],opacity:1,label:"ctx_lh_G_parietal_sup"},11128:{color:[20,180,140],opacity:1,label:"ctx_lh_G_postcentral"},11129:{color:[60,140,180],opacity:1,label:"ctx_lh_G_precentral"},11130:{color:[25,20,140],opacity:1,label:"ctx_lh_G_precuneus"},11131:{color:[20,60,100],opacity:1,label:"ctx_lh_G_rectus"},11132:{color:[60,220,20],opacity:1,label:"ctx_lh_G_subcallosal"},11133:{color:[60,60,220],opacity:1,label:"ctx_lh_G_temp_sup-G_T_transv"},11134:{color:[220,60,220],opacity:1,label:"ctx_lh_G_temp_sup-Lateral"},11135:{color:[65,220,60],opacity:1,label:"ctx_lh_G_temp_sup-Plan_polar"},11136:{color:[25,140,20],opacity:1,label:"ctx_lh_G_temp_sup-Plan_tempo"},11137:{color:[220,220,100],opacity:1,label:"ctx_lh_G_temporal_inf"},11138:{color:[180,60,60],opacity:1,label:"ctx_lh_G_temporal_middle"},11139:{color:[61,20,220],opacity:1,label:"ctx_lh_Lat_Fis-ant-Horizont"},11140:{color:[61,20,60],opacity:1,label:"ctx_lh_Lat_Fis-ant-Vertical"},11141:{color:[61,60,100],opacity:1,label:"ctx_lh_Lat_Fis-post"},11142:{color:[25,25,25],opacity:1,label:"ctx_lh_Medial_wall"},11143:{color:[140,20,60],opacity:1,label:"ctx_lh_Pole_occipital"},11144:{color:[220,180,20],opacity:1,label:"ctx_lh_Pole_temporal"},11145:{color:[63,180,180],opacity:1,label:"ctx_lh_S_calcarine"},11146:{color:[221,20,10],opacity:1,label:"ctx_lh_S_central"},11147:{color:[221,20,100],opacity:1,label:"ctx_lh_S_cingul-Marginalis"},11148:{color:[221,60,140],opacity:1,label:"ctx_lh_S_circular_insula_ant"},11149:{color:[221,20,220],opacity:1,label:"ctx_lh_S_circular_insula_inf"},11150:{color:[61,220,220],opacity:1,label:"ctx_lh_S_circular_insula_sup"},11151:{color:[100,200,200],opacity:1,label:"ctx_lh_S_collat_transv_ant"},11152:{color:[10,200,200],opacity:1,label:"ctx_lh_S_collat_transv_post"},11153:{color:[221,220,20],opacity:1,label:"ctx_lh_S_front_inf"},11154:{color:[141,20,100],opacity:1,label:"ctx_lh_S_front_middle"},11155:{color:[61,220,100],opacity:1,label:"ctx_lh_S_front_sup"},11156:{color:[141,60,20],opacity:1,label:"ctx_lh_S_interm_prim-Jensen"},11157:{color:[143,20,220],opacity:1,label:"ctx_lh_S_intrapariet_and_P_trans"},11158:{color:[101,60,220],opacity:1,label:"ctx_lh_S_oc_middle_and_Lunatus"},11159:{color:[21,20,140],opacity:1,label:"ctx_lh_S_oc_sup_and_transversal"},11160:{color:[61,20,180],opacity:1,label:"ctx_lh_S_occipital_ant"},11161:{color:[221,140,20],opacity:1,label:"ctx_lh_S_oc-temp_lat"},11162:{color:[141,100,220],opacity:1,label:"ctx_lh_S_oc-temp_med_and_Lingual"},11163:{color:[221,100,20],opacity:1,label:"ctx_lh_S_orbital_lateral"},11164:{color:[181,200,20],opacity:1,label:"ctx_lh_S_orbital_med-olfact"},11165:{color:[101,20,20],opacity:1,label:"ctx_lh_S_orbital-H_Shaped"},11166:{color:[101,100,180],opacity:1,label:"ctx_lh_S_parieto_occipital"},11167:{color:[181,220,20],opacity:1,label:"ctx_lh_S_pericallosal"},11168:{color:[21,140,200],opacity:1,label:"ctx_lh_S_postcentral"},11169:{color:[21,20,240],opacity:1,label:"ctx_lh_S_precentral-inf-part"},11170:{color:[21,20,200],opacity:1,label:"ctx_lh_S_precentral-sup-part"},11171:{color:[21,20,60],opacity:1,label:"ctx_lh_S_suborbital"},11172:{color:[101,60,60],opacity:1,label:"ctx_lh_S_subparietal"},11173:{color:[21,180,180],opacity:1,label:"ctx_lh_S_temporal_inf"},11174:{color:[223,220,60],opacity:1,label:"ctx_lh_S_temporal_sup"},11175:{color:[221,60,60],opacity:1,label:"ctx_lh_S_temporal_transverse"},12100:{color:[0,0,0],opacity:1,label:"ctx_rh_Unknown"},12101:{color:[23,220,60],opacity:1,label:"ctx_rh_G_and_S_frontomargin"},12102:{color:[23,60,180],opacity:1,label:"ctx_rh_G_and_S_occipital_inf"},12103:{color:[63,100,60],opacity:1,label:"ctx_rh_G_and_S_paracentral"},12104:{color:[63,20,220],opacity:1,label:"ctx_rh_G_and_S_subcentral"},12105:{color:[13,0,250],opacity:1,label:"ctx_rh_G_and_S_transv_frontopol"},12106:{color:[26,60,0],opacity:1,label:"ctx_rh_G_and_S_cingul-Ant"},12107:{color:[26,60,75],opacity:1,label:"ctx_rh_G_and_S_cingul-Mid-Ant"},12108:{color:[26,60,150],opacity:1,label:"ctx_rh_G_and_S_cingul-Mid-Post"},12109:{color:[25,60,250],opacity:1,label:"ctx_rh_G_cingul-Post-dorsal"},12110:{color:[60,25,25],opacity:1,label:"ctx_rh_G_cingul-Post-ventral"},12111:{color:[180,20,20],opacity:1,label:"ctx_rh_G_cuneus"},12112:{color:[220,20,100],opacity:1,label:"ctx_rh_G_front_inf-Opercular"},12113:{color:[140,60,60],opacity:1,label:"ctx_rh_G_front_inf-Orbital"},12114:{color:[180,220,140],opacity:1,label:"ctx_rh_G_front_inf-Triangul"},12115:{color:[140,100,180],opacity:1,label:"ctx_rh_G_front_middle"},12116:{color:[180,20,140],opacity:1,label:"ctx_rh_G_front_sup"},12117:{color:[23,10,10],opacity:1,label:"ctx_rh_G_Ins_lg_and_S_cent_ins"},12118:{color:[225,140,140],opacity:1,label:"ctx_rh_G_insular_short"},12119:{color:[180,60,180],opacity:1,label:"ctx_rh_G_occipital_middle"},12120:{color:[20,220,60],opacity:1,label:"ctx_rh_G_occipital_sup"},12121:{color:[60,20,140],opacity:1,label:"ctx_rh_G_oc-temp_lat-fusifor"},12122:{color:[220,180,140],opacity:1,label:"ctx_rh_G_oc-temp_med-Lingual"},12123:{color:[65,100,20],opacity:1,label:"ctx_rh_G_oc-temp_med-Parahip"},12124:{color:[220,60,20],opacity:1,label:"ctx_rh_G_orbital"},12125:{color:[20,60,220],opacity:1,label:"ctx_rh_G_pariet_inf-Angular"},12126:{color:[100,100,60],opacity:1,label:"ctx_rh_G_pariet_inf-Supramar"},12127:{color:[220,180,220],opacity:1,label:"ctx_rh_G_parietal_sup"},12128:{color:[20,180,140],opacity:1,label:"ctx_rh_G_postcentral"},12129:{color:[60,140,180],opacity:1,label:"ctx_rh_G_precentral"},12130:{color:[25,20,140],opacity:1,label:"ctx_rh_G_precuneus"},12131:{color:[20,60,100],opacity:1,label:"ctx_rh_G_rectus"},12132:{color:[60,220,20],opacity:1,label:"ctx_rh_G_subcallosal"},12133:{color:[60,60,220],opacity:1,label:"ctx_rh_G_temp_sup-G_T_transv"},12134:{color:[220,60,220],opacity:1,label:"ctx_rh_G_temp_sup-Lateral"},12135:{color:[65,220,60],opacity:1,label:"ctx_rh_G_temp_sup-Plan_polar"},12136:{color:[25,140,20],opacity:1,label:"ctx_rh_G_temp_sup-Plan_tempo"},12137:{color:[220,220,100],opacity:1,label:"ctx_rh_G_temporal_inf"},12138:{color:[180,60,60],opacity:1,label:"ctx_rh_G_temporal_middle"},12139:{color:[61,20,220],opacity:1,label:"ctx_rh_Lat_Fis-ant-Horizont"},12140:{color:[61,20,60],opacity:1,label:"ctx_rh_Lat_Fis-ant-Vertical"},12141:{color:[61,60,100],opacity:1,label:"ctx_rh_Lat_Fis-post"},12142:{color:[25,25,25],opacity:1,label:"ctx_rh_Medial_wall"},12143:{color:[140,20,60],opacity:1,label:"ctx_rh_Pole_occipital"},12144:{color:[220,180,20],opacity:1,label:"ctx_rh_Pole_temporal"},12145:{color:[63,180,180],opacity:1,label:"ctx_rh_S_calcarine"},12146:{color:[221,20,10],opacity:1,label:"ctx_rh_S_central"},12147:{color:[221,20,100],opacity:1,label:"ctx_rh_S_cingul-Marginalis"},12148:{color:[221,60,140],opacity:1,label:"ctx_rh_S_circular_insula_ant"},12149:{color:[221,20,220],opacity:1,label:"ctx_rh_S_circular_insula_inf"},12150:{color:[61,220,220],opacity:1,label:"ctx_rh_S_circular_insula_sup"},12151:{color:[100,200,200],opacity:1,label:"ctx_rh_S_collat_transv_ant"},12152:{color:[10,200,200],opacity:1,label:"ctx_rh_S_collat_transv_post"},12153:{color:[221,220,20],opacity:1,label:"ctx_rh_S_front_inf"},12154:{color:[141,20,100],opacity:1,label:"ctx_rh_S_front_middle"},12155:{color:[61,220,100],opacity:1,label:"ctx_rh_S_front_sup"},12156:{color:[141,60,20],opacity:1,label:"ctx_rh_S_interm_prim-Jensen"},12157:{color:[143,20,220],opacity:1,label:"ctx_rh_S_intrapariet_and_P_trans"},12158:{color:[101,60,220],opacity:1,label:"ctx_rh_S_oc_middle_and_Lunatus"},12159:{color:[21,20,140],opacity:1,label:"ctx_rh_S_oc_sup_and_transversal"},12160:{color:[61,20,180],opacity:1,label:"ctx_rh_S_occipital_ant"},12161:{color:[221,140,20],opacity:1,label:"ctx_rh_S_oc-temp_lat"},12162:{color:[141,100,220],opacity:1,label:"ctx_rh_S_oc-temp_med_and_Lingual"},12163:{color:[221,100,20],opacity:1,label:"ctx_rh_S_orbital_lateral"},12164:{color:[181,200,20],opacity:1,label:"ctx_rh_S_orbital_med-olfact"},12165:{color:[101,20,20],opacity:1,label:"ctx_rh_S_orbital-H_Shaped"},12166:{color:[101,100,180],opacity:1,label:"ctx_rh_S_parieto_occipital"},12167:{color:[181,220,20],opacity:1,label:"ctx_rh_S_pericallosal"},12168:{color:[21,140,200],opacity:1,label:"ctx_rh_S_postcentral"},12169:{color:[21,20,240],opacity:1,label:"ctx_rh_S_precentral-inf-part"},12170:{color:[21,20,200],opacity:1,label:"ctx_rh_S_precentral-sup-part"},12171:{color:[21,20,60],opacity:1,label:"ctx_rh_S_suborbital"},12172:{color:[101,60,60],opacity:1,label:"ctx_rh_S_subparietal"},12173:{color:[21,180,180],opacity:1,label:"ctx_rh_S_temporal_inf"},12174:{color:[223,220,60],opacity:1,label:"ctx_rh_S_temporal_sup"},12175:{color:[221,60,60],opacity:1,label:"ctx_rh_S_temporal_transverse"},13100:{color:[0,0,0],opacity:1,label:"wm_lh_Unknown"},13101:{color:[23,220,60],opacity:1,label:"wm_lh_G_and_S_frontomargin"},13102:{color:[23,60,180],opacity:1,label:"wm_lh_G_and_S_occipital_inf"},13103:{color:[63,100,60],opacity:1,label:"wm_lh_G_and_S_paracentral"},13104:{color:[63,20,220],opacity:1,label:"wm_lh_G_and_S_subcentral"},13105:{color:[13,0,250],opacity:1,label:"wm_lh_G_and_S_transv_frontopol"},13106:{color:[26,60,0],opacity:1,label:"wm_lh_G_and_S_cingul-Ant"},13107:{color:[26,60,75],opacity:1,label:"wm_lh_G_and_S_cingul-Mid-Ant"},13108:{color:[26,60,150],opacity:1,label:"wm_lh_G_and_S_cingul-Mid-Post"},13109:{color:[25,60,250],opacity:1,label:"wm_lh_G_cingul-Post-dorsal"},13110:{color:[60,25,25],opacity:1,label:"wm_lh_G_cingul-Post-ventral"},13111:{color:[180,20,20],opacity:1,label:"wm_lh_G_cuneus"},13112:{color:[220,20,100],opacity:1,label:"wm_lh_G_front_inf-Opercular"},13113:{color:[140,60,60],opacity:1,label:"wm_lh_G_front_inf-Orbital"},13114:{color:[180,220,140],opacity:1,label:"wm_lh_G_front_inf-Triangul"},13115:{color:[140,100,180],opacity:1,label:"wm_lh_G_front_middle"},13116:{color:[180,20,140],opacity:1,label:"wm_lh_G_front_sup"},13117:{color:[23,10,10],opacity:1,label:"wm_lh_G_Ins_lg_and_S_cent_ins"},13118:{color:[225,140,140],opacity:1,label:"wm_lh_G_insular_short"},13119:{color:[180,60,180],opacity:1,label:"wm_lh_G_occipital_middle"},13120:{color:[20,220,60],opacity:1,label:"wm_lh_G_occipital_sup"},13121:{color:[60,20,140],opacity:1,label:"wm_lh_G_oc-temp_lat-fusifor"},13122:{color:[220,180,140],opacity:1,label:"wm_lh_G_oc-temp_med-Lingual"},13123:{color:[65,100,20],opacity:1,label:"wm_lh_G_oc-temp_med-Parahip"},13124:{color:[220,60,20],opacity:1,label:"wm_lh_G_orbital"},13125:{color:[20,60,220],opacity:1,label:"wm_lh_G_pariet_inf-Angular"},13126:{color:[100,100,60],opacity:1,label:"wm_lh_G_pariet_inf-Supramar"},13127:{color:[220,180,220],opacity:1,label:"wm_lh_G_parietal_sup"},13128:{color:[20,180,140],opacity:1,label:"wm_lh_G_postcentral"},13129:{color:[60,140,180],opacity:1,label:"wm_lh_G_precentral"},13130:{color:[25,20,140],opacity:1,label:"wm_lh_G_precuneus"},13131:{color:[20,60,100],opacity:1,label:"wm_lh_G_rectus"},13132:{color:[60,220,20],opacity:1,label:"wm_lh_G_subcallosal"},13133:{color:[60,60,220],opacity:1,label:"wm_lh_G_temp_sup-G_T_transv"},13134:{color:[220,60,220],opacity:1,label:"wm_lh_G_temp_sup-Lateral"},13135:{color:[65,220,60],opacity:1,label:"wm_lh_G_temp_sup-Plan_polar"},13136:{color:[25,140,20],opacity:1,label:"wm_lh_G_temp_sup-Plan_tempo"},13137:{color:[220,220,100],opacity:1,label:"wm_lh_G_temporal_inf"},13138:{color:[180,60,60],opacity:1,label:"wm_lh_G_temporal_middle"},13139:{color:[61,20,220],opacity:1,label:"wm_lh_Lat_Fis-ant-Horizont"},13140:{color:[61,20,60],opacity:1,label:"wm_lh_Lat_Fis-ant-Vertical"},13141:{color:[61,60,100],opacity:1,label:"wm_lh_Lat_Fis-post"},13142:{color:[25,25,25],opacity:1,label:"wm_lh_Medial_wall"},13143:{color:[140,20,60],opacity:1,label:"wm_lh_Pole_occipital"},13144:{color:[220,180,20],opacity:1,label:"wm_lh_Pole_temporal"},13145:{color:[63,180,180],opacity:1,label:"wm_lh_S_calcarine"},13146:{color:[221,20,10],opacity:1,label:"wm_lh_S_central"},13147:{color:[221,20,100],opacity:1,label:"wm_lh_S_cingul-Marginalis"},13148:{color:[221,60,140],opacity:1,label:"wm_lh_S_circular_insula_ant"},13149:{color:[221,20,220],opacity:1,label:"wm_lh_S_circular_insula_inf"},13150:{color:[61,220,220],opacity:1,label:"wm_lh_S_circular_insula_sup"},13151:{color:[100,200,200],opacity:1,label:"wm_lh_S_collat_transv_ant"},13152:{color:[10,200,200],opacity:1,label:"wm_lh_S_collat_transv_post"},13153:{color:[221,220,20],opacity:1,label:"wm_lh_S_front_inf"},13154:{color:[141,20,100],opacity:1,label:"wm_lh_S_front_middle"},13155:{color:[61,220,100],opacity:1,label:"wm_lh_S_front_sup"},13156:{color:[141,60,20],opacity:1,label:"wm_lh_S_interm_prim-Jensen"},13157:{color:[143,20,220],opacity:1,label:"wm_lh_S_intrapariet_and_P_trans"},13158:{color:[101,60,220],opacity:1,label:"wm_lh_S_oc_middle_and_Lunatus"},13159:{color:[21,20,140],opacity:1,label:"wm_lh_S_oc_sup_and_transversal"},13160:{color:[61,20,180],opacity:1,label:"wm_lh_S_occipital_ant"},13161:{color:[221,140,20],opacity:1,label:"wm_lh_S_oc-temp_lat"},13162:{color:[141,100,220],opacity:1,label:"wm_lh_S_oc-temp_med_and_Lingual"},13163:{color:[221,100,20],opacity:1,label:"wm_lh_S_orbital_lateral"},13164:{color:[181,200,20],opacity:1,label:"wm_lh_S_orbital_med-olfact"},13165:{color:[101,20,20],opacity:1,label:"wm_lh_S_orbital-H_Shaped"},13166:{color:[101,100,180],opacity:1,label:"wm_lh_S_parieto_occipital"},13167:{color:[181,220,20],opacity:1,label:"wm_lh_S_pericallosal"},13168:{color:[21,140,200],opacity:1,label:"wm_lh_S_postcentral"},13169:{color:[21,20,240],opacity:1,label:"wm_lh_S_precentral-inf-part"},13170:{color:[21,20,200],opacity:1,label:"wm_lh_S_precentral-sup-part"},13171:{color:[21,20,60],opacity:1,label:"wm_lh_S_suborbital"},13172:{color:[101,60,60],opacity:1,label:"wm_lh_S_subparietal"},13173:{color:[21,180,180],opacity:1,label:"wm_lh_S_temporal_inf"},13174:{color:[223,220,60],opacity:1,label:"wm_lh_S_temporal_sup"},13175:{color:[221,60,60],opacity:1,label:"wm_lh_S_temporal_transverse"},14100:{color:[0,0,0],opacity:1,label:"wm_rh_Unknown"},14101:{color:[23,220,60],opacity:1,label:"wm_rh_G_and_S_frontomargin"},14102:{color:[23,60,180],opacity:1,label:"wm_rh_G_and_S_occipital_inf"},14103:{color:[63,100,60],opacity:1,label:"wm_rh_G_and_S_paracentral"},14104:{color:[63,20,220],opacity:1,label:"wm_rh_G_and_S_subcentral"},14105:{color:[13,0,250],opacity:1,label:"wm_rh_G_and_S_transv_frontopol"},14106:{color:[26,60,0],opacity:1,label:"wm_rh_G_and_S_cingul-Ant"},14107:{color:[26,60,75],opacity:1,label:"wm_rh_G_and_S_cingul-Mid-Ant"},14108:{color:[26,60,150],opacity:1,label:"wm_rh_G_and_S_cingul-Mid-Post"},14109:{color:[25,60,250],opacity:1,label:"wm_rh_G_cingul-Post-dorsal"},14110:{color:[60,25,25],opacity:1,label:"wm_rh_G_cingul-Post-ventral"},14111:{color:[180,20,20],opacity:1,label:"wm_rh_G_cuneus"},14112:{color:[220,20,100],opacity:1,label:"wm_rh_G_front_inf-Opercular"},14113:{color:[140,60,60],opacity:1,label:"wm_rh_G_front_inf-Orbital"},14114:{color:[180,220,140],opacity:1,label:"wm_rh_G_front_inf-Triangul"},14115:{color:[140,100,180],opacity:1,label:"wm_rh_G_front_middle"},14116:{color:[180,20,140],opacity:1,label:"wm_rh_G_front_sup"},14117:{color:[23,10,10],opacity:1,label:"wm_rh_G_Ins_lg_and_S_cent_ins"},14118:{color:[225,140,140],opacity:1,label:"wm_rh_G_insular_short"},14119:{color:[180,60,180],opacity:1,label:"wm_rh_G_occipital_middle"},14120:{color:[20,220,60],opacity:1,label:"wm_rh_G_occipital_sup"},14121:{color:[60,20,140],opacity:1,label:"wm_rh_G_oc-temp_lat-fusifor"},14122:{color:[220,180,140],opacity:1,label:"wm_rh_G_oc-temp_med-Lingual"},14123:{color:[65,100,20],opacity:1,label:"wm_rh_G_oc-temp_med-Parahip"},14124:{color:[220,60,20],opacity:1,label:"wm_rh_G_orbital"},14125:{color:[20,60,220],opacity:1,label:"wm_rh_G_pariet_inf-Angular"},14126:{color:[100,100,60],opacity:1,label:"wm_rh_G_pariet_inf-Supramar"},14127:{color:[220,180,220],opacity:1,label:"wm_rh_G_parietal_sup"},14128:{color:[20,180,140],opacity:1,label:"wm_rh_G_postcentral"},14129:{color:[60,140,180],opacity:1,label:"wm_rh_G_precentral"},14130:{color:[25,20,140],opacity:1,label:"wm_rh_G_precuneus"},14131:{color:[20,60,100],opacity:1,label:"wm_rh_G_rectus"},14132:{color:[60,220,20],opacity:1,label:"wm_rh_G_subcallosal"},14133:{color:[60,60,220],opacity:1,label:"wm_rh_G_temp_sup-G_T_transv"},14134:{color:[220,60,220],opacity:1,label:"wm_rh_G_temp_sup-Lateral"},14135:{color:[65,220,60],opacity:1,label:"wm_rh_G_temp_sup-Plan_polar"},14136:{color:[25,140,20],opacity:1,label:"wm_rh_G_temp_sup-Plan_tempo"},14137:{color:[220,220,100],opacity:1,label:"wm_rh_G_temporal_inf"},14138:{color:[180,60,60],opacity:1,label:"wm_rh_G_temporal_middle"},14139:{color:[61,20,220],opacity:1,label:"wm_rh_Lat_Fis-ant-Horizont"},14140:{color:[61,20,60],opacity:1,label:"wm_rh_Lat_Fis-ant-Vertical"},14141:{color:[61,60,100],opacity:1,label:"wm_rh_Lat_Fis-post"},14142:{color:[25,25,25],opacity:1,label:"wm_rh_Medial_wall"},14143:{color:[140,20,60],opacity:1,label:"wm_rh_Pole_occipital"},14144:{color:[220,180,20],opacity:1,label:"wm_rh_Pole_temporal"},14145:{color:[63,180,180],opacity:1,label:"wm_rh_S_calcarine"},14146:{color:[221,20,10],opacity:1,label:"wm_rh_S_central"},14147:{color:[221,20,100],opacity:1,label:"wm_rh_S_cingul-Marginalis"},14148:{color:[221,60,140],opacity:1,label:"wm_rh_S_circular_insula_ant"},14149:{color:[221,20,220],opacity:1,label:"wm_rh_S_circular_insula_inf"},14150:{color:[61,220,220],opacity:1,label:"wm_rh_S_circular_insula_sup"},14151:{color:[100,200,200],opacity:1,label:"wm_rh_S_collat_transv_ant"},14152:{color:[10,200,200],opacity:1,label:"wm_rh_S_collat_transv_post"},14153:{color:[221,220,20],opacity:1,label:"wm_rh_S_front_inf"},14154:{color:[141,20,100],opacity:1,label:"wm_rh_S_front_middle"},14155:{color:[61,220,100],opacity:1,label:"wm_rh_S_front_sup"},14156:{color:[141,60,20],opacity:1,label:"wm_rh_S_interm_prim-Jensen"},14157:{color:[143,20,220],opacity:1,label:"wm_rh_S_intrapariet_and_P_trans"},14158:{color:[101,60,220],opacity:1,label:"wm_rh_S_oc_middle_and_Lunatus"},14159:{color:[21,20,140],opacity:1,label:"wm_rh_S_oc_sup_and_transversal"},14160:{color:[61,20,180],opacity:1,label:"wm_rh_S_occipital_ant"},14161:{color:[221,140,20],opacity:1,label:"wm_rh_S_oc-temp_lat"},14162:{color:[141,100,220],opacity:1,label:"wm_rh_S_oc-temp_med_and_Lingual"},14163:{color:[221,100,20],opacity:1,label:"wm_rh_S_orbital_lateral"},14164:{color:[181,200,20],opacity:1,label:"wm_rh_S_orbital_med-olfact"},14165:{color:[101,20,20],opacity:1,label:"wm_rh_S_orbital-H_Shaped"},14166:{color:[101,100,180],opacity:1,label:"wm_rh_S_parieto_occipital"},14167:{color:[181,220,20],opacity:1,label:"wm_rh_S_pericallosal"},14168:{color:[21,140,200],opacity:1,label:"wm_rh_S_postcentral"},14169:{color:[21,20,240],opacity:1,label:"wm_rh_S_precentral-inf-part"},14170:{color:[21,20,200],opacity:1,label:"wm_rh_S_precentral-sup-part"},14171:{color:[21,20,60],opacity:1,label:"wm_rh_S_suborbital"},14172:{color:[101,60,60],opacity:1,label:"wm_rh_S_subparietal"},14173:{color:[21,180,180],opacity:1,label:"wm_rh_S_temporal_inf"},14174:{color:[223,220,60],opacity:1,label:"wm_rh_S_temporal_sup"},14175:{color:[221,60,60],opacity:1,label:"wm_rh_S_temporal_transverse"}};class xt{static get code(){return'\n\t\t\t\t.widgets-handle {\n\t\t\t\t\t\tposition: absolute;\n\t\t\t\t\t\tborder: 1px solid;\n\t\t\t\t\t\tborder-radius: 50%;\n\t\t\t\t\t\twidth: 10px;\n\t\t\t\t\t\theight: 10px;\n\t\t\t\t\t\tmargin: -6px; /* border + width / 2 */\n\t\t\t\t\t\tz-index: 3;\n\t\t\t\t}\n\t\t\t\t.widgets-line {\n\t\t\t\t\t\tposition: absolute;\n\t\t\t\t\t\twidth: 1px;\n\t\t\t\t\t\theight: 1px;\n\t\t\t\t\t\tmargin-top: -0.5px; /* height / 2 */\n\t\t\t\t}\n\t\t\t\t.widgets-dashline {\n\t\t\t\t\t\tposition: absolute;\n\t\t\t\t\t\tborder-top: 1px dashed;\n\t\t\t\t\t\tmargin-top: -0.5px; /* border / 2 */\n\t\t\t\t}\n\t\t\t\t.widgets-line:before,\n\t\t\t\t.widgets-dashline:before { /* for dragging */\n\t\t\t\t\t\tcontent: " ";\n\t\t\t\t\t\tposition: absolute;\n\t\t\t\t\t\theight: 12px;\n\t\t\t\t\t\tleft: 0;\n\t\t\t\t\t\tright: 0;\n\t\t\t\t\t\tmargin-top: -6px;\n\t\t\t\t}\n\t\t\t\t.widgets-rectangle {\n\t\t\t\t\t\tposition: absolute;\n\t\t\t\t\t\tborder: 1px solid;\n\t\t\t\t\t\tmargin: -1px; /* border */\n\t\t\t\t}\n\t\t\t\t.widgets-rectangle-helper {\n\t\t\t\t\t\tposition: absolute;\n\t\t\t\t\t\tborder: 1px dashed;\n\t\t\t\t\t\tmargin: -1px; /* border */\n\t\t\t\t}\n\t\t\t\t.widgets-ellipse {\n\t\t\t\t\t\tposition: absolute;\n\t\t\t\t\t\tborder: 1px solid;\n\t\t\t\t\t\tborder-radius: 50%;\n\t\t\t\t\t\tmargin: -1px; /* border */\n\t\t\t\t\t\tz-index: 2;\n\t\t\t\t}\n\t\t\t\t.widgets-label {\n\t\t\t\t\t\tposition: absolute;\n\t\t\t\t\t\tborder: 1px solid;\n\t\t\t\t\t\tbackground-color: rgba(0, 0, 0, 0.7);\n\t\t\t\t\t\tcolor: rgb(255, 255, 255);\n\t\t\t\t\t\tpadding: 4px;\n\t\t\t\t\t\tz-index: 3;\n\t\t\t\t}\n\t\t\t\t'}}class wt extends e.Object3D{constructor(t,i,s){super(),this._widgetType="Base",this._params=s,!0===s.hideMesh&&(this.visible=!1);if(null===document.getElementById("ami-widgets")){const t=document.createElement("style");t.id="ami-widgets",t.innerHTML=xt.code,document.head.appendChild(t)}this._enabled=!0,this._selected=!1,this._hovered=!0,this._active=!0,this._colors={default:d,active:p,hover:u,select:m,text:y,error:b},this._color=this._colors.default,this._dragged=!1,this._displayed=!0,this._targetMesh=t,this._controls=i,this._camera=i.object,this._container=i.domElement,this._worldPosition=new e.Vector3,s.worldPosition?this._worldPosition.copy(s.worldPosition):null!==this._targetMesh&&this._worldPosition.copy(this._targetMesh.position)}initOffsets(){const t=this._container.getBoundingClientRect(),e=document.body,i=document.documentElement,s=scrollY||i.scrollTop||e.scrollTop,a=scrollX||i.scrollLeft||e.scrollLeft,o=i.clientTop||e.clientTop||0,n=i.clientLeft||e.clientLeft||0;this._offsets={top:Math.round(t.top+s-o),left:Math.round(t.left+a-n)}}getMouseOffsets(t,e){return{x:(t.clientX-this._offsets.left)/e.offsetWidth*2-1,y:-(t.clientY-this._offsets.top)/e.offsetHeight*2+1,screenX:t.clientX-this._offsets.left,screenY:t.clientY-this._offsets.top}}getArea(t){let e=0,i=t.length-1;for(let s=0;s<t.length;s++)e+=(t[i].x+t[s].x)*(t[i].y-t[s].y),i=s;return Math.abs(e/2)}getRegionByXY(t,e){let i=null;return t.some(((t,s)=>{if(e.x>=t.x0&&e.x<=t.x1&&e.y>=t.y0&&e.y<=t.y1)return i=s,!0})),i}getPointInRegion(t,i){return t?new e.Vector2((i.x-t.x0-(t.axisX||0))*t.deltaX,(i.y-t.y0-(t.axisY||0))*t.deltaY):null}getUsPoint(t,e){return this.getPointInRegion(t[this.getRegionByXY(t,e)],e)}getUsDistance(t,e){const i=this._params.ultrasoundRegions||[];if(i.length<1)return null;const s=this.getRegionByXY(i,t),a=this.getRegionByXY(i,e);return null===s||null===a||s!==a||"cm"!==i[s].unitsX||"cm"!==i[s].unitsY?null:this.getPointInRegion(i[s],t).distanceTo(this.getPointInRegion(i[s],e))}getDistanceData(t,e,i){let s=null,a=null;if(i)s=t.distanceTo(e)*i;else if(this._params.ultrasoundRegions&&this._params.lps2IJK){const i=this.getUsDistance(n.worldToData(this._params.lps2IJK,t),n.worldToData(this._params.lps2IJK,e));null!==i?(s=10*i,a="mm"):(s=t.distanceTo(e),a=this._params.pixelSpacing?"mm":"units")}else s=t.distanceTo(e);return{distance:s,units:a}}getLineData(t,i){const s=i.clone().sub(t),a=i.clone().add(t).multiplyScalar(.5),o=s.length(),n=s.angleTo(new e.Vector3(1,0,0));return{line:s,length:o,transformX:a.x-o/2,transformY:a.y-this._container.offsetHeight,transformAngle:t.y<i.y?n:-n,center:a}}getRectData(t,i){const s=i.clone().sub(t),a=s.clone().projectOnVector(new e.Vector3(0,1,0)),o=t.clone().min(i);return{width:s.clone().projectOnVector(new e.Vector3(1,0,0)).length(),height:a.length(),transformX:o.x,transformY:o.y-this._container.offsetHeight,paddingVector:a.clone().normalize()}}adjustLabelTransform(t,i,s){let a=Math.round(i.x-(s?0:t.offsetWidth/2)),o=Math.round(i.y-(s?0:t.offsetHeight/2))-this._container.offsetHeight;return a<0?a=a>-t.offsetWidth?0:a+t.offsetWidth:a>this._container.offsetWidth-t.offsetWidth&&(a=a<this._container.offsetWidth?this._container.offsetWidth-t.offsetWidth:a-t.offsetWidth),o<-this._container.offsetHeight?o=o>-this._container.offsetHeight-t.offsetHeight?-this._container.offsetHeight:o+t.offsetHeight:o>-t.offsetHeight&&(o=o<0?-t.offsetHeight:o-t.offsetHeight),new e.Vector2(a,o)}worldToScreen(t){const e=t.clone();return e.project(this._camera),e.x=Math.round((e.x+1)*this._container.offsetWidth/2),e.y=Math.round((1-e.y)*this._container.offsetHeight/2),e.z=0,e}update(){console.log("update() should be overloaded!")}updateColor(){this._active?this._color=this._colors.active:this._hovered?this._color=this._colors.hover:this._selected?this._color=this._colors.select:this._color=this._colors.default}setDefaultColor(t){this._colors.default=t,this._handles&&this._handles.forEach((e=>e._colors.default=t)),this.update()}show(){this.showDOM(),this.showMesh(),this.update(),this._displayed=!0}hide(){this.hideDOM(),this.hideMesh(),this._displayed=!1}hideDOM(){console.log("hideDOM() should be overloaded!")}showDOM(){console.log("showDOM() should be overloaded!")}hideMesh(){this.visible=!1}showMesh(){!0!==this._params.hideMesh&&(this.visible=!0)}free(){this._camera=null,this._container=null,this._controls=null,this._params=null,this._targetMesh=null}get widgetType(){return this._widgetType}get targetMesh(){return this._targetMesh}set targetMesh(t){this._targetMesh=t,this.update()}get worldPosition(){return this._worldPosition}set worldPosition(t){this._worldPosition.copy(t),this.update()}get enabled(){return this._enabled}set enabled(t){this._enabled=t,this.update()}get selected(){return this._selected}set selected(t){this._selected=t,this.update()}get hovered(){return this._hovered}set hovered(t){this._hovered=t,this.update()}get dragged(){return this._dragged}set dragged(t){this._dragged=t,this.update()}get displayed(){return this._displayed}set displayed(t){this._displayed=t,this.update()}get active(){return this._active}set active(t){this._active=t,this.update()}get color(){return this._color}set color(t){this._color=t,this.update()}}class St extends wt{constructor(t,i,s={}){super(t,i,s),this._widgetType="Handle",!0===s.hideHandleMesh&&(this.visible=!1),this._plane={position:new e.Vector3,direction:new e.Vector3},this._offset=new e.Vector3,this._raycaster=new e.Raycaster,this._active=!1,this._hovered=!1,this._tracking=!1,this._mouse=new e.Vector2,this._initialized=!1,this._material=null,this._geometry=null,this._mesh=null,this._meshHovered=!1,this._dom=null,this._domHovered=!1,this._screenPosition=this.worldToScreen(this._worldPosition),this.create(),this.initOffsets(),this.onResize=this.onResize.bind(this),this.onMove=this.onMove.bind(this),this.onHover=this.onHover.bind(this),this.addEventListeners()}addEventListeners(){addEventListener("resize",this.onResize),this._dom.addEventListener("mouseenter",this.onHover),this._dom.addEventListener("mouseleave",this.onHover),this._container.addEventListener("wheel",this.onMove)}removeEventListeners(){removeEventListener("resize",this.onResize),this._dom.removeEventListener("mouseenter",this.onHover),this._dom.removeEventListener("mouseleave",this.onHover),this._container.removeEventListener("wheel",this.onMove)}onResize(){this.initOffsets()}onHover(t){t&&this.hoverDom(t),this.hoverMesh(),this._hovered=this._meshHovered||this._domHovered,this._container.style.cursor=this._hovered?"pointer":"default"}hoverMesh(){let t=this._raycaster.intersectObject(this._mesh);this._meshHovered=t.length>0}hoverDom(t){this._domHovered="mouseenter"===t.type}onStart(t){const e=this.getMouseOffsets(t,this._container);if(this._mouse.set(e.x,e.y),this._raycaster.setFromCamera(this._mouse,this._camera),this._raycaster.ray.position=this._raycaster.ray.origin,this._hovered){if(this._active=!0,this._controls.enabled=!1,this._targetMesh){let t=this._raycaster.intersectObject(this._targetMesh);t.length>0&&this._offset.copy(t[0].point).sub(this._worldPosition)}else{this._plane.position.copy(this._worldPosition),this._plane.direction.copy(this._camera.getWorldDirection());let t=l.rayPlane(this._raycaster.ray,this._plane);null!==t&&this._offset.copy(t).sub(this._plane.position)}this.update()}}onMove(t,e){const i=this.getMouseOffsets(t,this._container);if(this._mouse.set(i.x,i.y),this._raycaster.setFromCamera(this._mouse,this._camera),this._raycaster.ray.position=this._raycaster.ray.origin,this._active||e)if(this._dragged=!0,null!==this._targetMesh){let t=this._raycaster.intersectObject(this._targetMesh);t.length>0&&this._worldPosition.copy(t[0].point.sub(this._offset))}else{0===this._plane.direction.length()&&(this._plane.position.copy(this._worldPosition),this._plane.direction.copy(this._camera.getWorldDirection()));let t=l.rayPlane(this._raycaster.ray,this._plane);null!==t&&this._worldPosition.copy(t.sub(this._offset))}else this.onHover(null);this.update()}onEnd(){!0!==this._tracking&&(!this._dragged&&this._active&&this._initialized&&(this._selected=!this._selected),this._initialized=!0,this._active=!1,this._dragged=!1,this._controls.enabled=!0,this.update())}create(){this.createMesh(),this.createDOM()}createMesh(){this._geometry=new e.SphereGeometry(1,16,16),this._material=new e.MeshBasicMaterial({wireframe:!0,wireframeLinewidth:2}),this.updateMeshColor(),this._mesh=new e.Mesh(this._geometry,this._material),this._mesh.position.copy(this._worldPosition),this._mesh.visible=!0,this.add(this._mesh)}createDOM(){this._dom=document.createElement("div"),this._dom.className="widgets-handle",this._dom.style.transform=`translate3D(\n\t\t\t${this._screenPosition.x}px,\n\t\t\t${this._screenPosition.y-this._container.offsetHeight}px, 0)`,this.updateDOMColor(),this._container.appendChild(this._dom)}update(){this.updateColor(),this._screenPosition=this.worldToScreen(this._worldPosition),this.updateMeshColor(),this.updateMeshPosition(),this.updateDOMColor(),this.updateDOMPosition()}updateMeshColor(){this._material&&this._material.color.set(this._color)}updateMeshPosition(){this._mesh&&this._mesh.position.copy(this._worldPosition)}updateDOMPosition(){this._dom&&(this._dom.style.transform=`translate3D(${this._screenPosition.x}px,\n\t\t\t\t${this._screenPosition.y-this._container.offsetHeight}px, 0)`)}updateDOMColor(){this._dom.style.borderColor=this._color}showMesh(){!0!==this._params.hideMesh&&!0!==this._params.hideHandleMesh&&(this.visible=!0)}free(){this.removeEventListeners(),this._container.removeChild(this._dom),this.remove(this._mesh),this._mesh.geometry.dispose(),this._mesh.geometry=null,this._mesh.material.dispose(),this._mesh.material=null,this._mesh=null,this._geometry.dispose(),this._geometry=null,this._material.vertexShader=null,this._material.fragmentShader=null,this._material.uniforms=null,this._material.dispose(),this._material=null,super.free()}hideDOM(){this._dom.style.display="none"}showDOM(){this._dom.style.display=""}get screenPosition(){return this._screenPosition}set screenPosition(t){this._screenPosition=t}get active(){return this._active}set active(t){this._active=t,this._controls.enabled=!this._active,this.update()}get tracking(){return this._tracking}set tracking(t){this._tracking=t,this.update()}}const Mt=require("../package.json").version,Pt=require("three/package").version;console.log(`AMI ${Mt} (three ${Pt})`),t.AngleWidget=class extends wt{constructor(t,e,i={}){let s;super(t,e,i),this._widgetType="Angle",this._opangle=null,this._moving=!1,this._domHovered=!1,this._defaultAngle=!0,this._material=null,this._geometry=null,this._mesh=null,this._line=null,this._line2=null,this._label=null,this._handles=[];const a=St();for(let o=0;o<3;o++)s=new a(t,e,i),this.add(s),this._handles.push(s);this._handles[1].active=!0,this._handles[1].tracking=!0,this._handles[2].active=!0,this._handles[2].tracking=!0,this._moveHandle=new a(t,e,i),this.add(this._moveHandle),this._handles.push(this._moveHandle),this._moveHandle.hide(),this.create(),this.onMove=this.onMove.bind(this),this.onHover=this.onHover.bind(this),this.addEventListeners()}addEventListeners(){this._container.addEventListener("wheel",this.onMove),this._line.addEventListener("mouseenter",this.onHover),this._line.addEventListener("mouseleave",this.onHover),this._line2.addEventListener("mouseenter",this.onHover),this._line2.addEventListener("mouseleave",this.onHover),this._label.addEventListener("mouseenter",this.onHover),this._label.addEventListener("mouseleave",this.onHover)}removeEventListeners(){this._container.removeEventListener("wheel",this.onMove),this._line.removeEventListener("mouseenter",this.onHover),this._line.removeEventListener("mouseleave",this.onHover),this._line2.removeEventListener("mouseenter",this.onHover),this._line2.removeEventListener("mouseleave",this.onHover),this._label.removeEventListener("mouseenter",this.onHover),this._label.removeEventListener("mouseleave",this.onHover)}onHover(t){t&&this.hoverDom(t),this.hoverMesh(),this._hovered=this._handles[0].hovered||this._handles[1].hovered||this._handles[2].hovered||this._domHovered,this._container.style.cursor=this._hovered?"pointer":"default"}hoverMesh(){}hoverDom(t){this._domHovered="mouseenter"===t.type}onStart(t){this._moveHandle.onMove(t,!0),this._handles[0].onStart(t),this._handles[1].onStart(t),this._handles[2].onStart(t),this._active=this._handles[0].active||this._handles[1].active||this._handles[2].active||this._domHovered,!this._domHovered||this._handles[1].tracking||this._handles[2].tracking||(this._moving=!0,this._controls.enabled=!1),this.update()}onMove(t){if(this._active){const e=this._moveHandle.worldPosition.clone();this._dragged=!0,this._moveHandle.onMove(t,!0),this._moving&&this._handles.slice(0,-1).forEach((t=>{t.worldPosition.add(this._moveHandle.worldPosition.clone().sub(e))}))}else this.onHover(null);this._handles[0].onMove(t),this._handles[1].onMove(t),this._handles[2].onMove(t),this.update()}onEnd(){this._handles[0].onEnd(),this._handles[1].tracking&&this._handles[0].screenPosition.distanceTo(this._handles[1].screenPosition)<10||!this._handles[1].tracking&&this._handles[2].tracking&&this._handles[1].screenPosition.distanceTo(this._handles[2].screenPosition)<10||(this._dragged||!this._active||this._handles[2].tracking||(this._selected=!this._selected,this._handles[0].selected=this._selected),this._handles[1].active?this._handles[2].onEnd():this._dragged||!this._handles[2].tracking?(this._handles[2].tracking=!1,this._handles[2].onEnd()):this._handles[2].tracking=!1,this._handles[2].selected=this._selected,this._dragged||!this._handles[1].tracking?(this._handles[1].tracking=!1,this._handles[1].onEnd()):this._handles[1].tracking=!1,this._handles[1].selected=this._selected,this._active=this._handles[0].active||this._handles[1].active||this._handles[2].active,this._dragged=this._handles[2].tracking,this._moving=!1,this.update())}create(){this.createMesh(),this.createDOM()}createMesh(){this._geometry=new e.BufferGeometry;const t=new Float32Array(12);this._geometry.setAttribute("position",new e.BufferAttribute(t,3));let i=0;t[i++]=this._handles[0].worldPosition.x,t[i++]=this._handles[0].worldPosition.y,t[i++]=this._handles[0].worldPosition.z,t[i++]=this._handles[1].worldPosition.x,t[i++]=this._handles[1].worldPosition.y,t[i++]=this._handles[1].worldPosition.z,t[i++]=this._handles[1].worldPosition.x,t[i++]=this._handles[1].worldPosition.y,t[i++]=this._handles[1].worldPosition.z,t[i++]=this._handles[2].worldPosition.x,t[i++]=this._handles[2].worldPosition.y,t[i++]=this._handles[2].worldPosition.z,this._material=new e.LineBasicMaterial,this.updateMeshColor(),this._mesh=new e.LineSegments(this._geometry,this._material),this._mesh.visible=!0,this.add(this._mesh)}createDOM(){this._line=document.createElement("div"),this._line.className="widgets-line",this._container.appendChild(this._line),this._line2=document.createElement("div"),this._line2.className="widgets-line",this._container.appendChild(this._line2),this._label=document.createElement("div"),this._label.className="widgets-label",this._container.appendChild(this._label),this.updateDOMColor()}hideDOM(){this._line.style.display="none",this._line2.style.display="none",this._label.style.display="none",this._handles.forEach((t=>t.hideDOM()))}showDOM(){this._line.style.display="",this._line2.style.display="",this._label.style.display="",this._handles[0].showDOM(),this._handles[1].showDOM(),this._handles[2].showDOM()}update(){this.updateColor(),this._handles[0].update(),this._handles[1].update(),this._handles[2].update(),this._opangle=180*this._handles[1].worldPosition.clone().sub(this._handles[0].worldPosition).angleTo(this._handles[1].worldPosition.clone().sub(this._handles[2].worldPosition))/Math.PI||0,this._opangle=this._defaultAngle?this._opangle:360-this._opangle,this.updateMeshColor(),this.updateMeshPosition(),this.updateDOM()}updateMeshColor(){this._material&&this._material.color.set(this._color)}updateMeshPosition(){this._geometry&&(this._geometry.verticesNeedUpdate=!0)}updateDOM(){this.updateDOMColor();const t=this.getLineData(this._handles[1].screenPosition,this._handles[0].screenPosition);this._line.style.transform=`translate3D(${t.transformX}px, ${t.transformY}px, 0)\n\t\t\t\t\t\trotate(${t.transformAngle}rad)`,this._line.style.width=t.length+"px";const i=this.getLineData(this._handles[1].screenPosition,this._handles[2].screenPosition);this._line2.style.transform=`translate3D(${i.transformX}px, ${i.transformY}px, 0)\n\t\t\t\t\t\trotate(${i.transformAngle}rad)`,this._line2.style.width=i.length+"px",this._label.innerHTML=`${this._opangle.toFixed(2)}&deg;`;let s=t.line.clone().add(i.line).normalize().negate(),a=s.angleTo(new e.Vector3(1,0,0));a>Math.PI/2&&(a=Math.PI-a);const o=Math.tan(a)<this._label.offsetHeight/this._label.offsetWidth?this._label.offsetWidth/2/Math.cos(a)+15:this._label.offsetHeight/2/Math.cos(Math.PI/2-a)+15,n=this._handles[1].screenPosition.clone().add(s.multiplyScalar(o)),l=this.adjustLabelTransform(this._label,n);this._label.style.transform=`translate3D(${l.x}px, ${l.y}px, 0)`}updateDOMColor(){this._line.style.backgroundColor=this._color,this._line2.style.backgroundColor=this._color,this._label.style.borderColor=this._color}free(){this.removeEventListeners(),this._handles.forEach((t=>{this.remove(t),t.free()})),this._handles=[],this._container.removeChild(this._line),this._container.removeChild(this._line2),this._container.removeChild(this._label),this.remove(this._mesh),this._mesh.geometry.dispose(),this._mesh.geometry=null,this._mesh.material.dispose(),this._mesh.material=null,this._mesh=null,this._geometry.dispose(),this._geometry=null,this._material.vertexShader=null,this._material.fragmentShader=null,this._material.uniforms=null,this._material.dispose(),this._material=null,super.free()}toggleDefaultAngle(){this._defaultAngle=!this._defaultAngle}get targetMesh(){return this._targetMesh}set targetMesh(t){this._targetMesh=t,this._handles.forEach((e=>e.targetMesh=t)),this.update()}get worldPosition(){return this._worldPosition}set worldPosition(t){this._handles[0].worldPosition.copy(t),this._handles[1].worldPosition.copy(t),this._handles[2].worldPosition.copy(t),this._worldPosition.copy(t),this.update()}get angle(){return this._opangle}},t.AnnotationWidget=class extends wt{constructor(t,i,s={}){let a;super(t,i,s),this._widgetType="Annotation",this._initialized=!1,this._movinglabel=null,this._labelmoved=!1,this._labelhovered=!1,this._manuallabeldisplay=!1,this._material=null,this._geometry=null,this._meshline=null,this._cone=null,this._line=null,this._dashline=null,this._label=null,this._labeltext=null,this._labelOffset=new e.Vector3,this._mouseLabelOffset=new e.Vector3,this._handles=[];const o=St();for(let e=0;e<2;e++)a=new o(t,i,s),this.add(a),this._handles.push(a);this._handles[1].active=!0,this.create(),this.initOffsets(),this.onResize=this.onResize.bind(this),this.onMove=this.onMove.bind(this),this.onHoverlabel=this.onHoverlabel.bind(this),this.notonHoverlabel=this.notonHoverlabel.bind(this),this.changelabeltext=this.changelabeltext.bind(this),this.addEventListeners()}addEventListeners(){addEventListener("resize",this.onResize),this._label.addEventListener("mouseenter",this.onHoverlabel),this._label.addEventListener("mouseleave",this.notonHoverlabel),this._label.addEventListener("dblclick",this.changelabeltext),this._container.addEventListener("wheel",this.onMove)}removeEventListeners(){removeEventListener("resize",this.onResize),this._label.removeEventListener("mouseenter",this.onHoverlabel),this._label.removeEventListener("mouseleave",this.notonHoverlabel),this._label.removeEventListener("dblclick",this.changelabeltext),this._container.removeEventListener("wheel",this.onMove)}onResize(){this.initOffsets()}onHoverlabel(){this._labelhovered=!0,this._container.style.cursor="pointer"}notonHoverlabel(){this._labelhovered=!1,this._container.style.cursor="default"}onStart(t){if(this._labelhovered){const i=this.getMouseOffsets(t,this._container),s=this._handles[1].screenPosition.clone().sub(this._labelOffset);this._mouseLabelOffset=new e.Vector3(i.screenX-s.x,i.screenY-s.y,0),this._movinglabel=!0,this._labelmoved=!0}this._handles[0].onStart(t),this._handles[1].onStart(t),this._active=this._handles[0].active||this._handles[1].active||this._labelhovered,this.update()}onMove(t){if(this._movinglabel){const i=this.getMouseOffsets(t,this._container);this._labelOffset=new e.Vector3(this._handles[1].screenPosition.x-i.screenX+this._mouseLabelOffset.x,this._handles[1].screenPosition.y-i.screenY+this._mouseLabelOffset.y,0),this._controls.enabled=!1}this._active&&(this._dragged=!0),this._handles[0].onMove(t),this._handles[1].onMove(t),this._hovered=this._handles[0].hovered||this._handles[1].hovered||this._labelhovered,this.update()}onEnd(){this._handles[0].onEnd(),this._dragged||!this._handles[1].tracking?(this._handles[1].tracking=!1,this._handles[1].onEnd()):this._handles[1].tracking=!1,!this._dragged&&this._active&&this._initialized&&(this._selected=!this._selected,this._handles[0].selected=this._selected,this._handles[1].selected=this._selected),this._initialized||(this._labelOffset=this._handles[1].screenPosition.clone().sub(this._handles[0].screenPosition).multiplyScalar(.5),this.setlabeltext(),this._initialized=!0),this._active=this._handles[0].active||this._handles[1].active,this._dragged=!1,this._movinglabel=!1,this.update()}setlabeltext(){for(;!this._labeltext;)this._labeltext=prompt("Please enter the annotation text","");this.displaylabel()}changelabeltext(){this._labeltext=prompt("Please enter a new annotation text",this._label.innerHTML),this.displaylabel()}displaylabel(){this._label.innerHTML="string"==typeof this._labeltext&&this._labeltext.length>0?this._labeltext:"",this._label.style.display="",this._dashline.style.display="",this._label.style.transform=`translate3D(\n\t\t\t\t${this._handles[1].screenPosition.x-this._labelOffset.x-this._label.offsetWidth/2}px,\n\t\t\t\t${this._handles[1].screenPosition.y-this._labelOffset.y-this._label.offsetHeight/2-this._container.offsetHeight}px, 0)`}create(){this.createMesh(),this.createDOM()}createMesh(){this._material=new e.LineBasicMaterial,this.updateMeshColor(),this._geometry=new e.BufferGeometry;const t=new Float32Array(6);this._geometry.setAttribute("position",new e.BufferAttribute(t,3));let i=0;t[i++]=this._handles[0].worldPosition.x,t[i++]=this._handles[0].worldPosition.y,t[i++]=this._handles[0].worldPosition.z,t[i++]=this._handles[1].worldPosition.x,t[i++]=this._handles[1].worldPosition.y,t[i++]=this._handles[1].worldPosition.z,this._meshline=new e.Line(this._geometry,this._material),this._meshline.visible=!0,this.add(this._meshline),this._conegeometry=new e.CylinderGeometry(0,2,10),this._conegeometry.translate(0,-5,0),this._conegeometry.rotateX(-Math.PI/2),this._cone=new e.Mesh(this._conegeometry,this._material),this._cone.visible=!0,this.add(this._cone)}createDOM(){this._line=document.createElement("div"),this._line.className="widgets-line",this._container.appendChild(this._line),this._dashline=document.createElement("div"),this._dashline.className="widgets-dashline",this._dashline.style.display="none",this._container.appendChild(this._dashline),this._label=document.createElement("div"),this._label.className="widgets-label",this._label.style.display="none",this._container.appendChild(this._label),this.updateDOMColor()}update(){this.updateColor(),this._handles[0].update(),this._handles[1].update(),this.updateMeshColor(),this.updateMeshPosition(),this.updateDOM()}updateMeshColor(){this._material&&this._material.color.set(this._color)}updateMeshPosition(){this._geometry&&(this._geometry.verticesNeedUpdate=!0),this._cone&&(this._cone.position.copy(this._handles[1].worldPosition),this._cone.lookAt(this._handles[0].worldPosition))}updateDOM(){this.updateDOMColor();const t=this.getLineData(this._handles[0].screenPosition,this._handles[1].screenPosition);this._line.style.transform=`translate3D(${t.transformX}px, ${t.transformY}px, 0)\n\t\t\t\trotate(${t.transformAngle}rad)`,this._line.style.width=t.length+"px";const e=t.line.multiplyScalar(.5),i=this._handles[1].screenPosition.clone().sub(this._labelmoved?this._labelOffset:e),s=this.adjustLabelTransform(this._label,i);this._label.style.transform=`translate3D(${s.x}px, ${s.y}px, 0)`,this._manuallabeldisplay&&this.displaylabel();let a=this.getLineData(this._handles[0].screenPosition,i),o=this.getLineData(t.center,i),n=this.getLineData(this._handles[1].screenPosition,i);a.length>o.length&&(a=o),a.length>n.length&&(a=n),this._dashline.style.transform=`translate3D(${a.transformX}px, ${a.transformY}px, 0)\n\t\t\t\trotate(${a.transformAngle}rad)`,this._dashline.style.width=a.length+"px"}updateDOMColor(){this._line.style.backgroundColor=this._color,this._dashline.style.borderTop="1.5px dashed "+this._color,this._label.style.borderColor=this._color}hideDOM(){this._line.style.display="none",this._dashline.style.display="none",this._label.style.display="none",this._handles.forEach((t=>t.hideDOM()))}showDOM(){this._line.style.display="",this._dashline.style.display="",this._label.style.display="",this._handles.forEach((t=>t.showDOM()))}free(){this.removeEventListeners(),this._handles.forEach((t=>{this.remove(t),t.free()})),this._handles=[],this._container.removeChild(this._line),this._container.removeChild(this._dashline),this._container.removeChild(this._label),this.remove(this._meshline),this._meshline.geometry.dispose(),this._meshline.geometry=null,this._meshline.material.dispose(),this._meshline.material=null,this._meshline=null,this._geometry.dispose(),this._geometry=null,this._material.vertexShader=null,this._material.fragmentShader=null,this._material.uniforms=null,this._material.dispose(),this._material=null,this.remove(this._cone),this._cone.geometry.dispose(),this._cone.geometry=null,this._cone.material.dispose(),this._cone.material=null,this._cone=null,this._conegeometry.dispose(),this._conegeometry=null,super.free()}get targetMesh(){return this._targetMesh}set targetMesh(t){this._targetMesh=t,this._handles.forEach((e=>e.targetMesh=t)),this.update()}get worldPosition(){return this._worldPosition}set worldPosition(t){this._handles[0].worldPosition.copy(t),this._handles[1].worldPosition.copy(t),this._worldPosition.copy(t),this.update()}},t.BiRulerWidget=class extends wt{constructor(t,e,i={}){let s;super(t,e,i),this._widgetType="BiRuler",this._calibrationFactor=i.calibrationFactor||null,this._distance=null,this._distance2=null,this._units=this._calibrationFactor||i.pixelSpacing?"mm":"units",this._material=null,this._geometry=null,this._mesh=null,this._line=null,this._label=null,this._line2=null,this._label2=null,this._dashline=null,this._handles=[];const a=St();for(let o=0;o<4;o++)s=new a(t,e,i),this.add(s),this._handles.push(s);this._handles[1].active=!0,this._handles[1].tracking=!0,this._handles[3].active=!0,this._handles[3].tracking=!0,this.create(),this.onMove=this.onMove.bind(this),this.addEventListeners()}addEventListeners(){this._container.addEventListener("wheel",this.onMove)}removeEventListeners(){this._container.removeEventListener("wheel",this.onMove)}onStart(t){this._handles.forEach((e=>e.onStart(t))),this._active=this._handles[0].active||this._handles[1].active||this._handles[2].active||this._handles[3].active,this.update()}onMove(t){this._active?this._dragged=!0:(this._hovered=this._handles[0].hovered||this._handles[1].hovered||this._handles[2].hovered||this._handles[3].hovered,this._container.style.cursor=this._hovered?"pointer":"default"),this._handles.forEach((e=>e.onMove(t))),this.update()}onEnd(){this._handles[0].onEnd(),this._handles[2].onEnd(),this._handles[1].tracking&&this._handles[0].screenPosition.distanceTo(this._handles[1].screenPosition)<10||(this._dragged||!this._active||this._handles[3].tracking||(this._selected=!this._selected,this._handles[0].selected=this._selected,this._handles[2].selected=this._selected),this._handles[1].active?this._handles[3].onEnd():this._dragged||!this._handles[3].tracking?(this._handles[3].tracking=!1,this._handles[3].onEnd()):this._handles[3].tracking=!1,this._handles[3].selected=this._selected,this._dragged||!this._handles[1].tracking?(this._handles[1].tracking=!1,this._handles[1].onEnd()):this._handles[1].tracking=!1,this._handles[1].selected=this._selected,this._active=this._handles[0].active||this._handles[1].active||this._handles[2].active||this._handles[3].active,this._dragged=!1,this.update())}create(){this.createMesh(),this.createDOM()}createMesh(){this._geometry=new BufferGeometry;const t=new Float32Array(12);this._geometry.setAttribute("position",new BufferAttribute(t,3));let i=0;t[i++]=this._handles[0].worldPosition.x,t[i++]=this._handles[0].worldPosition.y,t[i++]=this._handles[0].worldPosition.z,t[i++]=this._handles[1].worldPosition.x,t[i++]=this._handles[1].worldPosition.y,t[i++]=this._handles[1].worldPosition.z,t[i++]=this._handles[2].worldPosition.x,t[i++]=this._handles[2].worldPosition.y,t[i++]=this._handles[2].worldPosition.z,t[i++]=this._handles[3].worldPosition.x,t[i++]=this._handles[3].worldPosition.y,t[i++]=this._handles[3].worldPosition.z,this._material=new e.LineBasicMaterial,this.updateMeshColor(),this._mesh=new e.LineSegments(this._geometry,this._material),this._mesh.visible=!0,this.add(this._mesh)}createDOM(){this._line=document.createElement("div"),this._line.className="widgets-line",this._container.appendChild(this._line),this._label=document.createElement("div"),this._label.className="widgets-label",this._container.appendChild(this._label),this._line2=document.createElement("div"),this._line2.className="widgets-line",this._container.appendChild(this._line2),this._label2=document.createElement("div"),this._label2.className="widgets-label",this._container.appendChild(this._label2),this._dashline=document.createElement("div"),this._dashline.className="widgets-dashline",this._container.appendChild(this._dashline),this.updateDOMColor()}hideDOM(){this._line.style.display="none",this._label.style.display="none",this._line2.style.display="none",this._label2.style.display="none",this._dashline.style.display="none",this._handles.forEach((t=>t.hideDOM()))}showDOM(){this._line.style.display="",this._label.style.display="",this._line2.style.display="",this._label2.style.display="",this._dashline.style.display="",this._handles.forEach((t=>t.showDOM()))}update(){this.updateColor(),this._handles.forEach((t=>t.update())),this.updateMeshColor(),this.updateMeshPosition(),this.updateDOM()}updateMeshColor(){this._material&&this._material.color.set(this._color)}updateMeshPosition(){this._geometry&&(this._geometry.verticesNeedUpdate=!0)}updateDOM(){this.updateDOMColor();const t=this.getLineData(this._handles[0].screenPosition,this._handles[1].screenPosition);this._line.style.transform=`translate3D(${t.transformX}px, ${t.transformY}px, 0)\n\t\t\t\t\t\t\t\trotate(${t.transformAngle}rad)`,this._line.style.width=t.length+"px";const e=this.getLineData(this._handles[2].screenPosition,this._handles[3].screenPosition);this._line2.style.transform=`translate3D(${e.transformX}px, ${e.transformY}px, 0)\n\t\t\t\t\t\t\t\trotate(${e.transformAngle}rad)`,this._line2.style.width=e.length+"px";const i=this._handles[0].worldPosition.clone().add(this._handles[1].worldPosition).multiplyScalar(.5),s=this._handles[2].worldPosition.clone().add(this._handles[3].worldPosition).multiplyScalar(.5),a=this.getLineData(this.worldToScreen(i),this.worldToScreen(s));this._dashline.style.transform=`translate3D(${a.transformX}px, ${a.transformY}px, 0)\n\t\t\t\t\t\t\t\trotate(${a.transformAngle}rad)`,this._dashline.style.width=a.length+"px";const o=this.getDistanceData(this._handles[0].worldPosition,this._handles[1].worldPosition,this._calibrationFactor),n=this.getDistanceData(this._handles[2].worldPosition,this._handles[3].worldPosition,this._calibrationFactor),l="Calibration is required to display the distance in mm";this._distance=o.distance,this._distance2=n.distance,o.units&&n.units&&o.units===n.units?this._units=o.units:(o.units||(o.units=this._units),n.units||(n.units=this._units)),"units"!==o.units||this._label.hasAttribute("title")?"units"!==o.units&&this._label.hasAttribute("title")&&(this._label.removeAttribute("title"),this._label.style.color=this._colors.text):(this._label.setAttribute("title",l),this._label.style.color=this._colors.error),"units"!==n.units||this._label2.hasAttribute("title")?"units"!==n.units&&this._label2.hasAttribute("title")&&(this._label2.removeAttribute("title"),this._label2.style.color=this._colors.text):(this._label2.setAttribute("title",l),this._label2.style.color=this._colors.error),this._label.innerHTML=`${this._distance.toFixed(2)} ${o.units}`,this._label2.innerHTML=`${this._distance2.toFixed(2)} ${n.units}`;let r=Math.abs(t.transformAngle);r>Math.PI/2&&(r=Math.PI-r);const h=Math.tan(r)<this._label.offsetHeight/this._label.offsetWidth?this._label.offsetWidth/2/Math.cos(r)+15:this._label.offsetHeight/2/Math.cos(Math.PI/2-r)+15,c=t.line.normalize().multiplyScalar(h),_=t.length>2*h?this._handles[1].screenPosition.clone().sub(c):this._handles[1].screenPosition.clone().add(c),d=this.adjustLabelTransform(this._label,_);this._label.style.transform=`translate3D(${d.x}px, ${d.y}px, 0)`;let p=Math.abs(e.transformAngle);p>Math.PI/2&&(p=Math.PI-p);const u=Math.tan(p)<this._label2.offsetHeight/this._label2.offsetWidth?this._label2.offsetWidth/2/Math.cos(p)+15:this._label2.offsetHeight/2/Math.cos(Math.PI/2-p)+15,m=e.line.normalize().multiplyScalar(u),y=e.length>2*u?this._handles[3].screenPosition.clone().sub(m):this._handles[3].screenPosition.clone().add(m),b=this.adjustLabelTransform(this._label2,y);this._label2.style.transform=`translate3D(${b.x}px, ${b.y}px, 0)`}updateDOMColor(){this._line.style.backgroundColor=this._color,this._label.style.borderColor=this._color,this._line2.style.backgroundColor=this._color,this._label2.style.borderColor=this._color,this._dashline.style.borderTop="1.5px dashed "+this._color}free(){this.removeEventListeners(),this._handles.forEach((t=>{this.remove(t),t.free()})),this._handles=[],this._container.removeChild(this._line),this._container.removeChild(this._label),this._container.removeChild(this._line2),this._container.removeChild(this._label2),this._container.removeChild(this._dashline),this.remove(this._mesh),this._mesh.geometry.dispose(),this._mesh.geometry=null,this._mesh.material.dispose(),this._mesh.material=null,this._mesh=null,this._geometry.dispose(),this._geometry=null,this._material.vertexShader=null,this._material.fragmentShader=null,this._material.uniforms=null,this._material.dispose(),this._material=null,super.free()}getDistances(){return[this._distance,this._distance2]}get targetMesh(){return this._targetMesh}set targetMesh(t){this._targetMesh=t,this._handles.forEach((e=>e.targetMesh=t)),this.update()}get worldPosition(){return this._worldPosition}set worldPosition(t){this._handles.forEach((e=>e.worldPosition.copy(t))),this._worldPosition.copy(t),this.update()}get calibrationFactor(){return this._calibrationFactor}set calibrationFactor(t){this._calibrationFactor=t,this._units="mm",this.update()}get shotestDistance(){return this._distance<this._distance2?this._distance:this._distance2}get longestDistance(){return this._distance>this._distance2?this._distance:this._distance2}},t.BorderHelper=x,t.BoundingBoxHelper=w,t.ColorsCore=g,t.ContourFragmentShader=P,t.ContourHelper=C,t.ContourUniformShader=S,t.ContourVertexShader=M,t.CrossRulerWidget=class extends wt{constructor(t,e,i={}){let s;super(t,e,i),this._widgetType="CrossRuler",this._calibrationFactor=i.calibrationFactor||null,this._distances=null,this._line01=null,this._normal=null,this._distance=null,this._distance2=null,this._units=this._calibrationFactor||i.pixelSpacing?"mm":"units",this._domHovered=!1,this._moving=!1,this._material=null,this._geometry=null,this._mesh=null,this._line=null,this._line2=null,this._label=null,this._label2=null,this._handles=[];const a=St();for(let o=0;o<4;o++)s=new a(t,e,i),this.add(s),this._handles.push(s);this._handles[1].active=!0,this._handles[1].tracking=!0,this._moveHandle=new a(t,e,i),this.add(this._moveHandle),this._handles.push(this._moveHandle),this._moveHandle.hide(),this.onHover=this.onHover.bind(this),this.onMove=this.onMove.bind(this),this.create(),this.addEventListeners()}addEventListeners(){this._line.addEventListener("mouseenter",this.onHover),this._line.addEventListener("mouseleave",this.onHover),this._line2.addEventListener("mouseenter",this.onHover),this._line2.addEventListener("mouseleave",this.onHover),this._container.addEventListener("wheel",this.onMove)}removeEventListeners(){this._line.removeEventListener("mouseenter",this.onHover),this._line.removeEventListener("mouseleave",this.onHover),this._line2.removeEventListener("mouseenter",this.onHover),this._line2.removeEventListener("mouseleave",this.onHover),this._container.removeEventListener("wheel",this.onMove)}onHover(t){t&&this.hoverDom(t),this.hoverMesh(),this._hovered=this._handles[0].hovered||this._handles[1].hovered||this._handles[2].hovered||this._handles[3].hovered||this._domHovered,this._container.style.cursor=this._hovered?"pointer":"default"}hoverMesh(){}hoverDom(t){this._domHovered="mouseenter"===t.type}onStart(t){this._moveHandle.onMove(t,!0),this._handles.slice(0,-1).forEach((e=>e.onStart(t))),this._active=this._handles[0].active||this._handles[1].active||this._handles[2].active||this._handles[3].active||this._domHovered,this._domHovered&&this._distances&&(this._moving=!0,this._controls.enabled=!1),this.update()}onMove(t){if(this._active){const e=this._moveHandle.worldPosition.clone();this._dragged=!0,this._moveHandle.onMove(t,!0),this._moving&&this._handles.slice(0,-1).forEach((t=>{t.worldPosition.add(this._moveHandle.worldPosition.clone().sub(e))}))}else this.onHover(null);this._handles.slice(0,-1).forEach((e=>e.onMove(t))),this._distances&&(this._handles[0].active||this._handles[1].active?this.repositionOrtho():(this._handles[2].active||this._handles[3].active)&&this.recalculateOrtho()),this.update()}onEnd(){this._handles[0].onEnd(),this._handles[2].onEnd(),this._handles[3].onEnd(),this._handles[1].tracking&&this._handles[0].screenPosition.distanceTo(this._handles[1].screenPosition)<10||(this._dragged||!this._active||this._handles[1].tracking||(this._selected=!this._selected,this._handles[0].selected=this._selected,this._handles[2].selected=this._selected,this._handles[3].selected=this._selected),this._dragged||!this._handles[1].tracking?(this._handles[1].tracking=!1,this._handles[1].onEnd()):this._handles[1].tracking=!1,this._handles[1].selected=this._selected,this._active=this._handles[0].active||this._handles[1].active||this._handles[2].active||this._handles[3].active,this._dragged=!1,this._moving=!1,this._distances||this.initOrtho(),this.update())}create(){this.createMesh(),this.createDOM()}createMesh(){this._geometry=new BufferGeometry;const t=new Float32Array(12);this._geometry.setAttribute("position",new BufferAttribute(t,3));let i=0;t[i++]=this._handles[0].worldPosition.x,t[i++]=this._handles[0].worldPosition.y,t[i++]=this._handles[0].worldPosition.z,t[i++]=this._handles[1].worldPosition.x,t[i++]=this._handles[1].worldPosition.y,t[i++]=this._handles[1].worldPosition.z,t[i++]=this._handles[2].worldPosition.x,t[i++]=this._handles[2].worldPosition.y,t[i++]=this._handles[2].worldPosition.z,t[i++]=this._handles[3].worldPosition.x,t[i++]=this._handles[3].worldPosition.y,t[i++]=this._handles[3].worldPosition.z,this._material=new e.LineBasicMaterial,this.updateMeshColor(),this._mesh=new e.LineSegments(this._geometry,this._material),this._mesh.visible=!0,this.add(this._mesh)}createDOM(){this._line=document.createElement("div"),this._line.className="widgets-line",this._container.appendChild(this._line),this._line2=document.createElement("div"),this._line2.className="widgets-line",this._container.appendChild(this._line2),this._label=document.createElement("div"),this._label.className="widgets-label",this._container.appendChild(this._label),this._label2=document.createElement("div"),this._label2.className="widgets-label",this._container.appendChild(this._label2),this.updateDOMColor()}hideDOM(){this._line.style.display="none",this._line2.style.display="none",this._label.style.display="none",this._label2.style.display="none",this._handles.slice(0,-1).forEach((t=>t.hideDOM()))}showDOM(){this._line.style.display="",this._line2.style.display="",this._label.style.display="",this._label2.style.display="",this._handles.slice(0,-1).forEach((t=>t.showDOM()))}update(){this.updateColor(),this._handles.slice(0,-1).forEach((t=>t.update())),this.updateMeshColor(),this.updateMeshPosition(),this.updateDOM()}updateMeshColor(){this._material&&this._material.color.set(this._color)}updateMeshPosition(){this._geometry&&(this._geometry.verticesNeedUpdate=!0)}updateDOM(){this.updateDOMColor();const t=this.getLineData(this._handles[0].screenPosition,this._handles[1].screenPosition);this._line.style.transform=`translate3D(${t.transformX}px, ${t.transformY}px, 0)\n\t\t\t\t\t\trotate(${t.transformAngle}rad)`,this._line.style.width=t.length+"px";const e=this.getLineData(this._handles[2].screenPosition,this._handles[3].screenPosition);this._line2.style.transform=`translate3D(${e.transformX}px, ${e.transformY}px, 0)\n\t\t\t\t\t\trotate(${e.transformAngle}rad)`,this._line2.style.width=e.length+"px";const i=this.getDistanceData(this._handles[0].worldPosition,this._handles[1].worldPosition,this._calibrationFactor),s=this.getDistanceData(this._handles[2].worldPosition,this._handles[3].worldPosition,this._calibrationFactor),a="Calibration is required to display the distance in mm";this._distance=i.distance,this._distance2=s.distance,i.units&&s.units&&i.units===s.units?this._units=i.units:(i.units||(i.units=this._units),s.units||(s.units=this._units)),"units"!==i.units||this._label.hasAttribute("title")?"units"!==i.units&&this._label.hasAttribute("title")&&(this._label.removeAttribute("title"),this._label.style.color=this._colors.text):(this._label.setAttribute("title",a),this._label.style.color=this._colors.error),"units"!==s.units||this._label2.hasAttribute("title")?"units"!==s.units&&this._label2.hasAttribute("title")&&(this._label2.removeAttribute("title"),this._label2.style.color=this._colors.text):(this._label2.setAttribute("title",a),this._label2.style.color=this._colors.error),this._label.innerHTML=`${this._distance.toFixed(2)} ${i.units}`,this._label2.innerHTML=`${this._distance2.toFixed(2)} ${s.units}`;let o=Math.abs(t.transformAngle);o>Math.PI/2&&(o=Math.PI-o);const n=Math.tan(o)<this._label.offsetHeight/this._label.offsetWidth?this._label.offsetWidth/2/Math.cos(o)+15:this._label.offsetHeight/2/Math.cos(Math.PI/2-o)+15,l=t.line.normalize().multiplyScalar(n),r=t.length>4*n?this._handles[1].screenPosition.clone().sub(l):this._handles[1].screenPosition.clone().add(l),h=this.adjustLabelTransform(this._label,r);this._label.style.transform=`translate3D(${h.x}px, ${h.y}px, 0)`;let c=Math.abs(e.transformAngle);c>Math.PI/2&&(c=Math.PI-c);const _=Math.tan(c)<this._label2.offsetHeight/this._label2.offsetWidth?this._label2.offsetWidth/2/Math.cos(c)+15:this._label2.offsetHeight/2/Math.cos(Math.PI/2-c)+15,d=e.line.normalize().multiplyScalar(_),p=e.length>4*_?this._handles[3].screenPosition.clone().sub(d):this._handles[3].screenPosition.clone().add(d),u=this.adjustLabelTransform(this._label2,p);this._label2.style.transform=`translate3D(${u.x}px, ${u.y}px, 0)`}updateDOMColor(){this._line.style.backgroundColor=this._color,this._line2.style.backgroundColor=this._color,this._label.style.borderColor=this._color,this._label2.style.borderColor=this._color}free(){this.removeEventListeners(),this._handles.forEach((t=>{this.remove(t),t.free()})),this._handles=[],this._container.removeChild(this._line),this._container.removeChild(this._line2),this._container.removeChild(this._label),this._container.removeChild(this._label2),this.remove(this._mesh),this._mesh.geometry.dispose(),this._mesh.geometry=null,this._mesh.material.dispose(),this._mesh.material=null,this._mesh=null,this._geometry.dispose(),this._geometry=null,this._material.vertexShader=null,this._material.fragmentShader=null,this._material.uniforms=null,this._material.dispose(),this._material=null,super.free()}initLineAndNormal(){this._line01=this._handles[1].worldPosition.clone().sub(this._handles[0].worldPosition),this._normal=this._line01.clone().cross(this._camera._direction).normalize()}initOrtho(){this.initLineAndNormal();const t=this._handles[1].worldPosition.clone().add(this._handles[0].worldPosition).multiplyScalar(.5),e=this._line01.length()/2,i=this._normal.clone().multiplyScalar(.8*e),s=i.length();this._handles[2].worldPosition.copy(t.clone().add(i)),this._handles[3].worldPosition.copy(t.clone().sub(i)),this._distances=[e,e,s,s]}repositionOrtho(){this.initLineAndNormal(),this._distances[0]*=this._line01.length()/(this._distances[0]+this._distances[1]),this._distances[1]=this._line01.length()-this._distances[0];const t=this._handles[0].worldPosition.clone().add(this._line01.clone().normalize().multiplyScalar(this._distances[0]));this._handles[2].worldPosition.copy(t.clone().add(this._normal.clone().multiplyScalar(this._distances[2]))),this._handles[3].worldPosition.copy(t.clone().sub(this._normal.clone().multiplyScalar(this._distances[3])))}recalculateOrtho(){const t=this._handles[2].active?2:3,i=[],s=new e.Vector3;i[2]=this._handles[2].worldPosition.clone().sub(this._handles[0].worldPosition),i[3]=this._handles[3].worldPosition.clone().sub(this._handles[0].worldPosition),new e.Ray(this._handles[0].worldPosition,this._line01.clone().normalize()).closestPointToPoint(this._handles[t].worldPosition,s);const a=s.clone().sub(this._handles[0].worldPosition).length()>this._line01.length();(a||s.equals(this._handles[0].worldPosition))&&(a&&s.copy(this._handles[1].worldPosition),this._handles[t].worldPosition.copy(s.clone().add(i[t].clone().projectOnVector(this._normal)))),i[2].cross(this._line01).angleTo(this._camera._direction)>.01&&this._handles[2].worldPosition.copy(s),i[3].cross(this._line01).angleTo(this._camera._direction)<Math.PI-.01&&this._handles[3].worldPosition.copy(s),i[0]=this._normal.clone().multiplyScalar(this._distances[5-t]),2===t&&i[0].negate(),this._handles[5-t].worldPosition.copy(s.clone().add(i[0])),this._distances[t]=s.distanceTo(this._handles[t].worldPosition),this._distances[0]=s.distanceTo(this._handles[0].worldPosition),this._distances[1]=s.distanceTo(this._handles[1].worldPosition)}getDimensions(){return[this._distance,this._distance2]}getCoordinates(){return[this._handles[0].worldPosition,this._handles[1].worldPosition,this._handles[2].worldPosition,this._handles[3].worldPosition]}initCoordinates(t,i,s,a){const o=new e.Vector3,n=new e.Vector3,l=new e.Ray(t);l.lookAt(i),l.distanceSqToSegment(s,a,o,n),o.distanceTo(n)>.01&&o.distanceTo(t)>i.distanceTo(t)+.01?console.warn("Lines do not intersect"):(this.active=!1,this.hovered=!1,this.setDefaultColor("#198"),this._worldPosition.copy(t),this._handles[0].worldPosition.copy(t),this._handles[1].worldPosition.copy(i),this._handles[1].active=!1,this._handles[1].tracking=!1,this._handles[2].worldPosition.copy(s),this._handles[3].worldPosition.copy(a),this._distances=[o.distanceTo(t),o.distanceTo(i),o.distanceTo(s),o.distanceTo(a)],this.initLineAndNormal(),this.update())}get targetMesh(){return this._targetMesh}set targetMesh(t){this._targetMesh=t,this._handles.forEach((e=>e.targetMesh=t)),this.update()}get worldPosition(){return this._worldPosition}set worldPosition(t){this._handles.slice(0,-1).forEach((e=>e.worldPosition.copy(t))),this._worldPosition.copy(t),this.update()}get calibrationFactor(){return this._calibrationFactor}set calibrationFactor(t){this._calibrationFactor=t,this._units="mm",this.update()}},t.DataFragmentShader=N,t.DataUniformShader=k,t.DataVertexShader=H,t.DicomParser=ct,t.EllipseWidget=class extends wt{constructor(t,e,i={}){let s;super(t,e,i),this._widgetType="Ellipse",this._stack=i.stack,this._calibrationFactor=i.calibrationFactor||null,this._area=null,this._units=this._calibrationFactor||i.stack.frame[i.frameIndex].pixelSpacing?"cm":"units",this._moving=!1,this._domHovered=!1,this._material=null,this._geometry=null,this._mesh=null,this._rectangle=null,this._ellipse=null,this._label=null,this._handles=[];const a=St();for(let o=0;o<2;o++)s=new a(t,e,i),this.add(s),this._handles.push(s);this._handles[1].active=!0,this._handles[1].tracking=!0,this._moveHandle=new a(t,e,i),this.add(this._moveHandle),this._handles.push(this._moveHandle),this._moveHandle.hide(),this.create(),this.onMove=this.onMove.bind(this),this.onHover=this.onHover.bind(this),this.addEventListeners()}addEventListeners(){this._container.addEventListener("wheel",this.onMove),this._rectangle.addEventListener("mouseenter",this.onHover),this._rectangle.addEventListener("mouseleave",this.onHover),this._ellipse.addEventListener("mouseenter",this.onHover),this._ellipse.addEventListener("mouseleave",this.onHover),this._label.addEventListener("mouseenter",this.onHover),this._label.addEventListener("mouseleave",this.onHover)}removeEventListeners(){this._container.removeEventListener("wheel",this.onMove),this._rectangle.removeEventListener("mouseenter",this.onHover),this._rectangle.removeEventListener("mouseleave",this.onHover),this._ellipse.removeEventListener("mouseenter",this.onHover),this._ellipse.removeEventListener("mouseleave",this.onHover),this._label.removeEventListener("mouseenter",this.onHover),this._label.removeEventListener("mouseleave",this.onHover)}onHover(t){t&&this.hoverDom(t),this.hoverMesh(),this._hovered=this._handles[0].hovered||this._handles[1].hovered||this._domHovered,this._container.style.cursor=this._hovered?"pointer":"default"}hoverMesh(){}hoverDom(t){this._domHovered="mouseenter"===t.type}onStart(t){this._moveHandle.onMove(t,!0),this._handles[0].onStart(t),this._handles[1].onStart(t),this._active=this._handles[0].active||this._handles[1].active||this._domHovered,this._domHovered&&!this._handles[1].tracking&&(this._moving=!0,this._controls.enabled=!1),this.update()}onMove(t){if(this._active){const e=this._moveHandle.worldPosition.clone();this._dragged=!0,this._moveHandle.onMove(t,!0),this._moving&&this._handles.slice(0,-1).forEach((t=>{t.worldPosition.add(this._moveHandle.worldPosition.clone().sub(e))})),this.updateRoI(!0)}else this.onHover(null);this._handles[0].onMove(t),this._handles[1].onMove(t),this.update()}onEnd(){this._handles[0].onEnd(),this._handles[1].tracking&&this._handles[0].screenPosition.distanceTo(this._handles[1].screenPosition)<10||(this._dragged||!this._active||this._handles[1].tracking||(this._selected=!this._selected,this._handles[0].selected=this._selected),this._dragged||!this._handles[1].tracking?(this._handles[1].tracking=!1,this._handles[1].onEnd()):this._handles[1].tracking=!1,this._handles[1].selected=this._selected,this._active=this._handles[0].active||this._handles[1].active,this._dragged=!1,this._moving=!1,this.updateRoI(),this.update())}hideDOM(){this._handles.forEach((t=>t.hideDOM())),this._rectangle.style.display="none",this._ellipse.style.display="none",this._label.style.display="none"}showDOM(){this._handles[0].showDOM(),this._handles[1].showDOM(),this._rectangle.style.display="",this._ellipse.style.display="",this._label.style.display=""}create(){this.createMaterial(),this.createDOM()}createMaterial(){this._material=new e.MeshBasicMaterial,this._material.transparent=!0,this._material.opacity=.2}createDOM(){this._rectangle=document.createElement("div"),this._rectangle.className="widgets-rectangle-helper",this._container.appendChild(this._rectangle),this._ellipse=document.createElement("div"),this._ellipse.className="widgets-ellipse",this._container.appendChild(this._ellipse),this._label=document.createElement("div"),this._label.className="widgets-label";const t=document.createElement("div");let e=document.createElement("div");e.className="mean-sd",t.appendChild(e);let i=document.createElement("div");i.className="max-min",t.appendChild(i);let s=document.createElement("div");s.className="area",t.appendChild(s),this._label.appendChild(t),this._container.appendChild(this._label),this.updateDOMColor()}update(){this.updateColor(),this._handles[0].update(),this._handles[1].update(),this.updateMeshColor(),this.updateMeshPosition(),this.updateDOM()}updateMeshColor(){this._material&&this._material.color.set(this._color)}updateMeshPosition(){this._mesh&&this.remove(this._mesh);const t=this._handles[1].worldPosition.clone().sub(this._handles[0].worldPosition),i=t.clone().projectOnVector(this._camera.up).length(),s=t.clone().projectOnVector(this._camera._right).length();0!==s&&0!==i&&(this._geometry=new e.ShapeGeometry(new e.Shape(new e.EllipseCurve(0,0,s/2,i/2,0,2*Math.PI,!1).getPoints(50))),this._mesh=new e.Mesh(this._geometry,this._material),this._mesh.position.copy(this._handles[0].worldPosition.clone().add(t.multiplyScalar(.5))),this._mesh.rotation.copy(this._camera.rotation),this._mesh.visible=!0,this.add(this._mesh))}updateRoI(t){if(!this._geometry)return;const e=this._label.querySelector(".mean-sd"),i=this._label.querySelector(".max-min");if(t)return e.innerHTML="",void(i.innerHTML="");const s=n.getRoI(this._mesh,this._camera,this._stack);null!==s?(e.innerHTML=`Mean: ${s.mean.toFixed(1)} / SD: ${s.sd.toFixed(1)}`,i.innerHTML=`Max: ${s.max.toFixed()} / Min: ${s.min.toFixed()}`):(e.innerHTML="",i.innerHTML="")}updateDOMColor(){this._rectangle.style.borderColor=this._color,this._ellipse.style.borderColor=this._color,this._label.style.borderColor=this._color}updateDOM(){if(!this._geometry)return;this.updateDOMColor();const t=this._stack.frame[this._params.frameIndex].ultrasoundRegions||[];if(this._area=n.getGeometryArea(this._geometry),this._calibrationFactor)this._area*=Math.pow(this._calibrationFactor,2);else if(t&&t.length>0&&this._stack.lps2IJK){const e=this.getRegionByXY(t,n.worldToData(this._stack.lps2IJK,this._handles[0].worldPosition)),i=this.getRegionByXY(t,n.worldToData(this._stack.lps2IJK,this._handles[1].worldPosition));null!==e&&null!==i&&e===i&&"cm"===t[e].unitsX&&"cm"===t[e].unitsY?(this._area*=Math.pow(t[e].deltaX,2),this._units="cm"):this._stack.frame[this._params.frameIndex].pixelSpacing?(this._area/=100,this._units="cm"):this._units="units"}else"cm"===this._units&&(this._area/=100);"units"!==this._units||this._label.hasAttribute("title")?"units"!==this._units&&this._label.hasAttribute("title")&&(this._label.removeAttribute("title"),this._label.style.color=this._colors.text):(this._label.setAttribute("title","Calibration is required to display the area in cm"),this._label.style.color=this._colors.error),this._label.querySelector(".area").innerHTML=`Area: ${this._area.toFixed(2)} ${this._units}`;const e=this.getRectData(this._handles[0].screenPosition,this._handles[1].screenPosition),i=this.adjustLabelTransform(this._label,this._handles[1].screenPosition.clone().add(e.paddingVector.multiplyScalar(15+this._label.offsetHeight/2)));this._rectangle.style.transform=`translate3D(${e.transformX}px, ${e.transformY}px, 0)`,this._rectangle.style.width=e.width+"px",this._rectangle.style.height=e.height+"px",this._ellipse.style.transform=`translate3D(${e.transformX}px, ${e.transformY}px, 0)`,this._ellipse.style.width=e.width+"px",this._ellipse.style.height=e.height+"px",this._label.style.transform="translate3D("+i.x+"px,"+i.y+"px, 0)"}free(){this.removeEventListeners(),this._handles.forEach((t=>{this.remove(t),t.free()})),this._handles=[],this._container.removeChild(this._rectangle),this._container.removeChild(this._ellipse),this._container.removeChild(this._label),this._mesh&&(this.remove(this._mesh),this._mesh.geometry.dispose(),this._mesh.geometry=null,this._mesh.material.dispose(),this._mesh.material=null,this._mesh=null),this._geometry&&(this._geometry.dispose(),this._geometry=null),this._material.vertexShader=null,this._material.fragmentShader=null,this._material.uniforms=null,this._material.dispose(),this._material=null,this._stack=null,super.free()}getMeasurements(){return{area:this._area,units:this._units}}get targetMesh(){return this._targetMesh}set targetMesh(t){this._targetMesh=t,this._handles.forEach((e=>e.targetMesh=t)),this.update()}get worldPosition(){return this._worldPosition}set worldPosition(t){this._handles[0].worldPosition.copy(t),this._handles[1].worldPosition.copy(t),this._worldPosition.copy(t),this.update()}get calibrationFactor(){return this._calibrationFactor}set calibrationFactor(t){this._calibrationFactor=t,this._units="cm",this.update()}},t.FrameModel=et,t.FreehandWidget=class extends wt{constructor(t,e,i={}){super(t,e,i),this._widgetType="Freehand",this._stack=i.stack,this._calibrationFactor=i.calibrationFactor||null,this._area=null,this._units=this._calibrationFactor||i.stack.frame[i.frameIndex].pixelSpacing?"cm":"units",this._initialized=!1,this._moving=!1,this._domHovered=!1,this._material=null,this._geometry=null,this._mesh=null,this._lines=[],this._label=null,this._handles=[];const s=St();let a=new s(t,e,i);this.add(a),this._handles.push(a),this._moveHandle=new s(t,e,i),this.add(this._moveHandle),this._moveHandle.hide(),this.onMove=this.onMove.bind(this),this.onHover=this.onHover.bind(this),this.create(),this.addEventListeners()}addEventListeners(){this._container.addEventListener("wheel",this.onMove),this._label.addEventListener("mouseenter",this.onHover),this._label.addEventListener("mouseleave",this.onHover)}removeEventListeners(){this._container.removeEventListener("wheel",this.onMove),this._label.removeEventListener("mouseenter",this.onHover),this._label.removeEventListener("mouseleave",this.onHover)}onHover(t){t&&this.hoverDom(t),this.hoverMesh();let e=!1;this._handles.forEach((t=>e=e||t.hovered)),this._hovered=e||this._domHovered,this._container.style.cursor=this._hovered?"pointer":"default"}hoverMesh(){}hoverDom(t){this._domHovered="mouseenter"===t.type}onStart(t){let e=!1;this._moveHandle.onMove(t,!0),this._handles.forEach((i=>{i.onStart(t),e=e||i.active})),this._active=e||this._domHovered,this._domHovered&&this._initialized&&(this._moving=!0,this._controls.enabled=!1),this.update()}onMove(t){let e=!1;if(this.active)if(this._dragged=!0,this._initialized){const e=this._moveHandle.worldPosition.clone();this._moveHandle.onMove(t,!0),this._mesh&&this.remove(this._mesh),this.updateDOMContent(!0),this._moving&&this._handles.forEach((t=>{t.worldPosition.add(this._moveHandle.worldPosition.clone().sub(e))}))}else{this._handles[this._handles.length-1].hovered=!1,this._handles[this._handles.length-1].active=!1,this._handles[this._handles.length-1].tracking=!1;let t=new(St())(this._targetMesh,this._controls,this._params);t.hovered=!0,t.active=!0,t.tracking=!0,this.add(t),this._handles.push(t),this.createLine()}this._handles.forEach((i=>{i.onMove(t),e=e||i.hovered})),this._hovered=e||this._domHovered,this._container.style.cursor=this._hovered?"pointer":"default",this.active&&this._handles.length>2&&this.pushPopHandle(),this.update()}onEnd(){if(this._handles.length<3)return;let t=!1;this._handles.slice(0,-1).forEach((e=>{e.onEnd(),t=t||e.active})),this._dragged||!this._handles[this._handles.length-1].tracking?(this._handles[this._handles.length-1].tracking=!1,this._handles[this._handles.length-1].onEnd()):this._handles[this._handles.length-1].tracking=!1,this._lines.length<this._handles.length&&this.createLine(),!this._dragged&&this._initialized||(this.updateMesh(),this.updateDOMContent()),!this._dragged&&this._active&&(this._selected=!this._selected,this._handles.forEach((t=>t.selected=this._selected))),this._active=t||this._handles[this._handles.length-1].active,this._dragged=!1,this._moving=!1,this._initialized=!0,this.update()}create(){this.createMaterial(),this.createDOM()}createMaterial(){this._material=new e.MeshBasicMaterial({side:e.DoubleSide}),this._material.transparent=!0,this._material.opacity=.2}createDOM(){this._label=document.createElement("div"),this._label.className="widgets-label";const t=document.createElement("div");let e=document.createElement("div");e.className="mean-sd",t.appendChild(e);let i=document.createElement("div");i.className="max-min",t.appendChild(i);let s=document.createElement("div");s.className="area",t.appendChild(s),this._label.appendChild(t),this._container.appendChild(this._label),this.updateDOMColor()}createLine(){const t=document.createElement("div");t.className="widgets-line",t.addEventListener("mouseenter",this.onHover),t.addEventListener("mouseleave",this.onHover),this._lines.push(t),this._container.appendChild(t)}hideDOM(){this._handles.forEach((t=>t.hideDOM())),this._lines.forEach((t=>t.style.display="none")),this._label.style.display="none"}showDOM(){this._handles.forEach((t=>t.showDOM())),this._lines.forEach((t=>t.style.display="")),this._label.style.display=""}update(){this.updateColor(),this._handles.forEach((t=>t.update())),this.updateMeshColor(),this.updateMeshPosition(),this.updateDOMColor(),this.updateDOMPosition()}updateMesh(){this._mesh&&this.remove(this._mesh);let t=[];this._handles.forEach((e=>t.push(e.worldPosition)));let i=n.centerOfMass(t),s=(new e.Vector3).subVectors(t[0],i).normalize(),a=(new e.Vector3).crossVectors((new e.Vector3).subVectors(t[0],i),(new e.Vector3).subVectors(t[1],i)),o=(new e.Vector3).crossVectors(s,a).normalize(),l=[];for(let a=0;a<t.length;a++){let n=new e.Vector3(t[a].x,t[a].y,t[a].z);n.direction=(new e.Vector3).subVectors(t[a],i).normalize();let r=s.dot(n.direction),h=o.dot(n.direction);n.xy={x:r,y:h},n.angle=Math.atan2(h,r)*(180/Math.PI),l.push(n)}this._shapeWarn=!1;const r=console.warn;console.warn=function(...t){return"three.ShapeUtils: Unable to triangulate polygon! in triangulate()"===t[0]&&(this._shapeWarn=!0),r.apply(console,t)}.bind(this);let h=new e.Shape;h.moveTo(l[0].xy.x,l[0].xy.y);for(let t=1;t<l.length;t++)h.lineTo(l[t].xy.x,l[t].xy.y);h.lineTo(l[0].xy.x,l[0].xy.y),this._geometry=new e.ShapeGeometry(h),console.warn=r,this._geometry.vertices=l,this._geometry.verticesNeedUpdate=!0,this._geometry.elementsNeedUpdate=!0,this.updateMeshColor(),this._mesh=new e.Mesh(this._geometry,this._material),this._mesh.visible=!0,this.add(this._mesh)}updateMeshColor(){this._material&&this._material.color.set(this._color)}updateMeshPosition(){this._geometry&&(this._geometry.verticesNeedUpdate=!0)}isPointOnLine(t,i,s){let a=new e.Vector3;return a.crossVectors(t.clone().sub(s),i.clone().sub(s)),!a.length()}pushPopHandle(){let t=this._handles[this._handles.length-3],e=this._handles[this._handles.length-2],i=this._handles[this._handles.length-1],s=this.isPointOnLine(t.worldPosition,e.worldPosition,i.worldPosition);return(s||t.screenPosition.distanceTo(i.screenPosition)<25)&&(this.remove(e),e.free(),this._handles[this._handles.length-2]=i,this._handles.pop(),this._container.removeChild(this._lines.pop())),s}updateDOMColor(){this._handles.length>=2&&this._lines.forEach((t=>t.style.backgroundColor=this._color)),this._label.style.borderColor=this._color}updateDOMContent(t){const e=this._label.querySelector(".mean-sd"),i=this._label.querySelector(".max-min"),s=this._label.querySelector(".area");if(t)return e.innerHTML="",i.innerHTML="",void(s.innerHTML="");const a=this._stack.frame[this._params.frameIndex].ultrasoundRegions||[];if(this._area=n.getGeometryArea(this._geometry),this._calibrationFactor)this._area*=Math.pow(this._calibrationFactor,2);else if(a&&a.length>0&&this._stack.lps2IJK){let t,e,i=!0;this._handles.forEach((s=>{t=this.getRegionByXY(a,n.worldToData(this._stack.lps2IJK,s.worldPosition)),(null===t||"cm"!==a[t].unitsX||void 0!==e&&e!==t)&&(i=!1),e=t})),i?(this._area*=Math.pow(a[t].deltaX,2),this._units="cm"):this._stack.frame[this._params.frameIndex].pixelSpacing?(this._area/=100,this._units="cm"):this._units="units"}else"cm"===this._units&&(this._area/=100);let o="units"===this._units?"Calibration is required to display the area in cm. ":"";this._shapeWarn&&(o+="Values may be incorrect due to triangulation error."),""===o||this._label.hasAttribute("title")?""===o&&this._label.hasAttribute("title")&&(this._label.removeAttribute("title"),this._label.style.color=this._colors.text):(this._label.setAttribute("title",o),this._label.style.color=this._colors.error);const l=n.getRoI(this._mesh,this._camera,this._stack);null!==l?(e.innerHTML=`Mean: ${l.mean.toFixed(1)} / SD: ${l.sd.toFixed(1)}`,i.innerHTML=`Max: ${l.max.toFixed()} / Min: ${l.min.toFixed()}`):(e.innerHTML="",i.innerHTML=""),s.innerHTML=`Area: ${this._area.toFixed(2)} ${this._units}`}updateDOMPosition(){if(this._handles.length<2)return;let t=null;this._lines.forEach(((e,i)=>{const s=this.getLineData(this._handles[i].screenPosition,this._handles[i+1===this._handles.length?0:i+1].screenPosition);e.style.transform=`translate3D(${s.transformX}px, ${s.transformY}px, 0)\n\t\t\t\t\t\t\t\trotate(${s.transformAngle}rad)`,e.style.width=s.length+"px",(null===t||t.y<this._handles[i].screenPosition.y)&&(t=this._handles[i].screenPosition.clone())})),this._initialized&&(t.y+=15+this._label.offsetHeight/2,t=this.adjustLabelTransform(this._label,t),this._label.style.transform=`translate3D(${t.x}px, ${t.y}px, 0)`)}free(){this.removeEventListeners(),this._handles.forEach((t=>{this.remove(t),t.free()})),this._handles=[],this.remove(this._moveHandle),this._moveHandle.free(),this._moveHandle=null,this._lines.forEach((t=>{t.removeEventListener("mouseenter",this.onHover),t.removeEventListener("mouseleave",this.onHover),this._container.removeChild(t)})),this._lines=[],this._container.removeChild(this._label),this._mesh&&(this.remove(this._mesh),this._mesh.geometry.dispose(),this._mesh.geometry=null,this._mesh.material.dispose(),this._mesh.material=null,this._mesh=null),this._geometry&&(this._geometry.dispose(),this._geometry=null),this._material.vertexShader=null,this._material.fragmentShader=null,this._material.uniforms=null,this._material.dispose(),this._material=null,this._stack=null,super.free()}getMeasurements(){return{area:this._area,units:this._units}}get targetMesh(){return this._targetMesh}set targetMesh(t){this._targetMesh=t,this._handles.forEach((e=>e.targetMesh=t)),this._moveHandle.targetMesh=t,this.update()}get worldPosition(){return this._worldPosition}set worldPosition(t){this._handles.forEach((e=>e._worldPosition.copy(t))),this._worldPosition.copy(t),this.update()}get calibrationFactor(){return this._calibrationFactor}set calibrationFactor(t){this._calibrationFactor=t,this._units="cm",this.update()}},t.HandleWidget=St,t.IntersectionsCore=l,t.LayerFragmentShader=class{constructor(t){this._uniforms=t,this._functions={},this._main=""}functions(){""===this._main&&this.main();let t="";for(let e in this._functions)t+=this._functions[e]+"\n";return t}uniforms(){let t="";for(let e in this._uniforms){let i=this._uniforms[e];t+=`uniform ${i.typeGLSL} ${e}`,i&&i.length&&(t+=`[${i.length}]`),t+=";\n"}return t}main(){this._main="\nvoid main(void) {\n\n\tvec2 texc = vec2(((vProjectedCoords.x / vProjectedCoords.w) + 1.0 ) / 2.0,\n\t\t\t\t\t\t\t\t((vProjectedCoords.y / vProjectedCoords.w) + 1.0 ) / 2.0 );\n\n\t// just silence warning for\n\t// vec4 dummy = vPos;\n\n\t//The back position is the world space position stored in the texture.\n\tvec4 baseColor0 = texture2D(uTextureBackTest0, texc);\n\tvec4 baseColor1 = texture2D(uTextureBackTest1, texc);\n\n\tif( uTrackMouse == 1 ){\n\n\t\t\tif( vProjectedCoords.x < uMouse.x ){\n\n\t\t\t\tgl_FragColor = baseColor0;\n\n\t\t\t}\n\t\t\telse{\n\n\t\t\t\tgl_FragColor = mix( baseColor0, baseColor1, uOpacity1 );\n\n\t\t\t}\n\n\t}\n\telse{\n\n\t\tif( uType1 == 0 ){\n\n\t\t\t//merge an image into\n\t\t\tgl_FragColor = mix( baseColor0, baseColor1, uOpacity1 );\n\n\t\t}\n\t\telse{\n\n\t\t\tfloat opacity = baseColor1.a;\n\t\t\tgl_FragColor = mix( baseColor0, baseColor1, opacity * uOpacity1 );\n\n\t\t}\n\n\t}\n\n\treturn;\n}\n\t "}compute(){return`\n// uniforms\n${this.uniforms()}\n\n// varying (should fetch it from vertex directly)\n// varying vec4\t\t\tvPos;\nvarying vec4\t\t\tvProjectedCoords;\n\n// tailored functions\n${this.functions()}\n\n// main loop\n${this._main}\n\t\t\t`}},t.LayerUniformShader=class{static uniforms(){return{uTextureBackTest0:{type:"t",value:[],typeGLSL:"sampler2D"},uTextureBackTest1:{type:"t",value:[],typeGLSL:"sampler2D"},uOpacity0:{type:"f",value:1,typeGLSL:"float"},uOpacity1:{type:"f",value:1,typeGLSL:"float"},uType0:{type:"i",value:0,typeGLSL:"int"},uType1:{type:"i",value:1,typeGLSL:"int"},uTrackMouse:{type:"i",value:0,typeGLSL:"int"},uMouse:{type:"v2",value:new e.Vector2,typeGLSL:"vec2"}}}},t.LayerVertexShader=class{compute(){return"\n// varying vec4 vPos;\nvarying vec4 vProjectedCoords;\n\n//\n// main\n//\nvoid main() {\n\n\tvec4 vPos = modelMatrix * vec4(position, 1.0 );\n\tvProjectedCoords =\tprojectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0 );\n\n}\n\t\t\t\t"}},t.LocalizerFragmentShader=D,t.LocalizerHelper=E,t.LocalizerUniformShader=L,t.LocalizerVertexShader=I,t.LutHelper=T,t.MghParser=bt,t.NiftiParser=pt,t.NrrdParser=yt,t.OrbitControl=_,t.OrthographicCamera=r,t.PeakVelocityWidget=class extends wt{constructor(t,e,i={}){if(super(t,e,i),this._widgetType="PeakVelocity",this._regions=i.ultrasoundRegions||[],this._regions.length<1)throw new Error("Ultrasound regions should not be empty!");if(this._velocity=null,this._gradient=null,this._container.style.cursor="pointer",this._controls.enabled=!1,this._initialized=!1,this._active=!0,this._domHovered=!1,this._initialRegion=this.getRegionByXY(this._regions,n.worldToData(i.lps2IJK,i.worldPosition)),null===this._initialRegion)throw new Error("Invalid initial UltraSound region!");this._line=null,this._label=null;const s=St();this._handle=new s(t,e,i),this.add(this._handle),this._moveHandle=new s(t,e,i),this.add(this._moveHandle),this._moveHandle.hide(),this.create(),this.onMove=this.onMove.bind(this),this.onHover=this.onHover.bind(this),this.addEventListeners()}addEventListeners(){this._container.addEventListener("wheel",this.onMove),this._line.addEventListener("mouseenter",this.onHover),this._line.addEventListener("mouseleave",this.onHover),this._label.addEventListener("mouseenter",this.onHover),this._label.addEventListener("mouseleave",this.onHover)}removeEventListeners(){this._container.removeEventListener("wheel",this.onMove),this._line.removeEventListener("mouseenter",this.onHover),this._line.removeEventListener("mouseleave",this.onHover),this._label.removeEventListener("mouseenter",this.onHover),this._label.removeEventListener("mouseleave",this.onHover)}onHover(t){t&&this.hoverDom(t),this._hovered=this._handle.hovered||this._domHovered,this._container.style.cursor=this._hovered?"pointer":"default"}hoverDom(t){this._domHovered="mouseenter"===t.type}onStart(t){this._moveHandle.onMove(t,!0),this._handle.onStart(t),this._active=this._handle.active||this._domHovered,this._domHovered&&(this._controls.enabled=!1),this.update()}onMove(t){if(this._active){const e=this._moveHandle.worldPosition.clone();this._moveHandle.onMove(t,!0);const i=this._moveHandle.worldPosition.clone().sub(e);if(!this.isCorrectRegion(i))return void this._moveHandle.worldPosition.copy(e);this._handle.active||this._handle.worldPosition.add(i),this._dragged=!0}else this.onHover(null);this._handle.onMove(t),this.update()}onEnd(){this._handle.onEnd(),!this._dragged&&this._active&&this._initialized&&(this._selected=!this._selected,this._handle.selected=this._selected),this._initialized=!0,this._active=!1,this._dragged=!1,this.update()}isCorrectRegion(t){const e=this.getRegionByXY(this._regions,n.worldToData(this._params.lps2IJK,this._handle.worldPosition.clone().add(t)));return null!==e&&e===this._initialRegion&&"cm/sec"===this._regions[e].unitsY}create(){this.createDOM()}createDOM(){this._line=document.createElement("div"),this._line.className="widgets-dashline",this._container.appendChild(this._line),this._label=document.createElement("div"),this._label.className="widgets-label";let t=document.createElement("div"),e=document.createElement("div");e.className="peakVelocity",t.appendChild(e);let i=document.createElement("div");i.className="gradient",t.appendChild(i),this._label.appendChild(t),this._container.appendChild(this._label),this.updateDOMColor()}update(){this.updateColor(),this._handle.update(),this._worldPosition.copy(this._handle.worldPosition),this.updateDOM()}updateDOM(){this.updateDOMColor();const t=n.worldToData(this._params.lps2IJK,this._worldPosition),e=this._regions[this.getRegionByXY(this._regions,t)],i=this.getPointInRegion(e,t);this._velocity=Math.abs(i.y/100),this._gradient=4*Math.pow(this._velocity,2),this._label.querySelector(".peakVelocity").innerHTML=`${this._velocity.toFixed(2)} m/s`,this._label.querySelector(".gradient").innerHTML=`${this._gradient.toFixed(2)} mmhg`;const s=this.adjustLabelTransform(this._label,this._handle.screenPosition,!0);this._line.style.transform=`translate3D(${s.x-(t.x-e.x0)*this._camera.zoom}px, ${s.y}px, 0)`,this._line.style.width=(e.x1-e.x0)*this._camera.zoom+"px",this._label.style.transform=`translate3D(${s.x+10}px, ${s.y+10}px, 0)`}updateDOMColor(){this._line.style.backgroundColor=this._color,this._label.style.borderColor=this._color}hideDOM(){this._line.style.display="none",this._label.style.display="none",this._handle.hideDOM()}showDOM(){this._line.style.display="",this._label.style.display="",this._handle.showDOM()}free(){this.removeEventListeners(),this.remove(this._handle),this._handle.free(),this._handle=null,this.remove(this._moveHandle),this._moveHandle.free(),this._moveHandle=null,this._container.removeChild(this._line),this._container.removeChild(this._label),super.free()}getMeasurements(){return{velocity:this._velocity,gradient:this._gradient}}get targetMesh(){return this._targetMesh}set targetMesh(t){this._targetMesh=t,this._handle.targetMesh=t,this._moveHandle.targetMesh=t,this.update()}get worldPosition(){return this._worldPosition}set worldPosition(t){this._handle.worldPosition.copy(t),this._moveHandle.worldPosition.copy(t),this._worldPosition.copy(t),this.update()}get active(){return this._active}set active(t){this._active=t,this._controls.enabled=!this._active,this.update()}},t.PolygonWidget=class extends wt{constructor(t,e,i={}){super(t,e,i),this._widgetType="Polygon",this._stack=i.stack,this._calibrationFactor=i.calibrationFactor||null,this._area=null,this._units=this._calibrationFactor||i.stack.frame[i.frameIndex].pixelSpacing?"cm":"units",this._initialized=!1,this._newHandleRequired=!0,this._moving=!1,this._domHovered=!1,this._material=null,this._geometry=null,this._mesh=null,this._lines=[],this._label=null,this._handles=[];const s=St();let a=new s(t,e,i);this.add(a),this._handles.push(a),this._moveHandle=new s(t,e,i),this.add(this._moveHandle),this._moveHandle.hide(),this.onDoubleClick=this.onDoubleClick.bind(this),this.onMove=this.onMove.bind(this),this.onHover=this.onHover.bind(this),this.create(),this.addEventListeners()}addEventListeners(){this._container.addEventListener("dblclick",this.onDoubleClick),this._container.addEventListener("wheel",this.onMove),this._label.addEventListener("mouseenter",this.onHover),this._label.addEventListener("mouseleave",this.onHover)}removeEventListeners(){this._container.removeEventListener("dblclick",this.onDoubleClick),this._container.removeEventListener("wheel",this.onMove),this._label.removeEventListener("mouseenter",this.onHover),this._label.removeEventListener("mouseleave",this.onHover)}onHover(t){t&&this.hoverDom(t),this.hoverMesh();let e=!1;this._handles.forEach((t=>e=e||t.hovered)),this._hovered=e||this._domHovered,this._container.style.cursor=this._hovered?"pointer":"default"}hoverMesh(){}hoverDom(t){this._domHovered="mouseenter"===t.type}onStart(t){let e=!1;this._handles.forEach((i=>{i.onStart(t),e=e||i.active})),this._initialized&&(this._moveHandle.onMove(t,!0),this._active=e||this._domHovered,this._domHovered&&this._initialized&&(this._moving=!0,this._controls.enabled=!1),this.update())}onMove(t){let e=!1;if(this.active)if(this._dragged=!0,this._newHandleRequired&&!this._initialized){this._handles[this._handles.length-1].hovered=!1,this._handles[this._handles.length-1].active=!1,this._handles[this._handles.length-1].tracking=!1;let t=new(St())(this._targetMesh,this._controls,this._params);t.hovered=!0,t.active=!0,t.tracking=!0,this.add(t),this._handles.push(t),this.createLine(),this._newHandleRequired=!1}else{const e=this._moveHandle.worldPosition.clone();this._moveHandle.onMove(t,!0),this._mesh&&this.remove(this._mesh),this.updateDOMContent(!0),this._moving&&this._handles.forEach((t=>{t.worldPosition.add(this._moveHandle.worldPosition.clone().sub(e))}))}this._handles.forEach((i=>{i.onMove(t),e=e||i.hovered})),this._hovered=e||this._domHovered,this._container.style.cursor=this._hovered?"pointer":"default",this.update()}onEnd(){let t=this._handles.length,e=!1;!this._initialized&&t>1&&this._handles[t-2].screenPosition.distanceTo(this._handles[t-1].screenPosition)<10||(this._handles.forEach((t=>{t.onEnd(),e=e||t.active})),this._initialized?(this._dragged&&(this.updateMesh(),this.updateDOMContent()),!this._dragged&&this._active&&(this._selected=!this._selected,this._handles.forEach((t=>t.selected=this._selected))),this._active=e||this._handles[t-1].active,this._dragged=!1,this._moving=!1,this.update()):this._newHandleRequired=!0)}onDoubleClick(){let t=this._handles.length;t<3||this._initialized||t>1&&this._handles[t-2].screenPosition.distanceTo(this._handles[t-1].screenPosition)<10||(this._handles[t-1].tracking=!1,this._handles.forEach((t=>t.onEnd())),this._active=!1,this._dragged=!1,this._moving=!1,this._initialized=!0,this.updateMesh(),this.updateDOMContent(),this.update())}create(){this.createMaterial(),this.createDOM()}createMaterial(){this._material=new e.MeshBasicMaterial({side:e.DoubleSide}),this._material.transparent=!0,this._material.opacity=.2}createDOM(){this.createLine(),this._label=document.createElement("div"),this._label.className="widgets-label";const t=document.createElement("div");let e=document.createElement("div");e.className="mean-sd",t.appendChild(e);let i=document.createElement("div");i.className="max-min",t.appendChild(i);let s=document.createElement("div");s.className="area",t.appendChild(s),this._label.appendChild(t),this._container.appendChild(this._label),this.updateDOMColor()}createLine(){const t=document.createElement("div");t.className="widgets-line",t.addEventListener("mouseenter",this.onHover),t.addEventListener("mouseleave",this.onHover),this._lines.push(t),this._container.appendChild(t)}hideDOM(){this._handles.forEach((t=>t.hideDOM())),this._lines.forEach((t=>t.style.display="none")),this._label.style.display="none"}showDOM(){this._handles.forEach((t=>t.showDOM())),this._lines.forEach((t=>t.style.display="")),this._label.style.display=""}update(){this.updateColor(),this._handles.forEach((t=>t.update())),this.updateMeshColor(),this.updateMeshPosition(),this.updateDOMColor(),this.updateDOMPosition()}updateMesh(){this._mesh&&this.remove(this._mesh);let t=[];this._handles.forEach((e=>t.push(e.worldPosition)));let i=n.centerOfMass(t),s=(new e.Vector3).subVectors(t[0],i).normalize(),a=(new e.Vector3).crossVectors((new e.Vector3).subVectors(t[0],i),(new e.Vector3).subVectors(t[1],i)),o=(new e.Vector3).crossVectors(s,a).normalize(),l=[];for(let a=0;a<t.length;a++){let n=new e.Vector3(t[a].x,t[a].y,t[a].z);n.direction=(new e.Vector3).subVectors(t[a],i).normalize();let r=s.dot(n.direction),h=o.dot(n.direction);n.xy={x:r,y:h},n.angle=Math.atan2(h,r)*(180/Math.PI),l.push(n)}this._shapeWarn=!1;const r=console.warn;console.warn=function(...t){return"THREE.ShapeUtils: Unable to triangulate polygon! in triangulate()"===t[0]&&(this._shapeWarn=!0),r.apply(console,t)}.bind(this);let h=new e.Shape;h.moveTo(l[0].xy.x,l[0].xy.y);for(let t=1;t<l.length;t++)h.lineTo(l[t].xy.x,l[t].xy.y);h.lineTo(l[0].xy.x,l[0].xy.y),this._geometry=new e.ShapeGeometry(h),console.warn=r,this._geometry.vertices=l,this._geometry.verticesNeedUpdate=!0,this._geometry.elementsNeedUpdate=!0,this.updateMeshColor(),this._mesh=new e.Mesh(this._geometry,this._material),this._mesh.visible=!0,this.add(this._mesh)}updateMeshColor(){this._material&&this._material.color.set(this._color)}updateMeshPosition(){this._geometry&&(this._geometry.verticesNeedUpdate=!0)}updateDOMColor(){this._lines.forEach((t=>t.style.backgroundColor=this._color)),this._label.style.borderColor=this._color}updateDOMContent(t){const e=this._label.querySelector(".mean-sd"),i=this._label.querySelector(".max-min"),s=this._label.querySelector(".area");if(t)return e.innerHTML="",i.innerHTML="",void(s.innerHTML="");const a=this._stack.frame[this._params.frameIndex].ultrasoundRegions||[];if(this._area=n.getGeometryArea(this._geometry),this._calibrationFactor)this._area*=Math.pow(this._calibrationFactor,2);else if(a&&a.length>0&&this._stack.lps2IJK){let t,e,i=!0;this._handles.forEach((s=>{t=this.getRegionByXY(a,n.worldToData(this._stack.lps2IJK,s.worldPosition)),(null===t||"cm"!==a[t].unitsX||void 0!==e&&e!==t)&&(i=!1),e=t})),i?(this._area*=Math.pow(a[t].deltaX,2),this._units="cm"):this._stack.frame[this._params.frameIndex].pixelSpacing?(this._area/=100,this._units="cm"):this._units="units"}else"cm"===this._units&&(this._area/=100);let o="units"===this._units?"Calibration is required to display the area in cm. ":"";this._shapeWarn&&(o+="Values may be incorrect due to triangulation error."),""===o||this._label.hasAttribute("title")?""===o&&this._label.hasAttribute("title")&&(this._label.removeAttribute("title"),this._label.style.color=this._colors.text):(this._label.setAttribute("title",o),this._label.style.color=this._colors.error);const l=n.getRoI(this._mesh,this._camera,this._stack);null!==l?(e.innerHTML=`Mean: ${l.mean.toFixed(1)} / SD: ${l.sd.toFixed(1)}`,i.innerHTML=`Max: ${l.max.toFixed()} / Min: ${l.min.toFixed()}`):(e.innerHTML="",i.innerHTML=""),s.innerHTML=`Area: ${this._area.toFixed(2)} ${this._units}`}updateDOMPosition(){let t=null;this._lines.forEach(((e,i)=>{const s=this.getLineData(this._handles[i].screenPosition,this._handles[i+1===this._handles.length?0:i+1].screenPosition);e.style.transform=`translate3D(${s.transformX}px, ${s.transformY}px, 0)\n\t\t\t\t\t\t\t\t\t\trotate(${s.transformAngle}rad)`,e.style.width=s.length+"px",(null===t||t.y<this._handles[i].screenPosition.y)&&(t=this._handles[i].screenPosition.clone())})),this._initialized&&(t.y+=15+this._label.offsetHeight/2,t=this.adjustLabelTransform(this._label,t),this._label.style.transform=`translate3D(${t.x}px, ${t.y}px, 0)`)}free(){this.removeEventListeners(),this._handles.forEach((t=>{this.remove(t),t.free()})),this._handles=[],this.remove(this._moveHandle),this._moveHandle.free(),this._moveHandle=null,this._lines.forEach((t=>{t.removeEventListener("mouseenter",this.onHover),t.removeEventListener("mouseleave",this.onHover),this._container.removeChild(t)})),this._lines=[],this._container.removeChild(this._label),this._mesh&&(this.remove(this._mesh),this._mesh.geometry.dispose(),this._mesh.geometry=null,this._mesh.material.dispose(),this._mesh.material=null,this._mesh=null),this._geometry&&(this._geometry.dispose(),this._geometry=null),this._material.vertexShader=null,this._material.fragmentShader=null,this._material.uniforms=null,this._material.dispose(),this._material=null,this._stack=null,super.free()}getMeasurements(){return{area:this._area,units:this._units}}get targetMesh(){return this._targetMesh}set targetMesh(t){this._targetMesh=t,this._handles.forEach((e=>e.targetMesh=t)),this._moveHandle.targetMesh=t,this.update()}get worldPosition(){return this._worldPosition}set worldPosition(t){this._handles.forEach((e=>e.worldPosition.copy(t))),this._worldPosition.copy(t),this.update()}get calibrationFactor(){return this._calibrationFactor}set calibrationFactor(t){this._calibrationFactor=t,this._units="cm",this.update()}},t.PressureHalfTimeWidget=class extends wt{constructor(t,e,i={}){if(super(t,e,i),this._widgetType="PressureHalfTime",this._regions=i.ultrasoundRegions||[],this._regions.length<1)throw new Error("Ultrasound regions should not be empty!");if(this._vMax=null,this._gMax=null,this._pht=null,this._mva=null,this._dt=null,this._ds=null,this._domHovered=!1,this._initialRegion=this.getRegionByXY(this._regions,n.worldToData(i.lps2IJK,i.worldPosition)),null===this._initialRegion)throw new Error("Invalid initial UltraSound region!");this._material=null,this._geometry=null,this._mesh=null,this._line=null,this._label=null,this._handles=[];const s=St();let a;for(let o=0;o<2;o++)a=new s(t,e,i),this.add(a),this._handles.push(a);this._handles[1].active=!0,this._handles[1].tracking=!0,this._moveHandle=new s(t,e,i),this.add(this._moveHandle),this._handles.push(this._moveHandle),this._moveHandle.hide(),this.create(),this.onMove=this.onMove.bind(this),this.onHover=this.onHover.bind(this),this.addEventListeners()}addEventListeners(){this._container.addEventListener("wheel",this.onMove),this._line.addEventListener("mouseenter",this.onHover),this._line.addEventListener("mouseleave",this.onHover),this._label.addEventListener("mouseenter",this.onHover),this._label.addEventListener("mouseleave",this.onHover)}removeEventListeners(){this._container.removeEventListener("wheel",this.onMove),this._line.removeEventListener("mouseenter",this.onHover),this._line.removeEventListener("mouseleave",this.onHover),this._label.removeEventListener("mouseenter",this.onHover),this._label.removeEventListener("mouseleave",this.onHover)}onHover(t){t&&this.hoverDom(t),this.hoverMesh(),this._hovered=this._handles[0].hovered||this._handles[1].hovered||this._domHovered,this._container.style.cursor=this._hovered?"pointer":"default"}hoverMesh(){}hoverDom(t){this._domHovered="mouseenter"===t.type}onStart(t){this._moveHandle.onMove(t,!0),this._handles[0].onStart(t),this._handles[1].onStart(t),this._active=this._handles[0].active||this._handles[1].active||this._domHovered,this._domHovered&&(this._controls.enabled=!1),this.update()}onMove(t){if(this._active){const e=this._moveHandle.worldPosition.clone();this._moveHandle.onMove(t,!0);const i=this._moveHandle.worldPosition.clone().sub(e);if(!this.isCorrectRegion(i))return void this._moveHandle.worldPosition.copy(e);this._handles[0].active||this._handles[1].active||this._handles.slice(0,-1).forEach((t=>{t.worldPosition.add(i)})),this._dragged=!0}else this.onHover(null);this._handles[0].onMove(t),this._handles[1].onMove(t),this.update()}onEnd(){this._handles[0].onEnd(),this._handles[1].tracking&&this._handles[0].screenPosition.distanceTo(this._handles[1].screenPosition)<10||(this._dragged||!this._active||this._handles[1].tracking||(this._selected=!this._selected,this._handles[0].selected=this._selected),this._dragged||!this._handles[1].tracking?(this._handles[1].tracking=!1,this._handles[1].onEnd()):this._handles[1].tracking=!1,this._handles[1].selected=this._selected,this._active=this._handles[0].active||this._handles[1].active,this._dragged=!1,this.update())}isCorrectRegion(t){const e=!(this._handles[0].active||this._handles[1].active);let i=!0;return(this._handles[0].active||e)&&(i=i&&this.checkHandle(0,t)),(this._handles[1].active||e)&&(i=i&&this.checkHandle(1,t)),i}checkHandle(t,e){const i=this.getRegionByXY(this._regions,n.worldToData(this._params.lps2IJK,this._handles[t].worldPosition.clone().add(e)));return null!==i&&i===this._initialRegion&&"cm/sec"===this._regions[i].unitsY}create(){this.createMesh(),this.createDOM()}createMesh(){this._geometry=new BufferGeometry;const t=new Float32Array(6);this._geometry.setAttribute("position",new BufferAttribute(t,3));let i=0;t[i++]=this._handles[0].worldPosition.x,t[i++]=this._handles[0].worldPosition.y,t[i++]=this._handles[0].worldPosition.z,t[i++]=this._handles[1].worldPosition.x,t[i++]=this._handles[1].worldPosition.y,t[i++]=this._handles[1].worldPosition.z,this._material=new e.LineBasicMaterial,this.updateMeshColor(),this._mesh=new e.Line(this._geometry,this._material),this._mesh.visible=!0,this.add(this._mesh)}createDOM(){this._line=document.createElement("div"),this._line.className="widgets-line",this._container.appendChild(this._line),this._label=document.createElement("div"),this._label.className="widgets-label";const t=document.createElement("div");["vmax","gmax","pht","mva","dt","ds"].forEach((e=>{const i=document.createElement("div");i.className=e,t.appendChild(i)})),this._label.appendChild(t),this._container.appendChild(this._label),this.updateDOMColor()}hideDOM(){this._line.style.display="none",this._label.style.display="none",this._handles.forEach((t=>t.hideDOM()))}showDOM(){this._line.style.display="",this._label.style.display="",this._handles[0].showDOM(),this._handles[1].showDOM()}update(){this.updateColor(),this._handles[0].update(),this._handles[1].update(),this.updateValues(),this.updateMeshColor(),this.updateMeshPosition(),this.updateDOM()}updateValues(){const t=this.getUsPoint(this._regions,n.worldToData(this._params.lps2IJK,this._handles[0].worldPosition)),e=this.getUsPoint(this._regions,n.worldToData(this._params.lps2IJK,this._handles[1].worldPosition)),i=Math.abs(t.y/100),s=Math.abs(e.y/100),a=Math.abs(t.x),o=Math.abs(e.x),l=this._vMax===i?a:o;this._vMax=Math.max(i,s),this._gMax=4*Math.pow(this._vMax,2);const r=this._vMax/Math.sqrt(2),h=(i-r)/(s-r),c=i/s;this._pht=1===h?Number.POSITIVE_INFINITY:1e3*Math.abs(l-(a-h*o)/(1-h)),this._mva=220/this._pht,this._dt=1===c?Number.POSITIVE_INFINITY:1e3*Math.abs(l-(a-c*o)/(1-c)),this._ds=0===this._dt?Number.POSITIVE_INFINITY:this._vMax/this._dt*1e3}updateMeshColor(){this._material&&this._material.color.set(this._color)}updateMeshPosition(){this._geometry&&(this._geometry.verticesNeedUpdate=!0)}updateDOM(){this.updateDOMColor();const t=this.getLineData(this._handles[0].screenPosition,this._handles[1].screenPosition);this._line.style.transform=`translate3D(${t.transformX}px, ${t.transformY}px, 0)\n\t\t\t\t\t\t\t\trotate(${t.transformAngle}rad)`,this._line.style.width=t.length+"px",this._label.querySelector(".vmax").innerHTML=`Vmax: ${this._vMax.toFixed(2)} m/s`,this._label.querySelector(".gmax").innerHTML=`Gmax: ${this._gMax.toFixed(2)} mmhg`,this._label.querySelector(".pht").innerHTML=`PHT: ${this._pht.toFixed(1)} ms`,this._label.querySelector(".mva").innerHTML=`MVA: ${this._mva.toFixed(2)} cm`,this._label.querySelector(".dt").innerHTML=`DT: ${this._dt.toFixed(1)} ms`,this._label.querySelector(".ds").innerHTML=`DS: ${this._ds.toFixed(2)} m/s`;let e=Math.abs(t.transformAngle);e>Math.PI/2&&(e=Math.PI-e);const i=Math.tan(e)<this._label.offsetHeight/this._label.offsetWidth?this._label.offsetWidth/2/Math.cos(e)+15:this._label.offsetHeight/2/Math.cos(Math.PI/2-e)+15,s=t.line.normalize().multiplyScalar(i),a=t.length>2*i?this._handles[1].screenPosition.clone().sub(s):this._handles[1].screenPosition.clone().add(s),o=this.adjustLabelTransform(this._label,a);this._label.style.transform=`translate3D(${o.x}px, ${o.y}px, 0)`}updateDOMColor(){this._line.style.backgroundColor=this._color,this._label.style.borderColor=this._color}free(){this.removeEventListeners(),this._handles.forEach((t=>{this.remove(t),t.free()})),this._handles=[],this._container.removeChild(this._line),this._container.removeChild(this._label),this.remove(this._mesh),this._mesh.geometry.dispose(),this._mesh.geometry=null,this._mesh.material.dispose(),this._mesh.material=null,this._mesh=null,this._geometry.dispose(),this._geometry=null,this._material.vertexShader=null,this._material.fragmentShader=null,this._material.uniforms=null,this._material.dispose(),this._material=null,super.free()}getMeasurements(){return{vMax:this._vMax,gMax:this._gMax,pht:this._pht,mva:this._mva,dt:this._dt,ds:this._ds}}get targetMesh(){return this._targetMesh}set targetMesh(t){this._targetMesh=t,this._handles.forEach((e=>e.targetMesh=t)),this.update()}get worldPosition(){return this._worldPosition}set worldPosition(t){this._handles[0].worldPosition.copy(t),this._handles[1].worldPosition.copy(t),this._worldPosition.copy(t),this.update()}},t.ProgressBarEventBasedHelper=class{constructor(t,e){t&&this._isFunction(t.emit)?(n.isString(e)?this._dom=document.getElementById(e):this._dom=e,n.isElement(this._dom)?(this._emitter=t,this.initContainerDom(),this.initEventListenner(),this.loaded=0,this.totalFile=0):console.error("please give the id of container dom or directly a dom instance")):console.error("please give the this._emitter instance")}_isFunction(t){return"[object Function]"===Object.prototype.toString.call(t)}initEventListenner(){const t=this;this._emitter.on("load-start",(function(e){const i=e.files.length;t.totalFile=i,t._domTotalFile.innerHTML=i})),this._emitter.on("fetch-start",(function(e){const i=document.createElement("li"),s=document.createElement("div");s.innerHTML="file: "+e.file,s.style.color="#ffffff",i.append(s),i.className="fetch-file",i.id="file-"+e.file,i.style.marginBottom="7px",i.style.border="1px solid #ffffff;",i.style.width="60%";const a=document.createElement("div");a.id="file-fetch-"+e.file,a.style.width="0%",i.append(a),t._domProcessList.append(i)})),this._emitter.on("fetch-progress",(function(t){const e="file-fetch-"+t.file,i=document.getElementById(e);i.style.width=t.loaded/t.total*100+"%",i.style.border="1px solid red"})),this._emitter.on("fetch-success",(function(t){const e=document.getElementById("file-"+t.file),i=document.createElement("div");i.id="file-result-"+t.file,i.innerHTML="fetch-success",i.style.color="#ffffff",e.append(i)})),this._emitter.on("fetch-error",(function(t){})),this._emitter.on("fetch-abort",(function(t){})),this._emitter.on("fetch-end",(function(t){})),this._emitter.on("fetch-timeout",(function(t){})),this._emitter.on("parse-start",(function(t){const e=document.getElementById("file-"+t.file),i=document.createElement("div");i.id="file-parse-"+t.file,i.style.width="0%",e.append(i)})),this._emitter.on("parsing",(function(t){const e="file-parse-"+t.file,i=document.getElementById(e);i.style.width=t.parsed/t.total*100+"%",i.style.border="1px solid yellow"})),this._emitter.on("parse-success",(function(e){t.loaded+=1,t._domCurrentFile.innerHTML=t.loaded,t._domCurrentProgress.style.width=t.loaded/t.totalFile*100+"%";const i=document.getElementById("file-"+e.file),s=document.createElement("div");s.id="file-result-"+e.file,s.innerHTML="parse-success",s.style.color="#ffffff",i.append(s)}))}initContainerDom(){const t=document.createElement("div");t.innerHTML='\n\t\t\t<div id="ami-progress-bar-container" style="background-color: rgb(33, 33, 33); color: #ffffff;">\n\t\t\t<div>\n\t\t\t<label for="progress-bar" id="progress-label" style="width: 60%; border: 1px solid #ffffff; text-align: center;">\n\t\t\t<span id="current-file-index">0</span>\n\t\t\t<span id="total-file">0</span>\n\t\t\t</label>\n\t\t\t<div id="progress-bar" style="width: 60%; border: 1px solid #ffffff; text-align: center;">\n\t\t\t<div id="current-progress" style="border: 1px solid red; width: 0%;"></div>\n\t\t\t</div>\n\t\t\t</div>\n\t\t\t<ul id="process-list" style="list-style-type: none; padding: 0; overflow-y: auto;">\n\t\t\t</ul>\n\t\t\t</div>',this._dom.append(t),this._domCurrentFile=document.getElementById("current-file-index"),this._domTotalFile=document.getElementById("total-file"),this._domProcessList=document.getElementById("process-list"),this._domCurrentProgress=document.getElementById("current-progress")}},t.ProgressBarHelper=O,t.RectangleWidget=class extends wt{constructor(t,e,i={}){super(t,e,i),this._widgetType="Rectangle",this._stack=i.stack,this._calibrationFactor=i.calibrationFactor||null,this._area=null,this._units=this._calibrationFactor||i.stack.frame[i.frameIndex].pixelSpacing?"cm":"units",this._moving=!1,this._domHovered=!1,this._material=null,this._geometry=null,this._mesh=null,this._rectangle=null,this._label=null,this._handles=[];const s=St();let a;for(let o=0;o<2;o++)a=new s(t,e,i),this.add(a),this._handles.push(a);this._handles[1].active=!0,this._handles[1].tracking=!0,this._moveHandle=new s(t,e,i),this.add(this._moveHandle),this._handles.push(this._moveHandle),this._moveHandle.hide(),this.create(),this.onMove=this.onMove.bind(this),this.onHover=this.onHover.bind(this),this.addEventListeners()}addEventListeners(){this._container.addEventListener("wheel",this.onMove),this._rectangle.addEventListener("mouseenter",this.onHover),this._rectangle.addEventListener("mouseleave",this.onHover),this._label.addEventListener("mouseenter",this.onHover),this._label.addEventListener("mouseleave",this.onHover)}removeEventListeners(){this._container.removeEventListener("wheel",this.onMove),this._rectangle.removeEventListener("mouseenter",this.onHover),this._rectangle.removeEventListener("mouseleave",this.onHover),this._label.removeEventListener("mouseenter",this.onHover),this._label.removeEventListener("mouseleave",this.onHover)}onHover(t){t&&this.hoverDom(t),this.hoverMesh(),this._hovered=this._handles[0].hovered||this._handles[1].hovered||this._domHovered,this._container.style.cursor=this._hovered?"pointer":"default"}hoverMesh(){}hoverDom(t){this._domHovered="mouseenter"===t.type}onStart(t){this._moveHandle.onMove(t,!0),this._handles[0].onStart(t),this._handles[1].onStart(t),this._active=this._handles[0].active||this._handles[1].active||this._domHovered,this._domHovered&&!this._handles[1].tracking&&(this._moving=!0,this._controls.enabled=!1),this.update()}onMove(t){if(this._active){const e=this._moveHandle.worldPosition.clone();this._dragged=!0,this._moveHandle.onMove(t,!0),this._moving&&this._handles.slice(0,-1).forEach((t=>{t.worldPosition.add(this._moveHandle.worldPosition.clone().sub(e))})),this.updateRoI(!0)}else this.onHover(null);this._handles[0].onMove(t),this._handles[1].onMove(t),this.update()}onEnd(){this._handles[0].onEnd(),this._handles[1].tracking&&this._handles[0].screenPosition.distanceTo(this._handles[1].screenPosition)<10||(this._dragged||!this._active||this._handles[1].tracking||(this._selected=!this._selected,this._handles[0].selected=this._selected),this._dragged||!this._handles[1].tracking?(this._handles[1].tracking=!1,this._handles[1].onEnd()):this._handles[1].tracking=!1,this._handles[1].selected=this._selected,this._active=this._handles[0].active||this._handles[1].active,this._dragged=!1,this._moving=!1,this.updateRoI(),this.update())}hideDOM(){this._handles.forEach((t=>t.hideDOM())),this._rectangle.style.display="none",this._label.style.display="none"}showDOM(){this._handles[0].showDOM(),this._handles[1].showDOM(),this._rectangle.style.display="",this._label.style.display=""}create(){this.createMesh(),this.createDOM()}createMesh(){this._geometry=new e.PlaneGeometry(1,1),this._material=new e.MeshBasicMaterial({side:e.DoubleSide}),this._material.transparent=!0,this._material.opacity=.2,this.updateMeshColor(),this._mesh=new e.Mesh(this._geometry,this._material),this._mesh.visible=!0,this.add(this._mesh)}createDOM(){this._rectangle=document.createElement("div"),this._rectangle.className="widgets-rectangle",this._container.appendChild(this._rectangle),this._label=document.createElement("div"),this._label.className="widgets-label";const t=document.createElement("div");let e=document.createElement("div");e.className="mean-sd",t.appendChild(e);let i=document.createElement("div");i.className="max-min",t.appendChild(i);let s=document.createElement("div");s.className="area",t.appendChild(s),this._label.appendChild(t),this._container.appendChild(this._label),this.updateDOMColor()}update(){this.updateColor(),this._handles[0].update(),this._handles[1].update(),this.updateMeshColor(),this.updateMeshPosition(),this.updateDOM()}updateMeshColor(){this._material&&this._material.color.set(this._color)}updateMeshPosition(){if(this._geometry){const t=(new e.Vector3).subVectors(this._handles[1].worldPosition,this._handles[0].worldPosition).projectOnVector(this._camera.up);this._geometry.vertices[0].copy(this._handles[0].worldPosition),this._geometry.vertices[1].copy((new e.Vector3).addVectors(this._handles[0].worldPosition,t)),this._geometry.vertices[2].copy((new e.Vector3).subVectors(this._handles[1].worldPosition,t)),this._geometry.vertices[3].copy(this._handles[1].worldPosition),this._geometry.verticesNeedUpdate=!0,this._geometry.computeBoundingSphere()}}updateRoI(t){const e=this._label.querySelector(".mean-sd"),i=this._label.querySelector(".max-min");if(t)return e.innerHTML="",void(i.innerHTML="");const s=n.getRoI(this._mesh,this._camera,this._stack);null!==s?(e.innerHTML=`Mean: ${s.mean.toFixed(1)} / SD: ${s.sd.toFixed(1)}`,i.innerHTML=`Max: ${s.max.toFixed()} / Min: ${s.min.toFixed()}`):(e.innerHTML="",i.innerHTML="")}updateDOMColor(){this._rectangle.style.borderColor=this._color,this._label.style.borderColor=this._color}updateDOM(){this.updateDOMColor();const t=this._stack.frame[this._params.frameIndex].ultrasoundRegions||[];if(this._area=n.getGeometryArea(this._geometry),this._calibrationFactor)this._area*=Math.pow(this._calibrationFactor,2);else if(t&&t.length>0&&this._stack.lps2IJK){const e=this.getRegionByXY(t,n.worldToData(this._stack.lps2IJK,this._handles[0].worldPosition)),i=this.getRegionByXY(t,n.worldToData(this._stack.lps2IJK,this._handles[1].worldPosition));null!==e&&null!==i&&e===i&&"cm"===t[e].unitsX&&"cm"===t[e].unitsY?(this._area*=Math.pow(t[e].deltaX,2),this._units="cm"):this._stack.frame[this._params.frameIndex].pixelSpacing?(this._area/=100,this._units="cm"):this._units="units"}else"cm"===this._units&&(this._area/=100);"units"!==this._units||this._label.hasAttribute("title")?"units"!==this._units&&this._label.hasAttribute("title")&&(this._label.removeAttribute("title"),this._label.style.color=this._colors.text):(this._label.setAttribute("title","Calibration is required to display the area in cm"),this._label.style.color=this._colors.error),this._label.querySelector(".area").innerHTML=`Area: ${this._area.toFixed(2)} ${this._units}`;const e=this.getRectData(this._handles[0].screenPosition,this._handles[1].screenPosition),i=this.adjustLabelTransform(this._label,this._handles[1].screenPosition.clone().add(e.paddingVector.multiplyScalar(15+this._label.offsetHeight/2)));this._rectangle.style.transform=`translate3D(${e.transformX}px, ${e.transformY}px, 0)`,this._rectangle.style.width=e.width+"px",this._rectangle.style.height=e.height+"px",this._label.style.transform="translate3D("+i.x+"px,"+i.y+"px, 0)"}free(){this.removeEventListeners(),this._handles.forEach((t=>{this.remove(t),t.free()})),this._handles=[],this._container.removeChild(this._rectangle),this._container.removeChild(this._label),this.remove(this._mesh),this._mesh.geometry.dispose(),this._mesh.geometry=null,this._mesh.material.dispose(),this._mesh.material=null,this._mesh=null,this._geometry.dispose(),this._geometry=null,this._material.vertexShader=null,this._material.fragmentShader=null,this._material.uniforms=null,this._material.dispose(),this._material=null,this._stack=null,super.free()}getMeasurements(){return{area:this._area,units:this._units}}get targetMesh(){return this._targetMesh}set targetMesh(t){this._targetMesh=t,this._handles.forEach((e=>e.targetMesh=t)),this.update()}get worldPosition(){return this._worldPosition}set worldPosition(t){this._handles[0].worldPosition.copy(t),this._handles[1].worldPosition.copy(t),this._worldPosition.copy(t),this.update()}get calibrationFactor(){return this._calibrationFactor}set calibrationFactor(t){this._calibrationFactor=t,this._units="cm",this.update()}},t.RulerWidget=class extends wt{constructor(t,e,i={}){super(t,e,i),this._widgetType="Ruler",this._calibrationFactor=i.calibrationFactor||null,this._distance=null,this._units=this._calibrationFactor||i.pixelSpacing?"mm":"units",this._moving=!1,this._domHovered=!1,this._material=null,this._geometry=null,this._mesh=null,this._line=null,this._label=null,this._handles=[];const s=St();let a;for(let o=0;o<2;o++)a=new s(t,e,i),this.add(a),this._handles.push(a);this._handles[1].active=!0,this._handles[1].tracking=!0,this._moveHandle=new s(t,e,i),this.add(this._moveHandle),this._handles.push(this._moveHandle),this._moveHandle.hide(),this.create(),this.onMove=this.onMove.bind(this),this.onHover=this.onHover.bind(this),this.addEventListeners()}addEventListeners(){this._container.addEventListener("wheel",this.onMove),this._line.addEventListener("mouseenter",this.onHover),this._line.addEventListener("mouseleave",this.onHover),this._label.addEventListener("mouseenter",this.onHover),this._label.addEventListener("mouseleave",this.onHover)}removeEventListeners(){this._container.removeEventListener("wheel",this.onMove),this._line.removeEventListener("mouseenter",this.onHover),this._line.removeEventListener("mouseleave",this.onHover),this._label.removeEventListener("mouseenter",this.onHover),this._label.removeEventListener("mouseleave",this.onHover)}onHover(t){t&&this.hoverDom(t),this.hoverMesh(),this._hovered=this._handles[0].hovered||this._handles[1].hovered||this._domHovered,this._container.style.cursor=this._hovered?"pointer":"default"}hoverMesh(){}hoverDom(t){this._domHovered="mouseenter"===t.type}onStart(t){this._moveHandle.onMove(t,!0),this._handles[0].onStart(t),this._handles[1].onStart(t),this._active=this._handles[0].active||this._handles[1].active||this._domHovered,this._domHovered&&!this._handles[1].tracking&&(this._moving=!0,this._controls.enabled=!1),this.update()}onMove(t){if(this._active){const e=this._moveHandle.worldPosition.clone();this._dragged=!0,this._moveHandle.onMove(t,!0),this._moving&&this._handles.slice(0,-1).forEach((t=>{t.worldPosition.add(this._moveHandle.worldPosition.clone().sub(e))}))}else this.onHover(null);this._handles[0].onMove(t),this._handles[1].onMove(t),this.update()}onEnd(){this._handles[0].onEnd(),this._handles[1].tracking&&this._handles[0].screenPosition.distanceTo(this._handles[1].screenPosition)<10||(this._dragged||!this._active||this._handles[1].tracking||(this._selected=!this._selected,this._handles[0].selected=this._selected),this._dragged||!this._handles[1].tracking?(this._handles[1].tracking=!1,this._handles[1].onEnd()):this._handles[1].tracking=!1,this._handles[1].selected=this._selected,this._active=this._handles[0].active||this._handles[1].active,this._dragged=!1,this._moving=!1,this.update())}create(){this.createMesh(),this.createDOM()}createMesh(){this._geometry=new BufferGeometry;const t=new Float32Array(6);this._geometry.setAttribute("position",new BufferAttribute(t,3));let i=0;t[i++]=this._handles[0].worldPosition.x,t[i++]=this._handles[0].worldPosition.y,t[i++]=this._handles[0].worldPosition.z,t[i++]=this._handles[1].worldPosition.x,t[i++]=this._handles[1].worldPosition.y,t[i++]=this._handles[1].worldPosition.z,this._material=new e.LineBasicMaterial,this.updateMeshColor(),this._mesh=new e.Line(this._geometry,this._material),this._mesh.visible=!0,this.add(this._mesh)}createDOM(){this._line=document.createElement("div"),this._line.className="widgets-line",this._container.appendChild(this._line),this._label=document.createElement("div"),this._label.className="widgets-label",this._container.appendChild(this._label),this.updateDOMColor()}hideDOM(){this._line.style.display="none",this._label.style.display="none",this._handles.forEach((t=>t.hideDOM()))}showDOM(){this._line.style.display="",this._label.style.display="",this._handles[0].showDOM(),this._handles[1].showDOM()}update(){this.updateColor(),this._handles[0].update(),this._handles[1].update();const t=this.getDistanceData(this._handles[0].worldPosition,this._handles[1].worldPosition,this._calibrationFactor);this._distance=t.distance,t.units&&(this._units=t.units),this.updateMeshColor(),this.updateMeshPosition(),this.updateDOM()}updateMeshColor(){this._material&&this._material.color.set(this._color)}updateMeshPosition(){this._geometry&&(this._geometry.verticesNeedUpdate=!0)}updateDOM(){this.updateDOMColor();const t=this.getLineData(this._handles[0].screenPosition,this._handles[1].screenPosition);this._line.style.transform=`translate3D(${t.transformX}px, ${t.transformY}px, 0)\n\t\t\trotate(${t.transformAngle}rad)`,this._line.style.width=t.length+"px","units"!==this._units||this._label.hasAttribute("title")?"units"!==this._units&&this._label.hasAttribute("title")&&(this._label.removeAttribute("title"),this._label.style.color=this._colors.text):(this._label.setAttribute("title","Calibration is required to display the distance in mm"),this._label.style.color=this._colors.error),this._label.innerHTML=`${this._distance.toFixed(2)} ${this._units}`;let e=Math.abs(t.transformAngle);e>Math.PI/2&&(e=Math.PI-e);const i=Math.tan(e)<this._label.offsetHeight/this._label.offsetWidth?this._label.offsetWidth/2/Math.cos(e)+15:this._label.offsetHeight/2/Math.cos(Math.PI/2-e)+15,s=t.line.normalize().multiplyScalar(i),a=t.length>2*i?this._handles[1].screenPosition.clone().sub(s):this._handles[1].screenPosition.clone().add(s),o=this.adjustLabelTransform(this._label,a);this._label.style.transform=`translate3D(${o.x}px, ${o.y}px, 0)`}updateDOMColor(){this._line.style.backgroundColor=this._color,this._label.style.borderColor=this._color}free(){this.removeEventListeners(),this._handles.forEach((t=>{this.remove(t),t.free()})),this._handles=[],this._container.removeChild(this._line),this._container.removeChild(this._label),this.remove(this._mesh),this._mesh.geometry.dispose(),this._mesh.geometry=null,this._mesh.material.dispose(),this._mesh.material=null,this._mesh=null,this._geometry.dispose(),this._geometry=null,this._material.vertexShader=null,this._material.fragmentShader=null,this._material.uniforms=null,this._material.dispose(),this._material=null,super.free()}getMeasurements(){return{distance:this._distance,units:this._units}}get targetMesh(){return this._targetMesh}set targetMesh(t){this._targetMesh=t,this._handles.forEach((e=>e.targetMesh=t)),this.update()}get worldPosition(){return this._worldPosition}set worldPosition(t){this._handles[0].worldPosition.copy(t),this._handles[1].worldPosition.copy(t),this._worldPosition.copy(t),this.update()}get calibrationFactor(){return this._calibrationFactor}set calibrationFactor(t){this._calibrationFactor=t,this._units="mm",this.update()}},t.SegmentationLutHelper=class{constructor(t,e=A){n.isString(t)?this._dom=document.getElementById(t):this._dom=t,this._segmentation=e,this.initCanvas(),this.paintCanvas()}initCanvas(){this._canvasContainer=this.initCanvasContainer(this._dom),this._canvasBg=this.createCanvas(),this._canvasContainer.appendChild(this._canvasBg),this._canvas=this.createCanvas(),this._canvasContainer.appendChild(this._canvas)}initCanvasContainer(t){let e=t;return e.style.width="256 px",e.style.height="128 px",e.style.border="1px solid #F9F9F9",e}createCanvas(){let t=document.createElement("canvas");return t.height=128,t.width=256,t}paintCanvas(){let t=this._canvas.getContext("2d");t.clearRect(0,0,this._canvas.width,this._canvas.height),t.globalCompositeOperation="source-over",t.lineWidth=1;for(let e in this._segmentation){let i=e%this._canvas.width,s=Math.floor(e/this._canvas.width),a=void 0!==this._segmentation[e].opacity?this._segmentation[e].opacity:1,o=this._segmentation[e].color;t.fillStyle=`rgba( ${Math.round(o[0])}, ${Math.round(o[1])}, ${Math.round(o[2])}, ${a})`,t.fillRect(i,s,1,1)}}get texture(){let t=new e.Texture(this._canvas);return t.mapping=e.UVMapping,t.wrapS=t.wrapT=e.ClampToEdgeWrapping,t.magFilter=t.minFilter=e.NearestFilter,t.premultiplyAlpha=!0,t.needsUpdate=!0,t}set segmentation(t){this._segmentation=t,this.paintCanvas()}get segmentation(){return this._segmentation}},t.SegmentationPreset=class{constructor(t="Freesurfer"){this._presetID=t,this._presets=this.presetSegs()}set preset(t){this._presetID=t}get preset(){return this.fetchPreset(this._presetID)}fetchPreset(t){return this._presets[t]}addPreset(t){this._presets.push(t)}presetsAvailable(t="segmentation"){let e=[],i=this._presets;for(let t in i)e.push(t);return e}presetSegs(){return{Freesurfer:vt}}},t.SeriesModel=Z,t.SliceGeometry=f,t.SliceHelper=j,t.StackHelper=W,t.StackModel=tt,t.TrackballControl=h,t.TrackballOrthoControl=c,t.UtilsCore=n,t.VRFragmentShader=q,t.VRUniformShader=$,t.VRVertexShader=Y,t.ValidatorsCore=o,t.VelocityTimeIntegralWidget=class extends wt{constructor(t,e,i={}){if(super(t,e,i),this._widgetType="VelocityTimeIntegral",this._regions=i.ultrasoundRegions||[],this._regions.length<1)throw new Error("Ultrasound regions should not be empty!");if(this._vMax=null,this._vMean=null,this._gMax=null,this._gMean=null,this._envTi=null,this._vti=null,this._extraInfo=null,this._initialized=!1,this._isHandleActive=!0,this._domHovered=!1,this._initialRegion=this.getRegionByXY(this._regions,n.worldToData(i.lps2IJK,i.worldPosition)),null===this._initialRegion)throw new Error("Invalid initial UltraSound region!");this._usPoints=[],this._material=null,this._geometry=null,this._mesh=null,this._lines=[],this._label=null,this._handles=[];const s=St();let a=new s(t,e,i);this.add(a),this._handles.push(a),this._moveHandle=new s(t,e,i),this.add(this._moveHandle),this._moveHandle.hide(),this.onMove=this.onMove.bind(this),this.onHover=this.onHover.bind(this),this.create(),this.addEventListeners()}addEventListeners(){this._container.addEventListener("wheel",this.onMove),this._label.addEventListener("mouseenter",this.onHover),this._label.addEventListener("mouseleave",this.onHover)}removeEventListeners(){this._container.removeEventListener("wheel",this.onMove),this._label.removeEventListener("mouseenter",this.onHover),this._label.removeEventListener("mouseleave",this.onHover)}onHover(t){t&&this.hoverDom(t),this.hoverMesh();let e=!1;this._handles.forEach((t=>e=e||t.hovered)),this._hovered=e||this._domHovered,this._container.style.cursor=this._hovered?"pointer":"default"}hoverMesh(){}hoverDom(t){this._domHovered="mouseenter"===t.type}onStart(t){let e=!1;this._moveHandle.onMove(t,!0),this._handles.forEach((i=>{i.onStart(t),e=e||i.active})),this._active=e||this._domHovered,this._isHandleActive=e,this._domHovered&&(this._controls.enabled=!1),this.update()}onMove(t){if(this.active){const e=this._moveHandle.worldPosition.clone();this._moveHandle.onMove(t,!0);const i=this._moveHandle.worldPosition.clone().sub(e);if(!this.isCorrectRegion(i))return void this._moveHandle.worldPosition.copy(e);if(this._initialized)this.updateDOMContent(!0),(!this._isHandleActive||this._handles[this._handles.length-2].active||this._handles[this._handles.length-1].active)&&(this._handles.forEach((t=>{t.worldPosition.add(i)})),this._isHandleActive=!1,this._handles[this._handles.length-2].active=!1,this._handles[this._handles.length-1].active=!1,this._controls.enabled=!1);else{this._handles[this._handles.length-1].hovered=!1,this._handles[this._handles.length-1].active=!1,this._handles[this._handles.length-1].tracking=!1;let t=new(St())(this._targetMesh,this._controls,this._params);t.hovered=!0,t.active=!0,t.tracking=!0,this.add(t),this._handles.push(t),this.createLine()}this._dragged=!0}else this.onHover(null);this._handles.forEach((e=>{e.onMove(t)})),this.active&&this._handles.length>2&&this.pushPopHandle(),this.update()}onEnd(){if(this._handles.length<3)return;let t=!1;this._handles.slice(0,-1).forEach((e=>{e.onEnd(),t=t||e.active})),this._dragged||!this._handles[this._handles.length-1].tracking?(this._handles[this._handles.length-1].tracking=!1,this._handles[this._handles.length-1].onEnd()):this._handles[this._handles.length-1].tracking=!1,!this._dragged&&this._initialized||(this.finalize(),this.updateDOMContent()),!this._dragged&&this._active&&(this._selected=!this._selected,this._handles.forEach((t=>t.selected=this._selected))),this._active=t||this._handles[this._handles.length-1].active,this._isHandleActive=t,this._dragged=!1,this._initialized=!0,this.update()}isCorrectRegion(t){let e=!0;return this._handles.forEach(((i,s)=>{!i.active&&this._isHandleActive||(e=e&&this.checkHandle(s,t))})),e}checkHandle(t,e){const i=this.getRegionByXY(this._regions,n.worldToData(this._params.lps2IJK,this._handles[t].worldPosition.clone().add(e)));return null!==i&&i===this._initialRegion&&"cm/sec"===this._regions[i].unitsY}create(){this.createMaterial(),this.createDOM()}createMaterial(){this._material=new e.LineBasicMaterial}createDOM(){this._label=document.createElement("div"),this._label.className="widgets-label";const t=document.createElement("div");["vmax","vmean","gmax","gmean","envti","vti","info"].forEach((e=>{const i=document.createElement("div");i.className=e,t.appendChild(i)})),this._label.appendChild(t),this._container.appendChild(this._label),this.updateDOMColor()}createLine(){const t=document.createElement("div");t.className="widgets-line",t.addEventListener("mouseenter",this.onHover),t.addEventListener("mouseleave",this.onHover),this._lines.push(t),this._container.appendChild(t)}pushPopHandle(){let t=this._handles[this._handles.length-3],e=this._handles[this._handles.length-2],i=this._handles[this._handles.length-1],s=this.isPointOnLine(t.worldPosition,e.worldPosition,i.worldPosition);return(s||t.screenPosition.distanceTo(i.screenPosition)<25)&&(this.remove(e),e.free(),this._handles[this._handles.length-2]=i,this._handles.pop(),this._container.removeChild(this._lines.pop())),s}isPointOnLine(t,i,s){return!(new e.Vector3).crossVectors(t.clone().sub(s),i.clone().sub(s)).length()}finalize(){this._initialized&&this._handles.splice(-2).forEach((t=>{this.remove(t),t.free()}));const t=n.worldToData(this._params.lps2IJK,this._handles[0]._worldPosition),e=n.worldToData(this._params.lps2IJK,this._handles[this._handles.length-1]._worldPosition),i=this._regions[this.getRegionByXY(this._regions,t)],s=i.y0+(i.axisY||0),a=St(),o={hideHandleMesh:this._params.hideHandleMesh||!1};for(t.y=s,e.y=s,this._usPoints=[this.getPointInRegion(i,e),this.getPointInRegion(i,t)],o.worldPosition=e.applyMatrix4(this._params.ijk2LPS),this._handles.push(new a(this._targetMesh,this._controls,o)),this.add(this._handles[this._handles.length-1]),o.worldPosition=t.applyMatrix4(this._params.ijk2LPS),this._handles.push(new a(this._targetMesh,this._controls,o)),this.add(this._handles[this._handles.length-1]);this._lines.length<this._handles.length;)this.createLine()}update(){this.updateColor(),this._handles.forEach((t=>t.update())),this.updateMesh(),this.updateDOMColor(),this.updateDOMPosition()}updateValues(){const t=this._regions[this.getRegionByXY(this._regions,n.worldToData(this._params.lps2IJK,this._handles[0]._worldPosition))],e={xMin:Number.POSITIVE_INFINITY,xMax:Number.NEGATIVE_INFINITY,yMin:Number.POSITIVE_INFINITY,yMax:Number.NEGATIVE_INFINITY};let i,s,a,o=0;this._vMax=0,this._vMean=0,this._gMean=0,this._usPoints.splice(2),this._handles.slice(0,-2).forEach((l=>{const r=this.getPointInRegion(t,n.worldToData(this._params.lps2IJK,l._worldPosition)),h=Math.abs(r.y/100),c=4*Math.pow(h,2);if((null===this._vMax||h>this._vMax)&&(this._vMax=h),e.xMin=Math.min(r.x,e.xMin),e.xMax=Math.max(r.x,e.xMax),e.yMin=Math.min(r.y,e.yMin),e.yMax=Math.max(r.y,e.yMax),a){const t=Math.abs(r.x-a);o+=t,this._vMean+=t*(i+h)/2,this._gMean+=t*(s+c)/2}i=h,s=c,a=r.x,this._usPoints.push(r)})),this._gMax=4*Math.pow(this._vMax,2),this._vMean/=o,this._gMean/=o,this._envTi=1e3*o,this._vti=this.getArea(this._usPoints),this._shapeWarn=e.xMax-e.xMin!==o||e.yMin<0!=e.yMax<0}updateMesh(){this._mesh&&this.remove(this._mesh),this._geometry=new e.BufferGeometry;const t=new Float32Array(3*this._handles.length);this._geometry.setAttribute("position",new e.BufferAttribute(t,3));let i=0;this._handles.forEach((e=>{t[i++]=e.worldPosition.x,t[i++]=e.worldPosition.y,t[i++]=e.worldPosition.z})),t[i++]=this._handles[0].worldPosition.x,t[i++]=this._handles[0].worldPosition.y,t[i++]=this._handles[0].worldPosition.z,this._geometry.computeVertexNormals(),this.updateMeshColor(),this._mesh=new e.Line(this._geometry,this._material),this._mesh.visible=!0,this.add(this._mesh)}updateMeshColor(){this._material&&this._material.color.set(this._color)}updateDOMColor(){this._handles.length>=2&&this._lines.forEach((t=>t.style.backgroundColor=this._color)),this._label.style.borderColor=this._color}updateDOMContent(t){const e=this._label.querySelector(".vmax"),i=this._label.querySelector(".vmean"),s=this._label.querySelector(".gmax"),a=this._label.querySelector(".gmean"),o=this._label.querySelector(".envti"),n=this._label.querySelector(".vti"),l=this._label.querySelector(".info");if(t)return e.innerHTML="",i.innerHTML="",s.innerHTML="",a.innerHTML="",o.innerHTML="",n.innerHTML="",void(l.innerHTML="");this.updateValues(),this._shapeWarn&&!this._label.hasAttribute("title")?(this._label.setAttribute("title","Values may be incorrect due to invalid curve."),this._label.style.color=this._colors.error):!this._shapeWarn&&this._label.hasAttribute("title")&&(this._label.removeAttribute("title"),this._label.style.color=this._colors.text),e.innerHTML=`Vmax: ${this._vMax.toFixed(2)} m/s`,i.innerHTML=`Vmean: ${this._vMean.toFixed(2)} m/s`,s.innerHTML=`Gmax: ${this._gMax.toFixed(2)} mmhg`,a.innerHTML=`Gmean: ${this._gMean.toFixed(2)} mmhg`,o.innerHTML=`Env.Ti: ${this._envTi.toFixed(1)} ms`,n.innerHTML=`VTI: ${this._vti.toFixed(2)} cm`,l.innerHTML=this._extraInfo}updateDOMPosition(){if(this._handles.length<2)return;let t=null;this._lines.forEach(((e,i)=>{const s=this.getLineData(this._handles[i].screenPosition,this._handles[i+1===this._handles.length?0:i+1].screenPosition);e.style.transform=`translate3D(${s.transformX}px, ${s.transformY}px, 0)\n\t\t\t\t\t\t\t\t\t\trotate(${s.transformAngle}rad)`,e.style.width=s.length+"px",(null===t||t.y<this._handles[i].screenPosition.y)&&(t=this._handles[i].screenPosition.clone())})),this._initialized&&(t.y+=15+this._label.offsetHeight/2,t=this.adjustLabelTransform(this._label,t),this._label.style.transform=`translate3D(${t.x}px, ${t.y}px, 0)`)}hideDOM(){this._handles.forEach((t=>t.hideDOM())),this._lines.forEach((t=>t.style.display="none")),this._label.style.display="none"}showDOM(){this._handles.forEach((t=>t.showDOM())),this._lines.forEach((t=>t.style.display="")),this._label.style.display=""}free(){this.removeEventListeners(),this._handles.forEach((t=>{this.remove(t),t.free()})),this._handles=[],this._usPoints=[],this.remove(this._moveHandle),this._moveHandle.free(),this._moveHandle=null,this._lines.forEach((t=>{t.removeEventListener("mouseenter",this.onHover),t.removeEventListener("mouseleave",this.onHover),this._container.removeChild(t)})),this._lines=[],this._container.removeChild(this._label),this._mesh&&(this.remove(this._mesh),this._mesh.geometry.dispose(),this._mesh.geometry=null,this._mesh.material.dispose(),this._mesh.material=null,this._mesh=null),this._geometry&&(this._geometry.dispose(),this._geometry=null),this._material.vertexShader=null,this._material.fragmentShader=null,this._material.uniforms=null,this._material.dispose(),this._material=null,super.free()}getMeasurements(){return{vMax:this._vMax,vMean:this._vMean,gMax:this._gMax,gMean:this._gMean,envTi:this._envTi,vti:this._vti}}get targetMesh(){return this._targetMesh}set targetMesh(t){this._targetMesh=t,this._handles.forEach((e=>e.targetMesh=t)),this._moveHandle.targetMesh=t,this.update()}get worldPosition(){return this._worldPosition}set worldPosition(t){this._handles.forEach((e=>e._worldPosition.copy(t))),this._worldPosition.copy(t),this.update()}get extraInfo(){return this._extraInfo}set extraInfo(t){this._extraInfo=t,this._label.querySelector(".info").innerHTML=t}},t.VolumeLoader=class extends J{parse(t){return this.emit("parse-start",{file:t.url,time:new Date}),this._progressBar&&this._progressBar.update(0,100,"parse",t.url),new Promise(((e,i)=>{setTimeout((()=>{e(new Promise(((e,i)=>{let s=t;if(Array.isArray(s)||(s=[s]),s.forEach((t=>{this._preprocess(t)})),1===s.length)s=s[0];else{let t=s.filter(this._filterByExtension.bind(null,"MHD")),e=s.filter(this._filterByExtension.bind(null,"RAW"));2===s.length&&1===t.length&&1===e.length&&(s.url=t[0].url,s.extension=t[0].extension,s.mhdBuffer=t[0].buffer,s.rawBuffer=e[0].buffer)}let a=this._parser(s.extension);a||(this.emit("parse-error",{file:t.url,time:new Date,error:s.filename+"can not be parsed."}),i(s.filename+" can not be parsed."));let o=null;try{o=new a(s,0)}catch(e){console.warn(e),this.emit("parse-error",{file:t.url,time:new Date,error:e}),i(e)}let n=new Z;n.rawHeader=o.rawHeader(),n.seriesInstanceUID=o.seriesInstanceUID(),n.transferSyntaxUID=o.transferSyntaxUID(),n.seriesDate=o.seriesDate(),n.seriesDescription=o.seriesDescription(),n.studyDate=o.studyDate(),n.studyDescription=o.studyDescription(),n.numberOfFrames=o.numberOfFrames(),n.numberOfFrames||(n.numberOfFrames=1),n.numberOfChannels=o.numberOfChannels(),n.modality=o.modality(),"SEG"===n.modality&&(n.segmentationType=o.segmentationType(),n.segmentationSegments=o.segmentationSegments()),n.patientID=o.patientID(),n.patientName=o.patientName(),n.patientAge=o.patientAge(),n.patientBirthdate=o.patientBirthdate(),n.patientSex=o.patientSex();let l=new tt;l.numberOfChannels=o.numberOfChannels(),l.pixelRepresentation=o.pixelRepresentation(),l.pixelType=o.pixelType(),l.invert=o.invert(),l.spacingBetweenSlices=o.spacingBetweenSlices(),l.modality=n.modality,"SEG"===l.modality&&(l.segmentationType=n.segmentationType,l.segmentationSegments=n.segmentationSegments),n.stack.push(l),setTimeout(this.parseFrameClosure(n,l,t.url,0,o,e,i),0)})))}),10)}))}parseFrameClosure(t,e,i,s,a,o,n){return()=>{this.parseFrame(t,e,i,s,a,o,n)}}parseFrame(t,e,i,s,a,o,n){let l=new et;l.sopInstanceUID=a.sopInstanceUID(s),l.url=i,l.index=s,l.invert=e.invert,l.frameTime=a.frameTime(s),l.ultrasoundRegions=a.ultrasoundRegions(s),l.rows=a.rows(s),l.columns=a.columns(s),l.numberOfChannels=e.numberOfChannels,l.pixelPaddingValue=a.pixelPaddingValue(s),l.pixelRepresentation=e.pixelRepresentation,l.pixelType=e.pixelType,l.pixelData=a.extractPixelData(s),l.pixelSpacing=a.pixelSpacing(s),l.spacingBetweenSlices=a.spacingBetweenSlices(s),l.sliceThickness=a.sliceThickness(s),l.imageOrientation=a.imageOrientation(s),l.rightHanded=a.rightHanded(),e.rightHanded=l.rightHanded,null===l.imageOrientation&&(l.imageOrientation=[1,0,0,0,1,0]),l.imagePosition=a.imagePosition(s),l.dimensionIndexValues=a.dimensionIndexValues(s),l.bitsAllocated=a.bitsAllocated(s),l.instanceNumber=a.instanceNumber(s),l.windowCenter=a.windowCenter(s),l.windowWidth=a.windowWidth(s),l.rescaleSlope=a.rescaleSlope(s),l.rescaleIntercept=a.rescaleIntercept(s),l.minMax=a.minMaxPixelData(l.pixelData),"SEG"===t.modality&&(l.referencedSegmentNumber=a.referencedSegmentNumber(s)),e.frame.push(l),this._parsed=s+1,this._totalParsed=t.numberOfFrames,this._progressBar&&this._progressBar.update(this._parsed,this._totalParsed,"parse",i),this.emit("parsing",{file:i,total:this._totalParsed,parsed:this._parsed,time:new Date}),this._parsed===this._totalParsed?(this.emit("parse-success",{file:i,total:this._totalParsed,parsed:this._parsed,time:new Date}),o(t)):setTimeout(this.parseFrameClosure(t,e,i,this._parsed,a,o,n),0)}_parser(t){let e=null;switch(t.toUpperCase()){case"NII":case"NII_":e=pt;break;case"DCM":case"DIC":case"DICOM":case"IMA":case"":e=ct;break;case"MHD":e=_t;break;case"NRRD":e=yt;break;case"MGH":case"MGZ":e=bt;break;default:return console.warn("unsupported extension: "+t),!1}return e}_preprocess(t){const e=n.parseUrl(t.url);if(t.filename=e.filename,t.extension=e.extension,t.pathname=e.pathname,t.query=e.query,"gz"===t.extension?(t.gzcompressed=!0,t.extension=t.filename.split(".gz").shift().split(".").pop()):"mgz"===t.extension?(t.gzcompressed=!0,t.extension="mgh"):"zraw"===t.extension?(t.gzcompressed=!0,t.extension="raw"):t.gzcompressed=!1,t.gzcompressed){let e=gt.inflate(t.buffer);t.buffer=e.buffer}}_filterByExtension(t,e){return e.extension.toUpperCase()===t.toUpperCase()}},t.VolumeRenderingHelper=class extends U{constructor(t){super(),this._stack=t,this._textures=[],this._shadersFragment=q,this._shadersVertex=Y,this._uniforms=$.uniforms(),this._material=null,this._geometry=null,this._mesh=null,this._algorithm=0,this._alphaCorrection=.5,this._interpolation=1,this._shading=1,this._shininess=10,this._steps=256,this._offset=0,this._windowCenter=0,this._windowWidth=1,this._create()}_create(){this._prepareStack(),this._prepareTexture(),this._prepareMaterial(),this._prepareGeometry(),this._mesh=new e.Mesh(this._geometry,this._material),this.add(this._mesh)}_prepareStack(){this._stack.prepared||this._stack.prepare(),this._stack.packed||this._stack.pack(),this._offset=Math.min(0,this._stack._minMax[0]),this._windowCenter=this._stack.windowCenter,this._windowWidth=.8*this._stack.windowWidth}_prepareMaterial(){this._uniforms=$.uniforms(),this._uniforms.uWorldBBox.value=this._stack.worldBoundingBox(),this._uniforms.uTextureSize.value=this._stack.textureSize,this._uniforms.uTextureContainer.value=this._textures,this._stack.textureUnits>8&&(this._uniforms.uTextureContainer.length=14),this._uniforms.uWorldToData.value=this._stack.lps2IJK,this._uniforms.uNumberOfChannels.value=this._stack.numberOfChannels,this._uniforms.uPixelType.value=this._stack.pixelType,this._uniforms.uBitsAllocated.value=this._stack.bitsAllocated,this._uniforms.uPackedPerPixel.value=this._stack.packedPerPixel,this._uniforms.uWindowCenterWidth.value=[this._windowCenter-this._offset,this._windowWidth],this._uniforms.uRescaleSlopeIntercept.value=[this._stack.rescaleSlope,this._stack.rescaleIntercept],this._uniforms.uDataDimensions.value=[this._stack.dimensionsIJK.x,this._stack.dimensionsIJK.y,this._stack.dimensionsIJK.z],this._uniforms.uAlphaCorrection.value=this._alphaCorrection,this._uniforms.uInterpolation.value=this._interpolation,this._uniforms.uShading.value=this._shading,this._uniforms.uShininess.value=this._shininess,this._uniforms.uSteps.value=this._steps,this._uniforms.uAlgorithm.value=this._algorithm,this._createMaterial({side:e.BackSide,transparent:!0})}_prepareGeometry(){let t=this._stack.worldBoundingBox(),i=this._stack.worldCenter();this._geometry=new e.BoxGeometry(t[1]-t[0],t[3]-t[2],t[5]-t[4]),this._geometry.applyMatrix4((new e.Matrix4).makeTranslation(i.x,i.y,i.z))}get uniforms(){return this._uniforms}set uniforms(t){this._uniforms=t}set mesh(t){this._mesh=t}get mesh(){return this._mesh}get stack(){return this._stack}set stack(t){this._stack=t}get windowCenter(){return this._windowCenter}set windowCenter(t){this._windowCenter=t,this._uniforms.uWindowCenterWidth.value[0]=this._windowCenter-this._offset}get windowWidth(){return this._windowWidth}set windowWidth(t){this._windowWidth=Math.max(1,t),this._uniforms.uWindowCenterWidth.value[1]=this._windowWidth}get steps(){return this._steps}set steps(t){this._steps=t,this._uniforms.uSteps.value=this._steps}get alphaCorrection(){return this._alphaCorrection}set alphaCorrection(t){this._alphaCorrection=t,this._uniforms.uAlphaCorrection.value=this._alphaCorrection}get interpolation(){return this._interpolation}set interpolation(t){this._interpolation=t,this._uniforms.uInterpolation.value=this._interpolation,this._updateMaterial()}get shading(){return this._shading}set shading(t){this._shading=t,this._uniforms.uShading.value=this._shading}get shininess(){return this._shininess}set shininess(t){this._shininess=t,this._uniforms.uShininess.value=this._shininess}get algorithm(){return this._algorithm}set algorithm(t){this._algorithm=t,this._uniforms.uAlgorithm.value=this._algorithm}dispose(){for(let t=0;t<this._textures.length;t++)this._textures[t].dispose(),this._textures[t]=null;this._textures=null,this._shadersFragment=null,this._shadersVertex=null,this._uniforms.uTextureContainer=null,this._uniforms.uTextureLUT=null,this._uniforms=null,this.remove(this._mesh),this._mesh.geometry.dispose(),this._mesh.geometry=null,this._mesh.material.dispose(),this._mesh.material=null,this._mesh=null,this._geometry.dispose(),this._geometry=null,this._material.vertexShader=null,this._material.fragmentShader=null,this._material.uniforms=null,this._material.dispose(),this._material=null,this._stack=null}},t.VoxelGeometry=v,t.VoxelModel=ft,t.VoxelProbeWidget=class extends wt{constructor(t,e,i={}){super(t,e,i),this._widgetType="VoxelProbe",this._stack=i.stack,this._container.style.cursor="pointer",this._controls.enabled=!1,this._initialized=!1,this._active=!0,this._moving=!0,this._domHovered=!1,this._label=null;const s=St();this._handle=new s(t,e,i),this.add(this._handle),this._moveHandle=new s(t,e,i),this.add(this._moveHandle),this._moveHandle.hide(),this.create(),this.onMove=this.onMove.bind(this),this.onHover=this.onHover.bind(this),this.addEventListeners()}addEventListeners(){this._label.addEventListener("mouseenter",this.onHover),this._label.addEventListener("mouseleave",this.onHover),this._container.addEventListener("wheel",this.onMove)}removeEventListeners(){this._label.removeEventListener("mouseenter",this.onHover),this._label.removeEventListener("mouseleave",this.onHover),this._container.removeEventListener("wheel",this.onMove)}onStart(t){this._moveHandle.onMove(t,!0),this._handle.onStart(t),this._active=this._handle.active||this._domHovered,this._domHovered&&(this._moving=!0,this._controls.enabled=!1),this.update()}onMove(t){if(this._active){const e=this._moveHandle.worldPosition.clone();this._dragged=!0,this._moveHandle.onMove(t,!0),this._moving&&this._handle.worldPosition.add(this._moveHandle.worldPosition.clone().sub(e))}else this.onHover(null);this._handle.onMove(t),this.update()}onEnd(){this._handle.onEnd(),!this._dragged&&this._active&&this._initialized&&(this._selected=!this._selected,this._handle.selected=this._selected),this._initialized=!0,this._active=this._handle.active,this._dragged=!1,this._moving=!1,this.update()}onHover(t){t&&this.hoverDom(t),this._hovered=this._handle.hovered||this._domHovered,this._container.style.cursor=this._hovered?"pointer":"default"}hoverDom(t){this._domHovered="mouseenter"===t.type}create(){this.createVoxel(),this.createDOM()}createVoxel(){this._voxel=new ft,this._voxel.id=this.id}createDOM(){this._label=document.createElement("div"),this._label.className="widgets-label";let t=document.createElement("div"),e=document.createElement("div");e.className="lpsPosition",t.appendChild(e);let i=document.createElement("div");i.className="ijkPosition",t.appendChild(i);let s=document.createElement("div");s.className="value",t.appendChild(s),this._label.appendChild(t),this._container.appendChild(this._label),this.updateDOMColor()}update(){this.updateColor(),this._handle.update(),this._worldPosition.copy(this._handle.worldPosition),this.updateVoxel(),this.updateDOM()}updateVoxel(){this._voxel.worldCoordinates=this._worldPosition,this._voxel.dataCoordinates=n.worldToData(this._stack.lps2IJK,this._worldPosition);let t=n.getPixelData(this._stack,this._voxel.dataCoordinates);this._voxel.value=null===t||this._stack.numberOfChannels>1?"NA":n.rescaleSlopeIntercept(t,this._stack.rescaleSlope,this._stack.rescaleIntercept).toFixed()}updateDOM(){const t=this._label.querySelector(".lpsPosition"),e=this._label.querySelector(".ijkPosition"),i=this._label.querySelector(".value");t.innerHTML=`LPS: \n\t\t\t${this._voxel.worldCoordinates.x.toFixed(2)} :\n\t\t\t${this._voxel.worldCoordinates.y.toFixed(2)} :\n\t\t\t${this._voxel.worldCoordinates.z.toFixed(2)}`,e.innerHTML=`IJK: \n\t\t\t${this._voxel.dataCoordinates.x} :\n\t\t\t${this._voxel.dataCoordinates.y} :\n\t\t\t${this._voxel.dataCoordinates.z}`,i.innerHTML=`Value: ${this._voxel.value}`,this.updateDOMColor();const s=this.adjustLabelTransform(this._label,this._handle.screenPosition,!0);this._label.style.transform=`translate3D(${s.x}px, ${s.y}px, 0)`}updateDOMColor(){this._label.style.borderColor=this._color}free(){this.removeEventListeners(),this.remove(this._handle),this._handle.free(),this._handle=null,this.remove(this._moveHandle),this._moveHandle.free(),this._moveHandle=null,this._container.removeChild(this._label),this._stack=null,this._voxel=null,super.free()}hideDOM(){this._label.style.display="none",this._handle.hideDOM()}showDOM(){this._label.style.display="",this._handle.showDOM()}get targetMesh(){return this._targetMesh}set targetMesh(t){this._targetMesh=t,this._handle.targetMesh=t,this._moveHandle.targetMesh=t,this.update()}get worldPosition(){return this._worldPosition}set worldPosition(t){this._handle.worldPosition.copy(t),this._moveHandle.worldPosition.copy(t),this._worldPosition.copy(t),this.update()}get active(){return this._active}set active(t){this._active=t,this._controls.enabled=!this._active,this.update()}},t.WidgetsCss=xt,Object.defineProperty(t,"__esModule",{value:!0})}));
